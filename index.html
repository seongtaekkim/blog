<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Blog</title><link rel="manifest" href="/blog/manifest.json"><meta name="application-name" content="Blog"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Blog"><meta property="og:url" content="https://seongtaekkim.github.io/blog"><meta property="og:site_name" content="Blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://seongtaekkim.github.io/blog/img/og_image.png"><meta property="article:author" content="Seongtaek Kim"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://seongtaekkim.github.io/blog/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://seongtaekkim.github.io/blog"},"headline":"Blog","image":["https://seongtaekkim.github.io/blog/img/og_image.png"],"author":{"@type":"Person","name":"Seongtaek Kim"},"publisher":{"@type":"Organization","name":"Blog","logo":{"@type":"ImageObject"}},"description":""}</script><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/blog/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/blog/">Blog</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item is-active" href="/blog/">Home</a><a class="navbar-item" href="/blog/archives">Archives</a><a class="navbar-item" href="/blog/categories">Categories</a><a class="navbar-item" href="/blog/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-12-01T06:00:35.000Z" title="2024. 12. 1. 오후 3:00:35">2024-12-01</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-12-01T13:47:37.940Z" title="2024. 12. 1. 오후 10:47:37">2024-12-01</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/ingress-ingress/">ingress/ingress</a></span><span class="level-item">26 minutes read (About 3902 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/12/01/docs/ingress/ingress/">ingress concept</a></h1><div class="content"><h1 id="Ingress-요약"><a href="#Ingress-요약" class="headerlink" title="Ingress 요약"></a>Ingress 요약</h1><p>Nginx 인그레스 컨트롤러  : 외부에서 인그레스로 접속 시 Nginx 인그레스 컨트롤러 파드로 인입되고, 이후 애플리케이션 파드의 IP로 직접 통신</p>
<p><img src="/blog/img/ingress-01.png"></p>
<h2 id="클러스터-내부를-외부에-노출-발전-단계"><a href="#클러스터-내부를-외부에-노출-발전-단계" class="headerlink" title="클러스터 내부를 외부에 노출 - 발전 단계"></a>클러스터 내부를 외부에 노출 - 발전 단계</h2><ol>
<li>파드 생성 : K8S 클러스터 내부에서만 접속</li>
</ol>
<p><img src="/blog/img/ingress-02.png"></p>
<ol start="2">
<li>서비스(Cluster Type) 연결 : K8S 클러스터 내부에서만 접속</li>
</ol>
<ul>
<li>동일한 애플리케이션의 다수의 파드의 접속을 용이하게 하기 위한 서비스에 접속</li>
</ul>
<p><img src="/blog/img/ingress-03.png"></p>
<ol start="3">
<li>서비스(NodePort Type) 연결 : 외부 클라이언트가 서비스를 통해서 클러스터 내부의 파드로 접속</li>
</ol>
<ul>
<li>서비스(NodePort Type)의 일부 단점을 보완한 서비스(LoadBalancer Type) 도 있습니다!</li>
</ul>
<p><img src="/blog/img/ingress-04.png"></p>
<ol start="4">
<li>인그레스 컨트롤러 파드를 배치 : 서비스 앞단에 HTTP 고급 라우팅 등 기능 동작을 위한 배치</li>
</ol>
<ul>
<li>인그레스(정책)이 적용된 인그레스 컨트롤러 파드(예. nginx pod)를 앞단에 배치하여 고급 라우팅 등 기능을 제공</li>
</ul>
<p><img src="/blog/img/ingress-05.png"></p>
<ol start="5">
<li>인그레스 컨트롤러 파드 이중화 구성 :  Active(Leader) - Standby(Follower) 로 Active 파드 장애에 대비</li>
</ol>
<p><img src="/blog/img/ingress-06.png"></p>
<ol start="6">
<li>인그레스 컨트롤러 파드를 외부에 노출 : 인그레스 컨트롤러 파드를 외부에서 접속하기 위해서 노출(expose)</li>
</ol>
<ul>
<li>인그레스 컨트롤러 노출 시 서비스(NodePort Type) 보다는 좀 더 많은 기능을 제공하는 서비스(LoadBalancer Type)를 권장합니다 (80&#x2F;443 포트 오픈 시)</li>
</ul>
<p><img src="/blog/img/ingress-07.png"></p>
<ol start="7">
<li>인그레스와 파드간 내부 연결의 효율화 방안 : 인그레스 컨트롤러 파드(Layer7 동작)에서 서비스 파드의 IP로 직접 연결</li>
</ol>
<ul>
<li>인그레스 컨트롤러 파드는 K8S API서버로부터 서비스의 엔드포인트 정보(파드 IP)를 획득 후 바로 파드의 IP로 연결 - <a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/miscellaneous/#why-endpoints-and-not-services">링크</a></li>
<li>지원되는 인그레스 컨트롤러 : Nginx, Traefix 등 현재 대부분의 인그레스 컨트롤러가 지원함</li>
</ul>
<p><img src="/blog/img/ingress-08.png"></p>
<h1 id="인그레스-Ingress-소개"><a href="#인그레스-Ingress-소개" class="headerlink" title="인그레스(Ingress) 소개"></a>인그레스(Ingress) 소개</h1><p>인그레스 소개 : 클러스터 내부의 서비스(ClusterIP, NodePort, Loadbalancer)를 외부로 노출(HTTP&#x2F;HTTPS) - Web Proxy 역할</p>
<h4 id="인그레스-기능-HTTP-서비스-부하분산-카나리-업그레이드"><a href="#인그레스-기능-HTTP-서비스-부하분산-카나리-업그레이드" class="headerlink" title="인그레스 기능 : HTTP(서비스) 부하분산 , 카나리 업그레이드"></a>인그레스 기능 : HTTP(서비스) 부하분산 , 카나리 업그레이드</h4><p><img src="/blog/img/ingress-09.png"></p>
<h4 id="인그레스-컨트롤러-인그레스의-실제-동작-구현은-인그레스-컨트롤러-Nginx-Kong-등-가-담당"><a href="#인그레스-컨트롤러-인그레스의-실제-동작-구현은-인그레스-컨트롤러-Nginx-Kong-등-가-담당" class="headerlink" title="인그레스 컨트롤러 : 인그레스의 실제 동작 구현은 인그레스 컨트롤러(Nginx, Kong 등)가 담당"></a>인그레스 컨트롤러 : 인그레스의 실제 동작 구현은 인그레스 컨트롤러(Nginx, Kong 등)가 담당</h4><p><img src="/blog/img/ingress-10.png"></p>
<h4 id="인그레스-인그레스-컨트롤러-Nginx-기능-HTTP-서비스-부하분산-카나리-업그레이드-HTTPS-처리-TLS-종료"><a href="#인그레스-인그레스-컨트롤러-Nginx-기능-HTTP-서비스-부하분산-카나리-업그레이드-HTTPS-처리-TLS-종료" class="headerlink" title="인그레스 + 인그레스 컨트롤러(Nginx) 기능 : HTTP(서비스) 부하분산 , 카나리 업그레이드 , HTTPS 처리(TLS 종료)"></a>인그레스 + 인그레스 컨트롤러(Nginx) 기능 : HTTP(서비스) 부하분산 , 카나리 업그레이드 , HTTPS 처리(TLS 종료)</h4><p><img src="/blog/img/ingress-11.png"></p>
<h1 id="Nginx-인그레스-컨트롤러-설치"><a href="#Nginx-인그레스-컨트롤러-설치" class="headerlink" title="Nginx 인그레스 컨트롤러 설치"></a>Nginx 인그레스 컨트롤러 설치</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ingress-Nginx 컨트롤러 생성</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOT&gt; ingress-nginx-values.yaml</span></span><br><span class="line"><span class="string">controller:</span></span><br><span class="line"><span class="string">  service:</span></span><br><span class="line"><span class="string">    type: NodePort</span></span><br><span class="line"><span class="string">    nodePorts:</span></span><br><span class="line"><span class="string">      http: 30080</span></span><br><span class="line"><span class="string">      https: 30443</span></span><br><span class="line"><span class="string">  nodeSelector:</span></span><br><span class="line"><span class="string">    kubernetes.io/hostname: &quot;k3s-s&quot;</span></span><br><span class="line"><span class="string">  metrics:</span></span><br><span class="line"><span class="string">    enabled: true</span></span><br><span class="line"><span class="string">  serviceMonitor:</span></span><br><span class="line"><span class="string">      enabled: true</span></span><br><span class="line"><span class="string">EOT</span></span><br><span class="line"></span><br><span class="line">helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx</span><br><span class="line">helm repo update</span><br><span class="line"></span><br><span class="line">kubectl create ns ingress</span><br><span class="line">helm install ingress-nginx ingress-nginx/ingress-nginx -f ingress-nginx-values.yaml --namespace ingress --version 4.11.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인</span></span><br><span class="line">kubectl get all -n ingress</span><br><span class="line">kc describe svc -n ingress ingress-nginx-controller</span><br><span class="line"></span><br><span class="line"><span class="comment"># externalTrafficPolicy 설정</span></span><br><span class="line">kubectl patch svc -n ingress ingress-nginx-controller -p <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;externalTrafficPolicy&quot;: &quot;Local&quot;&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 기본 nginx conf 파일 확인</span></span><br><span class="line">kc describe cm -n ingress ingress-nginx-controller</span><br><span class="line">kubectl <span class="built_in">exec</span> deploy/ingress-nginx-controller -n ingress -it -- <span class="built_in">cat</span> /etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 관련된 정보 확인 : 포드(Nginx 서버), 서비스, 디플로이먼트, 리플리카셋, 컨피그맵, 롤, 클러스터롤, 서비스 어카운트 등</span></span><br><span class="line">kubectl get all,sa,cm,secret,roles -n ingress</span><br><span class="line">kc describe clusterroles ingress-nginx</span><br><span class="line">kubectl get pod,svc,ep -n ingress -o wide -l app.kubernetes.io/component=controller</span><br><span class="line"></span><br><span class="line"><span class="comment"># 버전 정보 확인</span></span><br><span class="line">POD_NAMESPACE=ingress</span><br><span class="line">POD_NAME=$(kubectl get pods -n <span class="variable">$POD_NAMESPACE</span> -l app.kubernetes.io/name=ingress-nginx --field-selector=status.phase=Running -o name)</span><br><span class="line">kubectl <span class="built_in">exec</span> <span class="variable">$POD_NAME</span> -n <span class="variable">$POD_NAMESPACE</span> -- /nginx-ingress-controller --version</span><br></pre></td></tr></table></figure>









<h1 id="인그레스-Ingress-실습-및-통신-흐름-확인"><a href="#인그레스-Ingress-실습-및-통신-흐름-확인" class="headerlink" title="인그레스(Ingress) 실습 및 통신 흐름 확인"></a>인그레스(Ingress) 실습 및 통신 흐름 확인</h1><ul>
<li>컨트롤플레인 노드에 인그레스 컨트롤러(Nginx) 파드를 생성, NodePort 로 외부에 노출</li>
<li>인그레스 정책 설정 : Host&#x2F;Path routing, 실습의 편리를 위해서 도메인 없이 IP로 접속 설정 가능</li>
</ul>
<p><img src="/blog/img/ingress-12.png"></p>
<p><img src="/blog/img/ingress-13.png"></p>
<h2 id="디플로이먼트와-서비스를-생성"><a href="#디플로이먼트와-서비스를-생성" class="headerlink" title="디플로이먼트와 서비스를 생성"></a>디플로이먼트와 서비스를 생성</h2><p>svc1-pod.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deploy1-websrv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">websrv</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">websrv</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-web</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc1-web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">websrv</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure>

<p>svc2-pod.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deploy2-guestsrv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">guestsrv</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">guestsrv</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-guest</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">gcr.io/google-samples/kubernetes-bootcamp:v1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc2-guest</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">guest-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9002</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">guestsrv</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure>

<p>svc3-pod.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deploy3-adminsrv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">adminsrv</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">adminsrv</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-admin</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">k8s.gcr.io/echoserver:1.5</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc3-admin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">admin-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9003</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">adminsrv</span></span><br></pre></td></tr></table></figure>

<p>생성</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 생성</span></span><br><span class="line">kubectl taint nodes k3s-s role=controlplane:NoSchedule</span><br><span class="line">kubectl apply -f svc1-pod.yaml,svc2-pod.yaml,svc3-pod.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인 : svc1, svc3 은 ClusterIP 로 클러스터 외부에서는 접속할 수 없다 &gt;&gt; Ingress 는 연결 가능!</span></span><br><span class="line">kubectl get pod,svc,ep</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/ingress-14.png"></p>
<h2 id="인그레스-정책-생성-링크"><a href="#인그레스-정책-생성-링크" class="headerlink" title="인그레스(정책) 생성 - 링크"></a>인그레스(정책) 생성 - <a target="_blank" rel="noopener" href="https://kubetm.github.io/k8s/08-intermediate-controller/ingress/">링크</a></h2><p><img src="/blog/img/ingress-15.png"></p>
<p>ingress1</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOT&gt;</span> <span class="string">ingress1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-1</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment">#nginx.ingress.kubernetes.io/upstream-hash-by: &quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc1-web</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/guest</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc2-guest</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/admin</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc3-admin</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line"><span class="string">EOT</span></span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 모니터링</span></span><br><span class="line">watch -d <span class="string">&#x27;kubectl get ingress,svc,ep,pod -owide&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 생성</span></span><br><span class="line">kubectl apply -f ingress1.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인</span></span><br><span class="line">kubectl get ingress</span><br><span class="line">kc describe ingress ingress-1</span><br><span class="line">...</span><br><span class="line">Rules:</span><br><span class="line">  Host        Path  Backends</span><br><span class="line">  ----        ----  --------</span><br><span class="line">  *           </span><br><span class="line">              /        svc1-web:80 ()</span><br><span class="line">              /guest   svc2-guest:8080 ()</span><br><span class="line">              /admin   svc3-admin:8080 ()</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 설정이 반영된 nginx conf 파일 확인</span></span><br><span class="line">kubectl <span class="built_in">exec</span> deploy/ingress-nginx-controller -n ingress -it -- <span class="built_in">cat</span> /etc/nginx/nginx.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/ingress-16.png"></p>
<h2 id="인그레스를-통한-내부-접속"><a href="#인그레스를-통한-내부-접속" class="headerlink" title="인그레스를 통한 내부 접속"></a>인그레스를 통한 내부 접속</h2><ul>
<li>Nginx 인그레스 컨트롤러를 통한 접속(HTTP 인입) 경로 : 인그레스 컨트롤러 파드에서 서비스 파드의 IP로 직접 연결</li>
</ul>
<p><img src="/blog/img/ingress-17.png"></p>
<p>인그레스(Nginx 인그레스 컨트롤러)를 통한 접속(HTTP 인입) 확인</p>
<ul>
<li><strong>HTTP 부하분산 &amp; PATH 기반 라우팅, 애플리케이션 파드에 연결된 서비스는 Bypass</strong></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl get ingress</span><br><span class="line">NAME        CLASS   HOSTS   ADDRESS        PORTS   AGE</span><br><span class="line">ingress-1   nginx   *       10.10.200.24   80      3m44s</span><br><span class="line"> </span><br><span class="line">kubectl describe ingress ingress-1 | sed -n <span class="string">&quot;5, \$p&quot;</span></span><br><span class="line">Rules:</span><br><span class="line">  Host        Path   Backends</span><br><span class="line">  ----        ----   --------</span><br><span class="line">  *           /      svc1-web:80 ()</span><br><span class="line">              /guest svc2-guest:8080 ()</span><br><span class="line">              /admin svc3-admin:8080 ()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 접속 로그 확인 : kubetail 설치되어 있음 - 출력되는 nginx 의 로그의 IP 확인</span></span><br><span class="line">kubetail -n ingress -l app.kubernetes.io/component=controller</span><br><span class="line"></span><br><span class="line">-------------------------------</span><br><span class="line"><span class="comment"># 자신의 집 PC에서 인그레스를 통한 접속 : 각각 </span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Ingress1 sv1-web URL = http://<span class="subst">$(curl -s ipinfo.io/ip)</span>:30080&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Ingress1 sv2-guest URL = http://<span class="subst">$(curl -s ipinfo.io/ip)</span>:30080/guest&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Ingress1 sv3-admin URL = http://<span class="subst">$(curl -s ipinfo.io/ip)</span>:30080/admin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># svc1-web 접속</span></span><br><span class="line">MYIP=&lt;EC2 공인 IP&gt;</span><br><span class="line">MYIP=13.124.93.150</span><br><span class="line">curl -s <span class="variable">$MYIP</span>:30080</span><br><span class="line"></span><br><span class="line"><span class="comment"># svvc2-guest 접속</span></span><br><span class="line">curl -s <span class="variable">$MYIP</span>:30080/guest</span><br><span class="line">curl -s <span class="variable">$MYIP</span>:30080/guest</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;; <span class="keyword">do</span> curl -s <span class="variable">$MYIP</span>:30080/guest ; <span class="keyword">done</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br><span class="line"></span><br><span class="line"><span class="comment"># svc3-admin 접속 &gt; 기본적으로 Nginx 는 라운드로빈 부하분산 알고리즘을 사용 &gt;&gt; Client_address 와 XFF 주소는 어떤 주소인가요?</span></span><br><span class="line">curl -s <span class="variable">$MYIP</span>:30080/admin</span><br><span class="line">curl -s <span class="variable">$MYIP</span>:30080/admin | egrep <span class="string">&#x27;(client_address|x-forwarded-for)&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;; <span class="keyword">do</span> curl -s <span class="variable">$MYIP</span>:30080/admin | grep Hostname ; <span class="keyword">done</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (옵션) 디플로이먼트의 파드 갯수를 증가/감소 설정 후 접속 테스트 해보자</span></span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/ingress-18.png"></p>
<p>노드에서 아래 패킷 캡처 확인 : flannel vxlan, 파드 간 통신 시 IP 정보 확인</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">ngrep -tW byline -d ens5 <span class="string">&#x27;&#x27;</span> udp port 8472 or tcp port 80</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">tcpdump -i ens5 udp port 8472 -nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># vethY는 각자 k3s-s 의 가장 마지막 veth 를 지정</span></span><br><span class="line">tcpdump -i vethY tcp port 8080 -nn</span><br><span class="line">tcpdump -i vethY tcp port 8080 -w /tmp/ingress-nginx.pcap</span><br><span class="line"></span><br><span class="line"><span class="comment"># 자신의 PC에서 k3s-s EC2 공인 IP로 pcap 다운로드</span></span><br><span class="line">scp ubuntu@&lt;k3s-s EC2 공인 IP&gt;:/tmp/ingress-nginx.pcap ~/Downloads</span><br><span class="line">scp ubuntu@52.78.155.19:/tmp/ingress-nginx.pcap ~/Downloads</span><br></pre></td></tr></table></figure>







<h2 id="Nginx-분산-알고리즘-변경"><a href="#Nginx-분산-알고리즘-변경" class="headerlink" title="Nginx 분산 알고리즘 변경"></a>Nginx 분산 알고리즘 변경</h2><ul>
<li>nginx 는 기본 RR 라운드 로빈 이지만, IP-Hash 나 Session Cookie 설정으로 대상 유지 가능 - <a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#load-balance">링크</a></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">  <span class="attr">nginx.ingress.kubernetes.io/upstream-hash-by:</span> <span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>

<p>확인</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mypc</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;; <span class="keyword">do</span> curl -s <span class="variable">$MYIP</span>:30080/admin | grep Hostname ; <span class="keyword">done</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> curl -s --connect-timeout 1 <span class="variable">$MYIP</span>:30080/admin | grep Hostname ; <span class="built_in">date</span> <span class="string">&quot;+%Y-%m-%d %H:%M:%S&quot;</span> ; <span class="built_in">echo</span> <span class="string">&quot;--------------&quot;</span> ; <span class="built_in">sleep</span> 1; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 아래 ingress 설정 중 IP-Hash 설정 &gt; # 주석 제거</span></span><br><span class="line">sed -i <span class="string">&#x27;s/#nginx.ingress/nginx.ingress/g&#x27;</span> ingress1.yaml</span><br><span class="line">kubectl apply -f ingress1.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 접속 확인</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;; <span class="keyword">do</span> curl -s <span class="variable">$MYIP</span>:30080/admin | grep Hostname ; <span class="keyword">done</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> curl -s --connect-timeout 1 <span class="variable">$MYIP</span>:30080/admin | grep Hostname ; <span class="built_in">date</span> <span class="string">&quot;+%Y-%m-%d %H:%M:%S&quot;</span> ; <span class="built_in">echo</span> <span class="string">&quot;--------------&quot;</span> ; <span class="built_in">sleep</span> 1; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 다시 원복(라운드 로빈) &gt; # 주석 추가</span></span><br><span class="line">sed -i <span class="string">&#x27;s/nginx.ingress/#nginx.ingress/g&#x27;</span> ingress1.yaml</span><br><span class="line">kubectl apply -f ingress1.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 접속 확인</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;; <span class="keyword">do</span> curl -s <span class="variable">$MYIP</span>:30080/admin | grep Hostname ; <span class="keyword">done</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> curl -s --connect-timeout 1 <span class="variable">$MYIP</span>:30080/admin | grep Hostname ; <span class="built_in">date</span> <span class="string">&quot;+%Y-%m-%d %H:%M:%S&quot;</span> ; <span class="built_in">echo</span> <span class="string">&quot;--------------&quot;</span> ; <span class="built_in">sleep</span> 1; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>삭제</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete deployments,svc,ingress --all</span><br></pre></td></tr></table></figure>





<h2 id="AWS-Ingress-ALB-모드"><a href="#AWS-Ingress-ALB-모드" class="headerlink" title="AWS Ingress (ALB) 모드"></a>AWS Ingress (ALB) 모드</h2><ul>
<li>인스턴스 모드 : AWS ALB(Ingress)로 인입 후 각 워커노드의 NodePort 로 전달 후 IPtables 룰(SEP)에 따라 파드로 분배</li>
</ul>
<p><img src="/blog/img/ingress-19.png"></p>
<ul>
<li>IP 모드 : nginx ingress controller 동작과 유사하게 AWS LoadBalancer Controller 파드가 kube api 를 통해서 파드의 IP를 제공받아서 AWS ALB 에 타켓(파드 IP)를 설정</li>
</ul>
<p><img src="/blog/img/ingress-20.png"></p>
<h2 id="Host-기반-라우팅"><a href="#Host-기반-라우팅" class="headerlink" title="Host 기반 라우팅"></a>Host 기반 라우팅</h2><p><img src="/blog/img/ingress-21.png"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOT&gt;</span> <span class="string">ingress2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">kans.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc3-admin</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">&quot;*.kans.com&quot;</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/echo</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc3-admin</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line"><span class="string">EOT</span></span><br></pre></td></tr></table></figure>

<p>생성</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 터미널1</span></span><br><span class="line">watch -d <span class="string">&#x27;kubectl get ingresses,svc,ep,pod -owide&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 도메인 변경</span></span><br><span class="line">MYDOMAIN1=staek.com</span><br><span class="line">sed -i <span class="string">&quot;s/kans.com/<span class="variable">$MYDOMAIN1</span>/g&quot;</span> ingress2.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 생성</span></span><br><span class="line">kubectl apply -f ingress2.yaml,svc3-pod.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인</span></span><br><span class="line">kubectl get ingress</span><br><span class="line">kubectl describe ingress ingress-2</span><br><span class="line"></span><br><span class="line">kubectl describe ingress ingress-2 | sed -n <span class="string">&quot;5, \$p&quot;</span></span><br><span class="line">Ingress Class:    nginx</span><br><span class="line">Default backend:  &lt;default&gt;</span><br><span class="line">Rules:</span><br><span class="line">  Host         Path  Backends</span><br><span class="line">  ----         ----  --------</span><br><span class="line">  staek.com</span><br><span class="line">               /   svc3-admin:8080 ()</span><br><span class="line">  *.staek.com</span><br><span class="line">               /echo   svc3-admin:8080 ()</span><br><span class="line">Annotations:   &lt;none&gt;</span><br><span class="line">Events:        &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h4 id="인그레스-Nginx-인그레스-컨트롤러-를-통한-접속-HTTP-인입-확인"><a href="#인그레스-Nginx-인그레스-컨트롤러-를-통한-접속-HTTP-인입-확인" class="headerlink" title="인그레스(Nginx 인그레스 컨트롤러)를 통한 접속(HTTP 인입) 확인"></a>인그레스(Nginx 인그레스 컨트롤러)를 통한 접속(HTTP 인입) 확인</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 로그 모니터링</span></span><br><span class="line"><span class="string">kubetail</span> <span class="string">-n</span> <span class="string">ingress</span> <span class="string">-l</span> <span class="string">app.kubernetes.io/component=controller</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (옵션) ingress nginx 파드 vethY 에서 패킷 캡처 후 확인 해 볼 것</span></span><br><span class="line"></span><br><span class="line"><span class="string">------------</span></span><br><span class="line"><span class="comment"># 자신의 PC 에서 접속 테스트</span></span><br><span class="line"><span class="comment"># svc3-admin 접속 &gt; 결과 확인 : 왜 접속이 되지 않는가? HTTP 헤더에 Host 필드를 잘 확인해보자!</span></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYIP:30080</span> <span class="string">-v</span></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYIP:30080/echo</span> <span class="string">-v</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mypc에서 접속을 위한 설정</span></span><br><span class="line"><span class="comment">## /etc/hosts 수정 : 도메인 이름으로 접속하기 위해서 변수 지정</span></span><br><span class="line"><span class="comment">## 윈도우 C:\Windows\System32\drivers\etc\hosts</span></span><br><span class="line"><span class="comment">## 맥 sudo vim /etc/hosts</span></span><br><span class="line"><span class="string">MYDOMAIN1=&lt;각자</span> <span class="string">자신의</span> <span class="string">닉네임의</span> <span class="string">도메인&gt;</span></span><br><span class="line"><span class="string">MYDOMAIN2=&lt;test.각자</span> <span class="string">자신의</span> <span class="string">닉네임의</span> <span class="string">도메인&gt;</span></span><br><span class="line"><span class="string">MYDOMAIN1=staek.com</span></span><br><span class="line"><span class="string">MYDOMAIN2=test.staek.com</span></span><br><span class="line"><span class="string">echo</span> <span class="string">$MYIP</span> <span class="string">$MYDOMAIN1</span> <span class="string">$MYDOMAIN2</span></span><br><span class="line"></span><br><span class="line"><span class="string">echo</span> <span class="string">&quot;$MYIP $MYDOMAIN1&quot;</span> <span class="string">|</span> <span class="string">sudo</span> <span class="string">tee</span> <span class="string">-a</span> <span class="string">/etc/hosts</span></span><br><span class="line"><span class="string">echo</span> <span class="string">&quot;$MYIP $MYDOMAIN2&quot;</span> <span class="string">|</span> <span class="string">sudo</span> <span class="string">tee</span> <span class="string">-a</span> <span class="string">/etc/hosts</span></span><br><span class="line"><span class="string">cat</span> <span class="string">/etc/hosts</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">$MYDOMAIN1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># svc3-admin 접속 &gt; 결과 확인</span></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYDOMAIN1:30080</span> <span class="string">-v</span></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYDOMAIN1:30080/admin</span></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYDOMAIN1:30080/echo</span></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYDOMAIN1:30080/echo/1</span></span><br><span class="line"></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYDOMAIN2:30080</span> <span class="string">-v</span></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYDOMAIN2:30080/admin</span></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYDOMAIN2:30080/echo</span></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYDOMAIN2:30080/echo/1</span></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYDOMAIN2:30080/echo/1/2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## (옵션) /etc/hosts 파일 변경 없이 접속 방안</span></span><br><span class="line"><span class="string">curl</span> <span class="string">-H</span> <span class="string">&quot;host: $MYDOMAIN1&quot;</span> <span class="string">$MYIP:30080</span></span><br></pre></td></tr></table></figure>





<h2 id="카나리-업그레이드"><a href="#카나리-업그레이드" class="headerlink" title="카나리 업그레이드"></a>카나리 업그레이드</h2><p>canary-svc1-pod.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dp-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">svc-v1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">svc-v1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-v1</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">k8s.gcr.io/echoserver:1.5</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">svc-v1</span></span><br></pre></td></tr></table></figure>

<p>canary-svc2-pod.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dp-v2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">svc-v2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">svc-v2</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-v2</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">k8s.gcr.io/echoserver:1.6</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-v2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">svc-v2</span></span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 터미널1</span></span><br><span class="line"><span class="string">watch</span> <span class="string">-d</span> <span class="string">&#x27;kubectl get ingress,svc,ep,pod -owide&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 생성</span></span><br><span class="line"><span class="string">curl</span> <span class="string">-s</span> <span class="string">-O</span> <span class="string">https://raw.githubusercontent.com/gasida/NDKS/main/7/canary-svc1-pod.yaml</span></span><br><span class="line"><span class="string">curl</span> <span class="string">-s</span> <span class="string">-O</span> <span class="string">https://raw.githubusercontent.com/gasida/NDKS/main/7/canary-svc2-pod.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">canary-svc1-pod.yaml,canary-svc2-pod.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">svc,ep,pod</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 버전 확인: 1.13.0 vs 1.13.1</span></span><br><span class="line"><span class="string">for</span> <span class="string">pod</span> <span class="string">in</span> <span class="string">$(kubectl</span> <span class="string">get</span> <span class="string">pod</span> <span class="string">-o</span> <span class="string">wide</span> <span class="string">-l</span> <span class="string">app=svc-v1</span> <span class="string">|awk</span> <span class="string">&#x27;NR&gt;1 &#123;print $6&#125;&#x27;</span><span class="string">);</span> <span class="string">do</span> <span class="string">curl</span> <span class="string">-s</span> <span class="string">$pod:8080</span> <span class="string">|</span> <span class="string">egrep</span> <span class="string">&#x27;(Hostname|nginx)&#x27;</span><span class="string">;</span> <span class="string">done</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Hostname:</span> <span class="string">dp-v1-8684d45558-9kb59</span></span><br><span class="line">	<span class="string">server_version=nginx:</span> <span class="attr">1.13.0 - lua:</span> <span class="number">10008</span></span><br><span class="line"><span class="attr">Hostname:</span> <span class="string">dp-v1-8684d45558-drwzf</span></span><br><span class="line">	<span class="string">server_version=nginx:</span> <span class="attr">1.13.0 - lua:</span> <span class="number">10008</span></span><br><span class="line"><span class="attr">Hostname:</span> <span class="string">dp-v1-8684d45558-hzcth</span></span><br><span class="line">	<span class="string">server_version=nginx:</span> <span class="attr">1.13.0 - lua:</span> <span class="number">10008</span></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"><span class="string">for</span> <span class="string">pod</span> <span class="string">in</span> <span class="string">$(kubectl</span> <span class="string">get</span> <span class="string">pod</span> <span class="string">-o</span> <span class="string">wide</span> <span class="string">-l</span> <span class="string">app=svc-v2</span> <span class="string">|awk</span> <span class="string">&#x27;NR&gt;1 &#123;print $6&#125;&#x27;</span><span class="string">);</span> <span class="string">do</span> <span class="string">curl</span> <span class="string">-s</span> <span class="string">$pod:8080</span> <span class="string">|</span> <span class="string">egrep</span> <span class="string">&#x27;(Hostname|nginx)&#x27;</span><span class="string">;</span> <span class="string">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">Hostname:</span> <span class="string">dp-v2-7757c4bdc-b8bkt</span></span><br><span class="line">	<span class="string">server_version=nginx:</span> <span class="attr">1.13.1 - lua:</span> <span class="number">10008</span></span><br><span class="line"><span class="attr">Hostname:</span> <span class="string">dp-v2-7757c4bdc-ggx8l</span></span><br><span class="line">	<span class="string">server_version=nginx:</span> <span class="attr">1.13.1 - lua:</span> <span class="number">10008</span></span><br><span class="line"><span class="attr">Hostname:</span> <span class="string">dp-v2-7757c4bdc-zfxfc</span></span><br><span class="line">	<span class="string">server_version=nginx:</span> <span class="attr">1.13.1 - lua:</span> <span class="number">10008</span></span><br><span class="line">	</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/ingress-22.png"></p>
<p>canary-ingress1.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOT&gt;</span> <span class="string">canary-ingress1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-canary-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">kans.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc-v1</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line"><span class="string">EOT</span></span><br></pre></td></tr></table></figure>

<p>canary-ingress2.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOT&gt;</span> <span class="string">canary-ingress2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-canary-v2</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/canary:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/canary-weight:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">kans.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc-v2</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line"><span class="string">EOT</span></span><br></pre></td></tr></table></figure>







<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 터미널1</span></span><br><span class="line"><span class="string">watch</span> <span class="string">-d</span> <span class="string">&#x27;kubectl get ingress,svc,ep&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 도메인 변경</span></span><br><span class="line"><span class="string">MYDOMAIN1=staek.com</span></span><br><span class="line"><span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/kans.com/$MYDOMAIN1/g&quot;</span> <span class="string">canary-ingress1.yaml</span></span><br><span class="line"><span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/kans.com/$MYDOMAIN1/g&quot;</span> <span class="string">canary-ingress2.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 생성</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">canary-ingress1.yaml,canary-ingress2.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 로그 모니터링</span></span><br><span class="line"><span class="string">kubetail</span> <span class="string">-n</span> <span class="string">ingress</span> <span class="string">-l</span> <span class="string">app.kubernetes.io/component=controller</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 접속 테스트</span></span><br><span class="line"><span class="string">curl</span> <span class="string">-s</span> <span class="string">$MYDOMAIN1:30080</span></span><br><span class="line"><span class="string">curl</span> <span class="string">-s</span> <span class="string">$MYDOMAIN1:30080</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 접속 시 v1 v2 버전별 비율이 어떻게 되나요? 왜 이렇게 되나요?</span></span><br><span class="line"><span class="string">for</span> <span class="string">i</span> <span class="string">in</span> &#123;<span class="number">1</span><span class="string">..100</span>&#125;<span class="string">;</span>  <span class="string">do</span> <span class="string">curl</span> <span class="string">-s</span> <span class="string">$MYDOMAIN1:30080</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">nginx</span> <span class="string">;</span> <span class="string">done</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">|</span> <span class="string">uniq</span> <span class="string">-c</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">-nr</span></span><br><span class="line"><span class="string">for</span> <span class="string">i</span> <span class="string">in</span> &#123;<span class="number">1</span><span class="string">..1000</span>&#125;<span class="string">;</span> <span class="string">do</span> <span class="string">curl</span> <span class="string">-s</span> <span class="string">$MYDOMAIN1:30080</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">nginx</span> <span class="string">;</span> <span class="string">done</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">|</span> <span class="string">uniq</span> <span class="string">-c</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">-nr</span></span><br><span class="line"><span class="string">while</span> <span class="literal">true</span><span class="string">;</span> <span class="string">do</span> <span class="string">curl</span> <span class="string">-s</span> <span class="string">--connect-timeout</span> <span class="number">1</span> <span class="string">$MYDOMAIN1:30080</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">Hostname</span> <span class="string">;</span> <span class="string">echo</span> <span class="string">&quot;--------------&quot;</span> <span class="string">;</span> <span class="string">date</span> <span class="string">&quot;+%Y-%m-%d %H:%M:%S&quot;</span> <span class="string">;</span> <span class="string">sleep</span> <span class="number">1</span><span class="string">;</span> <span class="string">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 비율 조정 &gt;&gt; 개발 배포 버전 전략에 유용하다!</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">annotate</span> <span class="string">--overwrite</span> <span class="string">ingress</span> <span class="string">ingress-canary-v2</span> <span class="string">nginx.ingress.kubernetes.io/canary-weight=50</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 접속 테스트</span></span><br><span class="line"><span class="string">for</span> <span class="string">i</span> <span class="string">in</span> &#123;<span class="number">1</span><span class="string">..100</span>&#125;<span class="string">;</span>  <span class="string">do</span> <span class="string">curl</span> <span class="string">-s</span> <span class="string">$MYDOMAIN1:30080</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">nginx</span> <span class="string">;</span> <span class="string">done</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">|</span> <span class="string">uniq</span> <span class="string">-c</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">-nr</span></span><br><span class="line"><span class="string">for</span> <span class="string">i</span> <span class="string">in</span> &#123;<span class="number">1</span><span class="string">..1000</span>&#125;<span class="string">;</span> <span class="string">do</span> <span class="string">curl</span> <span class="string">-s</span> <span class="string">$MYDOMAIN1:30080</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">nginx</span> <span class="string">;</span> <span class="string">done</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">|</span> <span class="string">uniq</span> <span class="string">-c</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">-nr</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (옵션) 비율 조정 &lt;&lt; 어떻게 비율이 조정될까요?</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">annotate</span> <span class="string">--overwrite</span> <span class="string">ingress</span> <span class="string">ingress-canary-v2</span> <span class="string">nginx.ingress.kubernetes.io/canary-weight=100</span></span><br><span class="line"><span class="string">for</span> <span class="string">i</span> <span class="string">in</span> &#123;<span class="number">1</span><span class="string">..100</span>&#125;<span class="string">;</span>  <span class="string">do</span> <span class="string">curl</span> <span class="string">-s</span> <span class="string">$MYDOMAIN1:30080</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">nginx</span> <span class="string">;</span> <span class="string">done</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">|</span> <span class="string">uniq</span> <span class="string">-c</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">-nr</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (옵션) 비율 조정 &lt;&lt; 어떻게 비율이 조정될까요?</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">annotate</span> <span class="string">--overwrite</span> <span class="string">ingress</span> <span class="string">ingress-canary-v2</span> <span class="string">nginx.ingress.kubernetes.io/canary-weight=0</span></span><br><span class="line"><span class="string">for</span> <span class="string">i</span> <span class="string">in</span> &#123;<span class="number">1</span><span class="string">..100</span>&#125;<span class="string">;</span>  <span class="string">do</span> <span class="string">curl</span> <span class="string">-s</span> <span class="string">$MYDOMAIN1:30080</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">nginx</span> <span class="string">;</span> <span class="string">done</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">|</span> <span class="string">uniq</span> <span class="string">-c</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">-nr</span></span><br></pre></td></tr></table></figure>



<p>아래와 같이 기본 비율과 <code>canary-weight=50</code> 비율 차이를 보자.</p>
<p><img src="/blog/img/ingress-23.png"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl annotate --overwrite ingress ingress-canary-v2 nginx.ingress.kubernetes.io/canary-weight=50</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/ingress-24.png"></p>
<p>삭제</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete deployments,svc,ingress --all</span><br></pre></td></tr></table></figure>





<h2 id="HTTPS-처리-TLS-종료-링크"><a href="#HTTPS-처리-TLS-종료-링크" class="headerlink" title="HTTPS 처리 (TLS 종료) - 링크"></a>HTTPS 처리 (TLS 종료) - <a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/examples/tls-termination/">링크</a></h2><p><img src="/blog/img/ingress-25.png"></p>
<p>svc-pod.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-https</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">https</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s.gcr.io/echoserver:1.6</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-https</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<p>ssl-termination-ingress.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOT&gt;</span> <span class="string">ssl-termination-ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kans.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">secret-https</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">kans.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc-https</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line"><span class="string">EOT</span></span><br></pre></td></tr></table></figure>





<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 서비스와 파드 생성</span></span><br><span class="line">curl -s -O https://raw.githubusercontent.com/gasida/NDKS/main/7/svc-pod.yaml</span><br><span class="line">kubectl apply -f svc-pod.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 도메인 변경</span></span><br><span class="line">MYDOMAIN1=&lt;각자 자신의 닉네임의 도메인&gt; 예시) gasida.com</span><br><span class="line">MYDOMAIN1=kans.com</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$MYDOMAIN1</span></span><br><span class="line">sed -i <span class="string">&quot;s/kans.com/<span class="variable">$MYDOMAIN1</span>/g&quot;</span> ssl-termination-ingress.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 인그레스 생성</span></span><br><span class="line">kubectl apply -f ssl-termination-ingress.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 인증서 생성</span></span><br><span class="line"><span class="comment"># openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj &quot;/CN=dkos.com/O=dkos.com&quot;mkdir key &amp;&amp; cd key</span></span><br><span class="line">MYDOMAIN1=kans.com</span><br><span class="line">openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj <span class="string">&quot;/CN=<span class="variable">$MYDOMAIN1</span>/O=<span class="variable">$MYDOMAIN1</span>&quot;</span></span><br><span class="line">tree</span><br><span class="line"></span><br><span class="line"><span class="comment"># Secret 생성</span></span><br><span class="line">kubectl create secret tls secret-https --key tls.key --cert tls.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># Secret 확인 </span></span><br><span class="line">kubectl get secrets secret-https</span><br><span class="line">kubectl get secrets secret-https -o yaml</span><br><span class="line"></span><br><span class="line">-------------------</span><br><span class="line"><span class="comment"># 자신의 PC 에서 접속 확인 : PC 웹브라우저</span></span><br><span class="line"><span class="comment"># 접속 확인 : -k 는 https 접속 시 : 접속 포트 정보 확인</span></span><br><span class="line">curl -Lk https://<span class="variable">$MYDOMAIN1</span>:30443</span><br><span class="line"></span><br><span class="line"><span class="comment">## (옵션) /etc/hosts 파일 변경 없이 접속 방안</span></span><br><span class="line">curl -Lk -H <span class="string">&quot;host: <span class="variable">$MYDOMAIN1</span>&quot;</span> https://<span class="variable">$MYDOMAIN1</span>:30443</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/ingress-26.png"></p>
<p><img src="/blog/img/ingress-27.png"></p>
<p>Nginx SSL Termination 패킷 확인 : 중간 172.16.29.11 이 nginx controller</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 패킷 캡처 명령어 참고</span></span><br><span class="line"><span class="built_in">export</span> IngHttp=$(kubectl get service -n ingress-nginx ingress-nginx-controller -o jsonpath=<span class="string">&#x27;&#123;.spec.ports[0].nodePort&#125;&#x27;</span>)</span><br><span class="line"><span class="built_in">export</span> IngHttps=$(kubectl get service -n ingress-nginx ingress-nginx-controller -o jsonpath=<span class="string">&#x27;&#123;.spec.ports[1].nodePort&#125;&#x27;</span>)</span><br><span class="line">tcpdump -i &lt;nginx 파드 veth&gt; -nnq tcp port 80 or tcp port 443 or tcp port 8080 or tcp port <span class="variable">$IngHttp</span> or tcp port <span class="variable">$IngHttps</span></span><br><span class="line">tcpdump -i &lt;nginx 파드 veth&gt; -nn  tcp port 80 or tcp port 443 or tcp port 8080 or tcp port <span class="variable">$IngHttp</span> or tcp port <span class="variable">$IngHttps</span> -w /tmp/ingress.pcap</span><br></pre></td></tr></table></figure>



<p>삭제</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod,svc,ingress --all</span><br><span class="line">helm uninstall -n ingress ingress-nginx</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CloudFormation 스택 삭제</span></span><br><span class="line">aws cloudformation delete-stack --stack-name mylab</span><br><span class="line"></span><br><span class="line"><span class="comment"># [모니터링] CloudFormation 스택 상태 : 삭제 확인</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> </span><br><span class="line">  <span class="built_in">date</span></span><br><span class="line">  AWS_PAGER=<span class="string">&quot;&quot;</span> aws cloudformation list-stacks \</span><br><span class="line">    --stack-status-filter CREATE_IN_PROGRESS CREATE_COMPLETE CREATE_FAILED DELETE_IN_PROGRESS DELETE_FAILED \</span><br><span class="line">    --query <span class="string">&quot;StackSummaries[*].&#123;StackName:StackName, StackStatus:StackStatus&#125;&quot;</span> \</span><br><span class="line">    --output table</span><br><span class="line">  <span class="built_in">sleep</span> 1</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

























































</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-12-01T01:00:35.000Z" title="2024. 12. 1. 오전 10:00:35">2024-12-01</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-12-01T13:47:29.064Z" title="2024. 12. 1. 오후 10:47:29">2024-12-01</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/gateway-gloo/">gateway/gloo</a></span><span class="level-item">16 minutes read (About 2338 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/12/01/docs/gateway/gloo/">gloo</a></h1><div class="content"><p><strong>Install KinD Cluster</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">**<span class="built_in">cat</span> &lt;&lt;<span class="string">EOT&gt; kind-1node.yaml**</span></span><br><span class="line"><span class="string">kind: Cluster</span></span><br><span class="line"><span class="string">apiVersion: kind.x-k8s.io/v1alpha4</span></span><br><span class="line"><span class="string">nodes:</span></span><br><span class="line"><span class="string">- role: **control-plane**</span></span><br><span class="line"><span class="string">  extraPortMappings:</span></span><br><span class="line"><span class="string">  - containerPort: 30000</span></span><br><span class="line"><span class="string">    hostPort: 30000</span></span><br><span class="line"><span class="string">  - containerPort: 30001</span></span><br><span class="line"><span class="string">    hostPort: 30001</span></span><br><span class="line"><span class="string">  - containerPort: 30002</span></span><br><span class="line"><span class="string">    hostPort: 30002</span></span><br><span class="line"><span class="string">**EOT</span>**</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install KinD Cluster</span></span><br><span class="line">kind create cluster --image **kindest/node:v1.30.0** --config **kind-1node.yaml** --name **myk8s**</span><br><span class="line"></span><br><span class="line"><span class="comment"># 노드에 기본 툴 설치</span></span><br><span class="line">docker <span class="built_in">exec</span> -it **myk8s-control-plane sh -c <span class="string">&#x27;**apt update &amp;&amp; apt install tree psmisc lsof wget bsdmainutils bridge-utils net-tools dnsutils tcpdump ngrep iputils-ping **git vim** -y&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 노드/파드 확인</span></span><br><span class="line">kubectl get nodes -o wide</span><br><span class="line">kubectl get pod -A</span><br></pre></td></tr></table></figure>

<p><strong>Install Gateway API CRDs</strong> : The Kubernetes Gateway API abstractions are expressed using Kubernetes CRDs.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CRDs 설치 및 확인</span></span><br><span class="line">**kubectl apply -f &lt;https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.0.0/standard-install.yaml**&gt;</span><br><span class="line">kubectl get crd</span><br></pre></td></tr></table></figure>

<p><strong>Install Glooctl Utility</strong> : GLOOCTL is a command-line utility that allows users to view, manage, and debug Gloo Gateway deployments - <a target="_blank" rel="noopener" href="https://docs.solo.io/gloo-edge/latest/installation/glooctl_setup/">Link</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># [신규 터미널] 아래 bash 진입 후 glooctl 툴 사용</span></span><br><span class="line">**docker <span class="built_in">exec</span> -it myk8s-control-plane bash**</span><br><span class="line">----------------------------------------</span><br><span class="line"><span class="comment"># Install Glooctl Utility</span></span><br><span class="line"><span class="comment">## glooctl install gateway     # install gloo&#x27;s function gateway functionality into the &#x27;gloo-system&#x27; namespace</span></span><br><span class="line"><span class="comment">## glooctl install ingress     # install very basic Kubernetes Ingress support with Gloo into namespace gloo-system</span></span><br><span class="line"><span class="comment">## glooctl install knative     # install Knative serving with Gloo configured as the default cluster ingress</span></span><br><span class="line"><span class="comment">## curl -sL &lt;https://run.solo.io/gloo/install&gt; | sh</span></span><br><span class="line">**curl -sL &lt;https://run.solo.io/gloo/install&gt; | GLOO_VERSION=v1.17.7 sh**</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$HOME</span>/.gloo/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 버전 확인</span></span><br><span class="line">**glooctl version**</span><br><span class="line"></span><br><span class="line">----------------------------------------</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;client&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: <span class="string">&quot;1.17.7&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;kubernetesCluster&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;major&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;minor&quot;</span>: <span class="string">&quot;30&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gitVersion&quot;</span>: <span class="string">&quot;v1.30.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;buildDate&quot;</span>: <span class="string">&quot;2024-05-13T22:02:25Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;platform&quot;</span>: <span class="string">&quot;linux/arm64&quot;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>gloo 설치 </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># [신규 터미널] 모니터링</span></span><br><span class="line">watch -d kubectl get pod,svc,endpointslices,ep -n gloo-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install Gloo Gateway</span></span><br><span class="line"><span class="comment">## --set kubeGateway.enabled=true: Kubernetes Gateway 기능을 활성화합니다.</span></span><br><span class="line"><span class="comment">## --set gloo.disableLeaderElection=true: Gloo의 리더 선출 기능을 비활성화합니다. (단일 인스턴스에서 Gloo를 실행 시 유용)</span></span><br><span class="line"><span class="comment">## --set discovery.enabled=false: 서비스 디스커버리 기능을 비활성화합니다.</span></span><br><span class="line">helm repo add gloo https://storage.googleapis.com/solo-public-helm</span><br><span class="line">helm repo update</span><br><span class="line">helm install -n gloo-system gloo-gateway gloo/gloo \</span><br><span class="line">--create-namespace \</span><br><span class="line">--version 1.17.7 \</span><br><span class="line">--<span class="built_in">set</span> kubeGateway.enabled=<span class="literal">true</span> \</span><br><span class="line">--<span class="built_in">set</span> gloo.disableLeaderElection=<span class="literal">true</span> \</span><br><span class="line">--<span class="built_in">set</span> discovery.enabled=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Confirm that the Gloo control plane has successfully been deployed using this command</span></span><br><span class="line">kubectl rollout status deployment/gloo -n gloo-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 설치 확인</span></span><br><span class="line">kubectl get crd | grep <span class="string">&#x27;networking.k8s.io&#x27;</span></span><br><span class="line">kubectl get crd | grep -v <span class="string">&#x27;networking.k8s.io&#x27;</span></span><br><span class="line">kubectl get pod,svc,endpointslices -n gloo-system</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl explain gatewayclasses</span><br><span class="line">kubectl get gatewayclasses</span><br><span class="line">NAME           CONTROLLER             ACCEPTED   AGE</span><br><span class="line">gloo-gateway   solo.io/gloo-gateway   True       21m</span><br><span class="line"></span><br><span class="line">kubectl get gatewayclasses -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">items:</span><br><span class="line">- apiVersion: gateway.networking.k8s.io/v1</span><br><span class="line">  kind: GatewayClass</span><br><span class="line">  metadata:</span><br><span class="line">    labels:</span><br><span class="line">      app: gloo</span><br><span class="line">    name: gloo-gateway</span><br><span class="line">  spec:</span><br><span class="line">    controllerName: solo.io/gloo-gateway</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/gateway-03.png"></p>
<p>접속확인</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">watch -d kubectl get pod,svc,endpointslices,ep -n httpbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install Httpbin Application</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/solo-io/solo-blog/main/gateway-api-tutorial/01-httpbin-svc.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 설치 확인</span></span><br><span class="line">kubectl get deploy,pod,svc,endpointslices,sa -n httpbin</span><br><span class="line">kubectl rollout status deploy/httpbin -n httpbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># (옵션) NodePort 설정</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl apply -f -</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: httpbin</span></span><br><span class="line"><span class="string">    service: httpbin</span></span><br><span class="line"><span class="string">  name: httpbin</span></span><br><span class="line"><span class="string">  namespace: httpbin</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  type: NodePort</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">  - name: http</span></span><br><span class="line"><span class="string">    port: 8000</span></span><br><span class="line"><span class="string">    targetPort: 80</span></span><br><span class="line"><span class="string">    nodePort: 30000</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: httpbin</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (옵션) 로컬 접속 확인</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;httpbin web - http://localhost:30000&quot;</span>     <span class="comment"># macOS 사용자</span></span><br><span class="line"></span><br><span class="line">httpbin web - http://localhost:30000</span><br></pre></td></tr></table></figure>



<h3 id="Configure-a-Gateway-Listener"><a href="#Configure-a-Gateway-Listener" class="headerlink" title="Configure a Gateway Listener"></a>Configure a Gateway Listener</h3><ul>
<li>Let’s begin by establishing a Gateway resource that sets up an HTTP listener on port 8080 to expose routes from all our namespaces. Gateway custom resources like this are part of the Gateway API standard.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 02-gateway.yaml</span></span><br><span class="line">kind: Gateway</span><br><span class="line">apiVersion: gateway.networking.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: http</span><br><span class="line">spec:</span><br><span class="line">  gatewayClassName: gloo-gateway</span><br><span class="line">  listeners:</span><br><span class="line">  - protocol: HTTP</span><br><span class="line">    port: 8080</span><br><span class="line">    name: http</span><br><span class="line">    allowedRoutes:</span><br><span class="line">      namespaces:</span><br><span class="line">        from: All</span><br><span class="line"></span><br><span class="line"><span class="comment"># gateway 리소스 생성</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/02-gateway.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인 : Now we can confirm that the Gateway has been activated</span></span><br><span class="line">kubectl get gateway -n gloo-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># You can also confirm that Gloo Gateway has spun up an Envoy proxy instance in response to the creation of this Gateway object by deploying gloo-proxy-http:</span></span><br><span class="line">kubectl get deployment gloo-proxy-http -n gloo-system</span><br><span class="line">NAME              READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">gloo-proxy-http   1/1     1            1           5m22s</span><br><span class="line"></span><br><span class="line"><span class="comment"># envoy 사용 확인</span></span><br><span class="line">kubectl get pod -n gloo-system</span><br><span class="line">kubectl describe pod -n gloo-system  |grep Image:</span><br><span class="line">    Image:         quay.io/solo-io/gloo-envoy-wrapper:1.17.7</span><br><span class="line">    Image:          quay.io/solo-io/gloo:1.17.7</span><br><span class="line">    Image:         quay.io/solo-io/gloo-envoy-wrapper:1.17.7</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># gloo-proxy-http 서비스는 External-IP는 Pending 상태</span></span><br><span class="line">kubectl get svc -n gloo-system gloo-proxy-http</span><br><span class="line">NAME              TYPE           CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">gloo-proxy-http   LoadBalancer   10.96.71.22   &lt;pending&gt;     8080:31555/TCP   2m4s</span><br><span class="line"></span><br><span class="line"><span class="comment"># gloo-proxy-http NodePort 30001 설정</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl apply -f -</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app.kubernetes.io/instance: http</span></span><br><span class="line"><span class="string">    app.kubernetes.io/managed-by: Helm</span></span><br><span class="line"><span class="string">    app.kubernetes.io/name: gloo-proxy-http</span></span><br><span class="line"><span class="string">    app.kubernetes.io/version: 1.17.7</span></span><br><span class="line"><span class="string">    gateway.networking.k8s.io/gateway-name: http</span></span><br><span class="line"><span class="string">    gloo: kube-gateway</span></span><br><span class="line"><span class="string">    helm.sh/chart: gloo-gateway-1.17.7</span></span><br><span class="line"><span class="string">  name: gloo-proxy-http</span></span><br><span class="line"><span class="string">  namespace: gloo-system</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">  - name: http</span></span><br><span class="line"><span class="string">    nodePort: 30001</span></span><br><span class="line"><span class="string">    port: 8080</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app.kubernetes.io/instance: http</span></span><br><span class="line"><span class="string">    app.kubernetes.io/name: gloo-proxy-http</span></span><br><span class="line"><span class="string">    gateway.networking.k8s.io/gateway-name: http</span></span><br><span class="line"><span class="string">  type: LoadBalancer</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">kubectl get svc -n gloo-system gloo-proxy-http</span><br><span class="line"></span><br><span class="line">NAME              TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">gloo-proxy-http   LoadBalancer   10.96.227.35   &lt;pending&gt;     8080:30001/TCP   51s</span><br></pre></td></tr></table></figure>







<h4 id="Configure-Simple-Routing-with-an-HTTPRoute"><a href="#Configure-Simple-Routing-with-an-HTTPRoute" class="headerlink" title="Configure Simple Routing with an HTTPRoute"></a>Configure Simple Routing with an HTTPRoute</h4><p><img src="/blog/img/gateway-04.png"></p>
<p><code>HTTPRoute</code> is one of the new Kubernetes CRDs introduced by the Gateway API, as documented <a target="_blank" rel="noopener" href="https://gateway-api.sigs.k8s.io/api-types/httproute/">here</a>. We’ll start by introducing a simple HTTPRoute for our service.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">gateway.networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HTTPRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">httpbin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">httpbin</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">example:</span> <span class="string">httpbin-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">parentRefs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">gloo-system</span></span><br><span class="line">  <span class="attr">hostnames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;api.example.com&quot;</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">matches:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Exact</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">/get</span></span><br><span class="line">    <span class="attr">backendRefs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">httpbin</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8000</span></span><br></pre></td></tr></table></figure>

<p>This example attaches to the default Gateway object created for us when we installed Gloo Gateway earlier.<br>See the gloo-system&#x2F;http reference in the parentRefs stanza. </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Our route watches for HTTP requests directed at the host api.example.com with the request path /get and then forwards the request to the httpbin service on port 8000.</span></span><br><span class="line"><span class="comment"># Let’s establish this route now:</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/03-httpbin-route.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl get httproute -n httpbin</span><br><span class="line">NAME      HOSTNAMES             AGE</span><br><span class="line">httpbin   [<span class="string">&quot;api.example.com&quot;</span>]   3m15s</span><br><span class="line"></span><br><span class="line">kubectl describe httproute -n httpbin</span><br></pre></td></tr></table></figure>



<h4 id="Test-the-Simple-Route-with-Curl"><a href="#Test-the-Simple-Route-with-Curl" class="headerlink" title="Test the Simple Route with Curl"></a>Test the Simple Route with Curl</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># let’s use curl to display the response with the -i option to additionally show the HTTP response code and headers.</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;127.0.0.1 api.example.com&quot;</span> | sudo <span class="built_in">tee</span> -a /etc/hosts</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;httproute - http://api.example.com:30001/get&quot;</span> <span class="comment"># 웹브라우저</span></span><br><span class="line">혹은</span><br><span class="line">curl -is -H <span class="string">&quot;Host: api.example.com&quot;</span> http://localhost:8080/get <span class="comment"># kubectl port-forward 사용 시</span></span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/gateway-05.png"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 호출 응답 왜 그럴까?</span></span><br><span class="line">curl -is -H <span class="string">&quot;Host: api.example.com&quot;</span> http://localhost:8080/delay/1</span><br><span class="line">HTTP/1.1 404 Not Found</span><br><span class="line"><span class="built_in">date</span>: Wed, 03 Jul 2024 07:19:21 GMT</span><br><span class="line">server: envoy</span><br><span class="line">content-length: 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># nodeport 직접 접속</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;httproute - http://api.example.com:30000/delay/1&quot;</span> <span class="comment"># 1초 후 응답</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;httproute - http://api.example.com:30000/delay/5&quot;</span> <span class="comment"># 5초 후 응답</span></span><br></pre></td></tr></table></figure>





<p><img src="/blog/img/gateway-06.png"></p>
<h3 id="정규식-패턴-매칭-Explore-Routing-with-Regex-Matching-Patterns"><a href="#정규식-패턴-매칭-Explore-Routing-with-Regex-Matching-Patterns" class="headerlink" title="[정규식 패턴 매칭] Explore Routing with Regex Matching Patterns"></a>[정규식 패턴 매칭] Explore Routing with Regex Matching Patterns</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;httproute - http://api.example.com:30001/api/httpbin/get&quot;</span> <span class="comment"># 웹브라우저</span></span><br><span class="line">혹은</span><br><span class="line">curl -is -H <span class="string">&quot;Host: api.example.com&quot;</span> http://localhost:8080/api/httpbin/get <span class="comment"># kubectl port-forward 사용 시</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">server: envoy</span><br><span class="line"><span class="built_in">date</span>: Sun, 06 Oct 2024 08:08:09 GMT</span><br><span class="line">content-type: application/json</span><br><span class="line">content-length: 289</span><br><span class="line">access-control-allow-origin: *</span><br><span class="line">access-control-allow-credentials: <span class="literal">true</span></span><br><span class="line">x-envoy-upstream-service-time: 18  <span class="comment"># envoy 가 업스트림 httpbin 요청 처리에 걸리 시간 0.018초</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;args&quot;</span>: &#123;&#125;, </span><br><span class="line">  <span class="string">&quot;headers&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;Host&quot;</span>: <span class="string">&quot;api.example.com&quot;</span>, </span><br><span class="line">    <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;curl/8.7.1&quot;</span>, </span><br><span class="line">    <span class="string">&quot;X-Envoy-Expected-Rq-Timeout-Ms&quot;</span>: <span class="string">&quot;15000&quot;</span>, </span><br><span class="line">    <span class="string">&quot;X-Envoy-Original-Path&quot;</span>: <span class="string">&quot;/api/httpbin/get&quot;</span></span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="string">&quot;origin&quot;</span>: <span class="string">&quot;10.244.0.11&quot;</span>, </span><br><span class="line">  <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://api.example.com/get&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 아래 NodePort 와 GW API 통한 접속 비교</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;httproute - http://api.example.com:30001/api/httpbin/get&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;httproute - http://api.example.com:30000/api/httpbin/get&quot;</span> <span class="comment"># NodePort 직접 접근</span></span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/gateway-07.png"></p>
<p><img src="/blog/img/gateway-08.png"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;httproute - http://api.example.com:30001/api/httpbin/delay/1&quot;</span> <span class="comment"># 웹브라우저</span></span><br><span class="line">혹은</span><br><span class="line">curl -is -H <span class="string">&quot;Host: api.example.com&quot;</span> http://localhost:8080/api/httpbin/delay/1 <span class="comment"># kubectl port-forward 사용 시</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">server: envoy</span><br><span class="line"><span class="built_in">date</span>: Wed, 03 Jul 2024 07:31:47 GMT</span><br><span class="line">content-type: application/json</span><br><span class="line">content-length: 342</span><br><span class="line">access-control-allow-origin: *</span><br><span class="line">access-control-allow-credentials: <span class="literal">true</span></span><br><span class="line">x-envoy-upstream-service-time: 1023   <span class="comment"># envoy 가 업스트림 httpbin 요청 처리에 걸리 시간 1초 이상</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;args&quot;</span>: &#123;&#125;, </span><br><span class="line">  <span class="string">&quot;data&quot;</span>: <span class="string">&quot;&quot;</span>, </span><br><span class="line">  <span class="string">&quot;files&quot;</span>: &#123;&#125;, </span><br><span class="line">  <span class="string">&quot;form&quot;</span>: &#123;&#125;, </span><br><span class="line">  <span class="string">&quot;headers&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;Host&quot;</span>: <span class="string">&quot;api.example.com&quot;</span>, </span><br><span class="line">    <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;curl/8.6.0&quot;</span>, </span><br><span class="line">    <span class="string">&quot;X-Envoy-Expected-Rq-Timeout-Ms&quot;</span>: <span class="string">&quot;15000&quot;</span>, </span><br><span class="line">    <span class="string">&quot;X-Envoy-Original-Path&quot;</span>: <span class="string">&quot;/api/httpbin/delay/1&quot;</span></span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="string">&quot;origin&quot;</span>: <span class="string">&quot;10.244.0.7&quot;</span>, </span><br><span class="line">  <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://api.example.com/delay/1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="/blog/img/gateway-09.png"></p>
<p><img src="/blog/img/gateway-10.png"></p>
<h3 id="업스트림-베어러-토큰을-사용한-변환-Test-Transformations-with-Upstream-Bearer-Tokens"><a href="#업스트림-베어러-토큰을-사용한-변환-Test-Transformations-with-Upstream-Bearer-Tokens" class="headerlink" title="[업스트림 베어러 토큰을 사용한 변환] Test Transformations with Upstream Bearer Tokens"></a>[업스트림 베어러 토큰을 사용한 변환] Test Transformations with Upstream Bearer Tokens</h3><ul>
<li>목적 : 요청을 라우팅하는 백엔드 시스템 중 하나에서 인증해야 하는 요구 사항이 있는 경우는 어떻게 할까요? 이 업스트림 시스템에는 권한 부여를 위한 API 키가 필요하고, 이를 소비하는 클라이언트에 직접 노출하고 싶지 않다고 가정해 보겠습니다. 즉, 프록시 계층에서 요청에 주입할 간단한 베어러 토큰을 구성하고 싶습니다. (정적 API 키 토큰을 직접 주입)</li>
</ul>
<p>설치</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/05-httpbin-rewrite-xform.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl describe httproute -n httpbin</span><br><span class="line">...</span><br><span class="line">Spec:</span><br><span class="line">  ...</span><br><span class="line">  Rules:</span><br><span class="line">    Backend Refs:</span><br><span class="line">      Group:   </span><br><span class="line">      Kind:    Service</span><br><span class="line">      Name:    httpbin</span><br><span class="line">      Port:    8000</span><br><span class="line">      Weight:  1</span><br><span class="line">    Filters:</span><br><span class="line">      Type:  URLRewrite</span><br><span class="line">      URL Rewrite:</span><br><span class="line">        Path:</span><br><span class="line">          Replace Prefix Match:  /</span><br><span class="line">          Type:                  ReplacePrefixMatch</span><br><span class="line">      Request Header Modifier:</span><br><span class="line">        Add:</span><br><span class="line">          Name:   Authorization</span><br><span class="line">          Value:  Bearer my-api-key</span><br><span class="line">      Type:       RequestHeaderModifier</span><br><span class="line">    Matches:</span><br><span class="line">      Path:</span><br><span class="line">        Type:   PathPrefix</span><br><span class="line">        Value:  /api/httpbin/</span><br></pre></td></tr></table></figure>

<p>테스트</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;httproute - http://api.example.com:30001/api/httpbin/get&quot;</span> <span class="comment"># 웹브라우저</span></span><br><span class="line">혹은</span><br><span class="line">curl -is -H <span class="string">&quot;Host: api.example.com&quot;</span> http://localhost:8080/api/httpbin/get <span class="comment"># kubectl port-forward 사용 시</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">server: envoy</span><br><span class="line"><span class="built_in">date</span>: Sun, 06 Oct 2024 08:20:00 GMT</span><br><span class="line">content-type: application/json</span><br><span class="line">content-length: 332</span><br><span class="line">access-control-allow-origin: *</span><br><span class="line">access-control-allow-credentials: <span class="literal">true</span></span><br><span class="line">x-envoy-upstream-service-time: 11</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;args&quot;</span>: &#123;&#125;, </span><br><span class="line">  <span class="string">&quot;headers&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;Authorization&quot;</span>: <span class="string">&quot;Bearer my-api-key&quot;</span>, </span><br><span class="line">    <span class="string">&quot;Host&quot;</span>: <span class="string">&quot;api.example.com&quot;</span>, </span><br><span class="line">    <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;curl/8.7.1&quot;</span>, </span><br><span class="line">    <span class="string">&quot;X-Envoy-Expected-Rq-Timeout-Ms&quot;</span>: <span class="string">&quot;15000&quot;</span>, </span><br><span class="line">    <span class="string">&quot;X-Envoy-Original-Path&quot;</span>: <span class="string">&quot;/api/httpbin/get&quot;</span></span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="string">&quot;origin&quot;</span>: <span class="string">&quot;10.244.0.11&quot;</span>, </span><br><span class="line">  <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://api.example.com/get&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/gateway-11.png"></p>
<h3 id="Migrate"><a href="#Migrate" class="headerlink" title="Migrate"></a>Migrate</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># You should see the response below, indicating deployments for both v1 and v2 of my-workload have been created in the my-workload namespace.</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/06-workload-svcs.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># v1,v2 2가지 버전 워크로드 확인</span></span><br><span class="line">kubectl get deploy,pod,svc,endpointslices -n my-workload</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/gateway-12.png"></p>
<p>Test Simple V1 Routing</p>
<p><img src="/blog/img/gateway-13.png"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">gateway.networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HTTPRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-workload</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">my-workload</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">example:</span> <span class="string">my-workload-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">parentRefs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">gloo-system</span></span><br><span class="line">  <span class="attr">hostnames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;api.example.com&quot;</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">matches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">PathPrefix</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/api/my-workload</span></span><br><span class="line">      <span class="attr">backendRefs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-workload-v1</span></span><br><span class="line">          <span class="attr">namespace:</span> <span class="string">my-workload</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<p>HTTPRoute 설치</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/07-workload-route.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl get httproute -A</span><br><span class="line">NAMESPACE     NAME          HOSTNAMES             AGE</span><br><span class="line">httpbin       httpbin       [<span class="string">&quot;api.example.com&quot;</span>]   41m</span><br><span class="line">my-workload   my-workload   [<span class="string">&quot;api.example.com&quot;</span>]   39s</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl describe httproute -n my-workload</span><br><span class="line">...</span><br><span class="line">Spec:</span><br><span class="line">  Hostnames:</span><br><span class="line">    api.example.com</span><br><span class="line">  Parent Refs:</span><br><span class="line">    Group:      gateway.networking.k8s.io</span><br><span class="line">    Kind:       Gateway</span><br><span class="line">    Name:       http</span><br><span class="line">    Namespace:  gloo-system</span><br><span class="line">  Rules:</span><br><span class="line">    Backend Refs:</span><br><span class="line">      Group:      </span><br><span class="line">      Kind:       Service</span><br><span class="line">      Name:       my-workload-v1</span><br><span class="line">      Namespace:  my-workload</span><br><span class="line">      Port:       8080</span><br><span class="line">      Weight:     1</span><br><span class="line">    Matches:</span><br><span class="line">      Path:</span><br><span class="line">        Type:   PathPrefix</span><br><span class="line">        Value:  /api/my-workload</span><br></pre></td></tr></table></figure>

<p>workload-v1 에만 접속됨을 확인</p>
<p><img src="/blog/img/gateway-14.png"></p>
<h3 id="Simulate-a-v2-Dark-Launch-with-Header-Based-Routing"><a href="#Simulate-a-v2-Dark-Launch-with-Header-Based-Routing" class="headerlink" title="Simulate a v2 Dark Launch with Header-Based Routing"></a>Simulate a v2 Dark Launch with Header-Based Routing</h3><p>Dark Launch : 일부 사용자에게 새로운 기능을 출시하여 피드백을 수집하고 잠재적으로 더 큰 사용자 커뮤니티를 방해하기 전에 개선 사항을 실험하는 훌륭한 클라우드 마이그레이션 기술</p>
<p><img src="/blog/img/gateway-16.png"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">rules:</span><br><span class="line">  - matches:</span><br><span class="line">    - path:</span><br><span class="line">        <span class="built_in">type</span>: PathPrefix</span><br><span class="line">        value: /api/my-workload</span><br><span class="line">      <span class="comment"># Add a matcher to route requests with a v2 version header to v2</span></span><br><span class="line">      <span class="comment"># version=v2 헤더값이 있는 사용자만 v2 라우팅</span></span><br><span class="line">      headers:</span><br><span class="line">      - name: version</span><br><span class="line">        value: v2</span><br><span class="line">    backendRefs:</span><br><span class="line">      - name: my-workload-v2</span><br><span class="line">        namespace: my-workload</span><br><span class="line">        port: 8080      </span><br><span class="line">  - matches:</span><br><span class="line">    <span class="comment"># Route requests without the version header to v1 as before</span></span><br><span class="line">    <span class="comment"># 대다수 일반 사용자는 기존 처럼 v1 라우팅</span></span><br><span class="line">    - path:</span><br><span class="line">        <span class="built_in">type</span>: PathPrefix</span><br><span class="line">        value: /api/my-workload</span><br><span class="line">    backendRefs:</span><br><span class="line">      - name: my-workload-v1</span><br><span class="line">        namespace: my-workload</span><br><span class="line">        port: 8080</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/08-workload-route-header.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">kubectl describe httproute -n my-workload</span><br><span class="line">...</span><br><span class="line">Spec:</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/gateway-17.png"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Now we’ll test the original route, with no special headers supplied, and confirm that traffic still goes to v1:</span></span><br><span class="line">curl -is -H <span class="string">&quot;Host: api.example.com&quot;</span> http://localhost:8080/api/my-workload</span><br><span class="line">curl -is -H <span class="string">&quot;Host: api.example.com&quot;</span> http://localhost:8080/api/my-workload | grep body</span><br><span class="line"><span class="string">&quot;body&quot;</span>: <span class="string">&quot;Hello From My Workload (v1)!&quot;</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment"># But it we supply the version: v2 header, note that our gateway routes the request to v2 as expected:</span></span><br><span class="line">curl -is -H <span class="string">&quot;Host: api.example.com&quot;</span> -H <span class="string">&quot;version: v2&quot;</span> http://localhost:8080/api/my-workload</span><br><span class="line">curl -is -H <span class="string">&quot;Host: api.example.com&quot;</span> -H <span class="string">&quot;version: v2&quot;</span> http://localhost:8080/api/my-workload | grep body</span><br></pre></td></tr></table></figure>

<ul>
<li>헤더에 <code>version: v1</code> 혹은 <code>version: v2</code> 를 작성하면 해당하는 팟에 접근됨</li>
</ul>
<p><img src="/blog/img/gateway-18.png"></p>
<h3 id="Expand-V2-Testing-with-Percentage-Based-Routing"><a href="#Expand-V2-Testing-with-Percentage-Based-Routing" class="headerlink" title="Expand V2 Testing with Percentage-Based Routing"></a>Expand V2 Testing with Percentage-Based Routing</h3><p>성공적인 다크 런칭 이후, 우리는 점진적으로 이전 버전에서 새 버전으로 사용자 트래픽을 옮기는 블루-그린 전략을 사용하는 기간을 원할 수 있습니다. 트래픽을 균등하게 분할하고 트래픽의 절반을 로 보내고 v1나머지 절반을 로 보내는 라우팅 정책으로 이를 살펴보겠습니다 v2.</p>
<p><img src="/blog/img/gateway-15.png"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Apply this 50-50 routing policy with kubectl:</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/09-workload-route-split.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl describe httproute -n my-workload</span><br><span class="line">...</span><br><span class="line">  rules:</span><br><span class="line">    - matches:</span><br><span class="line">      - path:</span><br><span class="line">          <span class="built_in">type</span>: PathPrefix</span><br><span class="line">          value: /api/my-workload</span><br><span class="line">      <span class="comment"># Configure a 50-50 traffic split across v1 and v2 : 버전 1,2 50:50 비율</span></span><br><span class="line">      backendRefs:</span><br><span class="line">        - name: my-workload-v1</span><br><span class="line">          namespace: my-workload</span><br><span class="line">          port: 8080</span><br><span class="line">          weight: 50</span><br><span class="line">        - name: my-workload-v2</span><br><span class="line">          namespace: my-workload</span><br><span class="line">          port: 8080</span><br><span class="line">          weight: 50</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;; <span class="keyword">do</span> curl -s -H <span class="string">&quot;Host: api.example.com&quot;</span> http://localhost:8080/api/my-workload/ | grep body; <span class="keyword">done</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br></pre></td></tr></table></figure>

<ul>
<li>트래픽 에 따라 my-workload-v1, my-workload-v2에 번갈아 접속됨</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-11-24T13:07:30.000Z" title="2024. 11. 24. 오후 10:07:30">2024-11-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-11-24T14:34:52.889Z" title="2024. 11. 24. 오후 11:34:52">2024-11-24</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/k8s-flannel/">k8s/flannel</a></span><span class="level-item">11 minutes read (About 1639 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/11/24/docs/flannel/">Flannel CNI Concept</a></h1><div class="content"><p>Flannel은 단일 바이너리 에이전트인 flanneld 가 각 노드에서 동작하여 작은 규모의 클러스터 환경에서</p>
<p>파드들 간 통신 환경을 구성하는 CNI이다.</p>
<p>Flannel은 노드간 통신에 VXLAN을 사용하며, UDP 8472 port를 사용한다.</p>
<h3 id="kind-amp-Flannel-배포"><a href="#kind-amp-Flannel-배포" class="headerlink" title="kind &amp; Flannel 배포"></a>kind &amp; Flannel 배포</h3><ul>
<li><code>disableDefaultCNI : true</code> 기본 CNI를 사용하지 않는다.</li>
<li>control-plane, worker node 2ea</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF&gt; kind-cni.yaml</span></span><br><span class="line"><span class="string">kind: Cluster</span></span><br><span class="line"><span class="string">apiVersion: kind.x-k8s.io/v1alpha4</span></span><br><span class="line"><span class="string">nodes:</span></span><br><span class="line"><span class="string">- role: control-plane</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    mynode: control-plane</span></span><br><span class="line"><span class="string">  extraPortMappings:</span></span><br><span class="line"><span class="string">  - containerPort: 30000</span></span><br><span class="line"><span class="string">    hostPort: 30000</span></span><br><span class="line"><span class="string">  - containerPort: 30001</span></span><br><span class="line"><span class="string">    hostPort: 30001</span></span><br><span class="line"><span class="string">  - containerPort: 30002</span></span><br><span class="line"><span class="string">    hostPort: 30002</span></span><br><span class="line"><span class="string">  kubeadmConfigPatches:</span></span><br><span class="line"><span class="string">  - |</span></span><br><span class="line"><span class="string">    kind: ClusterConfiguration</span></span><br><span class="line"><span class="string">    controllerManager:</span></span><br><span class="line"><span class="string">      extraArgs:</span></span><br><span class="line"><span class="string">        bind-address: 0.0.0.0</span></span><br><span class="line"><span class="string">    etcd:</span></span><br><span class="line"><span class="string">      local:</span></span><br><span class="line"><span class="string">        extraArgs:</span></span><br><span class="line"><span class="string">          listen-metrics-urls: http://0.0.0.0:2381</span></span><br><span class="line"><span class="string">    scheduler:</span></span><br><span class="line"><span class="string">      extraArgs:</span></span><br><span class="line"><span class="string">        bind-address: 0.0.0.0</span></span><br><span class="line"><span class="string">  - |</span></span><br><span class="line"><span class="string">    kind: KubeProxyConfiguration</span></span><br><span class="line"><span class="string">    metricsBindAddress: 0.0.0.0</span></span><br><span class="line"><span class="string">- role: worker</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    mynode: worker</span></span><br><span class="line"><span class="string">- role: worker</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    mynode: worker2</span></span><br><span class="line"><span class="string">networking:</span></span><br><span class="line"><span class="string">  disableDefaultCNI: true</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">kind create cluster --config kind-cni.yaml --name myk8s --image kindest/node:v1.30.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 배포 확인</span></span><br><span class="line">kind get clusters</span><br><span class="line">kind get nodes --name myk8s</span><br><span class="line">kubectl cluster-info</span><br><span class="line"></span><br><span class="line"><span class="comment"># 네트워크 확인</span></span><br><span class="line">kubectl cluster-info dump | grep -m 2 -E <span class="string">&quot;cluster-cidr|service-cluster-ip-range&quot;</span></span><br><span class="line">-----------------------</span><br><span class="line"><span class="string">&quot;--service-cluster-ip-range=10.96.0.0/16&quot;</span>, <span class="comment"># service ip 대역</span></span><br><span class="line"><span class="string">&quot;--cluster-cidr=10.244.0.0/16&quot;</span>, <span class="comment"># </span></span><br><span class="line">                            </span><br><span class="line">                            </span><br><span class="line"><span class="comment"># 노드 확인 : CRI</span></span><br><span class="line">kubectl get nodes -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 노드 라벨 확인</span></span><br><span class="line">kubectl get nodes myk8s-control-plane -o jsonpath=&#123;.metadata.labels&#125; | jq</span><br><span class="line">...</span><br><span class="line"><span class="string">&quot;mynode&quot;</span>: <span class="string">&quot;control-plane&quot;</span>,</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">kubectl get nodes myk8s-worker -o jsonpath=&#123;.metadata.labels&#125; | jq</span><br><span class="line">kubectl get nodes myk8s-worker2 -o jsonpath=&#123;.metadata.labels&#125; | jq</span><br><span class="line"></span><br><span class="line"><span class="comment"># 컨테이너 확인 : 컨테이너 갯수, 컨테이너 이름 확인</span></span><br><span class="line">docker ps</span><br><span class="line">docker port myk8s-control-plane</span><br><span class="line">docker port myk8s-worker</span><br><span class="line">docker port myk8s-worker2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 컨테이너 내부 정보 확인</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane ip -br -c -4 addr</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker  ip -br -c -4 addr</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2  ip -br -c -4 addr</span><br><span class="line"></span><br><span class="line"><span class="comment"># tool install</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane sh -c <span class="string">&#x27;apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump iputils-ping htop git nano -y&#x27;</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker  sh -c <span class="string">&#x27;apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump iputils-ping -y&#x27;</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2 sh -c <span class="string">&#x27;apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump iputils-ping -y&#x27;</span></span><br></pre></td></tr></table></figure>





<ul>
<li>CNI 를 disable 했기 때문에 kindnet 이 없고, coredns, sc가 실행되지 못한다.</li>
</ul>
<p><img src="/blog/img/flannel-01.png"></p>
<p><code>kubectl describe pod -n kube-system -l k8s-app=kube-dns</code></p>
<p><img src="/blog/img/flannel-02.png"></p>
<ul>
<li>flannel net-config</li>
</ul>
<p><img src="/blog/img/flannel-03.png"></p>
<ul>
<li>flannel 을 설치했으나 bridge 플러그인이 &#x2F;opt&#x2F;cni&#x2F;bin 에 없어서 추가해 주어야 한다.</li>
</ul>
<p><img src="/blog/img/flannel-04.png"></p>
<p><img src="/blog/img/flannel-05.png"></p>
<ul>
<li>권한에 유의하여 복사한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> bridge myk8s-control-plane:/opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">cp</span> bridge myk8s-worker:/opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">cp</span> bridge myk8s-worker2:/opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane  <span class="built_in">chmod</span> 755 /opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker         <span class="built_in">chmod</span> 755 /opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2        <span class="built_in">chmod</span> 755 /opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane  <span class="built_in">chown</span> root root /opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker         <span class="built_in">chown</span> root root /opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2        <span class="built_in">chown</span> root root /opt/cni/bin/bridge</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane  <span class="built_in">ls</span> -l /opt/cni/bin/</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker  <span class="built_in">ls</span> -l /opt/cni/bin/</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2 <span class="built_in">ls</span> -l /opt/cni/bin/</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> myk8s-control-plane myk8s-worker myk8s-worker2; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it <span class="variable">$i</span> <span class="built_in">ls</span> /opt/cni/bin/; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line">bridge	flannel  host-local  loopback  portmap	ptp</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl get pod -A -owide</span><br></pre></td></tr></table></figure>



<p>kubelet, pstree 확인</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubelet config 정보</span></span><br><span class="line">kubectl describe cm -n kube-system kubelet-config</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane <span class="built_in">cat</span> /var/lib/kubelet/config.yaml</span><br><span class="line">...</span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.96.0.10</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane <span class="built_in">cat</span> /var/lib/kubelet/kubeadm-flags.env</span><br><span class="line">KUBELET_KUBEADM_ARGS=<span class="string">&quot;--container-runtime-endpoint=unix:///run/containerd/containerd.sock --node-ip=172.18.0.2 --node-labels= --pod-infra-container-image=registry.k8s.io/pause:3.9 --provider-id=kind://docker/myk8s/myk8s-control-plane&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> myk8s-control-plane myk8s-worker myk8s-worker2; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it <span class="variable">$i</span> <span class="built_in">cat</span> /var/lib/kubelet/kubeadm-flags.env; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> myk8s-control-plane myk8s-worker myk8s-worker2; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it <span class="variable">$i</span> <span class="built_in">ls</span> /etc/kubernetes/manifests; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line">&gt;&gt; node myk8s-control-plane &lt;&lt;</span><br><span class="line"><span class="string">etcd.yaml  kube-apiserver.yaml	kube-controller-manager.yaml  kube-scheduler.yaml</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt;&gt; node myk8s-worker &lt;&lt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt;&gt; node myk8s-worker2 &lt;&lt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">kubectl describe pod -n kube-system kube-apiserver-myk8s-control-plane</span></span><br><span class="line"><span class="string">kubectl describe pod -n kube-system kube-controller-manager-myk8s-control-plane</span></span><br><span class="line"><span class="string">kubectl describe pod -n kube-system kube-scheduler-myk8s-control-plane</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">for i in myk8s-control-plane myk8s-worker myk8s-worker2; do echo &quot;&gt;&gt; node $i &lt;&lt;&quot;; docker exec -it $i pstree -aT; echo; done</span></span><br><span class="line"><span class="string">for i in myk8s-control-plane myk8s-worker myk8s-worker2; do echo &quot;&gt;&gt; node $i &lt;&lt;&quot;; docker exec -it $i pstree -atl; echo; done</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">docker exec -it myk8s-control-plane  systemctl status kubelet -l --no-pager</span></span><br><span class="line"><span class="string">docker exec -it myk8s-worker  systemctl status kubelet -l --no-pager</span></span><br><span class="line"><span class="string">docker exec -it myk8s-worker2 systemctl status kubelet -l --no-pager</span></span><br></pre></td></tr></table></figure>





<h3 id="flannel-정보-확인"><a href="#flannel-정보-확인" class="headerlink" title="flannel 정보 확인"></a>flannel 정보 확인</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl get ds,pod,cm -n kube-flannel -owide</span><br><span class="line">kubectl describe cm -n kube-flannel kube-flannel-cfg</span><br><span class="line"></span><br><span class="line"><span class="comment"># iptables 정보 확인</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> filter nat mangle raw ; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; IPTables Type : <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it myk8s-control-plane  iptables -t <span class="variable">$i</span> -S ; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> filter nat mangle raw ; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; IPTables Type : <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it myk8s-worker  iptables -t <span class="variable">$i</span> -S ; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> filter nat mangle raw ; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; IPTables Type : <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it myk8s-worker2 iptables -t <span class="variable">$i</span> -S ; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>FLANNEL_MTU 1450</code> 1500byte 에서 vxlan header 50byte 제외</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> myk8s-control-plane myk8s-worker myk8s-worker2; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it <span class="variable">$i</span> <span class="built_in">cat</span> /run/flannel/subnet.env ; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">&gt;&gt; node myk8s-control-plane &lt;&lt;</span><br><span class="line"><span class="string">FLANNEL_NETWORK=10.244.0.0/16</span></span><br><span class="line"><span class="string">FLANNEL_SUBNET=10.244.0.1/24 # 파드 네트워크 대역 정의, CNI inet</span></span><br><span class="line"><span class="string">FLANNEL_MTU=1450</span></span><br><span class="line"><span class="string">FLANNEL_IPMASQ=true # 파드가 외부(인터넷) 통신 시 해당 노드의 마스커레이딩을 사용</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt;&gt; node myk8s-worker &lt;&lt;</span></span><br><span class="line"><span class="string">FLANNEL_NETWORK</span>=10.244.0.0/16</span><br><span class="line">FLANNEL_SUBNET=10.244.2.1/24</span><br><span class="line">FLANNEL_MTU=1450</span><br><span class="line">FLANNEL_IPMASQ=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">&gt;&gt; node myk8s-worker2 &lt;&lt;</span><br><span class="line"><span class="string">FLANNEL_NETWORK=10.244.0.0/16</span></span><br><span class="line"><span class="string">FLANNEL_SUBNET=10.244.1.1/24</span></span><br><span class="line"><span class="string">FLANNEL_MTU=1450</span></span><br><span class="line"><span class="string">FLANNEL_IPMASQ=true</span></span><br></pre></td></tr></table></figure>



<h3 id="테스트-pod-생성"><a href="#테스트-pod-생성" class="headerlink" title="테스트 pod 생성"></a>테스트 pod 생성</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl create -f -</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: pod-1</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  nodeSelector:</span></span><br><span class="line"><span class="string">    kubernetes.io/hostname: myk8s-worker</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: netshoot-pod</span></span><br><span class="line"><span class="string">    image: nicolaka/netshoot</span></span><br><span class="line"><span class="string">    command: [&quot;tail&quot;]</span></span><br><span class="line"><span class="string">    args: [&quot;-f&quot;, &quot;/dev/null&quot;]</span></span><br><span class="line"><span class="string">  terminationGracePeriodSeconds: 0</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: pod-2</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  nodeSelector:</span></span><br><span class="line"><span class="string">    kubernetes.io/hostname: myk8s-worker2</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: netshoot-pod</span></span><br><span class="line"><span class="string">    image: nicolaka/netshoot</span></span><br><span class="line"><span class="string">    command: [&quot;tail&quot;]</span></span><br><span class="line"><span class="string">    args: [&quot;-f&quot;, &quot;/dev/null&quot;]</span></span><br><span class="line"><span class="string">  terminationGracePeriodSeconds: 0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 확인 : IP 확인</span></span><br><span class="line">kubectl get pod -o wide</span><br></pre></td></tr></table></figure>



<ul>
<li><p>worker node 의 여러 네트워크 정보를 파악할 수 있다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ip -c -br addr</span><br><span class="line">ip -c route <span class="comment"># 다른 노드의 파드 대역(podCIDR)의 라우팅 정보</span></span><br><span class="line">ip -c neigh show dev flannel.1 <span class="comment"># flannel.1 인터페이스를 통한 ARP 테이블 정보 확인</span></span><br><span class="line">bridge fdb show dev flannel.1 <span class="comment"># 브리지 fdb 정보에서 해당 MAC 주소와 통신 시 각 노드의 en0 dst</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="/blog/img/flannel-06.png"></p>
<h3 id="bridge-cni-정보-확인"><a href="#bridge-cni-정보-확인" class="headerlink" title="bridge, cni 정보 확인"></a>bridge, cni 정보 확인</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># [터미널1,2] 워커 노드1,2</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker  bash</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2 bash</span><br><span class="line">-----------------------------</span><br><span class="line"><span class="comment"># 브리지 정보 확인</span></span><br><span class="line">brctl show cni0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 브리지 연결 링크(veth) 확인</span></span><br><span class="line">bridge <span class="built_in">link</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 브리지 VLAN 정보 확인</span></span><br><span class="line">bridge vlan</span><br><span class="line"></span><br><span class="line"><span class="comment"># cbr(custom bridge) 정보 : kubenet CNI의 bridge - 링크</span></span><br><span class="line">tree /var/lib/cni/networks/cbr0</span><br><span class="line">	/var/lib/cni/networks/cbr0</span><br><span class="line">	├── 10.244.2.4.</span><br><span class="line">	├── last_reserved_ip.0</span><br><span class="line">	└── lock</span><br><span class="line"></span><br><span class="line"><span class="comment"># 네트워크 관련 정보들 확인</span></span><br><span class="line">ip -c addr | grep veth -A3</span><br><span class="line">-----------------------------</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/flannel-07.png"></p>
<h2 id="패킷-캡처"><a href="#패킷-캡처" class="headerlink" title="패킷 캡처"></a>패킷 캡처</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i cni0 -nn icmp</span><br><span class="line">tcpdump -i flannel.1 -nn icmp</span><br><span class="line">tcpdump -i eth0 -nn icmp</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># [터미널1,2] 워커 노드1,2</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker  bash</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2 bash</span><br><span class="line">-----------------------------</span><br><span class="line"></span><br><span class="line">tcpdump -i eth0 -nn udp port 8472 -w /root/vxlan.pcap </span><br><span class="line"><span class="comment"># CTRL+C 취소 후 확인 : ls -l /root/vxlan.pcap</span></span><br><span class="line"></span><br><span class="line">conntrack -L | grep -i icmp</span><br><span class="line">-----------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment"># [터미널3]</span></span><br><span class="line"><span class="comment"># 패킷캡처 후 호스트로 파일 이동 및 wireshark를 통해 패킷을 쉽게 확인할 수 있다.</span></span><br><span class="line">docker <span class="built_in">cp</span> myk8s-worker:/root/vxlan.pcap .</span><br><span class="line">wireshark vxlan.pcap</span><br></pre></td></tr></table></figure>

<ul>
<li>패킷 캡처</li>
</ul>
<p><img src="/blog/img/flannel-08.png"></p>
<p><img src="/blog/img/flannel-09.png"></p>
<p><img src="/blog/img/flannel-10.png"></p>
<ul>
<li>SRC, DST IP 확인</li>
</ul>
<p><img src="/blog/img/flannel-11.png"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-11-24T09:01:30.000Z" title="2024. 11. 24. 오후 6:01:30">2024-11-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-11-24T14:34:54.422Z" title="2024. 11. 24. 오후 11:34:54">2024-11-24</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-overlaynetwork/">container/overlaynetwork</a></span><span class="level-item">9 minutes read (About 1384 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/11/24/docs/overlaynetwork/overlay-network/">overlay network concept</a></h1><div class="content"><ul>
<li>가상화 또는 클라우드 기반의 네트워크는 유연하게 확장이 되어야 한다. </li>
<li>관리하는 Subnet들이 많아지고 연결되어 있는 host의 수가 증가하면 포워딩, 스위칭, 라우팅 과 같은 네트워크 구성이 복잡해진다.</li>
<li>따라서 물리적인 네트워크망은 고려하지 않고 가상으로 host와 host의 연결만을 고려해서 구현한 기술이 바로 Network Overlay이다.</li>
</ul>
<h3 id="오버레이-네트워크-종류"><a href="#오버레이-네트워크-종류" class="headerlink" title="오버레이 네트워크 종류"></a>오버레이 네트워크 종류</h3><ul>
<li><strong>Virtual Extensible Local Area Network (VxLAN)</strong></li>
<li>Generic Routing Encapsulation (GRE)</li>
<li>IP Security (IPsec)</li>
<li>Multiprotocol Label Switching (MPLS)</li>
<li>Ethernet Virtual Private Network(EVPN)</li>
<li>Software-Defined WAN (SD-WAN)</li>
<li>Software-Defined Access (SD-Access)</li>
<li>Application Centric Infrastructure (ACI)</li>
<li>Cisco Virtual Topology System (VTS)</li>
</ul>
<h2 id="practice"><a href="#practice" class="headerlink" title="practice"></a>practice</h2><ul>
<li>hostA 내부 veth와 hostB 내부 veth간 ICMP 통신을 실습</li>
<li>hostA : 192.168.64.27, hostB: 192.168.64.28</li>
</ul>
<h3 id="hostA-설정"><a href="#hostA-설정" class="headerlink" title="hostA 설정"></a>hostA 설정</h3><ul>
<li>namsepace, bridge, VxLAN을 설정한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># red: VxLAN을 설정한 namespace</span></span><br><span class="line">ip netns add red</span><br><span class="line"><span class="comment"># blue: 실제 통신을 위한 가상 단말기</span></span><br><span class="line">ip netns add blue</span><br><span class="line"></span><br><span class="line"><span class="comment"># red와 blue의 veth peer를 구성</span></span><br><span class="line"><span class="comment"># mtu 1450으로 설정</span></span><br><span class="line">ip <span class="built_in">link</span> add dev red-veth mtu 1450 netns red <span class="built_in">type</span> veth peer name blue-veth mtu 1450 netns blue</span><br><span class="line"></span><br><span class="line"><span class="comment"># 실제통신 단말기의 ip와 mac을 설정</span></span><br><span class="line">ip netns <span class="built_in">exec</span> blue ip <span class="built_in">link</span> <span class="built_in">set</span> dev blue-veth address 02:42:c0:a8:00:02</span><br><span class="line">ip netns <span class="built_in">exec</span> blue ip addr add dev blue-veth 7.7.7.2/24</span><br><span class="line"></span><br><span class="line"><span class="comment"># red에 bridge device설정 및 ip 세팅</span></span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> add dev br0 <span class="built_in">type</span> bridge</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip addr add dev br0 7.7.7.1/24</span><br><span class="line"></span><br><span class="line"><span class="comment"># endpoint 식별을 위해 id 설정 (VNI)</span></span><br><span class="line"><span class="comment"># proxy옵션: arp 쿼리에 응답</span></span><br><span class="line"><span class="comment"># learning: bridge fdb entry 자동갱신 (수정설정할 필요 없음)</span></span><br><span class="line"><span class="comment"># dstport 4789: UDP port 터널링</span></span><br><span class="line">ip <span class="built_in">link</span> add dev vxlan1 netns red <span class="built_in">type</span> vxlan <span class="built_in">id</span> 42 proxy learning dstport 4789</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># red 내부에 VxLAN, peer veth 장비를 bridge와 연결한다.</span></span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> red-veth master br0</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> vxlan1 master br0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 모든 가상장치를 실행한다.</span></span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> br0 up</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> vxlan1 up</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> red-veth up</span><br><span class="line">ip netns <span class="built_in">exec</span> blue ip <span class="built_in">link</span> <span class="built_in">set</span> blue-veth up</span><br></pre></td></tr></table></figure>



<h3 id="hostB-설정"><a href="#hostB-설정" class="headerlink" title="hostB 설정"></a>hostB 설정</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ip netns add red</span><br><span class="line">ip netns add blue</span><br><span class="line"></span><br><span class="line">ip <span class="built_in">link</span> add dev red-veth mtu 1450 netns red <span class="built_in">type</span> veth peer name blue-veth mtu 1450 netns blue</span><br><span class="line"></span><br><span class="line">ip netns <span class="built_in">exec</span> blue ip <span class="built_in">link</span> <span class="built_in">set</span> dev blue-veth address 02:42:c0:a8:00:03</span><br><span class="line">ip netns <span class="built_in">exec</span> blue ip addr add dev blue-veth 7.7.7.3/24</span><br><span class="line"></span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> add dev br0 <span class="built_in">type</span> bridge</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip addr add dev br0 7.7.7.1/24</span><br><span class="line"></span><br><span class="line">ip <span class="built_in">link</span> add dev vxlan1 netns red <span class="built_in">type</span> vxlan <span class="built_in">id</span> 42 proxy learning dstport 4789</span><br><span class="line"></span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> red-veth master br0</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> vxlan1 master br0</span><br><span class="line"></span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> br0 up</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> vxlan1 up</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> red-veth up</span><br><span class="line">ip netns <span class="built_in">exec</span> blue ip <span class="built_in">link</span> <span class="built_in">set</span> blue-veth up</span><br></pre></td></tr></table></figure>



<h3 id="hostA-gt-blue"><a href="#hostA-gt-blue" class="headerlink" title="hostA &gt; blue"></a>hostA &gt; blue</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># nsenter --net=/var/run/netns/blue</span></span><br><span class="line">ping 7.7.7.3 <span class="comment"># 실패</span></span><br><span class="line"></span><br><span class="line">\<span class="comment"># ip neigh # arp에 등록이 안되어있음.</span></span><br><span class="line">7.7.7.3 dev blue-veth  FAILED</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># nsenter --net=/var/run/netns/red</span></span><br><span class="line">tcpdump -i br0 <span class="comment"># 로그 확인</span></span><br><span class="line">05:28:15.024947 ARP, Request who-has 7.7.7.3 tell 7.7.7.2, length 28 <span class="comment"># arp 요청만 한다.</span></span><br></pre></td></tr></table></figure>





<h3 id="mac-추가"><a href="#mac-추가" class="headerlink" title="mac 추가"></a>mac 추가</h3><ul>
<li>VxLAN이 통신을 해야하는데, 해당 ip는 host 내부에 없다.</li>
<li>hostA의 VxLAN에 통신할 arp 정보를 수동으로 등록해준다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># nsenter --net=/var/run/netns/red</span></span><br><span class="line">\<span class="comment"># ip neigh add 7.7.7.3 lladdr 02:42:c0:a8:00:03 dev vxlan1 # in red namespace</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\<span class="comment"># ip neigh show</span></span><br><span class="line">7.7.7.3 dev vxlan1 lladdr 02:42:c0:a8:00:03 PERMANENT</span><br></pre></td></tr></table></figure>

<ul>
<li>arp table state</li>
</ul>
<p><img src="/blog/img/overlay-network-01.png"></p>
<ul>
<li>다시 테스트하면 ARP 통신이 된다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># ping 7.7.7.3</span></span><br><span class="line">PING 7.7.7.3 (7.7.7.3) 56(84) bytes of data.</span><br><span class="line">--- 7.7.7.3 ping statistics ---</span><br><span class="line">5 packets transmitted, 0 received, 100% packet loss, time 4087ms</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># ip neigh # arp테이블에 업데이트됨을 확인</span></span><br><span class="line">7.7.7.3 dev blue-veth lladdr 02:42:c0:a8:00:03 REACHABLE</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>hostA &gt; red</strong></li>
<li>ARP 통신 이후 ICMP 통신이 실패함을 알 수 있다.</li>
<li>ICMP (Internet Control Message Protocol) - L3 (Network Layer) 프로토콜</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># tcpdump -i br0</span></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on br0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">05:32:09.944756 ARP, Request who-has 7.7.7.3 tell 7.7.7.2, length 28</span><br><span class="line">05:32:09.944784 ARP, Reply 7.7.7.3 is-at 02:42:c0:a8:00:03 (oui Unknown), length 28</span><br><span class="line">05:32:09.944861 IP 7.7.7.2 &gt; 7.7.7.3: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 1821, <span class="built_in">seq</span> 1, length 64</span><br><span class="line">05:32:10.964330 IP 7.7.7.2 &gt; 7.7.7.3: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 1821, <span class="built_in">seq</span> 2, length 64</span><br><span class="line">05:32:11.987056 IP 7.7.7.2 &gt; 7.7.7.3: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 1821, <span class="built_in">seq</span> 3, length 64</span><br><span class="line">05:32:13.011901 IP 7.7.7.2 &gt; 7.7.7.3: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 1821, <span class="built_in">seq</span> 4, length 64</span><br></pre></td></tr></table></figure>





<h3 id="hostA-gt-blue-1"><a href="#hostA-gt-blue-1" class="headerlink" title="hostA &gt; blue"></a>hostA &gt; blue</h3><ul>
<li>br0 존재하는 blue 에서 netfilter 룰을 조회.</li>
<li>FORWARD 가 ACCEPT 임을 확인.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># iptables -t filter -L | grep policy</span></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br></pre></td></tr></table></figure>

<ul>
<li>route 조회</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># ip route</span></span><br><span class="line">7.7.7.0/24 dev br0 proto kernel scope <span class="built_in">link</span> src 7.7.7.1</span><br></pre></td></tr></table></figure>

<ul>
<li>bridge fdb 조회<ul>
<li>vxlan1의 정보를 확인할 수 있다.</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># bridge fdb | grep 02:42:c0:a8:00:03</span></span><br><span class="line">02:42:c0:a8:00:03 dev vxlan1 master br0</span><br></pre></td></tr></table></figure>

<ul>
<li>정확한 목적지 ip, VxLAN ip 등을 명시해 fdb entry에 추가한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># bridge fdb add 02:42:c0:a8:00:03 dev vxlan1 self dst 192.168.64.28 vni 42 port 4789</span></span><br><span class="line"></span><br><span class="line">root@seongtki:~<span class="comment"># bridge fdb | grep 02:42:c0:a8:00:03</span></span><br><span class="line">02:42:c0:a8:00:03 dev vxlan1 master br0</span><br><span class="line">02:42:c0:a8:00:03 dev vxlan1 dst 192.168.64.28 link-netnsid 1 self permanent</span><br></pre></td></tr></table></figure>





<h3 id="hostB-gt-red"><a href="#hostB-gt-red" class="headerlink" title="hostB &gt; red"></a>hostB &gt; red</h3><ul>
<li>hostB에도 필요한 정보가 전부 존재하는지 조회를 해보자.</li>
<li>arp는 수동으로 추가해주어야 한다.</li>
<li>fdb는 이미 추가되어 있다. -&gt; vxlan1 추가 시 learning 키워드를 추가해주면, fdb는 필요한 정보를 자동으로 업데이트 한다.<br>(hostA에서 이미 추가되어있어 요청했을 때 자동으로 추가됨)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># nsenter --net=/var/run/netns/red</span></span><br><span class="line">root@seongtki:~<span class="comment"># ip neigh</span></span><br><span class="line">root@seongtki:~<span class="comment"># ip route</span></span><br><span class="line">7.7.7.0/24 dev br0 proto kernel scope <span class="built_in">link</span> src 7.7.7.1</span><br><span class="line">root@seongtki:~<span class="comment"># bridge fdb | grep 02:42:c0:a8:00:02</span></span><br><span class="line">02:42:c0:a8:00:02 dev vxlan1 master br0</span><br><span class="line">02:42:c0:a8:00:02 dev vxlan1 dst 192.168.64.27 link-netnsid 1 self</span><br></pre></td></tr></table></figure>

<ul>
<li>arp 정보 추가</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># ip neigh add 7.7.7.2 lladdr 02:42:c0:a8:00:02 dev vxlan1</span></span><br><span class="line"></span><br><span class="line">root@seongtki:~<span class="comment"># ip neigh show</span></span><br><span class="line">7.7.7.2 dev vxlan1 lladdr 02:42:c0:a8:00:02 PERMANENT</span><br></pre></td></tr></table></figure>



<h3 id="최종-테스트"><a href="#최종-테스트" class="headerlink" title="최종 테스트"></a>최종 테스트</h3><p>hostA &gt; blue</p>
<ul>
<li>정상적으로 응답</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~# ping 7.7.7.3</span><br><span class="line">PING 7.7.7.3 (7.7.7.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from 7.7.7.3: icmp_seq=153 ttl=64 time=1008 ms</span><br><span class="line">64 bytes from 7.7.7.3: icmp_seq=154 ttl=64 time=4.79 ms</span><br><span class="line">64 bytes from 7.7.7.3: icmp_seq=155 ttl=64 time=3.85 ms</span><br><span class="line">64 bytes from 7.7.7.3: icmp_seq=156 ttl=64 time=3.37 ms</span><br></pre></td></tr></table></figure>

<p>hostB &gt; red</p>
<ul>
<li>정상적인 통신로그 조회</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~# tcpdump -i br0</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">listening on br0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">03:12:11.488557 IP 7.7.7.2 &gt; 7.7.7.3: ICMP echo request, id 1958, seq 174, length 64</span><br><span class="line">03:12:11.488648 IP 7.7.7.3 &gt; 7.7.7.2: ICMP echo reply, id 1958, seq 174, length 64</span><br><span class="line">03:12:12.490214 IP 7.7.7.2 &gt; 7.7.7.3: ICMP echo request, id 1958, seq 175, length 64</span><br><span class="line">03:12:12.490423 IP 7.7.7.3 &gt; 7.7.7.2: ICMP echo reply, id 1958, seq 175, length 64</span><br><span class="line">03:12:13.495586 IP 7.7.7.2 &gt; 7.7.7.3: ICMP echo request, id 1958, seq 176, length 64</span><br><span class="line">03:12:13.495828 IP 7.7.7.3 &gt; 7.7.7.2: ICMP echo reply, id 1958, seq 176, length 64</span><br></pre></td></tr></table></figure>



<ul>
<li>지금까지 구성한 overlay network 구성도.</li>
</ul>
<p><img src="/blog/img/overlay-network-02.png"></p>
<h3 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h3><p><a target="_blank" rel="noopener" href="https://ebt-forti.tistory.com/m/145?category=849281">https://ebt-forti.tistory.com/m/145?category=849281</a></p>
<p><a target="_blank" rel="noopener" href="https://netpple.github.io/docs/make-container-without-docker/">https://netpple.github.io/docs/make-container-without-docker/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-11-24T05:02:30.000Z" title="2024. 11. 24. 오후 2:02:30">2024-11-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-11-24T14:34:20.550Z" title="2024. 11. 24. 오후 11:34:20">2024-11-24</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-overlaynetwork/">container/overlaynetwork</a></span><span class="level-item">3 minutes read (About 429 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/11/24/docs/overlaynetwork/vxlan/">vxlan concept</a></h1><div class="content"><ul>
<li>VxLAN은 VLAN을 확장한 개념으로 기존의 VLAN에서 만들 수 있는 네트워크보다 훨씬 더 많은 네트워크를 생성할 수 있다.</li>
<li>VxLAN에서 x는 eXtensible으로 이름에서도 확장을 나타내고 있다.</li>
<li>VLAN은 이더넷 프레임에 16bit(vlan, option, id)를 추가로 구성하여 Tag를 기반으로 동작하는데 이때 id로 사용할 수 있는 비트가 12bit이기 때문에 만들 수 있는 네트워크가 최대 4096개만 생성할 수 있었다.</li>
<li>VxLAN은 VLAN의 문제를 해결하기 위해 50byte 헤더(Mac over IP, UDP Header, 24bit VLAN ID)를 추가로 구성하여 16,000,000개 이상의 VLAN을 제공할 수 있다.</li>
</ul>
<h3 id="VNI-virtual-Network-Identifier"><a href="#VNI-virtual-Network-Identifier" class="headerlink" title="VNI (virtual Network Identifier)"></a>VNI (virtual Network Identifier)</h3><ul>
<li>VLAN과 VxLAN segment간 mapping 구분자</li>
<li>같은 VLAN에 대해 여러 개의 VNI mapping이 가능하다.</li>
</ul>
<h3 id="VTEP-VXLAN-Tunnel-End-Point"><a href="#VTEP-VXLAN-Tunnel-End-Point" class="headerlink" title="VTEP ( VXLAN Tunnel End Point )"></a>VTEP ( VXLAN Tunnel End Point )</h3><ul>
<li>VXLAN Tunnel 종단 역할을 수행한다</li>
<li>인캡슐레이션과 터미네이션 의 end point 역활을 수행한다.</li>
</ul>
<p><img src="/blog/img/overlay-network-03.png"></p>
<ul>
<li><p>Original L2 frame 이외의 모든 헤더가 VXLAN 관련 헤더이다.</p>
</li>
<li><p>VXLAN 헤더 에는 VNI 라는 24비트 VLAN 을 생성할 수 있다.</p>
<p>일반적인 VLAN ID 가 16비트의 기반이라면, VXLAN의 VNI 에서 표현되는 VLAN 은 24비트의 기반으로, 16,000,000 개의 VLAN 을 생성 할 수 있다.</p>
</li>
<li><p>L2 over L3 : UDP 패킷 내부에 L2 프레임을  캡슐화 하는 <em>터널링</em>  기술</p>
</li>
<li><p>Mac in UDP </p>
<ul>
<li>VXLAN 패킷 사이즈 : 50byte</li>
<li>VXLAN L2 정보 (MAC address)를 L3에 넣어서 통신</li>
</ul>
</li>
</ul>
<h3 id="MTU"><a href="#MTU" class="headerlink" title="MTU"></a>MTU</h3><ul>
<li>원래는 1500byte 를 사용하는데 VXLAN 패킷에 50byte를 썼으므로</li>
<li>1450byte 를 세팅해서 사용하도록 MTU를 세팅한다.</li>
</ul>
<h3 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h3><p><a target="_blank" rel="noopener" href="https://skstp35.tistory.com/227">https://skstp35.tistory.com/227</a></p>
<p><a target="_blank" rel="noopener" href="https://atthis.tistory.com/7?category=750237">https://atthis.tistory.com/7?category=750237</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-11-10T11:40:35.000Z" title="2024. 11. 10. 오후 8:40:35">2024-11-10</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-11-10T14:25:52.101Z" title="2024. 11. 10. 오후 11:25:52">2024-11-10</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/java-interface/">java/interface</a></span><span class="level-item">2 minutes read (About 344 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/11/10/docs/java/interface/">interface</a></h1><div class="content"><h1 id="인터페이스에-정적-메소드"><a href="#인터페이스에-정적-메소드" class="headerlink" title="인터페이스에 정적 메소드"></a>인터페이스에 정적 메소드</h1><ul>
<li><p>기본메소드 (default method)와 정적 메소드를 가질 수 있다.</p>
</li>
<li><p>기본메소드</p>
<ul>
<li>인터페이스에서 메소드 선언 뿐 아니라, 기본적인 구현체까지 제공할 수 있다.</li>
<li>기존의 인터페이스를 구현하는 클래스에 새로운 기능을 추가할 수 있다.</li>
</ul>
</li>
<li><p>정적메소드</p>
<ul>
<li>자바 9부터 인터페이스에서 private static 메소드도 가질 수 있다.</li>
<li>단, private 필드는 아직도 선언할 수 없다. (private 필드가 필요한 경우 인스턴스와 불가 동반클래스가 필요해 보인다.)</li>
</ul>
</li>
<li><p>인터페이스에서 default, private static method를 정의할 수 있게 되어서<br>인스턴스와 불가  동반 클래스를 만들 필요가 없어졌다. (final class, private 생성자 등)</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; numbers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">numbers.add(<span class="number">100</span>);</span><br><span class="line">numbers.add(<span class="number">20</span>);</span><br><span class="line">numbers.add(<span class="number">44</span>);</span><br><span class="line">numbers.add(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(numbers);</span><br><span class="line"></span><br><span class="line">Comparator&lt;Integer&gt; desc = <span class="keyword">new</span> <span class="title class_">Comparator</span>&lt;Integer&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(Integer o1, Integer o2)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> o2 - o1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">numbers.sort(desc.reversed());</span><br><span class="line">System.out.println(numbers);</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Comparator</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> Comparator&lt;T&gt; <span class="title function_">reversed</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.reverseOrder(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<ul>
<li>인스턴스와 불가 동반 클래스인 Collections 로부터 정적 팩토리 메서드를 수행한다.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Collections</span> &#123;</span><br><span class="line">    <span class="comment">// Suppresses default constructor, ensuring non-instantiability.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Collections</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">List</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">Collection</span>&lt;E&gt; &#123;</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">sort</span><span class="params">(Comparator&lt;? <span class="built_in">super</span> E&gt; c)</span> &#123;</span><br><span class="line">      Object[] a = <span class="built_in">this</span>.toArray();</span><br><span class="line">      Arrays.sort(a, (Comparator) c);</span><br><span class="line">      ListIterator&lt;E&gt; i = <span class="built_in">this</span>.listIterator();</span><br><span class="line">      <span class="keyword">for</span> (Object e : a) &#123;</span><br><span class="line">          i.next();</span><br><span class="line">          i.set((E) e);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-11-10T11:30:35.000Z" title="2024. 11. 10. 오후 8:30:35">2024-11-10</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-11-10T14:26:23.425Z" title="2024. 11. 10. 오후 11:26:23">2024-11-10</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/java-flyweight/">java/flyweight</a></span><span class="level-item">3 minutes read (About 514 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/11/10/docs/java/flyweight/">flyweight</a></h1><div class="content"><p><img src="/blog/img/java/item01-flyweight-01.png"></p>
<ul>
<li><p>객체를 가볍게 만들어 메모리 사용을 줄이는 패턴</p>
</li>
<li><p>자주 변하는 속성(또는 외적인 속성, extrinsit)과 변하지 는 속성(또는 내적인 속성, intrinsit)을 분리하고 재사용하여 메모리 사용을<br>줄일  수 있다.</p>
</li>
</ul>
<h2 id="2-implement"><a href="#2-implement" class="headerlink" title="2. implement"></a>2. implement</h2><ul>
<li>공유하는 인스턴스가 있어서 메모리를 덜 쓴다. 인스턴스를 많이 사용하는 경우에 쓸 수 있는 방식</li>
</ul>
<h3 id="변경-전"><a href="#변경-전" class="headerlink" title="변경 전"></a>변경 전</h3><ul>
<li>변경되지 않는속성이 중복하여 생성되어 메모리를 잡아먹는다.<ul>
<li>Font, Font size는 언제사용해도 변하지 않는 속성이디ㅏ.</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Character</span> <span class="variable">c1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Character</span>(<span class="string">&#x27;h&#x27;</span>, <span class="string">&quot;white&quot;</span>, <span class="string">&quot;Nanum&quot;</span>, <span class="number">12</span>);</span><br><span class="line">        <span class="type">Character</span> <span class="variable">c2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Character</span>(<span class="string">&#x27;e&#x27;</span>, <span class="string">&quot;white&quot;</span>, <span class="string">&quot;Nanum&quot;</span>, <span class="number">12</span>);</span><br><span class="line">        <span class="type">Character</span> <span class="variable">c3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Character</span>(<span class="string">&#x27;l&#x27;</span>, <span class="string">&quot;white&quot;</span>, <span class="string">&quot;Nanum&quot;</span>, <span class="number">12</span>);</span><br><span class="line">        <span class="type">Character</span> <span class="variable">c4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Character</span>(<span class="string">&#x27;l&#x27;</span>, <span class="string">&quot;white&quot;</span>, <span class="string">&quot;Nanum&quot;</span>, <span class="number">12</span>);</span><br><span class="line">        <span class="type">Character</span> <span class="variable">c5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Character</span>(<span class="string">&#x27;o&#x27;</span>, <span class="string">&quot;white&quot;</span>, <span class="string">&quot;Nanum&quot;</span>, <span class="number">12</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="변경-후"><a href="#변경-후" class="headerlink" title="변경 후"></a>변경 후</h3><p><img src="/blog/img/java/item01-flyweight-02.png"></p>
<ul>
<li>변경되지 않느 속성은 Font class를 생성하여 이동시킨다.</li>
<li>플라이웨이트 팩토리 : FontFactory 를 생성해서 같은 속성(캐싱)을 가져 올 때는 인스턴스를 생성하지 않도록 한다.</li>
<li>플라이웨이트 : Font</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">FontFactory</span> <span class="variable">fontFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FontFactory</span>();</span><br><span class="line">        <span class="type">Character</span> <span class="variable">c1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Character</span>(<span class="string">&#x27;h&#x27;</span>, <span class="string">&quot;white&quot;</span>, fontFactory.getFont(<span class="string">&quot;nanum:12&quot;</span>));</span><br><span class="line">        <span class="type">Character</span> <span class="variable">c2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Character</span>(<span class="string">&#x27;e&#x27;</span>, <span class="string">&quot;white&quot;</span>, fontFactory.getFont(<span class="string">&quot;nanum:12&quot;</span>));</span><br><span class="line">        <span class="type">Character</span> <span class="variable">c3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Character</span>(<span class="string">&#x27;l&#x27;</span>, <span class="string">&quot;white&quot;</span>, fontFactory.getFont(<span class="string">&quot;nanum:12&quot;</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>플라이웨이트 (Font) 를 생성 할 때, 사용되는 속성들은 변경이 안되기 때문에 <code>final</code>로 생성한다.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Font</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String family;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Font</span><span class="params">(String family, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.family = family;</span><br><span class="line">        <span class="built_in">this</span>.size = size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getFamily</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> family;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>캐싱<ol>
<li>cache를 맴버변수로 생성</li>
<li>getFont 로 cache 한개를 리턴 할때, 포함되어 있으면 그대로 리턴하고 아니라면, 인스턴스를 생성하여 put 한 후 리턴한다.</li>
<li>같은 키 값은 같은 인스턴스를 계속 사용하여 캐싱 효과가 있다.</li>
</ol>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FontFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Font&gt; cache = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Font <span class="title function_">getFont</span><span class="params">(String font)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (cache.containsKey(font)) &#123;</span><br><span class="line">            <span class="keyword">return</span> cache.get(font);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String[] split = font.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">            <span class="type">Font</span> <span class="variable">newFont</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Font</span>(split[<span class="number">0</span>], Integer.parseInt(split[<span class="number">1</span>]));</span><br><span class="line">            cache.put(font, newFont);</span><br><span class="line">            <span class="keyword">return</span> newFont;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-11-10T11:00:35.000Z" title="2024. 11. 10. 오후 8:00:35">2024-11-10</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-11-10T14:25:12.300Z" title="2024. 11. 10. 오후 11:25:12">2024-11-10</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/java-Enumeration/">java/Enumeration</a></span><span class="level-item">a minute read (About 174 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/11/10/docs/java/enum/">Enumeration</a></h1><div class="content"><ul>
<li>상수목록을 담을 수 있는 데이터 타입.</li>
<li>특정한 변수가 가질 수 있는 값을 제한할 수 있다. (type-safety)를 보장할 수 있다.<ul>
<li>다른타입으로 정의할 경우 다른의미로 사용할 때의 예외처리가 필수이다.</li>
</ul>
</li>
<li>싱글톤 패턴을 구현할 때 사용하기 도 한다.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public enum OrderStatus &#123;</span><br><span class="line"></span><br><span class="line">    PREPARING(0), SHIPPED(1), DELIVERING(2), DELIVERED(3);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>jvm 내에서 인스턴스가 딱 하나만 생성이 된다.</p>
</li>
<li><p>&#x3D;&#x3D; 로 비교. (인스턴스가 한개이기 때문.)</p>
</li>
<li><p>equals 의 nullPointerException 을 피할 수 있다.</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Order order = new Order();</span><br><span class="line">if (order.orderStatus == OrderStatus.DELIVERED) &#123;</span><br><span class="line">    System.out.println(&quot;delivered&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p>[<a target="_blank" rel="noopener" href="https://scshim.tistory.com/253">Java] Enum, 자바의 열거타입을 알아보자</a></p>
<p><a target="_blank" rel="noopener" href="https://techblog.woowahan.com/2527/">https://techblog.woowahan.com/2527/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-11-02T19:00:35.000Z" title="2024. 11. 3. 오전 4:00:35">2024-11-03</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-11-02T23:55:23.545Z" title="2024. 11. 3. 오전 8:55:23">2024-11-03</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/vpccni-vpccni2/">vpccni/vpccni2</a></span><span class="level-item">11 minutes read (About 1588 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/11/03/docs/vpccni/vpccni-2/">vpccni-2</a></h1><div class="content"><h2 id="ExternalDNS"><a href="#ExternalDNS" class="headerlink" title="ExternalDNS"></a>ExternalDNS</h2><p>소개 : K8S 서비스&#x2F;인그레스 생성 시 도메인을 설정하면, AWS(Route 53), Azure(DNS), GCP(Cloud DNS) 에 A 레코드(TXT 레코드)로 자동 생성&#x2F;삭제</p>
<p>ExternalDNS CTRL 권한 주는 방법 3가지 : Node IAM Role, Static credentials, IRSA</p>
<p><img src="/blog/img/vpccni-13.png"></p>
<h2 id="CoreDNS"><a href="#CoreDNS" class="headerlink" title="CoreDNS"></a>CoreDNS</h2><p><img src="/blog/img/vpccni-14.png"></p>
<h2 id="Topology-Aware-Routing"><a href="#Topology-Aware-Routing" class="headerlink" title="Topology Aware Routing"></a>Topology Aware Routing</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 현재 노드 AZ 배포 확인</span></span><br><span class="line">kubectl get node --label-columns=topology.kubernetes.io/zone</span><br><span class="line">NAME                                               STATUS   ROLES    AGE   VERSION                ZONE</span><br><span class="line">ip-192-168-1-225.ap-northeast-2.compute.internal   Ready    &lt;none&gt;   70m   v1.24.11-eks-a59e1f0   ap-northeast-2a</span><br><span class="line">ip-192-168-2-248.ap-northeast-2.compute.internal   Ready    &lt;none&gt;   70m   v1.24.11-eks-a59e1f0   ap-northeast-2b</span><br><span class="line">ip-192-168-3-228.ap-northeast-2.compute.internal   Ready    &lt;none&gt;   70m   v1.24.11-eks-a59e1f0   ap-northeast-2c</span><br><span class="line"></span><br><span class="line"><span class="comment"># 테스트를 위한 디플로이먼트와 서비스 배포</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl apply -f -</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: deploy-echo</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  replicas: 3</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: deploy-websrv</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: deploy-websrv</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      terminationGracePeriodSeconds: 0</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - name: websrv</span></span><br><span class="line"><span class="string">        image: registry.k8s.io/echoserver:1.5</span></span><br><span class="line"><span class="string">        ports:</span></span><br><span class="line"><span class="string">        - containerPort: 8080</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: svc-clusterip</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">    - name: svc-webport</span></span><br><span class="line"><span class="string">      port: 80</span></span><br><span class="line"><span class="string">      targetPort: 8080</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: deploy-websrv</span></span><br><span class="line"><span class="string">  type: ClusterIP</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인</span></span><br><span class="line">kubectl get deploy,svc,ep,endpointslices</span><br><span class="line">kubectl get pod -owide</span><br><span class="line">kubectl get svc,ep svc-clusterip</span><br><span class="line">kubectl get endpointslices -l kubernetes.io/service-name=svc-clusterip</span><br><span class="line">kubectl get endpointslices -l kubernetes.io/service-name=svc-clusterip -o yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 접속 테스트를 수행할 클라이언트 파드 배포</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl apply -f -</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: netshoot-pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: netshoot-pod</span></span><br><span class="line"><span class="string">    image: nicolaka/netshoot</span></span><br><span class="line"><span class="string">    command: [&quot;tail&quot;]</span></span><br><span class="line"><span class="string">    args: [&quot;-f&quot;, &quot;/dev/null&quot;]</span></span><br><span class="line"><span class="string">  terminationGracePeriodSeconds: 0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인</span></span><br><span class="line">kubectl get pod -owide</span><br></pre></td></tr></table></figure>



<p>테스트 파드(netshoot-pod)에서 ClusterIP 접속 시 부하분산 확인 : AZ(zone) 상관없이 랜덤 확률 부하분산 동작</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 디플로이먼트 파드가 배포된 AZ(zone) 확인</span></span><br><span class="line">kubectl get pod -l app=deploy-websrv -owide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 테스트 파드(netshoot-pod)에서 ClusterIP 접속 시 부하분산 확인</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it netshoot-pod -- curl svc-clusterip | grep Hostname</span><br><span class="line">Hostname: deploy-echo-859cc9b57d-sjzg9</span><br><span class="line"></span><br><span class="line">kubectl <span class="built_in">exec</span> -it netshoot-pod -- curl svc-clusterip | grep Hostname</span><br><span class="line">Hostname: deploy-echo-859cc9b57d-zsp42</span><br><span class="line"></span><br><span class="line"><span class="comment"># 100번 반복 접속 : 3개의 파드로 AZ(zone) 상관없이 랜덤 확률 부하분산 동작</span></span><br><span class="line">(Administrator@myeks:N/A) [root@myeks-bastion ~]<span class="comment"># kubectl exec -it netshoot-pod -- zsh -c &quot;for i in &#123;1..100&#125;; do curl -s svc-clusterip | grep Hostname; done | sort | uniq -c | sort -nr&quot;</span></span><br><span class="line">     36 Hostname: deploy-echo-859cc9b57d-gqkzz</span><br><span class="line">     33 Hostname: deploy-echo-859cc9b57d-sjzg9</span><br><span class="line">     31 Hostname: deploy-echo-859cc9b57d-zsp42</span><br></pre></td></tr></table></figure>























<h2 id="Using-AWS-Load-Balancer-Controller-for-blue-x2F-green-deployment-canary-deployment-and-A-x2F-B-testing"><a href="#Using-AWS-Load-Balancer-Controller-for-blue-x2F-green-deployment-canary-deployment-and-A-x2F-B-testing" class="headerlink" title="Using AWS Load Balancer Controller for blue&#x2F;green deployment, canary deployment and A&#x2F;B testing"></a>Using AWS Load Balancer Controller for blue&#x2F;green deployment, canary deployment and A&#x2F;B testing</h2><ul>
<li><p><strong>Weighted target group</strong> 가중치가 적용된 대상 그룹</p>
<ul>
<li>AWS 고객이 블루&#x2F;그린 및 카나리아 배포와 A&#x2F;B 테스트 전략을 채택할 수 있도록 돕기 위해 AWS는 2019년 11월에 애플리케이션 로드 밸런서에 대한 <a target="_blank" rel="noopener" href="https://aws.amazon.com/blogs/aws/new-application-load-balancer-simplifies-deployment-with-weighted-target-groups/">가중 대상 그룹을 발표했습니다. 여러 대상 그룹을</a> <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-listeners.html#listener-rules">리스너 규칙</a> 의 동일한 <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-listeners.html#forward-actions">전달 작업</a> 에 연결 하고 각 그룹에 대한 가중치를 지정할 수 있습니다.</li>
<li>이를 통해 개발자는 트래픽을 여러 버전의 애플리케이션에 분산하는 방법을 제어할 수 있습니다. 예를 들어, 가중치가 8과 2인 두 개의 대상 그룹이 있는 규칙을 정의하면 로드 밸런서는 트래픽의 80%를 첫 번째 대상 그룹으로, 20%를 다른 대상 그룹으로 라우팅합니다.</li>
</ul>
</li>
<li><p><strong>Advanced request routing</strong> 고급 요청 라우팅</p>
<ul>
<li>AWS는 가중치가 적용된 대상 그룹 외에도 2019년에 <a target="_blank" rel="noopener" href="https://aws.amazon.com/blogs/aws/new-advanced-request-routing-for-aws-application-load-balancers/">고급 요청 라우팅 기능을</a> 발표했습니다 . 고급 요청 라우팅은 개발자에게 표준 및 사용자 지정 HTTP 헤더와 메서드, 요청 경로, 쿼리 문자열, 소스 IP 주소를 기반으로 규칙을 작성하고 트래픽을 라우팅할 수 있는 기능을 제공합니다.</li>
<li>이 새로운 기능은 라우팅을 위한 프록시 플릿의 필요성을 없애 애플리케이션 아키텍처를 간소화하고, 로드 밸런서에서 원치 않는 트래픽을 차단하며, A&#x2F;B 테스트를 구현할 수 있도록 합니다.</li>
</ul>
</li>
<li><p><strong>AWS Load Balancer Controller</strong> AWS 로드 밸런서 컨트롤러</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes-sigs.github.io/aws-load-balancer-controller">AWS Load Balancer Controller</a> 는 Kubernetes 클러스터의 Elastic Load Balancer를 관리하는 데 도움이 되는 컨트롤러입니다. 애플리케이션 로드 밸런서를 프로비저닝하여 Kubernetes 인그레스 리소스를 충족합니다.</li>
<li>Kubernetes 인그레스 객체에 주석을 추가하여 프로비저닝된 애플리케이션 로드 밸런서의 동작을 사용자 지정할 수 있습니다. 이를 통해 개발자는 애플리케이션 로드 밸런서를 구성하고 Kubernetes 기본 의미 체계를 사용하여 블루&#x2F;그린, 카나리아 및 A&#x2F;B 배포를 실현할 수 있습니다.</li>
<li>예를 들어, 다음 인그레스 주석은 애플리케이션 로드 밸런서를 구성하여 두 버전의 애플리케이션 간에 트래픽을 분할합니다.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">**annotations**:</span><br><span class="line">   ...</span><br><span class="line">  **alb.ingress.kubernetes.io/actions.blue-green**: |</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>:<span class="string">&quot;forward&quot;</span>,</span><br><span class="line">      <span class="string">&quot;forwardConfig&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;**targetGroups**&quot;</span>:[</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;serviceName&quot;</span>:<span class="string">&quot;**hello-kubernetes-v1**&quot;</span>,</span><br><span class="line">            <span class="string">&quot;servicePort&quot;</span>:<span class="string">&quot;80&quot;</span>,</span><br><span class="line">            <span class="string">&quot;weight&quot;</span>:**50**</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;serviceName&quot;</span>:<span class="string">&quot;h**ello-kubernetes-v2**&quot;</span>,</span><br><span class="line">            <span class="string">&quot;servicePort&quot;</span>:<span class="string">&quot;80&quot;</span>,</span><br><span class="line">            <span class="string">&quot;weight&quot;</span>:**50**</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/vpccni-15.png"></p>
</li>
</ul>
<h2 id="Network-Policies-with-VPC-CNI"><a href="#Network-Policies-with-VPC-CNI" class="headerlink" title="Network Policies with VPC CNI"></a>Network Policies with VPC CNI</h2><p><a target="_blank" rel="noopener" href="https://aws.amazon.com/ko/blogs/containers/amazon-vpc-cni-now-supports-kubernetes-network-policies/">Link1</a> <a target="_blank" rel="noopener" href="https://github.com/aws-samples/eks-network-policy-examples">Link2</a> <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-network-policy.html">Link3</a></p>
<ul>
<li>AWS EKS fully supports the <strong>upstream Kubernetes Network Policy API</strong>, ensuring compatibility and adherence to Kubernetes standards.</li>
</ul>
<p><strong>eBPF</strong>로 패킷 필터링 동작 - Network Policy Controller, Node Agent, <strong>eBPF</strong> SDK</p>
<ul>
<li>사전 조건 : EKS 1.25 버전 이상, AWS VPC CNI 1.14 이상, OS 커널 5.10 이상 EKS 최적화 AMI(AL2, Bottlerocket, Ubuntu)</li>
<li>Network Policy Controller : v1.25 EKS 버전 이상 자동 설치, 통제 정책 모니터링 후 eBPF 프로그램을 생성 및 업데이트하도록 Node Agent에 지시</li>
<li>Node Agent : AWS VPC CNI 번들로 ipamd 플러그인과 함께 설치됨(aws-node 데몬셋). eBPF 프래그램을 관리</li>
<li>eBPF SDK : AWS VPC CNI에는 노드에서 eBPF 프로그램과 상호 작용할 수 있는 SDK 포함, eBPF 실행의 런타임 검사, 추적 및 분석 가능</li>
</ul>
<p>사전정보확인</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Network Policy 기본 비활성화되어 있어, 활성화 필요 : 실습 환경은 미리 활성화 설정 추가되어 있음</span></span><br><span class="line"><span class="built_in">tail</span> -n 11 myeks.yaml</span><br><span class="line">addons: </span><br><span class="line">- name: vpc-cni <span class="comment"># no version is specified so it deploys the default version</span></span><br><span class="line">  version: latest <span class="comment"># auto discovers the latest available</span></span><br><span class="line">  attachPolicyARNs: </span><br><span class="line">    - arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy</span><br><span class="line">  configurationValues: |-</span><br><span class="line">    enableNetworkPolicy: <span class="string">&quot;true&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Node Agent 확인 : AWS VPC CNI 1.14 이상 버전 정보 확인</span></span><br><span class="line">kubectl get ds aws-node -n kube-system -o yaml | k neat</span><br><span class="line">...</span><br><span class="line">    - args: </span><br><span class="line">      - --enable-ipv6=<span class="literal">false</span></span><br><span class="line">      - --enable-network-policy=<span class="literal">true</span></span><br><span class="line">...</span><br><span class="line">    volumeMounts: </span><br><span class="line">    - mountPath: /host/opt/cni/bin</span><br><span class="line">      name: cni-bin-dir</span><br><span class="line">    - mountPath: /sys/fs/bpf</span><br><span class="line">      name: bpf-pin-path</span><br><span class="line">    - mountPath: /var/log/aws-routed-eni</span><br><span class="line">      name: log-dir</span><br><span class="line">    - mountPath: /var/run/aws-node</span><br><span class="line">      name: run-dir</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl get ds aws-node -n kube-system -o yaml | grep -i image:</span><br><span class="line">kubectl get pod -n kube-system -l k8s-app=aws-node</span><br><span class="line">kubectl get ds -n kube-system aws-node -o jsonpath=<span class="string">&#x27;&#123;.spec.template.spec.containers[*].name&#125;&#123;&quot;\n&quot;&#125;&#x27;</span></span><br><span class="line">aws-node aws-eks-nodeagent</span><br><span class="line"></span><br><span class="line"><span class="comment"># EKS 1.25 버전 이상 확인</span></span><br><span class="line">kubectl get nod</span><br><span class="line"></span><br><span class="line"><span class="comment"># OS 커널 5.10 이상 확인</span></span><br><span class="line">ssh ec2-user@<span class="variable">$N1</span> <span class="built_in">uname</span> -r</span><br><span class="line">5.10.210-201.852.amzn2.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 실행 중인 eBPF 프로그램 확인</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$N1</span> <span class="variable">$N2</span> <span class="variable">$N3</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; ssh ec2-user@<span class="variable">$i</span> sudo /opt/cni/bin/aws-eks-na-cli ebpf progs; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line">...</span><br><span class="line">Programs currently loaded : </span><br><span class="line">Type : 26 ID : 6 Associated maps count : 1</span><br><span class="line">========================================================================================</span><br><span class="line">Type : 26 ID : 8 Associated maps count : 1</span><br><span class="line">========================================================================================</span><br><span class="line"></span><br><span class="line"><span class="comment"># 각 노드에 BPF 파일 시스템을 탑재 확인</span></span><br><span class="line">ssh ec2-user@<span class="variable">$N1</span> mount | grep -i bpf</span><br><span class="line">none on /sys/fs/bpf <span class="built_in">type</span> bpf (rw,nosuid,nodev,noexec,relatime,mode=700)</span><br><span class="line"></span><br><span class="line">ssh ec2-user@<span class="variable">$N1</span> <span class="built_in">df</span> -a | grep -i bpf</span><br><span class="line">none                   0       0         0    - /sys/fs/bpf</span><br></pre></td></tr></table></figure>



<p>샘플 애플리케이션 배포 및 네트워크 정책 적용 실습 - <a target="_blank" rel="noopener" href="https://aws.amazon.com/ko/blogs/containers/amazon-vpc-cni-now-supports-kubernetes-network-policies/">Link</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">git <span class="built_in">clone</span> &lt;https://github.com/aws-samples/eks-network-policy-examples.git&gt;</span><br><span class="line"><span class="built_in">cd</span> eks-network-policy-examples</span><br><span class="line">tree advanced/manifests/</span><br><span class="line">kubectl apply -f advanced/manifests/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인</span></span><br><span class="line">kubectl get pod,svc</span><br><span class="line">kubectl get pod,svc -n another-ns</span><br><span class="line"></span><br><span class="line"><span class="comment"># 통신 확인</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it client-one -- curl demo-app</span><br><span class="line">kubectl <span class="built_in">exec</span> -it client-two -- curl demo-app</span><br><span class="line">kubectl <span class="built_in">exec</span> -it another-client-one -n another-ns -- curl **demo-app**</span><br><span class="line">kubectl <span class="built_in">exec</span> -it another-client-one -n another-ns -- curl demo-app.**default**</span><br><span class="line">kubectl <span class="built_in">exec</span> -it another-client-two -n another-ns -- curl demo-app.default.svc</span><br></pre></td></tr></table></figure>

<ul>
<li>모든 트래픽 거부</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 모니터링</span></span><br><span class="line"><span class="comment"># kubectl exec -it client-one -- curl demo-app</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> kubectl <span class="built_in">exec</span> -it client-one -- curl --connect-timeout 1 demo-app ; <span class="built_in">date</span>; <span class="built_in">sleep</span> 1; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 정책 적용</span></span><br><span class="line"><span class="built_in">cat</span> advanced/policies/01-deny-all-ingress.yaml</span><br><span class="line">kubectl apply -f advanced/policies/01-deny-all-ingress.yaml</span><br><span class="line">**kubectl get networkpolicy**</span><br><span class="line"></span><br><span class="line"><span class="comment"># 실행 중인 eBPF 프로그램 확인</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$N1</span> <span class="variable">$N2</span> <span class="variable">$N3</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; ssh ec2-user@<span class="variable">$i</span> **sudo /opt/cni/bin/aws-eks-na-cli ebpf progs**; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$N1</span> <span class="variable">$N2</span> <span class="variable">$N3</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; ssh ec2-user@<span class="variable">$i</span> **sudo /opt/cni/bin/aws-eks-na-cli ebpf loaded-ebpfdata**; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line">...</span><br><span class="line">&gt;&gt; node 192.168.3.201 &lt;&lt;</span><br><span class="line"><span class="string">PinPath:  /sys/fs/bpf/globals/aws/programs/demo-app-6fd76f694b-default_handle_ingress</span></span><br><span class="line"><span class="string">Pod Identifier : **demo-app-6fd76f694b-default**  Direction : **ingress** </span></span><br><span class="line"><span class="string">Prog ID:  9</span></span><br><span class="line"><span class="string">Associated Maps -&gt; </span></span><br><span class="line"><span class="string">Map Name:  ingress_map</span></span><br><span class="line"><span class="string">Map ID:  **7**</span></span><br><span class="line"><span class="string">Map Name:  policy_events</span></span><br><span class="line"><span class="string">Map ID:  **6**</span></span><br><span class="line"><span class="string">Map Name:  aws_conntrack_map</span></span><br><span class="line"><span class="string">Map ID:  **5**</span></span><br><span class="line"><span class="string">========================================================================================</span></span><br><span class="line"><span class="string">PinPath</span>:  /sys/fs/bpf/globals/aws/programs/demo-app-6fd76f694b-default_handle_egress</span><br><span class="line">Pod Identifier : **demo-app-6fd76f694b-default**  Direction : **egress** </span><br><span class="line">Prog ID:  10</span><br><span class="line">Associated Maps -&gt; </span><br><span class="line">Map Name:  aws_conntrack_map</span><br><span class="line">Map ID:  5</span><br><span class="line">Map Name:  egress_map</span><br><span class="line">Map ID:  8</span><br><span class="line">Map Name:  policy_events</span><br><span class="line">Map ID:  6</span><br><span class="line">========================================================================================</span><br><span class="line"></span><br><span class="line">ssh ec2-user@<span class="variable">$N3</span> sudo /opt/cni/bin/aws-eks-na-cli ebpf dump-maps 5</span><br><span class="line">ssh ec2-user@<span class="variable">$N3</span> sudo /opt/cni/bin/aws-eks-na-cli ebpf dump-maps 9</span><br><span class="line">ssh ec2-user@<span class="variable">$N3</span> sudo /opt/cni/bin/aws-eks-na-cli ebpf dump-maps 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 정책 다시 삭제</span></span><br><span class="line">kubectl delete -f advanced/policies/01-deny-all-ingress.yaml</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$N1</span> <span class="variable">$N2</span> <span class="variable">$N3</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; ssh ec2-user@<span class="variable">$i</span> **sudo /opt/cni/bin/aws-eks-na-cli ebpf loaded-ebpfdata**; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 다시 적용</span></span><br><span class="line">kubectl apply -f advanced/policies/01-deny-all-ingress.yaml</span><br></pre></td></tr></table></figure>

<ul>
<li>동일 네임스페이스 + 클라이언트1 로부터의 수신 허용</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">cat</span> advanced/policies/03-allow-ingress-from-samens-client-one.yaml </span><br><span class="line">kubectl apply -f advanced/policies/03-allow-ingress-from-samens-client-one.yaml</span><br><span class="line">kubectl get networkpolicy</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$N1</span> <span class="variable">$N2</span> <span class="variable">$N3</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; ssh ec2-user@<span class="variable">$i</span> **sudo /opt/cni/bin/aws-eks-na-cli ebpf loaded-ebpfdata**; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line">ssh ec2-user@<span class="variable">$N3</span> sudo /opt/cni/bin/aws-eks-na-cli ebpf dump-maps 5</span><br><span class="line">ssh ec2-user@<span class="variable">$N3</span> sudo /opt/cni/bin/aws-eks-na-cli ebpf dump-maps 9</span><br><span class="line">ssh ec2-user@<span class="variable">$N3</span> sudo /opt/cni/bin/aws-eks-na-cli ebpf dump-maps 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 클라이언트2 수신 확인</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it client-two -- curl --connect-timeout 1 demo-app</span><br></pre></td></tr></table></figure>

<ul>
<li>another-ns 네임스페이스로부터의 수신 허용</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 모니터링</span></span><br><span class="line"><span class="comment"># kubectl exec -it another-client-one -n another-ns -- curl --connect-timeout 1 demo-app.default</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> kubectl <span class="built_in">exec</span> -it another-client-one -n another-ns -- curl --connect-timeout 1 demo-app.default ; <span class="built_in">date</span>; <span class="built_in">sleep</span> 1; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">cat</span> advanced/policies/04-allow-ingress-from-xns.yaml</span><br><span class="line">kubectl apply -f advanced/policies/04-allow-ingress-from-xns.yaml</span><br><span class="line">kubectl get networkpolicy</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$N1</span> <span class="variable">$N2</span> <span class="variable">$N3</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; ssh ec2-user@<span class="variable">$i</span> **sudo /opt/cni/bin/aws-eks-na-cli ebpf loaded-ebpfdata**; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line">ssh ec2-user@<span class="variable">$N3</span> sudo /opt/cni/bin/aws-eks-na-cli ebpf dump-maps 5</span><br><span class="line">ssh ec2-user@<span class="variable">$N3</span> sudo /opt/cni/bin/aws-eks-na-cli ebpf dump-maps 9</span><br><span class="line">ssh ec2-user@<span class="variable">$N3</span> sudo /opt/cni/bin/aws-eks-na-cli ebpf dump-maps 10</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it another-client-two -n another-ns -- curl --connect-timeout 1 demo-app.default</span><br></pre></td></tr></table></figure>

<ul>
<li>eBPF 관련 정보 확인</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 실행 중인 eBPF 프로그램 확인</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$N1</span> <span class="variable">$N2</span> <span class="variable">$N3</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; ssh ec2-user@<span class="variable">$i</span> **sudo /opt/cni/bin/aws-eks-na-cli ebpf progs**; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># eBPF 로그 확인</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$N1</span> <span class="variable">$N2</span> <span class="variable">$N3</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; ssh ec2-user@<span class="variable">$i</span> sudo <span class="built_in">cat</span> /var/log/aws-routed-eni/ebpf-sdk.log; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$N1</span> <span class="variable">$N2</span> <span class="variable">$N3</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; ssh ec2-user@<span class="variable">$i</span> sudo <span class="built_in">cat</span> /var/log/aws-routed-eni/**network-policy-agent**; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<ul>
<li>송신 트래픽 거부 : 기본 네임스페이스의 클라이언트-1 포드에서 모든 송신 격리를 적용</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 모니터링</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> kubectl <span class="built_in">exec</span> -it client-one -- curl --connect-timeout 1 google.com ; <span class="built_in">date</span>; <span class="built_in">sleep</span> 1; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">cat</span> advanced/policies/06-deny-egress-from-client-one.yaml</span><br><span class="line">kubectl apply -f advanced/policies/06-deny-egress-from-client-one.yaml</span><br><span class="line">kubectl get networkpolicy</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$N1</span> <span class="variable">$N2</span> <span class="variable">$N3</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; ssh ec2-user@<span class="variable">$i</span> **sudo /opt/cni/bin/aws-eks-na-cli ebpf loaded-ebpfdata**; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line">ssh ec2-user@<span class="variable">$N3</span> sudo /opt/cni/bin/aws-eks-na-cli ebpf dump-maps 5</span><br><span class="line">ssh ec2-user@<span class="variable">$N3</span> sudo /opt/cni/bin/aws-eks-na-cli ebpf dump-maps 9</span><br><span class="line">ssh ec2-user@<span class="variable">$N3</span> sudo /opt/cni/bin/aws-eks-na-cli ebpf dump-maps 10</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it client-one -- nslookup demo-app</span><br></pre></td></tr></table></figure>

<ul>
<li>송신 트래픽 허용 : DNS 트래픽을 포함하여 여러 포트 및 네임스페이스에서의 송신을 허용</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 모니터링</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> kubectl <span class="built_in">exec</span> -it client-one -- curl --connect-timeout 1 demo-app ; <span class="built_in">date</span>; <span class="built_in">sleep</span> 1; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">cat</span> advanced/policies/08-allow-egress-to-demo-app.yaml | yh</span><br><span class="line">kubectl apply -f advanced/policies/08-allow-egress-to-demo-app.yaml</span><br><span class="line">kubectl get networkpolicy</span><br></pre></td></tr></table></figure>

<ul>
<li>실습 후 리소스 삭제</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete networkpolicy --all</span><br><span class="line">kubectl delete -f advanced/manifests/</span><br></pre></td></tr></table></figure>





















<h2 id="AWS-VPC-CNI-Cilium-CNI-Hybrid-mode"><a href="#AWS-VPC-CNI-Cilium-CNI-Hybrid-mode" class="headerlink" title="AWS VPC CNI + Cilium CNI : Hybrid mode"></a>AWS VPC CNI + Cilium CNI : Hybrid mode</h2><p>구성 방안 : 각 CNI의 강점을 조합하여 사용 - AWS VPC CNI(IPAM, Routing 등), Cilium(LB, Network Policy, Encryption, Visibility) - <a target="_blank" rel="noopener" href="https://docs.cilium.io/en/stable/installation/cni-chaining-aws-cni">Docs</a></p>
<p><img src="/blog/img/vpccni-16.png"></p>
<ul>
<li><p>제약 사항 : <a target="_blank" rel="noopener" href="https://docs.cilium.io/en/stable/security/policy/language/#l7-policy">Layer 7 Policy</a> (see <a target="_blank" rel="noopener" href="https://github.com/cilium/cilium/issues/12454">GitHub issue 12454</a>) , <a target="_blank" rel="noopener" href="https://docs.cilium.io/en/stable/security/network/encryption-ipsec/#encryption-ipsec">IPsec Transparent Encryption</a> (see <a target="_blank" rel="noopener" href="https://github.com/cilium/cilium/issues/15596">GitHub issue 15596</a>)</p>
</li>
<li><p>다만, <strong>Cilium Full 기능 사용</strong>을 위해서는 AWS VPN CNI를 제거하고 <strong>Fully to Cilium 사용을 권장함</strong> - <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=w6S6baRHHu8">Youtube</a></p>
</li>
<li><p>(참고) Cilium CNI 설치 → 기존 배치 파드는 Restart 필요</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cilium CNI 설치</span></span><br><span class="line">helm repo add cilium https://helm.cilium.io/</span><br><span class="line">helm install cilium cilium/cilium --version 1.16.3 \</span><br><span class="line">  --namespace kube-system \</span><br><span class="line">  --<span class="built_in">set</span> cni.chainingMode=aws-cni \</span><br><span class="line">  --<span class="built_in">set</span> cni.exclusive=<span class="literal">false</span> \</span><br><span class="line">  --<span class="built_in">set</span> enableIPv4Masquerade=<span class="literal">false</span> \</span><br><span class="line">  --<span class="built_in">set</span> routingMode=native \</span><br><span class="line">  --<span class="built_in">set</span> endpointRoutes.enabled=<span class="literal">true</span></span><br><span class="line"><span class="comment">## This will enable chaining with the AWS VPC CNI plugin. </span></span><br><span class="line"><span class="comment">## It will also disable tunneling, as it’s not required since ENI IP addresses can be directly routed in the VPC. </span></span><br><span class="line"><span class="comment">## For the same reason, masquerading can be disabled as well.</span></span><br></pre></td></tr></table></figure></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-11-02T18:00:35.000Z" title="2024. 11. 3. 오전 3:00:35">2024-11-03</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-11-02T23:55:14.395Z" title="2024. 11. 3. 오전 8:55:14">2024-11-03</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/vpccni-vpccni/">vpccni/vpccni</a></span><span class="level-item">33 minutes read (About 4910 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/11/03/docs/vpccni/vpccni/">vpccni</a></h1><div class="content"><h2 id="AWS-VPC-CNI-소개"><a href="#AWS-VPC-CNI-소개" class="headerlink" title="AWS VPC CNI 소개"></a>AWS VPC CNI 소개</h2><p>기본정보 확인</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CNI 정보 확인</span></span><br><span class="line">kubectl describe daemonset aws-node --namespace kube-system | grep Image | <span class="built_in">cut</span> -d <span class="string">&quot;/&quot;</span> -f 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># kube-proxy config 확인 : 모드 iptables 사용 &gt;&gt; ipvs 모드 사용하지 않는 이유???</span></span><br><span class="line">kubectl describe cm -n kube-system kube-proxy-config</span><br><span class="line">...</span><br><span class="line">mode: <span class="string">&quot;iptables&quot;</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 노드 IP 확인</span></span><br><span class="line">aws ec2 describe-instances --query <span class="string">&quot;Reservations[*].Instances[*].&#123;PublicIPAdd:PublicIpAddress,PrivateIPAdd:PrivateIpAddress,InstanceName:Tags[?Key==&#x27;Name&#x27;]|[0].Value,Status:State.Name&#125;&quot;</span> --filters Name=instance-state-name,Values=running --output table</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------------------------------------------------------</span><br><span class="line">|                       DescribeInstances                       |</span><br><span class="line">+----------------+-----------------+-----------------+----------+</span><br><span class="line">|  InstanceName  |  PrivateIPAdd   |   PublicIPAdd   | Status   |</span><br><span class="line">+----------------+-----------------+-----------------+----------+</span><br><span class="line">|  myeks-ng1-Node|  192.168.2.165  |  54.181.2.113   |  running |</span><br><span class="line">|  myeks-ng1-Node|  192.168.3.238  |  3.35.49.101    |  running |</span><br><span class="line">|  myeks-bastion |  192.168.1.100  |  52.79.247.213  |  running |</span><br><span class="line">|  myeks-ng1-Node|  192.168.1.220  |  3.36.114.42    |  running |</span><br><span class="line">+----------------+-----------------+-----------------+----------+</span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 IP 확인</span></span><br><span class="line">kubectl get pod -n kube-system -o=custom-columns=NAME:.metadata.name,IP:.status.podIP,STATUS:.status.phase</span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 이름 확인</span></span><br><span class="line">kubectl get pod -A -o name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 갯수 확인</span></span><br><span class="line">kubectl get pod -A -o name | <span class="built_in">wc</span> -l</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CNI 정보 확인</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$N1</span> <span class="variable">$N2</span> <span class="variable">$N3</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; ssh ec2-user@<span class="variable">$i</span> tree /var/log/aws-routed-eni; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line">ssh ec2-user@<span class="variable">$N1</span> sudo <span class="built_in">cat</span> /var/log/aws-routed-eni/plugin.log | jq</span><br><span class="line">ssh ec2-user@<span class="variable">$N1</span> sudo <span class="built_in">cat</span> /var/log/aws-routed-eni/ipamd.log | jq</span><br><span class="line">ssh ec2-user@<span class="variable">$N1</span> sudo <span class="built_in">cat</span> /var/log/aws-routed-eni/egress-v6-plugin.log | jq</span><br><span class="line">ssh ec2-user@<span class="variable">$N1</span> sudo <span class="built_in">cat</span> /var/log/aws-routed-eni/ebpf-sdk.log | jq</span><br><span class="line">ssh ec2-user@<span class="variable">$N1</span> sudo <span class="built_in">cat</span> /var/log/aws-routed-eni/network-policy-agent.log | jq</span><br><span class="line"></span><br><span class="line"><span class="comment"># 네트워크 정보 확인 : eniY는 pod network 네임스페이스와 veth pair</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$N1</span> <span class="variable">$N2</span> <span class="variable">$N3</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; ssh ec2-user@<span class="variable">$i</span> sudo ip -br -c addr; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$N1</span> <span class="variable">$N2</span> <span class="variable">$N3</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; ssh ec2-user@<span class="variable">$i</span> sudo ip -c addr; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$N1</span> <span class="variable">$N2</span> <span class="variable">$N3</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; ssh ec2-user@<span class="variable">$i</span> sudo ip -c route; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line">ssh ec2-user@<span class="variable">$N1</span> sudo iptables -t nat -S</span><br><span class="line">ssh ec2-user@<span class="variable">$N1</span> sudo iptables -t nat -L -n -v</span><br></pre></td></tr></table></figure>







<h2 id="노드에서-기본-네트워크-정보-확인"><a href="#노드에서-기본-네트워크-정보-확인" class="headerlink" title="노드에서 기본 네트워크 정보 확인"></a>노드에서 기본 네트워크 정보 확인</h2><p>워커 노드1 기본 네트워크 구성</p>
<p><img src="/blog/img/vpccni-01.png"></p>
<ul>
<li>Network 네임스페이스는 호스트(Root)와 파드 별(Per Pod)로 구분된다</li>
<li>특정한 파드(kube-proxy, aws-node)는 호스트(Root)의 IP를 그대로 사용한다 ⇒ <strong>파드의 Host Network 옵션</strong></li>
<li>t3.medium 의 경우 ENI 마다 최대 6개의 IP를 가질 수 있다</li>
<li>ENI0, ENI1 으로 2개의 ENI는 자신의 IP 이외에 추가적으로 5개의 보조 프라이빗 IP를 가질수 있다</li>
<li>coredns 파드는 veth 으로 호스트에는 eniY@ifN 인터페이스와 파드에 eth0 과 연결되어</li>
</ul>
<h4 id="보조-IPv4-주소를-파드가-사용하는지-확인"><a href="#보조-IPv4-주소를-파드가-사용하는지-확인" class="headerlink" title="보조 IPv4 주소를 파드가 사용하는지 확인"></a>보조 IPv4 주소를 파드가 사용하는지 확인</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coredns 파드 IP 정보 확인</span></span><br><span class="line">kubectl get pod -n kube-system -l k8s-app=kube-dns -owide</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE   IP              NODE                                               NOMINATED NODE   READINESS GATES</span><br><span class="line">coredns-699d8c5988-pzsvc   1/1     Running   0          19m   192.168.1.181   ip-192-168-1-220.ap-northeast-2.compute.internal   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-699d8c5988-tcktg   1/1     Running   0          19m   192.168.3.153   ip-192-168-3-238.ap-northeast-2.compute.internal   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 노드의 라우팅 정보 확인 &gt;&gt; EC2 네트워크 정보의 &#x27;보조 프라이빗 IPv4 주소&#x27;와 비교해보자</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$N1</span> <span class="variable">$N2</span> <span class="variable">$N3</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; ssh ec2-user@<span class="variable">$i</span> sudo ip -c route; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>



<h4 id="테스트용-파드"><a href="#테스트용-파드" class="headerlink" title="테스트용 파드"></a>테스트용 파드</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 테스트용 파드 netshoot-pod 생성</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl apply -f -</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: netshoot-pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  replicas: 3</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: netshoot-pod</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: netshoot-pod</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - name: netshoot-pod</span></span><br><span class="line"><span class="string">        image: nicolaka/netshoot</span></span><br><span class="line"><span class="string">        command: [&quot;tail&quot;]</span></span><br><span class="line"><span class="string">        args: [&quot;-f&quot;, &quot;/dev/null&quot;]</span></span><br><span class="line"><span class="string">      terminationGracePeriodSeconds: 0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 이름 변수 지정</span></span><br><span class="line">PODNAME1=$(kubectl get pod -l app=netshoot-pod -o jsonpath=&#123;.items[0].metadata.name&#125;)</span><br><span class="line">PODNAME2=$(kubectl get pod -l app=netshoot-pod -o jsonpath=&#123;.items[1].metadata.name&#125;)</span><br><span class="line">PODNAME3=$(kubectl get pod -l app=netshoot-pod -o jsonpath=&#123;.items[2].metadata.name&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 확인</span></span><br><span class="line">kubectl get pod -o wide</span><br><span class="line">kubectl get pod -o=custom-columns=NAME:.metadata.name,IP:.status.podIP</span><br><span class="line"></span><br><span class="line"><span class="comment"># 노드에 라우팅 정보 확인</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$N1</span> <span class="variable">$N2</span> <span class="variable">$N3</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; ssh ec2-user@<span class="variable">$i</span> sudo ip -c route; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<ul>
<li>파드가 생성되면, <strong>워커 노드</strong>에 <strong>eniY@ifN</strong> <strong>추가</strong>되고 라우팅 테이블에도 정보가 추가된다</li>
<li>테스트용 파드 <strong>eniY 정보 확인</strong> - 워커 노드 EC2</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 노드3에서 네트워크 인터페이스 정보 확인</span></span><br><span class="line">ssh ec2-user@<span class="variable">$N3</span></span><br><span class="line">----------------</span><br><span class="line">ip -br -c addr show</span><br><span class="line">ip -c <span class="built_in">link</span></span><br><span class="line">ip -c addr</span><br><span class="line">ip route <span class="comment"># 혹은 route -n</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 마지막 생성된 네임스페이스 정보 출력 -t net(네트워크 타입)</span></span><br><span class="line">sudo lsns -o PID,COMMAND -t net | awk <span class="string">&#x27;NR&gt;2 &#123;print $1&#125;&#x27;</span> | <span class="built_in">tail</span> -n 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 마지막 생성된 네임스페이스 net PID 정보 출력 -t net(네트워크 타입)를 변수 지정</span></span><br><span class="line">MyPID=$(sudo lsns -o PID,COMMAND -t net | awk <span class="string">&#x27;NR&gt;2 &#123;print $1&#125;&#x27;</span> | <span class="built_in">tail</span> -n 1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># PID 정보로 파드 정보 확인</span></span><br><span class="line">sudo nsenter -t <span class="variable">$MyPID</span> -n ip -c addr</span><br><span class="line">sudo nsenter -t <span class="variable">$MyPID</span> -n ip -c route</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">----------------</span><br><span class="line"></span><br><span class="line">[ec2-user@ip-192-168-3-238 ~]$ sudo nsenter -t <span class="variable">$MyPID</span> -n ip -c addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: eth0@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc noqueue state UP group default</span><br><span class="line">    <span class="built_in">link</span>/ether 76:f6:91:af:2c:27 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 192.168.3.138/32 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::74f6:91ff:feaf:2c27/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[ec2-user@ip-192-168-3-238 ~]$ sudo nsenter -t <span class="variable">$MyPID</span> -n ip -c route</span><br><span class="line">default via 169.254.1.1 dev eth0</span><br><span class="line">169.254.1.1 dev eth0 scope <span class="built_in">link</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>테스트용 파드 접속(exec) 후 확인</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 테스트용 파드 접속(exec) 후 Shell 실행</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it <span class="variable">$PODNAME1</span> -- zsh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 아래부터는 pod-1 Shell 에서 실행 : 네트워크 정보 확인</span></span><br><span class="line">----------------------------</span><br><span class="line">ip -c addr</span><br><span class="line">ip -c route</span><br><span class="line">route -n</span><br><span class="line">ping -c 1 &lt;pod-2 IP&gt;</span><br><span class="line">ps</span><br><span class="line"><span class="built_in">cat</span> /etc/resolv.conf</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">----------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    dP            dP                           dP</span><br><span class="line">                    88            88                           88</span><br><span class="line">88d888b. .d8888b. d8888P .d8888b. 88d888b. .d8888b. .d8888b. d8888P</span><br><span class="line">88<span class="string">&#x27;  `88 88ooood8   88   Y8ooooo. 88&#x27;</span>  `88 88<span class="string">&#x27;  `88 88&#x27;</span>  `88   88</span><br><span class="line">88    88 88.  ...   88         88 88    88 88.  .88 88.  .88   88</span><br><span class="line">dP    dP `88888P<span class="string">&#x27;   dP   `88888P&#x27;</span> dP    dP `88888P<span class="string">&#x27; `88888P&#x27;</span>   dP</span><br><span class="line"></span><br><span class="line">Welcome to Netshoot! (github.com/nicolaka/netshoot)</span><br><span class="line">Version: 0.13</span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드2 Shell 실행</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it <span class="variable">$PODNAME2</span> -- ip -c addr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드3 Shell 실행</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it <span class="variable">$PODNAME3</span> -- ip -br -c addr</span><br></pre></td></tr></table></figure>













<h2 id="노드-간-파드-통신"><a href="#노드-간-파드-통신" class="headerlink" title="노드 간 파드 통신"></a>노드 간 파드 통신</h2><ul>
<li>파드간 통신 시 tcpdump 내용을 확인하고 통신 과정을 알아본다</li>
</ul>
<p>파드간 통신 흐름 : AWS VPC CNI 경우 별도의 오버레이(Overlay) 통신 기술 없이, VPC Native 하게 파드간 직접 통신이 가능하다</p>
<p><img src="/blog/img/vpccni-02.png"></p>
<h4 id="파드간-통신-테스트-및-확인"><a href="#파드간-통신-테스트-및-확인" class="headerlink" title="파드간 통신 테스트 및 확인"></a>파드간 통신 테스트 및 확인</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 파드 IP 변수 지정</span></span><br><span class="line">PODIP1=$(kubectl get pod -l app=netshoot-pod -o jsonpath=&#123;.items[0].status.podIP&#125;)</span><br><span class="line">PODIP2=$(kubectl get pod -l app=netshoot-pod -o jsonpath=&#123;.items[1].status.podIP&#125;)</span><br><span class="line">PODIP3=$(kubectl get pod -l app=netshoot-pod -o jsonpath=&#123;.items[2].status.podIP&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드1 Shell 에서 파드2로 ping 테스트</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it <span class="variable">$PODNAME1</span> -- ping -c 2 <span class="variable">$PODIP2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드2 Shell 에서 파드3로 ping 테스트</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it <span class="variable">$PODNAME2</span> -- ping -c 2 <span class="variable">$PODIP3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드3 Shell 에서 파드1로 ping 테스트</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it <span class="variable">$PODNAME3</span> -- ping -c 2 <span class="variable">$PODIP1</span></span><br><span class="line"></span><br><span class="line">**<span class="comment"># 워커 노드 EC2 :** TCPDUMP 확인</span></span><br><span class="line"><span class="comment">## For Pod to external (outside VPC) traffic, we will program iptables to SNAT using Primary IP address on the Primary ENI.</span></span><br><span class="line">sudo tcpdump -i **any** -nn icmp</span><br><span class="line">sudo tcpdump -i **eth1** -nn icmp</span><br><span class="line">sudo tcpdump -i **eth0** -nn icmp</span><br><span class="line">sudo tcpdump -i **eniYYYYYYYY** -nn icmp</span><br><span class="line"></span><br><span class="line">[워커 노드1]</span><br><span class="line"><span class="comment"># routing policy database management 확인</span></span><br><span class="line">ip rule</span><br><span class="line"></span><br><span class="line"><span class="comment"># routing table management 확인</span></span><br><span class="line">ip route show table <span class="built_in">local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 디폴트 네트워크 정보를 eth0 을 통해서 빠져나간다</span></span><br><span class="line"><span class="comment"># ip route show table main</span></span><br><span class="line">default via 192.168.1.1 dev eth0</span><br><span class="line">169.254.169.254 dev eth0</span><br><span class="line">172.17.0.0/16 dev docker0 proto kernel scope <span class="built_in">link</span> src 172.17.0.1 linkdown</span><br><span class="line">192.168.1.0/24 dev eth0 proto kernel scope <span class="built_in">link</span> src 192.168.1.100</span><br></pre></td></tr></table></figure>







<h2 id="파드에서-외부-통신"><a href="#파드에서-외부-통신" class="headerlink" title="파드에서 외부 통신"></a>파드에서 외부 통신</h2><p>파드에서 외부 통신 흐름 : iptable 에 SNAT 을 통하여 노드의 eth0 IP로 변경되어서 외부와 통신됨</p>
<p><img src="/blog/img/vpccni-03.png"></p>
<p>VPC CNI 의 External source network address translation (SNAT) 설정에 따라, 외부(인터넷) 통신 시 SNAT 하거나 혹은 SNAT 없이 통신을 할 수 있다 - <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/eks/latest/userguide/external-snat.html">링크</a></p>
<h4 id="파드에서-외부-통신-테스트-및-확인"><a href="#파드에서-외부-통신-테스트-및-확인" class="headerlink" title="파드에서 외부 통신 테스트 및 확인"></a>파드에서 외부 통신 테스트 및 확인</h4><ul>
<li>파드 shell 실행 후 외부로 ping 테스트 &amp; 워커 노드에서 tcpdump 및 iptables 정보 확인</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 작업용 EC2 : pod-1 Shell 에서 외부로 ping</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it <span class="variable">$PODNAME1</span> -- ping -c 1 www.google.com</span><br><span class="line">kubectl <span class="built_in">exec</span> -it <span class="variable">$PODNAME1</span> -- ping -i 0.1 www.google.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 워커 노드 EC2 : TCPDUMP 확인</span></span><br><span class="line">sudo tcpdump -i any -nn icmp</span><br><span class="line">sudo tcpdump -i eth0 -nn icmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 작업용 EC2 : 퍼블릭IP 확인</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$N1</span> <span class="variable">$N2</span> <span class="variable">$N3</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; ssh ec2-user@<span class="variable">$i</span> curl -s ipinfo.io/ip; <span class="built_in">echo</span>; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 작업용 EC2 : pod-1 Shell 에서 외부 접속 확인 - 공인IP는 어떤 주소인가?</span></span><br><span class="line"><span class="comment">## The right way to check the weather - 링크</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$PODNAME1</span> <span class="variable">$PODNAME2</span> <span class="variable">$PODNAME3</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; Pod : <span class="variable">$i</span> &lt;&lt;&quot;</span>; kubectl <span class="built_in">exec</span> -it <span class="variable">$i</span> -- curl -s ipinfo.io/ip; <span class="built_in">echo</span>; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it <span class="variable">$PODNAME1</span> -- curl -s wttr.in/seoul</span><br><span class="line"></span><br><span class="line">Weather report: seoul</span><br><span class="line"></span><br><span class="line">      \   /     Clear</span><br><span class="line">       .-.      13 °C</span><br><span class="line">    ― (   ) ―   ↙ 4 km/h</span><br><span class="line">       `-’      10 km</span><br><span class="line">      /   \     0.0 mm</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">kubectl <span class="built_in">exec</span> -it <span class="variable">$PODNAME1</span> -- curl -s wttr.in/seoul?format=3</span><br><span class="line">kubectl <span class="built_in">exec</span> -it <span class="variable">$PODNAME1</span> -- curl -s wttr.in/Moon</span><br><span class="line">kubectl <span class="built_in">exec</span> -it <span class="variable">$PODNAME1</span> -- curl -s wttr.in/:<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 워커 노드 EC2</span></span><br><span class="line"><span class="comment">## 출력된 결과를 보고 어떻게 빠져나가는지 고민해보자!</span></span><br><span class="line">ip rule</span><br><span class="line">ip route show table main</span><br><span class="line">sudo iptables -L -n -v -t nat</span><br><span class="line">sudo iptables -t nat -S</span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드가 외부와 통신시에는 아래 처럼 &#x27;AWS-SNAT-CHAIN-0&#x27; 룰(rule)에 의해서 SNAT 되어서 외부와 통신!</span></span><br><span class="line"><span class="comment"># 참고로 뒤 IP는 eth0(ENI 첫번째)의 IP 주소이다</span></span><br><span class="line"><span class="comment"># --random-fully 동작 - 링크1  링크2</span></span><br><span class="line">sudo iptables -t nat -S | grep <span class="string">&#x27;A AWS-SNAT-CHAIN&#x27;</span></span><br><span class="line">-A AWS-SNAT-CHAIN-0 ! -d 192.168.0.0/16 -m comment --comment <span class="string">&quot;AWS SNAT CHAIN&quot;</span> -j RETURN</span><br><span class="line">-A AWS-SNAT-CHAIN-0 ! -o vlan+ -m comment --comment <span class="string">&quot;AWS, SNAT&quot;</span> -m addrtype ! --dst-type LOCAL -j SNAT --to-source 192.168.1.251 --random-fully</span><br><span class="line"></span><br><span class="line"><span class="comment">## 아래 &#x27;mark 0x4000/0x4000&#x27; 매칭되지 않아서 RETURN 됨!</span></span><br><span class="line">-A KUBE-POSTROUTING -m mark ! --mark 0x4000/0x4000 -j RETURN</span><br><span class="line">-A KUBE-POSTROUTING -j MARK --set-xmark 0x4000/0x0</span><br><span class="line">-A KUBE-POSTROUTING -m comment --comment <span class="string">&quot;kubernetes service traffic requiring SNAT&quot;</span> -j MASQUERADE --random-fully</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 카운트 확인 시 AWS-SNAT-CHAIN-0에 매칭되어, 목적지가 192.168.0.0/16 아니고 외부 빠져나갈때 SNAT 192.168.1.251(EC2 노드1 IP) 변경되어 나간다!</span></span><br><span class="line">sudo iptables -t filter --zero; sudo iptables -t nat --zero; sudo iptables -t mangle --zero; sudo iptables -t raw --zero</span><br><span class="line">watch -d <span class="string">&#x27;sudo iptables -v --numeric --table nat --list AWS-SNAT-CHAIN-0; echo ; sudo iptables -v --numeric --table nat --list KUBE-POSTROUTING; echo ; sudo iptables -v --numeric --table nat --list POSTROUTING&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># conntrack 확인</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$N1</span> <span class="variable">$N2</span> <span class="variable">$N3</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; ssh ec2-user@<span class="variable">$i</span> sudo conntrack -L -n |grep -v <span class="string">&#x27;169.254.169&#x27;</span>; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line">conntrack v1.4.5 (conntrack-tools): </span><br><span class="line">icmp     1 28 src=172.30.66.58 dst=8.8.8.8 <span class="built_in">type</span>=8 code=0 <span class="built_in">id</span>=34392 src=8.8.8.8 dst=172.30.85.242 <span class="built_in">type</span>=0 code=0 <span class="built_in">id</span>=50705 mark=128 use=1</span><br><span class="line">tcp      6 23 TIME_WAIT src=172.30.66.58 dst=34.117.59.81 sport=58144 dport=80 src=34.117.59.81 dst=172.30.85.242 sport=80 dport=44768 [ASSURED] mark=128 use=1</span><br></pre></td></tr></table></figure>



<p>자원 삭제</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete deploy netshoot-pod</span><br></pre></td></tr></table></figure>







<h2 id="노드에-파드-생성-갯수-제한"><a href="#노드에-파드-생성-갯수-제한" class="headerlink" title="노드에 파드 생성 갯수 제한"></a>노드에 파드 생성 갯수 제한</h2><p>사전 준비 : kube-ops-view 설치</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kube-ops-view</span></span><br><span class="line">helm repo add geek-cookbook https://geek-cookbook.github.io/charts/</span><br><span class="line">helm install kube-ops-view geek-cookbook/kube-ops-view --version 1.2.2 --<span class="built_in">set</span> service.main.type=LoadBalancer --<span class="built_in">set</span> env.TZ=<span class="string">&quot;Asia/Seoul&quot;</span> --namespace kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># kube-ops-view 접속 URL 확인 (1.5 배율)</span></span><br><span class="line">kubectl get svc -n kube-system kube-ops-view -o jsonpath=&#123;.status.loadBalancer.ingress[0].hostname&#125; | awk <span class="string">&#x27;&#123; print &quot;KUBE-OPS-VIEW URL = http://&quot;$1&quot;:8080/#scale=1.5&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>워커 노드의 인스턴스 타입 별 파드 생성 갯수 제한<ul>
<li><strong>인스턴스 타입</strong> 별 ENI 최대 갯수와 할당 가능한 최대 IP 갯수에 따라서 파드 배치 갯수가 결정됨</li>
<li>단, aws-node 와 kube-proxy 파드는 호스트의 IP를 사용함으로 최대 갯수에서 제외함</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># t3 타입의 정보(필터) 확인</span></span><br><span class="line">aws ec2 describe-instance-types --filters Name=instance-type,Values=t3.* \</span><br><span class="line"> --query <span class="string">&quot;InstanceTypes[].&#123;Type: InstanceType, MaxENI: NetworkInfo.MaximumNetworkInterfaces, IPv4addr: NetworkInfo.Ipv4AddressesPerInterface&#125;&quot;</span> \</span><br><span class="line"> --output table</span><br><span class="line">--------------------------------------</span><br><span class="line">|        DescribeInstanceTypes       |</span><br><span class="line">+----------+----------+--------------+</span><br><span class="line">| IPv4addr | MaxENI   |    Type      |</span><br><span class="line">+----------+----------+--------------+</span><br><span class="line">|  15      |  4       |  t3.2xlarge  |</span><br><span class="line">|  6       |  3       |  t3.medium   |</span><br><span class="line">|  12      |  3       |  t3.large    |</span><br><span class="line">|  15      |  4       |  t3.xlarge   |</span><br><span class="line">|  2       |  2       |  t3.micro    |</span><br><span class="line">|  2       |  2       |  t3.nano     |</span><br><span class="line">|  4       |  3       |  t3.small    |</span><br><span class="line">+----------+----------+--------------+</span><br><span class="line"></span><br><span class="line"><span class="comment"># c5 타입의 정보(필터) 확인</span></span><br><span class="line">aws ec2 describe-instance-types --filters Name=instance-type,Values=c5*.* \</span><br><span class="line"> --query <span class="string">&quot;InstanceTypes[].&#123;Type: InstanceType, MaxENI: NetworkInfo.MaximumNetworkInterfaces, IPv4addr: NetworkInfo.Ipv4AddressesPerInterface&#125;&quot;</span> \</span><br><span class="line"> --output table</span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 사용 가능 계산 예시 : aws-node 와 kube-proxy 파드는 host-networking 사용으로 IP 2개 남음</span></span><br><span class="line">((MaxENI * (IPv4addr-<span class="number">1</span>)) + 2)</span><br><span class="line">t3.medium 경우 : ((<span class="number">3</span> * (<span class="number">6</span> - <span class="number">1</span>) + <span class="number">2</span> ) = <span class="number">17</span>개 &gt;&gt; aws-node 와 kube-proxy <span class="number">2</span>개 제외하면 <span class="number">15</span>개</span><br><span class="line"></span><br><span class="line"># 워커노드 상세 정보 확인 : 노드 상세 정보의 Allocatable 에 pods 에 <span class="number">17</span>개 정보 확인</span><br><span class="line">kubectl describe node | grep Allocatable: -A6</span><br><span class="line">Allocatable:</span><br><span class="line">  cpu:                         <span class="number">1930</span>m</span><br><span class="line">  ephemeral-storage:           <span class="number">27905944324</span></span><br><span class="line">  hugepages-<span class="number">1</span>Gi:               <span class="number">0</span></span><br><span class="line">  hugepages-<span class="number">2</span>Mi:               <span class="number">0</span></span><br><span class="line">  memory:                      <span class="number">3388360</span>Ki</span><br><span class="line">  pods:                        <span class="number">17</span></span><br></pre></td></tr></table></figure>



<p>최대 파드 생성 및 확인</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 워커 노드 EC2 - 모니터링</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> ip -br -c addr show &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;--------------&quot;</span> ; <span class="built_in">date</span> <span class="string">&quot;+%Y-%m-%d %H:%M:%S&quot;</span> ; <span class="built_in">sleep</span> 1; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 작업용 EC2 - 터미널1</span></span><br><span class="line">watch -d <span class="string">&#x27;kubectl get pods -o wide&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 작업용 EC2 - 터미널2</span></span><br><span class="line"><span class="comment"># 디플로이먼트 생성</span></span><br><span class="line">curl -s -O https://raw.githubusercontent.com/gasida/PKOS/main/2/nginx-dp.yaml</span><br><span class="line">kubectl apply -f nginx-dp.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 확인</span></span><br><span class="line">kubectl get pod -o wide</span><br><span class="line">kubectl get pod -o=custom-columns=NAME:.metadata.name,IP:.status.podIP</span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 증가 테스트 &gt;&gt; 파드 정상 생성 확인, 워커 노드에서 eth, eni 갯수 확인</span></span><br><span class="line">kubectl scale deployment nginx-deployment --replicas=8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 증가 테스트 &gt;&gt; 파드 정상 생성 확인, 워커 노드에서 eth, eni 갯수 확인 &gt;&gt; 어떤일이 벌어졌는가?</span></span><br><span class="line">kubectl scale deployment nginx-deployment --replicas=15</span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 증가 테스트 &gt;&gt; 파드 정상 생성 확인, 워커 노드에서 eth, eni 갯수 확인 &gt;&gt; 어떤일이 벌어졌는가?</span></span><br><span class="line">kubectl scale deployment nginx-deployment --replicas=30</span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 증가 테스트 &gt;&gt; 파드 정상 생성 확인, 워커 노드에서 eth, eni 갯수 확인 &gt;&gt; 어떤일이 벌어졌는가?</span></span><br><span class="line">kubectl scale deployment nginx-deployment --replicas=50</span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 생성 실패!</span></span><br><span class="line">(Administrator@myeks:N/A) [root@myeks-bastion ~]<span class="comment"># k get pod | grep Pending</span></span><br><span class="line">nginx-deployment-6f999cfffb-5j7s4   0/1     Pending   0          22s</span><br><span class="line">nginx-deployment-6f999cfffb-9q67j   0/1     Pending   0          22s</span><br><span class="line">nginx-deployment-6f999cfffb-hknjj   0/1     Pending   0          22s</span><br><span class="line">nginx-deployment-6f999cfffb-l7l6d   0/1     Pending   0          22s</span><br><span class="line">nginx-deployment-6f999cfffb-mz592   0/1     Pending   0          22s</span><br><span class="line">nginx-deployment-6f999cfffb-rspw4   0/1     Pending   0          22s</span><br><span class="line">nginx-deployment-6f999cfffb-rxpzj   0/1     Pending   0          22s</span><br><span class="line">nginx-deployment-6f999cfffb-vv8bm   0/1     Pending   0          22s</span><br><span class="line"></span><br><span class="line">(Administrator@myeks:N/A) [root@myeks-bastion ~]<span class="comment"># k describe pod nginx-deployment-6f999cfffb-5j7s4 | grep Events: -A5</span></span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            Age   From               Message</span><br><span class="line">  ----     ------            ----  ----               -------</span><br><span class="line">  Warning  FailedScheduling  60s   default-scheduler  0/3 nodes are available: 3 Too many pods. preemption: 0/3 nodes are available: 3 No preemption victims found <span class="keyword">for</span> incoming pod.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 디플로이먼트 삭제</span></span><br><span class="line">kubectl delete deploy nginx-deployment</span><br></pre></td></tr></table></figure>





<h5 id="해결-방안-Prefix-Delegation-WARM-amp-MIN-IP-x2F-Prefix-Targets-Custom-Network"><a href="#해결-방안-Prefix-Delegation-WARM-amp-MIN-IP-x2F-Prefix-Targets-Custom-Network" class="headerlink" title="해결 방안 : Prefix Delegation, WARM &amp; MIN IP&#x2F;Prefix Targets, Custom Network"></a>해결 방안 : Prefix Delegation, WARM &amp; MIN IP&#x2F;Prefix Targets, Custom Network</h5><p><img src="/blog/img/vpccni-04.png"></p>
<h2 id="Service-amp-AWS-LoadBalancer-Controller"><a href="#Service-amp-AWS-LoadBalancer-Controller" class="headerlink" title="Service &amp; AWS LoadBalancer Controller"></a>Service &amp; AWS LoadBalancer Controller</h2><blockquote>
<p><strong>서비스 종류</strong></p>
</blockquote>
<p><code>ClusterIP</code> <strong>타입</strong></p>
<p><img src="/blog/img/vpccni-05.png"></p>
<p><code>NodePort</code> <strong>타입</strong></p>
<p><img src="/blog/img/vpccni-06.png"></p>
<p><code>LoadBalancer</code> <strong>타입 (기본 모드) : NLB 인스턴스 유형</strong></p>
<p><img src="/blog/img/vpccni-07.png"></p>
<p><code>Service (LoadBalancer Controller</code>) : <strong>AWS Load Balancer Controller</strong> + <strong>NLB</strong> <strong>IP 모드</strong> 동작 with <strong>AWS VPC CNI</strong></p>
<p><img src="/blog/img/vpccni-08.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NLB 모드 전체 정리</span><br></pre></td></tr></table></figure>

<ol>
<li><p><strong>인스턴스 유형</strong></p>
<p><img src="/blog/img/vpccni-09.png"></p>
<ol>
<li><code>externalTrafficPolicy</code> : ClusterIP ⇒ 2번 분산 및 SNAT으로 Client IP 확인 불가능 ← <code>LoadBalancer</code> 타입 (기본 모드) 동작</li>
<li><code>externalTrafficPolicy</code> : Local ⇒ 1번 분산 및 ClientIP 유지, 워커 노드의 iptables 사용함</li>
</ol>
<ul>
<li><p>상세 설명</p>
<p><strong>통신 흐름</strong></p>
<p><strong>요약</strong> : 외부 클라이언트가 ‘로드밸런서’ 접속 시 부하분산 되어 노드 도달 후 iptables 룰로 목적지 파드와 통신됨</p>
<ul>
<li>노드는 외부에 공개되지 않고 로드밸런서만 외부에 공개되어, 외부 클라이언트는 로드밸랜서에 접속을 할 뿐 내부 노드의 정보를 알 수 없다</li>
<li>로드밸런서가 부하분산하여 파드가 존재하는 노드들에게 전달한다, iptables 룰에서는 자신의 노드에 있는 파드만 연결한다 (<code>externalTrafficPolicy: local</code>)</li>
<li>DNAT 2번 동작 : 첫번째(로드밸런서 접속 후 빠져 나갈때), 두번째(노드의 iptables 룰에서 파드IP 전달 시)</li>
<li>외부 클라이언트 IP 보존(유지) : AWS NLB 는 <strong>타켓</strong>이 <strong>인스턴스</strong>일 경우 클라이언트 IP를 유지, iptables 룰 경우도 <code>externalTrafficPolicy</code> 로 클라이언트 IP를 보존</li>
</ul>
<p><strong>부하분산 최적화</strong> : 노드에 파드가 없을 경우 ‘로드밸런서’에서 노드에 헬스 체크(상태 검사)가 실패하여 해당 노드로는 외부 요청 트래픽을 전달하지 않는다</p>
<p>3번째 인스턴스(Node3)은 상태 확인 실패로 외부 요청 트래픽 전달하지 않는다</p>
</li>
</ul>
</li>
<li><p><strong>IP 유형 ⇒ 반드시 AWS LoadBalancer 컨트롤러 파드 및 정책 설정이 필요함!</strong></p>
<p><img src="/blog/img/vpccni-10.png"></p>
<ol>
<li><code>Proxy Protocol v2 비활성화</code> ⇒ NLB에서 바로 파드로 인입, 단 ClientIP가 NLB로 SNAT 되어 Client IP 확인 불가능</li>
<li><code>Proxy Protocol v2 활성화</code> ⇒ NLB에서 바로 파드로 인입 및 ClientIP 확인 가능(→ 단 PPv2 를 애플리케이션이 인지할 수 있게 설정 필요)</li>
</ol>
</li>
</ol>
<p>AWS LoadBalancer Controller 배포 - <a target="_blank" rel="noopener" href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/latest/deploy/installation/">Link</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Helm Chart 설치</span></span><br><span class="line">helm repo add eks https://aws.github.io/eks-charts</span><br><span class="line">helm repo update</span><br><span class="line">helm install aws-load-balancer-controller eks/aws-load-balancer-controller -n kube-system --<span class="built_in">set</span> clusterName=<span class="variable">$CLUSTER_NAME</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 설치 확인</span></span><br><span class="line">kubectl get crd</span><br><span class="line">kubectl get deployment -n kube-system aws-load-balancer-controller</span><br><span class="line">kubectl describe deploy -n kube-system aws-load-balancer-controller</span><br><span class="line">kubectl describe deploy -n kube-system aws-load-balancer-controller | grep <span class="string">&#x27;Service Account&#x27;</span></span><br><span class="line">  Service Account:  aws-load-balancer-controller</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 클러스터롤, 롤 확인</span></span><br><span class="line">kubectl describe clusterrolebindings.rbac.authorization.k8s.io aws-load-balancer-controller-rolebinding</span><br><span class="line">kubectl describe clusterroles.rbac.authorization.k8s.io aws-load-balancer-controller-role</span><br><span class="line">...</span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources                                     Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------                                     -----------------  --------------  -----</span><br><span class="line">  targetgroupbindings.elbv2.k8s.aws             []                 []              [create delete get list patch update watch]</span><br><span class="line">  events                                        []                 []              [create patch]</span><br><span class="line">  ingresses                                     []                 []              [get list patch update watch]</span><br><span class="line">  services                                      []                 []              [get list patch update watch]</span><br><span class="line">  ingresses.extensions                          []                 []              [get list patch update watch]</span><br><span class="line">  services.extensions                           []                 []              [get list patch update watch]</span><br><span class="line">  ingresses.networking.k8s.io                   []                 []              [get list patch update watch]</span><br><span class="line">  services.networking.k8s.io                    []                 []              [get list patch update watch]</span><br><span class="line">  endpoints                                     []                 []              [get list watch]</span><br><span class="line">  namespaces                                    []                 []              [get list watch]</span><br><span class="line">  nodes                                         []                 []              [get list watch]</span><br><span class="line">  pods                                          []                 []              [get list watch]</span><br><span class="line">  endpointslices.discovery.k8s.io               []                 []              [get list watch]</span><br><span class="line">  ingressclassparams.elbv2.k8s.aws              []                 []              [get list watch]</span><br><span class="line">  ingressclasses.networking.k8s.io              []                 []              [get list watch]</span><br><span class="line">  ingresses/status                              []                 []              [update patch]</span><br><span class="line">  pods/status                                   []                 []              [update patch]</span><br><span class="line">  services/status                               []                 []              [update patch]</span><br><span class="line">  targetgroupbindings/status                    []                 []              [update patch]</span><br><span class="line">  ingresses.elbv2.k8s.aws/status                []                 []              [update patch]</span><br><span class="line">  pods.elbv2.k8s.aws/status                     []                 []              [update patch]</span><br><span class="line">  services.elbv2.k8s.aws/status                 []                 []              [update patch]</span><br><span class="line">  targetgroupbindings.elbv2.k8s.aws/status      []                 []              [update patch]</span><br><span class="line">  ingresses.extensions/status                   []                 []              [update patch]</span><br><span class="line">  pods.extensions/status                        []                 []              [update patch]</span><br><span class="line">  services.extensions/status                    []                 []              [update patch]</span><br><span class="line">  targetgroupbindings.extensions/status         []                 []              [update patch]</span><br><span class="line">  ingresses.networking.k8s.io/status            []                 []              [update patch]</span><br><span class="line">  pods.networking.k8s.io/status                 []                 []              [update patch]</span><br><span class="line">  services.networking.k8s.io/status             []                 []              [update patch]</span><br><span class="line">  targetgroupbindings.networking.k8s.io/status  []                 []              [update patch]</span><br></pre></td></tr></table></figure>



<p>서비스&#x2F;파드 배포 테스트 with NLB - <a target="_blank" rel="noopener" href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.4/guide/service/nlb/">링크</a> <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/eks/latest/userguide/network-load-balancing.html">NLB</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 모니터링</span></span><br><span class="line">watch -d kubectl get pod,svc,ep</span><br><span class="line"></span><br><span class="line"><span class="comment"># 작업용 EC2 - 디플로이먼트 &amp; 서비스 생성</span></span><br><span class="line">curl -s -O https://raw.githubusercontent.com/gasida/PKOS/main/2/echo-service-nlb.yaml</span><br><span class="line"><span class="built_in">cat</span> echo-service-nlb.yaml</span><br><span class="line">kubectl apply -f echo-service-nlb.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인</span></span><br><span class="line">kubectl get deploy,pod</span><br><span class="line">kubectl get svc,ep,ingressclassparams,targetgroupbindings</span><br><span class="line">kubectl get targetgroupbindings -o json | jq</span><br><span class="line"></span><br><span class="line"><span class="comment"># (옵션) 빠른 실습을 위해서 등록 취소 지연(드레이닝 간격) 수정 : 기본값 300초</span></span><br><span class="line">vi echo-service-nlb.yaml</span><br><span class="line">..</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: svc-nlb-ip-type</span><br><span class="line">  annotations:</span><br><span class="line">    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip</span><br><span class="line">    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing</span><br><span class="line">    service.beta.kubernetes.io/aws-load-balancer-healthcheck-port: <span class="string">&quot;8080&quot;</span></span><br><span class="line">    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: <span class="string">&quot;true&quot;</span></span><br><span class="line">    service.beta.kubernetes.io/aws-load-balancer-target-group-attributes: deregistration_delay.timeout_seconds=60</span><br><span class="line">...</span><br><span class="line">:wq!</span><br><span class="line">kubectl apply -f echo-service-nlb.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># AWS ELB(NLB) 정보 확인</span></span><br><span class="line">aws elbv2 describe-load-balancers | jq</span><br><span class="line">aws elbv2 describe-load-balancers --query <span class="string">&#x27;LoadBalancers[*].State.Code&#x27;</span> --output text</span><br><span class="line">ALB_ARN=$(aws elbv2 describe-load-balancers --query <span class="string">&#x27;LoadBalancers[?contains(LoadBalancerName, `k8s-default-svcnlbip`) == `true`].LoadBalancerArn&#x27;</span> | jq -r <span class="string">&#x27;.[0]&#x27;</span>)</span><br><span class="line">aws elbv2 describe-target-groups --load-balancer-arn <span class="variable">$ALB_ARN</span> | jq</span><br><span class="line">TARGET_GROUP_ARN=$(aws elbv2 describe-target-groups --load-balancer-arn <span class="variable">$ALB_ARN</span> | jq -r <span class="string">&#x27;.TargetGroups[0].TargetGroupArn&#x27;</span>)</span><br><span class="line">aws elbv2 describe-target-health --target-group-arn <span class="variable">$TARGET_GROUP_ARN</span> | jq</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;TargetHealthDescriptions&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;Target&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;192.168.2.153&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Port&quot;</span>: 8080,</span><br><span class="line">        <span class="string">&quot;AvailabilityZone&quot;</span>: <span class="string">&quot;ap-northeast-2b&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;HealthCheckPort&quot;</span>: <span class="string">&quot;8080&quot;</span>,</span><br><span class="line">      <span class="string">&quot;TargetHealth&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;State&quot;</span>: <span class="string">&quot;initial&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Reason&quot;</span>: <span class="string">&quot;Elb.RegistrationInProgress&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Description&quot;</span>: <span class="string">&quot;Target registration is in progress&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 웹 접속 주소 확인</span></span><br><span class="line">kubectl get svc svc-nlb-ip-type -o jsonpath=&#123;.status.loadBalancer.ingress[0].hostname&#125; | awk <span class="string">&#x27;&#123; print &quot;Pod Web URL = http://&quot;$1 &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 로깅 모니터링</span></span><br><span class="line">kubectl logs -l app=deploy-websrv -f</span><br><span class="line"></span><br><span class="line"><span class="comment"># 분산 접속 확인</span></span><br><span class="line">NLB=$(kubectl get svc svc-nlb-ip-type -o jsonpath=&#123;.status.loadBalancer.ingress[0].hostname&#125;)</span><br><span class="line">curl -s <span class="variable">$NLB</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;; <span class="keyword">do</span> curl -s <span class="variable">$NLB</span> | grep Hostname ; <span class="keyword">done</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br><span class="line">  52 Hostname: deploy-echo-55456fc798-2w65p</span><br><span class="line">  48 Hostname: deploy-echo-55456fc798-cxl7z</span><br><span class="line"></span><br><span class="line"><span class="comment"># 지속적인 접속 시도 : 아래 상세 동작 확인 시 유용(패킷 덤프 등)</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> curl -s --connect-timeout 1 <span class="variable">$NLB</span> | egrep <span class="string">&#x27;Hostname|client_address&#x27;</span>; <span class="built_in">echo</span> <span class="string">&quot;----------&quot;</span> ; <span class="built_in">date</span> <span class="string">&quot;+%Y-%m-%d %H:%M:%S&quot;</span> ; <span class="built_in">sleep</span> 1; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<ul>
<li>AWS NLB의 대상 그룹 확인 : IP를 확인해보자</li>
<li>파드 2개 → 1개 → 3개 설정 시 동작 : auto discovery ← 어떻게 가능할까?</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (신규 터미널) 모니터링</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> aws elbv2 describe-target-health --target-group-arn <span class="variable">$TARGET_GROUP_ARN</span> --output text; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 작업용 EC2 - 파드 1개 설정 </span></span><br><span class="line">kubectl scale deployment deploy-echo --replicas=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인</span></span><br><span class="line">kubectl get deploy,pod,svc,ep</span><br><span class="line">curl -s <span class="variable">$NLB</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;; <span class="keyword">do</span> curl -s --connect-timeout 1 <span class="variable">$NLB</span> | grep Hostname ; <span class="keyword">done</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 작업용 EC2 - 파드 3개 설정 </span></span><br><span class="line">kubectl scale deployment deploy-echo --replicas=3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인 : NLB 대상 타켓이 아직 initial 일 때 100번 반복 접속 시 어떻게 되는지 확인해보자!</span></span><br><span class="line">kubectl get deploy,pod,svc,ep</span><br><span class="line">curl -s <span class="variable">$NLB</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;; <span class="keyword">do</span> curl -s --connect-timeout 1 <span class="variable">$NLB</span> | grep Hostname ; <span class="keyword">done</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">kubectl describe deploy -n kube-system aws-load-balancer-controller | grep -i <span class="string">&#x27;Service Account&#x27;</span></span><br><span class="line">  Service Account:  aws-load-balancer-controller</span><br><span class="line"></span><br><span class="line"><span class="comment"># [AWS LB Ctrl] 클러스터 롤 바인딩 정보 확인</span></span><br><span class="line">kubectl describe clusterrolebindings.rbac.authorization.k8s.io aws-load-balancer-controller-rolebinding</span><br><span class="line"></span><br><span class="line"><span class="comment"># [AWS LB Ctrl] 클러스터롤 확인 </span></span><br><span class="line">kubectl describe clusterroles.rbac.authorization.k8s.io aws-load-balancer-controller-role</span><br></pre></td></tr></table></figure>

















<h2 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h2><p><code>인그레스 소개</code> : 클러스터 내부의 서비스(ClusterIP, NodePort, Loadbalancer)를 외부로 노출(<strong>HTTP&#x2F;HTTPS</strong>) - Web Proxy 역할</p>
<p><strong>AWS Load Balancer Controller</strong> + <strong>Ingress (ALB) IP 모드</strong> 동작 with <strong>AWS VPC CNI</strong></p>
<p><img src="/blog/img/vpccni-11.png"></p>
<p>서비스&#x2F;파드 배포 테스트 with Ingress(ALB) - <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/eks/latest/userguide/alb-ingress.html">ALB</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 게임 파드와 Service, Ingress 배포</span></span><br><span class="line">curl -s -O https://raw.githubusercontent.com/gasida/PKOS/main/3/ingress1.yaml</span><br><span class="line"><span class="built_in">cat</span> ingress1.yaml</span><br><span class="line">kubectl apply -f ingress1.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 모니터링</span></span><br><span class="line">watch -d kubectl get pod,ingress,svc,ep -n game-2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># 생성 확인</span></span><br><span class="line">kubectl get-all -n game-2048</span><br><span class="line">kubectl get ingress,svc,ep,pod -n game-2048</span><br><span class="line">kubectl get targetgroupbindings -n game-2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># ALB 생성 확인</span></span><br><span class="line">aws elbv2 describe-load-balancers --query <span class="string">&#x27;LoadBalancers[?contains(LoadBalancerName, `k8s-game2048`) == `true`]&#x27;</span> | jq</span><br><span class="line">ALB_ARN=$(aws elbv2 describe-load-balancers --query <span class="string">&#x27;LoadBalancers[?contains(LoadBalancerName, `k8s-game2048`) == `true`].LoadBalancerArn&#x27;</span> | jq -r <span class="string">&#x27;.[0]&#x27;</span>)</span><br><span class="line">aws elbv2 describe-target-groups --load-balancer-arn <span class="variable">$ALB_ARN</span></span><br><span class="line">TARGET_GROUP_ARN=$(aws elbv2 describe-target-groups --load-balancer-arn <span class="variable">$ALB_ARN</span> | jq -r <span class="string">&#x27;.TargetGroups[0].TargetGroupArn&#x27;</span>)</span><br><span class="line">aws elbv2 describe-target-health --target-group-arn <span class="variable">$TARGET_GROUP_ARN</span> | jq</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ingress 확인</span></span><br><span class="line">kubectl describe ingress -n game-2048 ingress-2048</span><br><span class="line">kubectl get ingress -n game-2048 ingress-2048 -o jsonpath=<span class="string">&quot;&#123;.status.loadBalancer.ingress[*].hostname&#125;&#123;&#x27;\n&#x27;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 게임 접속 : ALB 주소로 웹 접속</span></span><br><span class="line">kubectl get ingress -n game-2048 ingress-2048 -o jsonpath=&#123;.status.loadBalancer.ingress[0].hostname&#125; | awk <span class="string">&#x27;&#123; print &quot;Game URL = http://&quot;$1 &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 IP 확인</span></span><br><span class="line">kubectl get pod -n game-2048 -owide</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>ALB 대상 그룹</strong>에 등록된 대상 확인 : ALB에서 파드 IP로 직접 전달</li>
</ul>
<p><img src="/blog/img/vpccni-12.png"></p>
<ul>
<li>파드 3개로 증가</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 터미널1</span></span><br><span class="line">watch kubectl get pod -n game-2048</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> aws elbv2 describe-target-health --target-group-arn <span class="variable">$TARGET_GROUP_ARN</span> --output text; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 터미널2 : 파드 3개로 증가</span></span><br><span class="line">kubectl scale deployment -n game-2048 deployment-2048 --replicas 3</span><br></pre></td></tr></table></figure>

<ul>
<li>파드 1개로 감소</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 터미널2 : 파드 1개로 감소</span></span><br><span class="line">kubectl scale deployment -n game-2048 deployment-2048 --replicas 1</span><br></pre></td></tr></table></figure>

<ul>
<li>실습 리소스  삭제</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete ingress ingress-2048 -n game-2048</span><br><span class="line">kubectl delete svc service-2048 -n game-2048 &amp;&amp; kubectl delete deploy deployment-2048 -n game-2048 &amp;&amp; kubectl delete ns game-2048</span><br></pre></td></tr></table></figure>





























































































































































</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/blog/page/0/">Previous</a></div><div class="pagination-next"><a href="/blog/page/2/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/blog/">1</a></li><li><a class="pagination-link" href="/blog/page/2/">2</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/blog/page/5/">5</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/blog/img/avatar.png" alt="Seongtaek Kim"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Seongtaek Kim</p><p class="is-size-6 is-block">Blog</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/blog/archives"><p class="title">45</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/blog/categories"><p class="title">34</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/blog/tags"><p class="title">0</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/seongtaekkim"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Linkedin" href="https://linkedin.com/in/staek"><i class="fab fa-linkedin"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/blog/categories/calico-communication/"><span class="level-start"><span class="level-item">calico/communication</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/calico-concept/"><span class="level-start"><span class="level-item">calico/concept</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/calico-networkmode/"><span class="level-start"><span class="level-item">calico/networkmode</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/cilium-cilium/"><span class="level-start"><span class="level-item">cilium/cilium</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/cilium-communication/"><span class="level-start"><span class="level-item">cilium/communication</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/cilium-install/"><span class="level-start"><span class="level-item">cilium/install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-cgroup/"><span class="level-start"><span class="level-item">container/cgroup</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-namespace/"><span class="level-start"><span class="level-item">container/namespace</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-overlayFS/"><span class="level-start"><span class="level-item">container/overlayFS</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-overlaynetwork/"><span class="level-start"><span class="level-item">container/overlaynetwork</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/gateway-gatewayapi/"><span class="level-start"><span class="level-item">gateway/gatewayapi</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/gateway-gloo/"><span class="level-start"><span class="level-item">gateway/gloo</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/ingress-ingress/"><span class="level-start"><span class="level-item">ingress/ingress</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-bookinfo/"><span class="level-start"><span class="level-item">istio/bookinfo</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-envoy/"><span class="level-start"><span class="level-item">istio/envoy</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-istio-outline/"><span class="level-start"><span class="level-item">istio/istio-outline</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-istio-test/"><span class="level-start"><span class="level-item">istio/istio-test</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-istio-traffic/"><span class="level-start"><span class="level-item">istio/istio-traffic</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/java-Enumeration/"><span class="level-start"><span class="level-item">java/Enumeration</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/java-flyweight/"><span class="level-start"><span class="level-item">java/flyweight</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/java-interface/"><span class="level-start"><span class="level-item">java/interface</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/k8s-PAUSE-Container/"><span class="level-start"><span class="level-item">k8s/PAUSE-Container</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/k8s-flannel/"><span class="level-start"><span class="level-item">k8s/flannel</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/k8s-kind/"><span class="level-start"><span class="level-item">k8s/kind</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-ipvs/"><span class="level-start"><span class="level-item">loadbaleancer/ipvs</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-ipvs-install/"><span class="level-start"><span class="level-item">loadbaleancer/ipvs-install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-metalLB/"><span class="level-start"><span class="level-item">loadbaleancer/metalLB</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-metalLB-install/"><span class="level-start"><span class="level-item">loadbaleancer/metalLB-install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/serivce-clusterip/"><span class="level-start"><span class="level-item">serivce/clusterip</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/serivce-install/"><span class="level-start"><span class="level-item">serivce/install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/serivce-nodeport/"><span class="level-start"><span class="level-item">serivce/nodeport</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/vpccni-vpccni/"><span class="level-start"><span class="level-item">vpccni/vpccni</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/vpccni-vpccni-install/"><span class="level-start"><span class="level-item">vpccni/vpccni-install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/vpccni-vpccni2/"><span class="level-start"><span class="level-item">vpccni/vpccni2</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-12-01T06:00:35.000Z">2024-12-01</time></p><p class="title"><a href="/blog/2024/12/01/docs/ingress/ingress/">ingress concept</a></p><p class="categories"><a href="/blog/categories/ingress-ingress/">ingress/ingress</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-12-01T01:00:35.000Z">2024-12-01</time></p><p class="title"><a href="/blog/2024/12/01/docs/gateway/gloo/">gloo</a></p><p class="categories"><a href="/blog/categories/gateway-gloo/">gateway/gloo</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-11-24T13:07:30.000Z">2024-11-24</time></p><p class="title"><a href="/blog/2024/11/24/docs/flannel/">Flannel CNI Concept</a></p><p class="categories"><a href="/blog/categories/k8s-flannel/">k8s/flannel</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-11-24T09:01:30.000Z">2024-11-24</time></p><p class="title"><a href="/blog/2024/11/24/docs/overlaynetwork/overlay-network/">overlay network concept</a></p><p class="categories"><a href="/blog/categories/container-overlaynetwork/">container/overlaynetwork</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-11-24T05:02:30.000Z">2024-11-24</time></p><p class="title"><a href="/blog/2024/11/24/docs/overlaynetwork/vxlan/">vxlan concept</a></p><p class="categories"><a href="/blog/categories/container-overlaynetwork/">container/overlaynetwork</a></p></div></article></div></div><!--!--></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/blog/">Blog</a><p class="is-size-7"><span>&copy; 2024 Seongtaek Kim</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/blog/js/column.js"></script><script src="/blog/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/blog/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/blog/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/blog/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/blog/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>