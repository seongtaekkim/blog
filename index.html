<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Blog</title><link rel="manifest" href="/blog/manifest.json"><meta name="application-name" content="Blog"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Blog"><meta property="og:url" content="https://seongtaekkim.github.io/blog"><meta property="og:site_name" content="Blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://seongtaekkim.github.io/blog/img/og_image.png"><meta property="article:author" content="Seongtaek Kim"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://seongtaekkim.github.io/blog/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://seongtaekkim.github.io/blog"},"headline":"Blog","image":["https://seongtaekkim.github.io/blog/img/og_image.png"],"author":{"@type":"Person","name":"Seongtaek Kim"},"publisher":{"@type":"Organization","name":"Blog","logo":{"@type":"ImageObject"}},"description":""}</script><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/blog/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/blog/">Blog</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item is-active" href="/blog/">Home</a><a class="navbar-item" href="/blog/archives">Archives</a><a class="navbar-item" href="/blog/categories">Categories</a><a class="navbar-item" href="/blog/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-12-08T06:40:35.000Z" title="2024. 12. 8. 오후 3:40:35">2024-12-08</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-12-08T12:33:14.081Z" title="2024. 12. 8. 오후 9:33:14">2024-12-08</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-namespace/">container/namespace</a></span><span class="level-item">8 minutes read (About 1229 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/12/08/docs/namespace/user-namespace/">user namespace</a></h1><div class="content"><ul>
<li><p>프로세스의 UID&#x2F;GID Isolation</p>
</li>
<li><p>중첩(nested) 구조 (최대 32레벨)</p>
</li>
<li><p>보안 상 중요 </p>
</li>
<li><p>컨테이너의 “root 권한” 문제를 해결</p>
</li>
<li><p>네임스페이스 안과 밖의 UID&#x2F;GID를 다르게 설정할 수 있음</p>
</li>
</ul>
<h3 id="Linux-USER"><a href="#Linux-USER" class="headerlink" title="Linux USER"></a>Linux USER</h3><ul>
<li><p>User name? 커널이 취급하는 값이 아닙니다<br>(managed by external tools, &#x2F;etc&#x2F;passwd, LDAP, Kerberos, …)</p>
</li>
<li><p>커널이 아는 것은 UID, GID</p>
</li>
<li><p>UID, GID space ~ 커널이 관리</p>
</li>
<li><p>프로세스와 호스트 사이의 UID&#x2F;GID 매핑 ~ Secure 측면에서 중요</p>
</li>
<li><p>권한(permission) 체크 ~ UID, GID를 검사</p>
</li>
<li><p>컨테이너? isolated processes로 호스트의 “커널”을 공유</p>
</li>
<li><p>Same UID, Same User</p>
</li>
</ul>
<h2 id="Linux-USER-namespace-isolation"><a href="#Linux-USER-namespace-isolation" class="headerlink" title="Linux USER namespace isolation"></a>Linux USER namespace isolation</h2><ul>
<li>-U : user namespace 격리</li>
<li>–map-root-user : user id를 remap 해서 usernamespace 를 생성</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unshare -U --map-root-user /bin/sh</span><br></pre></td></tr></table></figure>

<ul>
<li>namespace 가 격리되어 inode가 다름을 알 수 있다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) <span class="built_in">groups</span>=0(root),65534(nogroup)</span><br><span class="line"><span class="comment"># readlink /proc/$$/ns/user</span></span><br><span class="line">user:[4026532670]</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">seongtki@seongtki:~$  <span class="built_in">id</span></span><br><span class="line">uid=1000(seongtki) gid=1000(seongtki) <span class="built_in">groups</span>=1000(seongtki),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lxd),118(docker)</span><br><span class="line">seongtki@seongtki:~$</span><br><span class="line">seongtki@seongtki:~$ ps -ef | grep /bin/sh</span><br><span class="line">seongtki    1898    1415  0 00:35 pts/0    00:00:00 /bin/sh</span><br><span class="line">seongtki    1902    1662  0 00:35 pts/1    00:00:00 grep --color=auto /bin/sh</span><br><span class="line"></span><br><span class="line">seongtki@seongtki:~$ <span class="built_in">readlink</span> /proc/$$/ns/user</span><br><span class="line">user:[4026531837]</span><br></pre></td></tr></table></figure>

<ul>
<li>컨테이너 안에서는 root이지만 실제로 host에서 보면 seongtki로 실행이 되었고, inode도 다르다.</li>
<li>USER 네임스페이스 간 UID&#x2F;GID Remap 되어잇음.</li>
</ul>
<h2 id="Docker-Container와-User-namespace"><a href="#Docker-Container와-User-namespace" class="headerlink" title="Docker Container와 User namespace"></a>Docker Container와 User namespace</h2><h3 id="docker-run-일반-계정"><a href="#docker-run-일반-계정" class="headerlink" title="docker run (일반 계정)"></a>docker run (일반 계정)</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name <span class="built_in">test</span> --<span class="built_in">rm</span> -d ubuntu <span class="built_in">sleep</span> 3600</span><br></pre></td></tr></table></figure>

<ul>
<li>컨테이너가 root로 실행됨</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">seongtki@seongtki:~$ docker <span class="built_in">exec</span> <span class="built_in">test</span> ps aux |grep <span class="built_in">sleep</span></span><br><span class="line">root           1  0.0  0.0   2200   768 ?        Ss   05:14   0:00 <span class="built_in">sleep</span> 3600</span><br><span class="line">seongtki@seongtki:~$ ps aux | grep <span class="built_in">sleep</span></span><br><span class="line">root        4629  0.0  0.0   2200   768 ?        Ss   05:14   0:00 <span class="built_in">sleep</span> 3600</span><br></pre></td></tr></table></figure>

<ul>
<li>Dockerfile에서 실행 시 USER를 정해본다.</li>
</ul>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dockerfile</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:latest</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> useradd -r -u 1000 testuser</span></span><br><span class="line"><span class="keyword">USER</span> testuser</span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;sleep&quot;</span>, <span class="string">&quot;3600&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t testuser -f Dockerfile .</span><br><span class="line">$ docker run --name test2 --<span class="built_in">rm</span> -d testuser</span><br></pre></td></tr></table></figure>

<ul>
<li>도커를 그냥 실행했을 때와 USER를 지정하고 실행했을 때 차이.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">seongtki@seongtki:~$ docker <span class="built_in">exec</span> <span class="built_in">test</span> <span class="built_in">id</span></span><br><span class="line">uid=0(root) gid=0(root) <span class="built_in">groups</span>=0(root)</span><br><span class="line">seongtki@seongtki:~$ docker <span class="built_in">exec</span> test2 <span class="built_in">id</span></span><br><span class="line">uid=1000(testuser) gid=999(testuser) <span class="built_in">groups</span>=999(testuser)</span><br></pre></td></tr></table></figure>

<ul>
<li>test 컨테이너 - root (uid 0) 으로 실행됨</li>
<li>test2 -&gt; seongtki (uid 1000) 으로 실행됨<ul>
<li>test2 는 testuser로 보이고 host에서는 seongtki 로보임</li>
<li>커널에서는 둘 다  uid &#x3D; 1000 으로 취급된다. (&#x2F;etc&#x2F;passwd)</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">seongtki@seongtki:~$ ps aux | grep <span class="built_in">sleep</span></span><br><span class="line">root        4629  0.0  0.0   2200   768 ?        Ss   05:14   0:00 <span class="built_in">sleep</span> 3600</span><br><span class="line">seongtki    4884  0.0  0.0   2200   784 ?        Ss   05:16   0:00 <span class="built_in">sleep</span> 3600</span><br></pre></td></tr></table></figure>

<ul>
<li>user namespace inode 가 같으므로 같은 호스트임을 알 수 있다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># lsns -t user -p 4629</span></span><br><span class="line">        NS TYPE  NPROCS PID USER COMMAND</span><br><span class="line">4026531837 user     154   1 root /sbin/init</span><br><span class="line">root@seongtki:~<span class="comment"># lsns -t user -p 4884</span></span><br><span class="line">        NS TYPE  NPROCS PID USER COMMAND</span><br><span class="line">4026531837 user     154   1 root /sbin/init</span><br></pre></td></tr></table></figure>

<ul>
<li>도커 명령어로 user 접근해보기<ul>
<li>그런데, –user 0 으로 하면 root 로 실행된다.</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker run --name test3 -d --user 1000 --<span class="built_in">rm</span> ubuntu <span class="built_in">sleep</span> 3600</span><br><span class="line"></span><br><span class="line">seongtki@seongtki:~$ ps aux | grep <span class="built_in">sleep</span></span><br><span class="line">root        4629  0.0  0.0   2200   768 ?        Ss   05:14   0:00 <span class="built_in">sleep</span> 3600</span><br><span class="line">seongtki    4884  0.0  0.0   2200   784 ?        Ss   05:16   0:00 <span class="built_in">sleep</span> 3600</span><br><span class="line">seongtki    5034  0.0  0.0   2200   780 ?        Ss   05:21   0:00 <span class="built_in">sleep</span> 3600</span><br><span class="line"></span><br><span class="line">seongtki@seongtki:~$ docker <span class="built_in">exec</span> test3 <span class="built_in">id</span></span><br><span class="line">uid=1000 gid=0(root) <span class="built_in">groups</span>=0(root)</span><br><span class="line"></span><br><span class="line">seongtki@seongtki:~$ sudo lsns -t user -p 5034</span><br><span class="line">        NS TYPE  NPROCS PID USER COMMAND</span><br><span class="line">4026531837 user     155   1 root /sbin/init</span><br></pre></td></tr></table></figure>



<h3 id="도커의-root-사용"><a href="#도커의-root-사용" class="headerlink" title="도커의 root 사용"></a>도커의 root 사용</h3><ul>
<li>패키지인스톨이 쉬움</li>
<li>시스템리소스 사용에 제약이 없음</li>
<li>도커 v1.10+ 에서 user namespace 제공</li>
<li>호스트의 uid&#x2F;gid를 다른 uid&#x2F;gid로 매핑하는 방식</li>
<li>보안관점에서 큰 진보</li>
</ul>
<h3 id="도커-root-보안취약점"><a href="#도커-root-보안취약점" class="headerlink" title="도커 root 보안취약점"></a>도커 root 보안취약점</h3><ul>
<li>실제 root 권한으로 host 파일시스템을 조작할 수 있다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">seongtki@seongtki:~$ docker run --<span class="built_in">rm</span> -v /etc:/root/etc -it ubuntu</span><br><span class="line">root@1608149fa966:/<span class="comment"># echo &quot;127.0.0.1  hello&quot; &gt;&gt; /root/etc/hosts # root 권한이 있어 가능함.</span></span><br></pre></td></tr></table></figure>

<ul>
<li>host에서 실제 값이 입력됨을 확인.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1 localhost</span><br><span class="line">127.0.1.1 seongtki</span><br><span class="line"></span><br><span class="line"><span class="comment"># The following lines are desirable for IPv6 capable hosts</span></span><br><span class="line">::1     ip6-localhost ip6-loopback</span><br><span class="line">fe00::0 ip6-localnet</span><br><span class="line">ff00::0 ip6-mcastprefix</span><br><span class="line">ff02::1 ip6-allnodes</span><br><span class="line">ff02::2 ip6-allrouters</span><br><span class="line">127.0.0.1  hello <span class="comment"># 컨테이너에서 입력한 값이 실제로 입력됨.</span></span><br></pre></td></tr></table></figure>



<h3 id="docker-remap"><a href="#docker-remap" class="headerlink" title="docker remap"></a>docker remap</h3><ul>
<li>docker에서 user namespace를 적용해보자.</li>
<li>uid, gid를 remap할 대역을 정의한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo sh -c <span class="string">&#x27;echo dockremap:500000:65536 &gt; /etc/subuid&#x27;</span> <span class="comment"># &#123;username&#125;:&#123;start&#125;:&#123;count&#125; </span></span><br><span class="line">sudo sh -c <span class="string">&#x27;echo dockremap:500000:65536 &gt; /etc/subgid&#x27;</span> <span class="comment"># &#123;groupname&#125;:&#123;start&#125;:&#123;count&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">seongtki@seongtki:~$ sudo <span class="built_in">cat</span> /etc/subuid</span><br><span class="line">dockremap:500000:65536</span><br><span class="line">seongtki@seongtki:~$ sudo <span class="built_in">cat</span> /etc/subgid</span><br><span class="line">dockremap:500000:65536</span><br></pre></td></tr></table></figure>

<ul>
<li>실행 옵션에 remap 설정</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">seongtki@seongtki:~$  sudo vi /etc/systemd/system/docker.service</span><br><span class="line"></span><br><span class="line">[Service] <span class="comment"># add line</span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// -H tcp://127.0.0.1:2375 --userns-remap=default <span class="comment"># add line</span></span><br><span class="line"></span><br><span class="line">seongtki@seongtki:~$ sudo systemctl daemon-reload</span><br><span class="line">seongtki@seongtki:~$ sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 설정을 다시 없애려면</span></span><br><span class="line">/etc/systemd/system/docker.service <span class="comment"># 내부에 내용을 모두 지우고</span></span><br><span class="line">sudo systemctl unmask docker <span class="comment"># 실행하고 docker 재실행 하면 된다.</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.funtoo.org/LXD/What_are_subuids_and_subgids%3F">subuid, subgid</a></p>
<ul>
<li>컨테이너 실행</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --<span class="built_in">rm</span> -v /etc:/root/etc -it ubuntu</span><br></pre></td></tr></table></figure>

<ul>
<li>컨테이너에</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 권한제한 확인</span></span><br><span class="line">root@cb4263e1b582:/<span class="comment"># echo &quot;127.0.0.1    hello2&quot; &gt;&gt; /root/etc/hosts</span></span><br><span class="line">bash: /root/etc/hosts: Permission denied</span><br><span class="line"></span><br><span class="line">root@cb4263e1b582:/<span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) <span class="built_in">groups</span>=0(root) <span class="comment"># 컨테이너 내부에서는 root 이다.</span></span><br><span class="line"></span><br><span class="line">root@cb4263e1b582:/<span class="comment"># ls -al /root</span></span><br><span class="line">total 20</span><br><span class="line">drwx------   1 root   root    4096 Oct 12 02:57 .</span><br><span class="line">drwxr-xr-x   1 root   root    4096 Oct 12 02:57 ..</span><br><span class="line">-rw-r--r--   1 root   root    3106 Oct 15  2021 .bashrc</span><br><span class="line">-rw-r--r--   1 root   root     161 Jul  9  2019 .profile</span><br><span class="line">drwxr-xr-x 110 nobody nogroup 4096 Oct 12 02:54 etc <span class="comment"># root 권한이 아니다.</span></span><br><span class="line"></span><br><span class="line">root@cb4263e1b582:/<span class="comment"># ps aux</span></span><br><span class="line">USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root           1  0.0  0.0   4132  3404 pts/0    Ss   02:57   0:00 /bin/bash <span class="comment"># pid 1 확인</span></span><br><span class="line">root          10  0.0  0.0   6408  1632 pts/0    R+   02:57   0:00 ps aux</span><br><span class="line"></span><br><span class="line">root@cb4263e1b582:/<span class="comment"># lsns -t user -p $$</span></span><br><span class="line">        NS TYPE  NPROCS PID USER COMMAND</span><br><span class="line">4026532389 user       2   1 root /bin/bash <span class="comment"># user namespace inode 확인</span></span><br></pre></td></tr></table></figure>

<ul>
<li>host의 user namespace inode 확인 (<strong>격리되어 있으므로 다르다</strong>)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># ps aux | grep /bin/bash</span></span><br><span class="line">500000      3343  0.0  0.0   4132  3404 pts/0    Ss+  02:57   0:00 /bin/bash</span><br><span class="line">root        3385  0.0  0.0   5968   660 pts/1    S+   02:58   0:00 grep --color=auto /bin/bash</span><br><span class="line"></span><br><span class="line">root@seongtki:~<span class="comment"># lsns -t user -p $$</span></span><br><span class="line">        NS TYPE  NPROCS PID USER COMMAND</span><br><span class="line">4026531837 user     168   1 root /sbin/init <span class="comment"># 컨테이너의 user namespace inode 값과 다르다.</span></span><br><span class="line"></span><br><span class="line">root@seongtki:~<span class="comment"># readlink /proc/$$/ns/user</span></span><br><span class="line">user:[4026531837]</span><br></pre></td></tr></table></figure>



<p><img src="/blog/img/user-01.png"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-12-08T03:40:35.000Z" title="2024. 12. 8. 오후 12:40:35">2024-12-08</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-12-08T12:33:07.065Z" title="2024. 12. 8. 오후 9:33:07">2024-12-08</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-namespace/">container/namespace</a></span><span class="level-item">6 minutes read (About 956 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/12/08/docs/namespace/pid-namespace/">pid namespace</a></h1><div class="content"><ul>
<li>Process ID 넘버스페이스를 isolate 한다.</li>
<li>부모,자식 네임스페이스 중첩구조</li>
<li>부모 네임스페이스 (see) -&gt; 자식 네임스페이스</li>
</ul>
<h3 id="host-pid-1"><a href="#host-pid-1" class="headerlink" title="host pid 1"></a>host pid 1</h3><ul>
<li>init 프로세스 (커널이 생성해준다)</li>
<li>시그널 처리</li>
<li>좀비, 고아프로세스 처리</li>
<li>kill 1 되면, 시스템 패닉되어 reboot해야함</li>
</ul>
<h3 id="컨테이너-pid-1"><a href="#컨테이너-pid-1" class="headerlink" title="컨테이너 pid 1"></a>컨테이너 pid 1</h3><ul>
<li>unshare 할 때 fork 하여 자식 pid namespace의 pid 1 로 실행</li>
<li>시그널 처리</li>
<li>좀비, 고아프로세스 처리</li>
<li>죽으면 컨테이너가 종료됨</li>
</ul>
<h3 id="unshare"><a href="#unshare" class="headerlink" title="unshare"></a>unshare</h3><ul>
<li>-p : pid namespace</li>
<li>-f : fork</li>
<li>–mount-proc : proc 파일시스템 마운트</li>
</ul>
<h3 id="x2F-proc"><a href="#x2F-proc" class="headerlink" title="&#x2F;proc"></a>&#x2F;proc</h3><ul>
<li>메모리 기반의 가상파일 시스템<ul>
<li>pseudo filesystem (memory based virtual filesystem)</li>
</ul>
</li>
<li>커널이 관리하는 시스템 정보를 제공</li>
<li>시스템 모니터링과 분석에 활용</li>
<li>커널 데이터 구조의 접근을 쉽게 할 수 있음</li>
<li>ps, mount ,umount 할 때 &#x2F;proc 파일시스템을 통해서 명령어가 실행됨.</li>
<li>컨테이너 (pid namespace) 안에서 프로세스 정보를 조회하고 제어하기 위해 사용한다.</li>
</ul>
<h3 id="예제"><a href="#예제" class="headerlink" title="예제"></a>예제</h3><ul>
<li>fork하면서 pid namespace 로 격리함</li>
<li>proc 파일시스템을 마운트 하지 않으면 proc 정보가 보임</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp<span class="comment"># unshare -fp --mount-proc /bin/sh</span></span><br><span class="line">\<span class="comment">#</span></span><br></pre></td></tr></table></figure>



<ul>
<li>컨테이너<ul>
<li>pid 1은 &#x2F;bin&#x2F;sh이다.</li>
<li>namespace inode 조회.</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 컨테이너</span></span><br><span class="line"><span class="comment"># ps -ef</span></span><br><span class="line">UID          PID    PPID  C STIME TTY          TIME CMD</span><br><span class="line">root           1       0  0 04:41 pts/0    00:00:00 /bin/sh</span><br><span class="line">root           2       1  0 04:42 pts/0    00:00:00 ps -ef</span><br><span class="line"></span><br><span class="line"><span class="comment"># lsns -t pid -p 1</span></span><br><span class="line">        NS TYPE NPROCS PID USER COMMAND</span><br><span class="line">4026532398 pid       2   1 root /bin/sh</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="host"><a href="#host" class="headerlink" title="host"></a>host</h3><ul>
<li>pid 1은 &#x2F;sbin&#x2F;init 이다. (컨테이너와 다름)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># ps -ef</span></span><br><span class="line">UID          PID    PPID  C STIME TTY          TIME CMD</span><br><span class="line">root           1       0  0 03:21 ?        00:00:01 /sbin/init</span><br><span class="line">root           2       0  0 03:21 ?        00:00:00 [kthreadd]</span><br></pre></td></tr></table></figure>

<ul>
<li>unshare명령에 대한 프로세스의 자식에 &#x2F;bin&#x2F;sh 가 있다. </li>
<li>&#x2F;bin&#x2F;sh의 inode 를 조회해 보면, 컨테이너의 pid 1의 inode와 같음을 알 수 있다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># ps -ef | grep /bin/sh</span></span><br><span class="line">root       15787   15768  0 04:41 pts/0    00:00:00 unshare -fp --mount-proc /bin/sh</span><br><span class="line">root       15788   15787  0 04:41 pts/0    00:00:00 /bin/sh</span><br><span class="line">root       15952   15938  0 04:43 pts/2    00:00:00 grep --color=auto /bin/sh</span><br><span class="line"></span><br><span class="line">root@seongtki:~<span class="comment"># lsns -t pid -p 15788</span></span><br><span class="line">        NS TYPE NPROCS   PID USER COMMAND</span><br><span class="line">4026532398 pid       1 15788 root /bin/sh</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>위 예제의 pid namespace 구조도는 아래와 같다.</li>
</ul>
<p><img src="/blog/img/pid-01.png"></p>
<h2 id="signal-handler"><a href="#signal-handler" class="headerlink" title="signal handler"></a>signal handler</h2><h3 id="pid-namespace"><a href="#pid-namespace" class="headerlink" title="pid namespace"></a>pid namespace</h3><p>컨테이너의 pid 1을 SIGKILL 하면 컨테이너가 종료되는 것을 알 수 있다.</p>
<ul>
<li>컨테이너로 시그널을 보낼 때, 핸들링하는 프로그램 데몬이 존재해야 하지만, 없기 때문에 SIGKILL을 제외한 시그널을 무시된다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># kill -SIGHUP 15788 # ignore </span></span><br><span class="line">root@seongtki:~<span class="comment"># kill -SIGINT 15788 # ignore </span></span><br><span class="line">root@seongtki:~<span class="comment"># kill -SIGTERM 15788 # ignore </span></span><br><span class="line">root@seongtki:~<span class="comment"># kill -SIGKILL 15788 # ignore </span></span><br><span class="line">root@seongtki:~<span class="comment"># kill -SIGKILL 15788 # pid namespace 종료</span></span><br></pre></td></tr></table></figure>



<h3 id="docker-pid"><a href="#docker-pid" class="headerlink" title="docker pid"></a>docker pid</h3><ul>
<li>busybox 를 실행하고 sleep 3600 cmd 실행하도록 컨테이너를 생성하였다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># docker run --rm --name busybox busybox sleep 3600</span></span><br></pre></td></tr></table></figure>

<ul>
<li>host에서 sleep 3600 가 실행중인걸 알 수 있다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># ps aux | grep sleep</span></span><br><span class="line">root       16005  0.3  0.5 1326556 22572 pts/0   Sl+  05:20   0:00 docker run --<span class="built_in">rm</span> --name busybox busybox <span class="built_in">sleep</span> 3600</span><br><span class="line">root       16067  0.0  0.0   3852   400 ?        Ss   05:20   0:00 <span class="built_in">sleep</span> 3600</span><br><span class="line">root       16100  0.0  0.0   5968   668 pts/2    S+   05:20   0:00 grep --color=auto <span class="built_in">sleep</span></span><br></pre></td></tr></table></figure>

<ul>
<li>컨테이너 내부에서 pid1 은 cmd임을 알 수 있다.</li>
<li>이는 시그널을 컨트롤하는 사용자 프로그램이 없다는 뜻이어서, kill을 제외한 다른 시그널에대한 핸들링이 없다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># docker exec busybox ps -ef</span></span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 <span class="built_in">sleep</span> 3600</span><br><span class="line">    7 root      0:00 ps -ef</span><br><span class="line">    </span><br><span class="line">root@seongtki:~<span class="comment"># kill -SIGHUP 16067 # ignore </span></span><br><span class="line">root@seongtki:~<span class="comment"># kill -SIGINT 16067 # ignore</span></span><br><span class="line">root@seongtki:~<span class="comment"># kill -SIGTERM 16067 # ignore</span></span><br><span class="line">root@seongtki:~<span class="comment"># kill -SIGKILL 16067 # ignore</span></span><br><span class="line">root@seongtki:~<span class="comment"># kill -SIGTERM 16067 # 컨테이너 종료</span></span><br></pre></td></tr></table></figure>





<h3 id="docker-init-process"><a href="#docker-init-process" class="headerlink" title="docker init process"></a>docker init process</h3><ul>
<li>–init : docker 에서 제공하는 컨테이너 init process</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment">#  docker run --rm --name busybox --init busybox sleep 3600</span></span><br></pre></td></tr></table></figure>

<ul>
<li>cmd 인 sleep 3600 부모로 &#x2F;sbin&#x2F;docker-init이 존재하는걸 알수 있다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># ps aux | grep sleep</span></span><br><span class="line">root       16182  0.2  0.5 1326812 22972 pts/0   Sl+  05:22   0:00 docker run --<span class="built_in">rm</span> --name busybox --init busybox <span class="built_in">sleep</span> 3600</span><br><span class="line">root       16230  0.0  0.0    812     4 ?        Ss   05:22   0:00 /sbin/docker-init -- <span class="built_in">sleep</span> 3600</span><br><span class="line">root       16265  0.0  0.0   3852   412 ?        S    05:22   0:00 <span class="built_in">sleep</span> 3600</span><br><span class="line">root       16267  0.0  0.0   5968   672 pts/2    S+   05:22   0:00 grep --color=auto <span class="built_in">sleep</span></span><br></pre></td></tr></table></figure>

<ul>
<li>컨테이너 내부의 ps역시 initprocess 자식으로 cmd가 존재한다.</li>
<li>SIGHUP을 날렸을 때, docker-init 프로그램에서 시그널을 핸들링하여 컨테이너가 종료되는 걸 알 수 있다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># docker exec busybox ps -ef</span></span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 /sbin/docker-init -- <span class="built_in">sleep</span> 3600</span><br><span class="line">    6 root      0:00 <span class="built_in">sleep</span> 3600</span><br><span class="line">    7 root      0:00 ps -ef</span><br><span class="line"></span><br><span class="line">root@seongtki:~<span class="comment"># kill -SIGHUP 16230</span></span><br></pre></td></tr></table></figure>





























</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-12-07T23:40:35.000Z" title="2024. 12. 8. 오전 8:40:35">2024-12-08</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-12-08T12:32:57.298Z" title="2024. 12. 8. 오후 9:32:57">2024-12-08</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-namespace/">container/namespace</a></span><span class="level-item">9 minutes read (About 1362 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/12/08/docs/namespace/mount-namespace/">mount namespace</a></h1><div class="content"><h2 id="네임스페이스-namespace"><a href="#네임스페이스-namespace" class="headerlink" title="네임스페이스(namespace)"></a>네임스페이스(namespace)</h2><ul>
<li>하나의 시스템에서 수행되지만, 각각 별개의 독립된 공간인 것처럼 <strong>격리된 환경을 제공</strong>하는 *<em>경량 프로세스 가상화 기술</em></li>
<li>경량 프로세스는 부모 프로세스와 자원을 공유하는 프로세스를 의미</li>
</ul>
<h3 id="LXC-LinuX-Container-의-네임스페이스는-6-종류와-플래그"><a href="#LXC-LinuX-Container-의-네임스페이스는-6-종류와-플래그" class="headerlink" title="LXC(LinuX Container)의 네임스페이스는 6 종류와 플래그"></a>LXC(LinuX Container)의 네임스페이스는 6 종류와 플래그</h3><ul>
<li><p>마운트 네임스페이스 : CLONE_NEWNS</p>
</li>
<li><p>UTS 네임스페이스 : CLONE_NEWUTS</p>
</li>
<li><p>IPC 네임스페이스 : CLONE_NEWIPC</p>
</li>
<li><p>PID 네임스페이스 : CLONE_NEWPID</p>
</li>
<li><p>사용자 네임스페이스 : CLONE_NEWUSER</p>
</li>
<li><p>네트워크 네임스페이스 : CLONE_NEWNET</p>
</li>
<li><p>상수플래그 정의 (&#x2F;usr&#x2F;include&#x2F;linux&#x2F;sched.h)</p>
</li>
</ul>
<p><img src="/blog/img/layer-12.png"></p>
<h3 id="마운트-mount-네임스페이스란"><a href="#마운트-mount-네임스페이스란" class="headerlink" title="마운트(mount) 네임스페이스란?"></a>마운트(mount) 네임스페이스란?</h3><ul>
<li>프로세스와 그 자식 프로세스가 각기 다른 파일시스템 마운트 지점을 제공</li>
<li>기본적으로 모든 프로세스는 동일한 기본 네임스페이스를 공유하기 때문에, 파일 시스템을 마운트하거나 마운트를 해제하는 등의 변경을 모든 프로세스가 인지할 수 있음</li>
<li>만약 clone() 시스템 콜을 통해 프로세스를 생성할 때 CLONE_NEWNS 플래그가 전달되면, 새로 생성되는 프로세스는 호출한 프로세스가 갖고있는 마운트 트리의 사본을 가져옴</li>
<li>이 사본은 부모 프로세스에 영향을 미치지 않고 새로 생성된 프로세스가 파일시스템을 마운트 or 언마운트 등의 변경을 할 수 있도록 함</li>
<li>이 시점부터 기본 네임스페이스의 모든 파일시스템 마운트 및 언마운트는 새로운 네임스페이스에서 볼 수 있지만, 각각의 프로세스 별 마운트 네임스페이스 내부에서의 변경을 해당 프로세스의 네임스페이스 밖에서는 알 수 없음</li>
</ul>
<p>마운트 네임스페이스는 “mount point”를 격리 한다.<br>여기서 mount란 루트파일시스템에 서브파일시스템을 부착하는 시스템콜이고, mount point는 파일시스템이 부착(mount) 될 위치(디렉터리)다.</p>
<p>mount 하면 원래 디렉터리가 포함하고 있던 파일, 하위 디렉터리 등이 보이지 않고, 새로 부착된 파일시스템의 파일들이 보이게 됩니다. 예를 들어 USB 드라이브를 지정한 mount point로 부착을 시키면, 해당 위치에는 부착된 USB의 파일들이 보이게 됩니다. </p>
<p>마운트 네임스페이스가 mount point를 격리한다는 것은 파일시스템 마운트와 해제 등의 변경사항들이 네임스페이스 밖에서는 보이지 않고, 외부에 전혀 영향을 주지 않음을 의미합니다. 마운트 네임스페이스가 생김으로써 컨테이너를 위해 pivot_root를 안전하게 실행할 수 있게 되었습니다.</p>
<h3 id="unshare-mount-namespace"><a href="#unshare-mount-namespace" class="headerlink" title="unshare mount namespace"></a>unshare mount namespace</h3><h3 id="mount-플래그를-unshared-시스템-콜에-전달"><a href="#mount-플래그를-unshared-시스템-콜에-전달" class="headerlink" title="mount 플래그를 unshared 시스템 콜에 전달"></a>mount 플래그를 unshared 시스템 콜에 전달</h3><ul>
<li>부모 프로세스의 mounts를 복제</li>
<li>현재 bash 프로세스를 자체 마운트 네임스페이스로 이동</li>
<li>“-m”옵션 -&gt; 마운트 네임스페이스</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unshare -m</span><br><span class="line">root@seongtki:/tmp<span class="comment"># mkdir tmp1</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>root filesystem이 같기 때문에 양쪽다 폴더가 보임</p>
</li>
<li><p>mount는 namespace 내부에서만 적용되어 보인다.</p>
</li>
<li><p>tmp1 : mount point</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp<span class="comment"># mount -o size=1m -t tmpfs tmpfs tmp1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp<span class="comment"># mount | grep tmp1</span></span><br><span class="line">tmpfs on /tmp/tmp1 <span class="built_in">type</span> tmpfs (rw,relatime,size=1024k)</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># readlink 심폴릭링크를 통해 namepsace id를 가져올 수 있다.</span></span><br><span class="line"><span class="comment"># /proc/$$ 는 현재 bash 쉘의 프로세스 ID(PID)</span></span><br><span class="line">$ <span class="built_in">readlink</span> /proc/$$/ns/mnt</span><br><span class="line">mnt:[4026532211]</span><br></pre></td></tr></table></figure>





<ul>
<li>host</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp<span class="comment"># mount | grep tmp1</span></span><br><span class="line">root@seongtki:/tmp<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<ul>
<li>mount namespace는 per-process mount isolation을 제공 (프로세스에 격리된 파일시스템 마운트 제공)</li>
</ul>
<h3 id="per-process-mount-isolation"><a href="#per-process-mount-isolation" class="headerlink" title="per-process mount isolation"></a>per-process mount isolation</h3><ul>
<li>new-root 에 nginx를 설치한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">export</span> $(docker create nginx:latest) | tar -C new-root -xvf -</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">1 directory, 0 files</span><br><span class="line">root@seongtki:/tmp/tmp1<span class="comment"># tree -L 1 new-root</span></span><br><span class="line">new-root</span><br><span class="line">├── bin -&gt; usr/bin</span><br><span class="line">├── boot</span><br><span class="line">├── dev</span><br><span class="line">├── docker-entrypoint.d</span><br><span class="line">├── docker-entrypoint.sh</span><br><span class="line">├── etc</span><br><span class="line">├── hello</span><br><span class="line">├── home</span><br><span class="line">├── lib -&gt; usr/lib</span><br><span class="line">├── media</span><br><span class="line">├── mnt</span><br><span class="line">├── opt</span><br><span class="line">├── proc</span><br><span class="line">├── root</span><br><span class="line">├── run</span><br><span class="line">├── sbin -&gt; usr/sbin</span><br><span class="line">├── srv</span><br><span class="line">├── sys</span><br><span class="line">├── tmp</span><br><span class="line">├── usr</span><br><span class="line">├── var</span><br><span class="line">└── world</span><br></pre></td></tr></table></figure>

<ul>
<li>mount</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp/tmp1<span class="comment"># mount -t tmpfs none new-root</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp/tmp1<span class="comment"># df -h | grep new</span></span><br><span class="line">none                               2.0G     0  2.0G   0% /tmp/tmp1/new-root</span><br></pre></td></tr></table></figure>



<h3 id="pivot-root-적용"><a href="#pivot-root-적용" class="headerlink" title="pivot_root 적용"></a>pivot_root 적용</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/<span class="comment"># mkdir old-root</span></span><br><span class="line">/<span class="comment"># pivot_root . old-root # 현재디렉토리를 루트파일시스템으로 하고, old-root 폴더에 기존 루트디렉토리를 마운트시킨다.</span></span><br><span class="line"></span><br><span class="line">/<span class="comment"># nginx -g &quot;daemon off;&quot; # nginx 실행</span></span><br></pre></td></tr></table></figure>



<ul>
<li>host에서 nginx pid를 이용해서 namespace id를 가져와 해당 파일시스템을 조회해본다.</li>
<li>lsns: 현존하는 namespace를 확인하기 위해 사용하는 명령어</li>
</ul>
<p><img src="/blog/img/layer-13.png"></p>
<ul>
<li>자체적인 루트파일시스템이 보장되므로 서버 환경 (시스템 파일, 의존성 라이브러리 충돌, 경로 설정 등) 으로 부터 자유롭다.</li>
<li>서버의 파일시스템으로 부터 완전하게 분리됨으로써 보안상 안전함</li>
<li>컨테이너 내에서 자유롭게 마운트 변경이 가능하고 파일시스템을 확장할 수 있다.</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-12-07T20:40:35.000Z" title="2024. 12. 8. 오전 5:40:35">2024-12-08</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-12-08T12:32:46.693Z" title="2024. 12. 8. 오후 9:32:46">2024-12-08</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-namespace/">container/namespace</a></span><span class="level-item">7 minutes read (About 1072 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/12/08/docs/namespace/bridge/">bridge</a></h1><div class="content"><h3 id="bridge"><a href="#bridge" class="headerlink" title="bridge?"></a>bridge?</h3><ul>
<li>하나의 LAN 내부에서 단말이 많아질 경우 bridge를 사용하여 개선할 수 있다.</li>
<li>단말기가 많아졌을 경우 발생하는 Collision Domain을 분리해 주는 역할을 한다.</li>
<li>2계층 송수신을 처리한다.</li>
</ul>
<h3 id="Ethenet-Frame"><a href="#Ethenet-Frame" class="headerlink" title="Ethenet Frame"></a>Ethenet Frame</h3><ul>
<li>OSI L2계층 (data link) 을 처리 한다.</li>
<li>패킷 유입 &gt; 목적지 MAC 주소확인 &gt; 주소 테이블과 비교 &gt; 해당 디바이스가 연결된 포트로 패킷 전달.</li>
</ul>
<p><img src="/blog/img/bridge-01.png"></p>
<h3 id="bridge-기능"><a href="#bridge-기능" class="headerlink" title="bridge 기능"></a>bridge 기능</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Learning.</span><br><span class="line">출발지의 맥 어드레스를 배운다.</span><br><span class="line">브리지/스위치는 포트에 연결된 PC &quot;A&quot;가 통신을 위해 프레임을 내보내면</span><br><span class="line">그때 이 PC의 MAC 주소를 읽어서 자신의 bridge table에 저장한다.</span><br><span class="line">** bridge-table: 스위치나 브리지에 연결된 사용자들의 맥 주소를 저장하는 데이터베이스</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Flooding.</span><br><span class="line">들어온 포트를 제외한 나머지를 모든 포트로 데이터를 뿌린다.</span><br><span class="line">PC &quot;A&quot;가 통신하고자 하는 목적지 PC의 맥 주소가 브리지 테이블에 없으면</span><br><span class="line">모든 포트에 데이터를 전송한다. (브로드캐스트 라고 생각해도 됨. 브로드캐스트도 Flooding이 발생함)</span><br><span class="line"></span><br><span class="line">Forwarding</span><br><span class="line">Flooding과 반대로 목적지 PC의 맥 주소를 알고 그 목적지가 브릿지를 건너야 할때</span><br><span class="line">오직 그 해당 포트쪽으로만 데이터를 전송한다.</span><br><span class="line"> </span><br><span class="line">Filtering</span><br><span class="line">브릿지를 넘어가지 못하게 막는것.</span><br><span class="line">출발지와 목적지가 같은 세그먼트에 있을때 일어남.</span><br><span class="line">[세그먼트: 브릿지, 라우터, 허브 또는 스위치에 의해 묶어있는 네트워크의 한 부분]</span><br><span class="line">이 Filtering 기능 때문에 허브와 다르게 콜리젼 도메인을 나눌 수 있다.</span><br><span class="line"></span><br><span class="line">Aging</span><br><span class="line">브리지 테이블에 출발지의 MAC 주소가 들어오면 300초 동안 타이머를 설정한다.</span><br><span class="line">300초가 지나도록 다시 그 출발지 주소의 프레임이 들어오지 않으면 브리지 테이블에서 삭제한다.</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/bridge-02.png"></p>
<h2 id="Netfilter"><a href="#Netfilter" class="headerlink" title="Netfilter"></a>Netfilter</h2><p>커널 모듈로 <strong>네트워크 패킷을 처리</strong>하는 프레임워크이다.<br>네트워크 연산을 핸들러 형태로 처리할 수 있도록 hook 지점을 제공<br>패킷이 어떻게 <strong>전송될 지</strong>에 대한 결정 방법을 제공한다.</p>
<p><img src="/blog/img/bridge-03.png"></p>
<h3 id="Netfilter-항목"><a href="#Netfilter-항목" class="headerlink" title="Netfilter 항목"></a>Netfilter 항목</h3><table>
<thead>
<tr>
<th>항목</th>
<th>내용</th>
<th>키워드</th>
</tr>
</thead>
<tbody><tr>
<td>table</td>
<td>용도별 rule 모음</td>
<td>filter, nat, mangle</td>
</tr>
<tr>
<td>chain</td>
<td>패팃이 지나가는 hook 별로 존재</td>
<td>PREROUTING, FORWARD, INPUT (netfilter의 hook에 매핑)</td>
</tr>
<tr>
<td>rule</td>
<td>table과 chain matrix에 대해서 정의함</td>
<td>protocol type, dest&#x2F;src address ..</td>
</tr>
<tr>
<td>action(target)</td>
<td>패킷이 룰에 매칭되면 트리거 됨</td>
<td>ACCEPT, DROP, REJECT</td>
</tr>
</tbody></table>
<h3 id="red-gt-bridge-gt-blue-통신"><a href="#red-gt-bridge-gt-blue-통신" class="headerlink" title="red -&gt; bridge -&gt; blue 통신"></a>red -&gt; bridge -&gt; blue 통신</h3><ul>
<li><p>bridge 관점에서 보자.</p>
</li>
<li><p>패킷은 netfilter에서 파놓은 여러 hook을 통과하는데 hook별로 iptables에 정의한 각 체인룰을 점검한다.</p>
</li>
<li><p>hook에 정의된 체인은 테이블 순서대로 등록된 룰을 체크하고 조건을 만족하면 action(target)을 트리거한다.</p>
</li>
<li><p>외부(src) -&gt; 외부(dst) 패킷이므로 FORWARD 체인의 filter 테이블 룰을 봐야 한다.</p>
<ul>
<li>FORWARD: NF_IP_FORWARD (hook) 에 등록된 체인</li>
<li>NF_IP_FORWARD: incoming 패킷이 다른 호스트로 포워딩 되는 경우 트리거되는 netfilter hook</li>
<li>filter(table): 패킷을 목적지로 전송여부를 결정</li>
</ul>
</li>
<li><p><strong>rule 설정</strong></p>
<ul>
<li><p><strong>테이블 filter 에서 FORWARD 체인을 추가한다. 출발지가 1.1.1.0&#x2F;24 이면, ACCEPT 로 설정한다.</strong></p>
</li>
<li><pre><code class="sh">iptables -t filter -A FORWARD -s 1.1.1.0/24 -j ACCEPT
</code></pre>
</li>
</ul>
</li>
</ul>
<h3 id="iptalbes"><a href="#iptalbes" class="headerlink" title="iptalbes"></a>iptalbes</h3><ul>
<li>netfilter가 파놓은 hook에 룰을 등록하고 관리하는 방법을 제공하는 툴</li>
<li>netfilter에 내가 원하는 정책을 넣어야 하는데 그럴 때 사용하는 프로그램. 룰을 넣고 조회하는 역할을 한다.</li>
</ul>
<h3 id="정리"><a href="#정리" class="headerlink" title="정리"></a>정리</h3><p>A ns 에서 B ns 로 통신하기 위해 중간에 bridge 를 통과한다.<br>bridge 는 2계층 데이터 를 처리하는데, A, B 사이의 ARP 테이블을 채워주게 한다.<br>ping의 경우, ICMP를 이용해 송수신하는데 이 때 Netfilter 의 hook이 트리거 되어 ACCEPT 인 경우에만<br>송수신이 가능하다.<br>결국은 arp, bridge fdb 정보를 이용해서 통신하고 iptables rule에 따라 전송여부가 결정된다.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-12-01T06:00:35.000Z" title="2024. 12. 1. 오후 3:00:35">2024-12-01</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-12-01T13:47:37.940Z" title="2024. 12. 1. 오후 10:47:37">2024-12-01</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/ingress-ingress/">ingress/ingress</a></span><span class="level-item">26 minutes read (About 3902 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/12/01/docs/ingress/ingress/">ingress concept</a></h1><div class="content"><h1 id="Ingress-요약"><a href="#Ingress-요약" class="headerlink" title="Ingress 요약"></a>Ingress 요약</h1><p>Nginx 인그레스 컨트롤러  : 외부에서 인그레스로 접속 시 Nginx 인그레스 컨트롤러 파드로 인입되고, 이후 애플리케이션 파드의 IP로 직접 통신</p>
<p><img src="/blog/img/ingress-01.png"></p>
<h2 id="클러스터-내부를-외부에-노출-발전-단계"><a href="#클러스터-내부를-외부에-노출-발전-단계" class="headerlink" title="클러스터 내부를 외부에 노출 - 발전 단계"></a>클러스터 내부를 외부에 노출 - 발전 단계</h2><ol>
<li>파드 생성 : K8S 클러스터 내부에서만 접속</li>
</ol>
<p><img src="/blog/img/ingress-02.png"></p>
<ol start="2">
<li>서비스(Cluster Type) 연결 : K8S 클러스터 내부에서만 접속</li>
</ol>
<ul>
<li>동일한 애플리케이션의 다수의 파드의 접속을 용이하게 하기 위한 서비스에 접속</li>
</ul>
<p><img src="/blog/img/ingress-03.png"></p>
<ol start="3">
<li>서비스(NodePort Type) 연결 : 외부 클라이언트가 서비스를 통해서 클러스터 내부의 파드로 접속</li>
</ol>
<ul>
<li>서비스(NodePort Type)의 일부 단점을 보완한 서비스(LoadBalancer Type) 도 있습니다!</li>
</ul>
<p><img src="/blog/img/ingress-04.png"></p>
<ol start="4">
<li>인그레스 컨트롤러 파드를 배치 : 서비스 앞단에 HTTP 고급 라우팅 등 기능 동작을 위한 배치</li>
</ol>
<ul>
<li>인그레스(정책)이 적용된 인그레스 컨트롤러 파드(예. nginx pod)를 앞단에 배치하여 고급 라우팅 등 기능을 제공</li>
</ul>
<p><img src="/blog/img/ingress-05.png"></p>
<ol start="5">
<li>인그레스 컨트롤러 파드 이중화 구성 :  Active(Leader) - Standby(Follower) 로 Active 파드 장애에 대비</li>
</ol>
<p><img src="/blog/img/ingress-06.png"></p>
<ol start="6">
<li>인그레스 컨트롤러 파드를 외부에 노출 : 인그레스 컨트롤러 파드를 외부에서 접속하기 위해서 노출(expose)</li>
</ol>
<ul>
<li>인그레스 컨트롤러 노출 시 서비스(NodePort Type) 보다는 좀 더 많은 기능을 제공하는 서비스(LoadBalancer Type)를 권장합니다 (80&#x2F;443 포트 오픈 시)</li>
</ul>
<p><img src="/blog/img/ingress-07.png"></p>
<ol start="7">
<li>인그레스와 파드간 내부 연결의 효율화 방안 : 인그레스 컨트롤러 파드(Layer7 동작)에서 서비스 파드의 IP로 직접 연결</li>
</ol>
<ul>
<li>인그레스 컨트롤러 파드는 K8S API서버로부터 서비스의 엔드포인트 정보(파드 IP)를 획득 후 바로 파드의 IP로 연결 - <a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/miscellaneous/#why-endpoints-and-not-services">링크</a></li>
<li>지원되는 인그레스 컨트롤러 : Nginx, Traefix 등 현재 대부분의 인그레스 컨트롤러가 지원함</li>
</ul>
<p><img src="/blog/img/ingress-08.png"></p>
<h1 id="인그레스-Ingress-소개"><a href="#인그레스-Ingress-소개" class="headerlink" title="인그레스(Ingress) 소개"></a>인그레스(Ingress) 소개</h1><p>인그레스 소개 : 클러스터 내부의 서비스(ClusterIP, NodePort, Loadbalancer)를 외부로 노출(HTTP&#x2F;HTTPS) - Web Proxy 역할</p>
<h4 id="인그레스-기능-HTTP-서비스-부하분산-카나리-업그레이드"><a href="#인그레스-기능-HTTP-서비스-부하분산-카나리-업그레이드" class="headerlink" title="인그레스 기능 : HTTP(서비스) 부하분산 , 카나리 업그레이드"></a>인그레스 기능 : HTTP(서비스) 부하분산 , 카나리 업그레이드</h4><p><img src="/blog/img/ingress-09.png"></p>
<h4 id="인그레스-컨트롤러-인그레스의-실제-동작-구현은-인그레스-컨트롤러-Nginx-Kong-등-가-담당"><a href="#인그레스-컨트롤러-인그레스의-실제-동작-구현은-인그레스-컨트롤러-Nginx-Kong-등-가-담당" class="headerlink" title="인그레스 컨트롤러 : 인그레스의 실제 동작 구현은 인그레스 컨트롤러(Nginx, Kong 등)가 담당"></a>인그레스 컨트롤러 : 인그레스의 실제 동작 구현은 인그레스 컨트롤러(Nginx, Kong 등)가 담당</h4><p><img src="/blog/img/ingress-10.png"></p>
<h4 id="인그레스-인그레스-컨트롤러-Nginx-기능-HTTP-서비스-부하분산-카나리-업그레이드-HTTPS-처리-TLS-종료"><a href="#인그레스-인그레스-컨트롤러-Nginx-기능-HTTP-서비스-부하분산-카나리-업그레이드-HTTPS-처리-TLS-종료" class="headerlink" title="인그레스 + 인그레스 컨트롤러(Nginx) 기능 : HTTP(서비스) 부하분산 , 카나리 업그레이드 , HTTPS 처리(TLS 종료)"></a>인그레스 + 인그레스 컨트롤러(Nginx) 기능 : HTTP(서비스) 부하분산 , 카나리 업그레이드 , HTTPS 처리(TLS 종료)</h4><p><img src="/blog/img/ingress-11.png"></p>
<h1 id="Nginx-인그레스-컨트롤러-설치"><a href="#Nginx-인그레스-컨트롤러-설치" class="headerlink" title="Nginx 인그레스 컨트롤러 설치"></a>Nginx 인그레스 컨트롤러 설치</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ingress-Nginx 컨트롤러 생성</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOT&gt; ingress-nginx-values.yaml</span></span><br><span class="line"><span class="string">controller:</span></span><br><span class="line"><span class="string">  service:</span></span><br><span class="line"><span class="string">    type: NodePort</span></span><br><span class="line"><span class="string">    nodePorts:</span></span><br><span class="line"><span class="string">      http: 30080</span></span><br><span class="line"><span class="string">      https: 30443</span></span><br><span class="line"><span class="string">  nodeSelector:</span></span><br><span class="line"><span class="string">    kubernetes.io/hostname: &quot;k3s-s&quot;</span></span><br><span class="line"><span class="string">  metrics:</span></span><br><span class="line"><span class="string">    enabled: true</span></span><br><span class="line"><span class="string">  serviceMonitor:</span></span><br><span class="line"><span class="string">      enabled: true</span></span><br><span class="line"><span class="string">EOT</span></span><br><span class="line"></span><br><span class="line">helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx</span><br><span class="line">helm repo update</span><br><span class="line"></span><br><span class="line">kubectl create ns ingress</span><br><span class="line">helm install ingress-nginx ingress-nginx/ingress-nginx -f ingress-nginx-values.yaml --namespace ingress --version 4.11.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인</span></span><br><span class="line">kubectl get all -n ingress</span><br><span class="line">kc describe svc -n ingress ingress-nginx-controller</span><br><span class="line"></span><br><span class="line"><span class="comment"># externalTrafficPolicy 설정</span></span><br><span class="line">kubectl patch svc -n ingress ingress-nginx-controller -p <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;externalTrafficPolicy&quot;: &quot;Local&quot;&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 기본 nginx conf 파일 확인</span></span><br><span class="line">kc describe cm -n ingress ingress-nginx-controller</span><br><span class="line">kubectl <span class="built_in">exec</span> deploy/ingress-nginx-controller -n ingress -it -- <span class="built_in">cat</span> /etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 관련된 정보 확인 : 포드(Nginx 서버), 서비스, 디플로이먼트, 리플리카셋, 컨피그맵, 롤, 클러스터롤, 서비스 어카운트 등</span></span><br><span class="line">kubectl get all,sa,cm,secret,roles -n ingress</span><br><span class="line">kc describe clusterroles ingress-nginx</span><br><span class="line">kubectl get pod,svc,ep -n ingress -o wide -l app.kubernetes.io/component=controller</span><br><span class="line"></span><br><span class="line"><span class="comment"># 버전 정보 확인</span></span><br><span class="line">POD_NAMESPACE=ingress</span><br><span class="line">POD_NAME=$(kubectl get pods -n <span class="variable">$POD_NAMESPACE</span> -l app.kubernetes.io/name=ingress-nginx --field-selector=status.phase=Running -o name)</span><br><span class="line">kubectl <span class="built_in">exec</span> <span class="variable">$POD_NAME</span> -n <span class="variable">$POD_NAMESPACE</span> -- /nginx-ingress-controller --version</span><br></pre></td></tr></table></figure>









<h1 id="인그레스-Ingress-실습-및-통신-흐름-확인"><a href="#인그레스-Ingress-실습-및-통신-흐름-확인" class="headerlink" title="인그레스(Ingress) 실습 및 통신 흐름 확인"></a>인그레스(Ingress) 실습 및 통신 흐름 확인</h1><ul>
<li>컨트롤플레인 노드에 인그레스 컨트롤러(Nginx) 파드를 생성, NodePort 로 외부에 노출</li>
<li>인그레스 정책 설정 : Host&#x2F;Path routing, 실습의 편리를 위해서 도메인 없이 IP로 접속 설정 가능</li>
</ul>
<p><img src="/blog/img/ingress-12.png"></p>
<p><img src="/blog/img/ingress-13.png"></p>
<h2 id="디플로이먼트와-서비스를-생성"><a href="#디플로이먼트와-서비스를-생성" class="headerlink" title="디플로이먼트와 서비스를 생성"></a>디플로이먼트와 서비스를 생성</h2><p>svc1-pod.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deploy1-websrv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">websrv</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">websrv</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-web</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc1-web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">websrv</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure>

<p>svc2-pod.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deploy2-guestsrv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">guestsrv</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">guestsrv</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-guest</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">gcr.io/google-samples/kubernetes-bootcamp:v1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc2-guest</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">guest-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9002</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">guestsrv</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure>

<p>svc3-pod.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deploy3-adminsrv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">adminsrv</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">adminsrv</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-admin</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">k8s.gcr.io/echoserver:1.5</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc3-admin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">admin-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9003</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">adminsrv</span></span><br></pre></td></tr></table></figure>

<p>생성</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 생성</span></span><br><span class="line">kubectl taint nodes k3s-s role=controlplane:NoSchedule</span><br><span class="line">kubectl apply -f svc1-pod.yaml,svc2-pod.yaml,svc3-pod.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인 : svc1, svc3 은 ClusterIP 로 클러스터 외부에서는 접속할 수 없다 &gt;&gt; Ingress 는 연결 가능!</span></span><br><span class="line">kubectl get pod,svc,ep</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/ingress-14.png"></p>
<h2 id="인그레스-정책-생성-링크"><a href="#인그레스-정책-생성-링크" class="headerlink" title="인그레스(정책) 생성 - 링크"></a>인그레스(정책) 생성 - <a target="_blank" rel="noopener" href="https://kubetm.github.io/k8s/08-intermediate-controller/ingress/">링크</a></h2><p><img src="/blog/img/ingress-15.png"></p>
<p>ingress1</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOT&gt;</span> <span class="string">ingress1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-1</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment">#nginx.ingress.kubernetes.io/upstream-hash-by: &quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc1-web</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/guest</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc2-guest</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/admin</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc3-admin</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line"><span class="string">EOT</span></span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 모니터링</span></span><br><span class="line">watch -d <span class="string">&#x27;kubectl get ingress,svc,ep,pod -owide&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 생성</span></span><br><span class="line">kubectl apply -f ingress1.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인</span></span><br><span class="line">kubectl get ingress</span><br><span class="line">kc describe ingress ingress-1</span><br><span class="line">...</span><br><span class="line">Rules:</span><br><span class="line">  Host        Path  Backends</span><br><span class="line">  ----        ----  --------</span><br><span class="line">  *           </span><br><span class="line">              /        svc1-web:80 ()</span><br><span class="line">              /guest   svc2-guest:8080 ()</span><br><span class="line">              /admin   svc3-admin:8080 ()</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 설정이 반영된 nginx conf 파일 확인</span></span><br><span class="line">kubectl <span class="built_in">exec</span> deploy/ingress-nginx-controller -n ingress -it -- <span class="built_in">cat</span> /etc/nginx/nginx.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/ingress-16.png"></p>
<h2 id="인그레스를-통한-내부-접속"><a href="#인그레스를-통한-내부-접속" class="headerlink" title="인그레스를 통한 내부 접속"></a>인그레스를 통한 내부 접속</h2><ul>
<li>Nginx 인그레스 컨트롤러를 통한 접속(HTTP 인입) 경로 : 인그레스 컨트롤러 파드에서 서비스 파드의 IP로 직접 연결</li>
</ul>
<p><img src="/blog/img/ingress-17.png"></p>
<p>인그레스(Nginx 인그레스 컨트롤러)를 통한 접속(HTTP 인입) 확인</p>
<ul>
<li><strong>HTTP 부하분산 &amp; PATH 기반 라우팅, 애플리케이션 파드에 연결된 서비스는 Bypass</strong></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl get ingress</span><br><span class="line">NAME        CLASS   HOSTS   ADDRESS        PORTS   AGE</span><br><span class="line">ingress-1   nginx   *       10.10.200.24   80      3m44s</span><br><span class="line"> </span><br><span class="line">kubectl describe ingress ingress-1 | sed -n <span class="string">&quot;5, \$p&quot;</span></span><br><span class="line">Rules:</span><br><span class="line">  Host        Path   Backends</span><br><span class="line">  ----        ----   --------</span><br><span class="line">  *           /      svc1-web:80 ()</span><br><span class="line">              /guest svc2-guest:8080 ()</span><br><span class="line">              /admin svc3-admin:8080 ()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 접속 로그 확인 : kubetail 설치되어 있음 - 출력되는 nginx 의 로그의 IP 확인</span></span><br><span class="line">kubetail -n ingress -l app.kubernetes.io/component=controller</span><br><span class="line"></span><br><span class="line">-------------------------------</span><br><span class="line"><span class="comment"># 자신의 집 PC에서 인그레스를 통한 접속 : 각각 </span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Ingress1 sv1-web URL = http://<span class="subst">$(curl -s ipinfo.io/ip)</span>:30080&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Ingress1 sv2-guest URL = http://<span class="subst">$(curl -s ipinfo.io/ip)</span>:30080/guest&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Ingress1 sv3-admin URL = http://<span class="subst">$(curl -s ipinfo.io/ip)</span>:30080/admin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># svc1-web 접속</span></span><br><span class="line">MYIP=&lt;EC2 공인 IP&gt;</span><br><span class="line">MYIP=13.124.93.150</span><br><span class="line">curl -s <span class="variable">$MYIP</span>:30080</span><br><span class="line"></span><br><span class="line"><span class="comment"># svvc2-guest 접속</span></span><br><span class="line">curl -s <span class="variable">$MYIP</span>:30080/guest</span><br><span class="line">curl -s <span class="variable">$MYIP</span>:30080/guest</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;; <span class="keyword">do</span> curl -s <span class="variable">$MYIP</span>:30080/guest ; <span class="keyword">done</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br><span class="line"></span><br><span class="line"><span class="comment"># svc3-admin 접속 &gt; 기본적으로 Nginx 는 라운드로빈 부하분산 알고리즘을 사용 &gt;&gt; Client_address 와 XFF 주소는 어떤 주소인가요?</span></span><br><span class="line">curl -s <span class="variable">$MYIP</span>:30080/admin</span><br><span class="line">curl -s <span class="variable">$MYIP</span>:30080/admin | egrep <span class="string">&#x27;(client_address|x-forwarded-for)&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;; <span class="keyword">do</span> curl -s <span class="variable">$MYIP</span>:30080/admin | grep Hostname ; <span class="keyword">done</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># (옵션) 디플로이먼트의 파드 갯수를 증가/감소 설정 후 접속 테스트 해보자</span></span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/ingress-18.png"></p>
<p>노드에서 아래 패킷 캡처 확인 : flannel vxlan, 파드 간 통신 시 IP 정보 확인</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">ngrep -tW byline -d ens5 <span class="string">&#x27;&#x27;</span> udp port 8472 or tcp port 80</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">tcpdump -i ens5 udp port 8472 -nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># vethY는 각자 k3s-s 의 가장 마지막 veth 를 지정</span></span><br><span class="line">tcpdump -i vethY tcp port 8080 -nn</span><br><span class="line">tcpdump -i vethY tcp port 8080 -w /tmp/ingress-nginx.pcap</span><br><span class="line"></span><br><span class="line"><span class="comment"># 자신의 PC에서 k3s-s EC2 공인 IP로 pcap 다운로드</span></span><br><span class="line">scp ubuntu@&lt;k3s-s EC2 공인 IP&gt;:/tmp/ingress-nginx.pcap ~/Downloads</span><br><span class="line">scp ubuntu@52.78.155.19:/tmp/ingress-nginx.pcap ~/Downloads</span><br></pre></td></tr></table></figure>







<h2 id="Nginx-분산-알고리즘-변경"><a href="#Nginx-분산-알고리즘-변경" class="headerlink" title="Nginx 분산 알고리즘 변경"></a>Nginx 분산 알고리즘 변경</h2><ul>
<li>nginx 는 기본 RR 라운드 로빈 이지만, IP-Hash 나 Session Cookie 설정으로 대상 유지 가능 - <a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#load-balance">링크</a></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">  <span class="attr">nginx.ingress.kubernetes.io/upstream-hash-by:</span> <span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>

<p>확인</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mypc</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;; <span class="keyword">do</span> curl -s <span class="variable">$MYIP</span>:30080/admin | grep Hostname ; <span class="keyword">done</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> curl -s --connect-timeout 1 <span class="variable">$MYIP</span>:30080/admin | grep Hostname ; <span class="built_in">date</span> <span class="string">&quot;+%Y-%m-%d %H:%M:%S&quot;</span> ; <span class="built_in">echo</span> <span class="string">&quot;--------------&quot;</span> ; <span class="built_in">sleep</span> 1; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 아래 ingress 설정 중 IP-Hash 설정 &gt; # 주석 제거</span></span><br><span class="line">sed -i <span class="string">&#x27;s/#nginx.ingress/nginx.ingress/g&#x27;</span> ingress1.yaml</span><br><span class="line">kubectl apply -f ingress1.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 접속 확인</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;; <span class="keyword">do</span> curl -s <span class="variable">$MYIP</span>:30080/admin | grep Hostname ; <span class="keyword">done</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> curl -s --connect-timeout 1 <span class="variable">$MYIP</span>:30080/admin | grep Hostname ; <span class="built_in">date</span> <span class="string">&quot;+%Y-%m-%d %H:%M:%S&quot;</span> ; <span class="built_in">echo</span> <span class="string">&quot;--------------&quot;</span> ; <span class="built_in">sleep</span> 1; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 다시 원복(라운드 로빈) &gt; # 주석 추가</span></span><br><span class="line">sed -i <span class="string">&#x27;s/nginx.ingress/#nginx.ingress/g&#x27;</span> ingress1.yaml</span><br><span class="line">kubectl apply -f ingress1.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 접속 확인</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;; <span class="keyword">do</span> curl -s <span class="variable">$MYIP</span>:30080/admin | grep Hostname ; <span class="keyword">done</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> curl -s --connect-timeout 1 <span class="variable">$MYIP</span>:30080/admin | grep Hostname ; <span class="built_in">date</span> <span class="string">&quot;+%Y-%m-%d %H:%M:%S&quot;</span> ; <span class="built_in">echo</span> <span class="string">&quot;--------------&quot;</span> ; <span class="built_in">sleep</span> 1; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>삭제</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete deployments,svc,ingress --all</span><br></pre></td></tr></table></figure>





<h2 id="AWS-Ingress-ALB-모드"><a href="#AWS-Ingress-ALB-모드" class="headerlink" title="AWS Ingress (ALB) 모드"></a>AWS Ingress (ALB) 모드</h2><ul>
<li>인스턴스 모드 : AWS ALB(Ingress)로 인입 후 각 워커노드의 NodePort 로 전달 후 IPtables 룰(SEP)에 따라 파드로 분배</li>
</ul>
<p><img src="/blog/img/ingress-19.png"></p>
<ul>
<li>IP 모드 : nginx ingress controller 동작과 유사하게 AWS LoadBalancer Controller 파드가 kube api 를 통해서 파드의 IP를 제공받아서 AWS ALB 에 타켓(파드 IP)를 설정</li>
</ul>
<p><img src="/blog/img/ingress-20.png"></p>
<h2 id="Host-기반-라우팅"><a href="#Host-기반-라우팅" class="headerlink" title="Host 기반 라우팅"></a>Host 기반 라우팅</h2><p><img src="/blog/img/ingress-21.png"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOT&gt;</span> <span class="string">ingress2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">kans.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc3-admin</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">&quot;*.kans.com&quot;</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/echo</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc3-admin</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line"><span class="string">EOT</span></span><br></pre></td></tr></table></figure>

<p>생성</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 터미널1</span></span><br><span class="line">watch -d <span class="string">&#x27;kubectl get ingresses,svc,ep,pod -owide&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 도메인 변경</span></span><br><span class="line">MYDOMAIN1=staek.com</span><br><span class="line">sed -i <span class="string">&quot;s/kans.com/<span class="variable">$MYDOMAIN1</span>/g&quot;</span> ingress2.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 생성</span></span><br><span class="line">kubectl apply -f ingress2.yaml,svc3-pod.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인</span></span><br><span class="line">kubectl get ingress</span><br><span class="line">kubectl describe ingress ingress-2</span><br><span class="line"></span><br><span class="line">kubectl describe ingress ingress-2 | sed -n <span class="string">&quot;5, \$p&quot;</span></span><br><span class="line">Ingress Class:    nginx</span><br><span class="line">Default backend:  &lt;default&gt;</span><br><span class="line">Rules:</span><br><span class="line">  Host         Path  Backends</span><br><span class="line">  ----         ----  --------</span><br><span class="line">  staek.com</span><br><span class="line">               /   svc3-admin:8080 ()</span><br><span class="line">  *.staek.com</span><br><span class="line">               /echo   svc3-admin:8080 ()</span><br><span class="line">Annotations:   &lt;none&gt;</span><br><span class="line">Events:        &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h4 id="인그레스-Nginx-인그레스-컨트롤러-를-통한-접속-HTTP-인입-확인"><a href="#인그레스-Nginx-인그레스-컨트롤러-를-통한-접속-HTTP-인입-확인" class="headerlink" title="인그레스(Nginx 인그레스 컨트롤러)를 통한 접속(HTTP 인입) 확인"></a>인그레스(Nginx 인그레스 컨트롤러)를 통한 접속(HTTP 인입) 확인</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 로그 모니터링</span></span><br><span class="line"><span class="string">kubetail</span> <span class="string">-n</span> <span class="string">ingress</span> <span class="string">-l</span> <span class="string">app.kubernetes.io/component=controller</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (옵션) ingress nginx 파드 vethY 에서 패킷 캡처 후 확인 해 볼 것</span></span><br><span class="line"></span><br><span class="line"><span class="string">------------</span></span><br><span class="line"><span class="comment"># 자신의 PC 에서 접속 테스트</span></span><br><span class="line"><span class="comment"># svc3-admin 접속 &gt; 결과 확인 : 왜 접속이 되지 않는가? HTTP 헤더에 Host 필드를 잘 확인해보자!</span></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYIP:30080</span> <span class="string">-v</span></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYIP:30080/echo</span> <span class="string">-v</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mypc에서 접속을 위한 설정</span></span><br><span class="line"><span class="comment">## /etc/hosts 수정 : 도메인 이름으로 접속하기 위해서 변수 지정</span></span><br><span class="line"><span class="comment">## 윈도우 C:\Windows\System32\drivers\etc\hosts</span></span><br><span class="line"><span class="comment">## 맥 sudo vim /etc/hosts</span></span><br><span class="line"><span class="string">MYDOMAIN1=&lt;각자</span> <span class="string">자신의</span> <span class="string">닉네임의</span> <span class="string">도메인&gt;</span></span><br><span class="line"><span class="string">MYDOMAIN2=&lt;test.각자</span> <span class="string">자신의</span> <span class="string">닉네임의</span> <span class="string">도메인&gt;</span></span><br><span class="line"><span class="string">MYDOMAIN1=staek.com</span></span><br><span class="line"><span class="string">MYDOMAIN2=test.staek.com</span></span><br><span class="line"><span class="string">echo</span> <span class="string">$MYIP</span> <span class="string">$MYDOMAIN1</span> <span class="string">$MYDOMAIN2</span></span><br><span class="line"></span><br><span class="line"><span class="string">echo</span> <span class="string">&quot;$MYIP $MYDOMAIN1&quot;</span> <span class="string">|</span> <span class="string">sudo</span> <span class="string">tee</span> <span class="string">-a</span> <span class="string">/etc/hosts</span></span><br><span class="line"><span class="string">echo</span> <span class="string">&quot;$MYIP $MYDOMAIN2&quot;</span> <span class="string">|</span> <span class="string">sudo</span> <span class="string">tee</span> <span class="string">-a</span> <span class="string">/etc/hosts</span></span><br><span class="line"><span class="string">cat</span> <span class="string">/etc/hosts</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">$MYDOMAIN1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># svc3-admin 접속 &gt; 결과 확인</span></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYDOMAIN1:30080</span> <span class="string">-v</span></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYDOMAIN1:30080/admin</span></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYDOMAIN1:30080/echo</span></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYDOMAIN1:30080/echo/1</span></span><br><span class="line"></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYDOMAIN2:30080</span> <span class="string">-v</span></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYDOMAIN2:30080/admin</span></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYDOMAIN2:30080/echo</span></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYDOMAIN2:30080/echo/1</span></span><br><span class="line"><span class="string">curl</span> <span class="string">$MYDOMAIN2:30080/echo/1/2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## (옵션) /etc/hosts 파일 변경 없이 접속 방안</span></span><br><span class="line"><span class="string">curl</span> <span class="string">-H</span> <span class="string">&quot;host: $MYDOMAIN1&quot;</span> <span class="string">$MYIP:30080</span></span><br></pre></td></tr></table></figure>





<h2 id="카나리-업그레이드"><a href="#카나리-업그레이드" class="headerlink" title="카나리 업그레이드"></a>카나리 업그레이드</h2><p>canary-svc1-pod.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dp-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">svc-v1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">svc-v1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-v1</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">k8s.gcr.io/echoserver:1.5</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">svc-v1</span></span><br></pre></td></tr></table></figure>

<p>canary-svc2-pod.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dp-v2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">svc-v2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">svc-v2</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-v2</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">k8s.gcr.io/echoserver:1.6</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-v2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web-port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">svc-v2</span></span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 터미널1</span></span><br><span class="line"><span class="string">watch</span> <span class="string">-d</span> <span class="string">&#x27;kubectl get ingress,svc,ep,pod -owide&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 생성</span></span><br><span class="line"><span class="string">curl</span> <span class="string">-s</span> <span class="string">-O</span> <span class="string">https://raw.githubusercontent.com/gasida/NDKS/main/7/canary-svc1-pod.yaml</span></span><br><span class="line"><span class="string">curl</span> <span class="string">-s</span> <span class="string">-O</span> <span class="string">https://raw.githubusercontent.com/gasida/NDKS/main/7/canary-svc2-pod.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">canary-svc1-pod.yaml,canary-svc2-pod.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">svc,ep,pod</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 버전 확인: 1.13.0 vs 1.13.1</span></span><br><span class="line"><span class="string">for</span> <span class="string">pod</span> <span class="string">in</span> <span class="string">$(kubectl</span> <span class="string">get</span> <span class="string">pod</span> <span class="string">-o</span> <span class="string">wide</span> <span class="string">-l</span> <span class="string">app=svc-v1</span> <span class="string">|awk</span> <span class="string">&#x27;NR&gt;1 &#123;print $6&#125;&#x27;</span><span class="string">);</span> <span class="string">do</span> <span class="string">curl</span> <span class="string">-s</span> <span class="string">$pod:8080</span> <span class="string">|</span> <span class="string">egrep</span> <span class="string">&#x27;(Hostname|nginx)&#x27;</span><span class="string">;</span> <span class="string">done</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Hostname:</span> <span class="string">dp-v1-8684d45558-9kb59</span></span><br><span class="line">	<span class="string">server_version=nginx:</span> <span class="attr">1.13.0 - lua:</span> <span class="number">10008</span></span><br><span class="line"><span class="attr">Hostname:</span> <span class="string">dp-v1-8684d45558-drwzf</span></span><br><span class="line">	<span class="string">server_version=nginx:</span> <span class="attr">1.13.0 - lua:</span> <span class="number">10008</span></span><br><span class="line"><span class="attr">Hostname:</span> <span class="string">dp-v1-8684d45558-hzcth</span></span><br><span class="line">	<span class="string">server_version=nginx:</span> <span class="attr">1.13.0 - lua:</span> <span class="number">10008</span></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"><span class="string">for</span> <span class="string">pod</span> <span class="string">in</span> <span class="string">$(kubectl</span> <span class="string">get</span> <span class="string">pod</span> <span class="string">-o</span> <span class="string">wide</span> <span class="string">-l</span> <span class="string">app=svc-v2</span> <span class="string">|awk</span> <span class="string">&#x27;NR&gt;1 &#123;print $6&#125;&#x27;</span><span class="string">);</span> <span class="string">do</span> <span class="string">curl</span> <span class="string">-s</span> <span class="string">$pod:8080</span> <span class="string">|</span> <span class="string">egrep</span> <span class="string">&#x27;(Hostname|nginx)&#x27;</span><span class="string">;</span> <span class="string">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">Hostname:</span> <span class="string">dp-v2-7757c4bdc-b8bkt</span></span><br><span class="line">	<span class="string">server_version=nginx:</span> <span class="attr">1.13.1 - lua:</span> <span class="number">10008</span></span><br><span class="line"><span class="attr">Hostname:</span> <span class="string">dp-v2-7757c4bdc-ggx8l</span></span><br><span class="line">	<span class="string">server_version=nginx:</span> <span class="attr">1.13.1 - lua:</span> <span class="number">10008</span></span><br><span class="line"><span class="attr">Hostname:</span> <span class="string">dp-v2-7757c4bdc-zfxfc</span></span><br><span class="line">	<span class="string">server_version=nginx:</span> <span class="attr">1.13.1 - lua:</span> <span class="number">10008</span></span><br><span class="line">	</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/ingress-22.png"></p>
<p>canary-ingress1.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOT&gt;</span> <span class="string">canary-ingress1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-canary-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">kans.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc-v1</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line"><span class="string">EOT</span></span><br></pre></td></tr></table></figure>

<p>canary-ingress2.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOT&gt;</span> <span class="string">canary-ingress2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-canary-v2</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/canary:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/canary-weight:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">kans.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc-v2</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line"><span class="string">EOT</span></span><br></pre></td></tr></table></figure>







<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 터미널1</span></span><br><span class="line"><span class="string">watch</span> <span class="string">-d</span> <span class="string">&#x27;kubectl get ingress,svc,ep&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 도메인 변경</span></span><br><span class="line"><span class="string">MYDOMAIN1=staek.com</span></span><br><span class="line"><span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/kans.com/$MYDOMAIN1/g&quot;</span> <span class="string">canary-ingress1.yaml</span></span><br><span class="line"><span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/kans.com/$MYDOMAIN1/g&quot;</span> <span class="string">canary-ingress2.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 생성</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">canary-ingress1.yaml,canary-ingress2.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 로그 모니터링</span></span><br><span class="line"><span class="string">kubetail</span> <span class="string">-n</span> <span class="string">ingress</span> <span class="string">-l</span> <span class="string">app.kubernetes.io/component=controller</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 접속 테스트</span></span><br><span class="line"><span class="string">curl</span> <span class="string">-s</span> <span class="string">$MYDOMAIN1:30080</span></span><br><span class="line"><span class="string">curl</span> <span class="string">-s</span> <span class="string">$MYDOMAIN1:30080</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 접속 시 v1 v2 버전별 비율이 어떻게 되나요? 왜 이렇게 되나요?</span></span><br><span class="line"><span class="string">for</span> <span class="string">i</span> <span class="string">in</span> &#123;<span class="number">1</span><span class="string">..100</span>&#125;<span class="string">;</span>  <span class="string">do</span> <span class="string">curl</span> <span class="string">-s</span> <span class="string">$MYDOMAIN1:30080</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">nginx</span> <span class="string">;</span> <span class="string">done</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">|</span> <span class="string">uniq</span> <span class="string">-c</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">-nr</span></span><br><span class="line"><span class="string">for</span> <span class="string">i</span> <span class="string">in</span> &#123;<span class="number">1</span><span class="string">..1000</span>&#125;<span class="string">;</span> <span class="string">do</span> <span class="string">curl</span> <span class="string">-s</span> <span class="string">$MYDOMAIN1:30080</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">nginx</span> <span class="string">;</span> <span class="string">done</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">|</span> <span class="string">uniq</span> <span class="string">-c</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">-nr</span></span><br><span class="line"><span class="string">while</span> <span class="literal">true</span><span class="string">;</span> <span class="string">do</span> <span class="string">curl</span> <span class="string">-s</span> <span class="string">--connect-timeout</span> <span class="number">1</span> <span class="string">$MYDOMAIN1:30080</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">Hostname</span> <span class="string">;</span> <span class="string">echo</span> <span class="string">&quot;--------------&quot;</span> <span class="string">;</span> <span class="string">date</span> <span class="string">&quot;+%Y-%m-%d %H:%M:%S&quot;</span> <span class="string">;</span> <span class="string">sleep</span> <span class="number">1</span><span class="string">;</span> <span class="string">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 비율 조정 &gt;&gt; 개발 배포 버전 전략에 유용하다!</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">annotate</span> <span class="string">--overwrite</span> <span class="string">ingress</span> <span class="string">ingress-canary-v2</span> <span class="string">nginx.ingress.kubernetes.io/canary-weight=50</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 접속 테스트</span></span><br><span class="line"><span class="string">for</span> <span class="string">i</span> <span class="string">in</span> &#123;<span class="number">1</span><span class="string">..100</span>&#125;<span class="string">;</span>  <span class="string">do</span> <span class="string">curl</span> <span class="string">-s</span> <span class="string">$MYDOMAIN1:30080</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">nginx</span> <span class="string">;</span> <span class="string">done</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">|</span> <span class="string">uniq</span> <span class="string">-c</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">-nr</span></span><br><span class="line"><span class="string">for</span> <span class="string">i</span> <span class="string">in</span> &#123;<span class="number">1</span><span class="string">..1000</span>&#125;<span class="string">;</span> <span class="string">do</span> <span class="string">curl</span> <span class="string">-s</span> <span class="string">$MYDOMAIN1:30080</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">nginx</span> <span class="string">;</span> <span class="string">done</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">|</span> <span class="string">uniq</span> <span class="string">-c</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">-nr</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (옵션) 비율 조정 &lt;&lt; 어떻게 비율이 조정될까요?</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">annotate</span> <span class="string">--overwrite</span> <span class="string">ingress</span> <span class="string">ingress-canary-v2</span> <span class="string">nginx.ingress.kubernetes.io/canary-weight=100</span></span><br><span class="line"><span class="string">for</span> <span class="string">i</span> <span class="string">in</span> &#123;<span class="number">1</span><span class="string">..100</span>&#125;<span class="string">;</span>  <span class="string">do</span> <span class="string">curl</span> <span class="string">-s</span> <span class="string">$MYDOMAIN1:30080</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">nginx</span> <span class="string">;</span> <span class="string">done</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">|</span> <span class="string">uniq</span> <span class="string">-c</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">-nr</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (옵션) 비율 조정 &lt;&lt; 어떻게 비율이 조정될까요?</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">annotate</span> <span class="string">--overwrite</span> <span class="string">ingress</span> <span class="string">ingress-canary-v2</span> <span class="string">nginx.ingress.kubernetes.io/canary-weight=0</span></span><br><span class="line"><span class="string">for</span> <span class="string">i</span> <span class="string">in</span> &#123;<span class="number">1</span><span class="string">..100</span>&#125;<span class="string">;</span>  <span class="string">do</span> <span class="string">curl</span> <span class="string">-s</span> <span class="string">$MYDOMAIN1:30080</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">nginx</span> <span class="string">;</span> <span class="string">done</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">|</span> <span class="string">uniq</span> <span class="string">-c</span> <span class="string">|</span> <span class="string">sort</span> <span class="string">-nr</span></span><br></pre></td></tr></table></figure>



<p>아래와 같이 기본 비율과 <code>canary-weight=50</code> 비율 차이를 보자.</p>
<p><img src="/blog/img/ingress-23.png"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl annotate --overwrite ingress ingress-canary-v2 nginx.ingress.kubernetes.io/canary-weight=50</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/ingress-24.png"></p>
<p>삭제</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete deployments,svc,ingress --all</span><br></pre></td></tr></table></figure>





<h2 id="HTTPS-처리-TLS-종료-링크"><a href="#HTTPS-처리-TLS-종료-링크" class="headerlink" title="HTTPS 처리 (TLS 종료) - 링크"></a>HTTPS 처리 (TLS 종료) - <a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/examples/tls-termination/">링크</a></h2><p><img src="/blog/img/ingress-25.png"></p>
<p>svc-pod.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-https</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">https</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s.gcr.io/echoserver:1.6</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-https</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<p>ssl-termination-ingress.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOT&gt;</span> <span class="string">ssl-termination-ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kans.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">secret-https</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">kans.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">svc-https</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line"><span class="string">EOT</span></span><br></pre></td></tr></table></figure>





<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 서비스와 파드 생성</span></span><br><span class="line">curl -s -O https://raw.githubusercontent.com/gasida/NDKS/main/7/svc-pod.yaml</span><br><span class="line">kubectl apply -f svc-pod.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 도메인 변경</span></span><br><span class="line">MYDOMAIN1=&lt;각자 자신의 닉네임의 도메인&gt; 예시) gasida.com</span><br><span class="line">MYDOMAIN1=kans.com</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$MYDOMAIN1</span></span><br><span class="line">sed -i <span class="string">&quot;s/kans.com/<span class="variable">$MYDOMAIN1</span>/g&quot;</span> ssl-termination-ingress.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 인그레스 생성</span></span><br><span class="line">kubectl apply -f ssl-termination-ingress.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 인증서 생성</span></span><br><span class="line"><span class="comment"># openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj &quot;/CN=dkos.com/O=dkos.com&quot;mkdir key &amp;&amp; cd key</span></span><br><span class="line">MYDOMAIN1=kans.com</span><br><span class="line">openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj <span class="string">&quot;/CN=<span class="variable">$MYDOMAIN1</span>/O=<span class="variable">$MYDOMAIN1</span>&quot;</span></span><br><span class="line">tree</span><br><span class="line"></span><br><span class="line"><span class="comment"># Secret 생성</span></span><br><span class="line">kubectl create secret tls secret-https --key tls.key --cert tls.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># Secret 확인 </span></span><br><span class="line">kubectl get secrets secret-https</span><br><span class="line">kubectl get secrets secret-https -o yaml</span><br><span class="line"></span><br><span class="line">-------------------</span><br><span class="line"><span class="comment"># 자신의 PC 에서 접속 확인 : PC 웹브라우저</span></span><br><span class="line"><span class="comment"># 접속 확인 : -k 는 https 접속 시 : 접속 포트 정보 확인</span></span><br><span class="line">curl -Lk https://<span class="variable">$MYDOMAIN1</span>:30443</span><br><span class="line"></span><br><span class="line"><span class="comment">## (옵션) /etc/hosts 파일 변경 없이 접속 방안</span></span><br><span class="line">curl -Lk -H <span class="string">&quot;host: <span class="variable">$MYDOMAIN1</span>&quot;</span> https://<span class="variable">$MYDOMAIN1</span>:30443</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/ingress-26.png"></p>
<p><img src="/blog/img/ingress-27.png"></p>
<p>Nginx SSL Termination 패킷 확인 : 중간 172.16.29.11 이 nginx controller</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 패킷 캡처 명령어 참고</span></span><br><span class="line"><span class="built_in">export</span> IngHttp=$(kubectl get service -n ingress-nginx ingress-nginx-controller -o jsonpath=<span class="string">&#x27;&#123;.spec.ports[0].nodePort&#125;&#x27;</span>)</span><br><span class="line"><span class="built_in">export</span> IngHttps=$(kubectl get service -n ingress-nginx ingress-nginx-controller -o jsonpath=<span class="string">&#x27;&#123;.spec.ports[1].nodePort&#125;&#x27;</span>)</span><br><span class="line">tcpdump -i &lt;nginx 파드 veth&gt; -nnq tcp port 80 or tcp port 443 or tcp port 8080 or tcp port <span class="variable">$IngHttp</span> or tcp port <span class="variable">$IngHttps</span></span><br><span class="line">tcpdump -i &lt;nginx 파드 veth&gt; -nn  tcp port 80 or tcp port 443 or tcp port 8080 or tcp port <span class="variable">$IngHttp</span> or tcp port <span class="variable">$IngHttps</span> -w /tmp/ingress.pcap</span><br></pre></td></tr></table></figure>



<p>삭제</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod,svc,ingress --all</span><br><span class="line">helm uninstall -n ingress ingress-nginx</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CloudFormation 스택 삭제</span></span><br><span class="line">aws cloudformation delete-stack --stack-name mylab</span><br><span class="line"></span><br><span class="line"><span class="comment"># [모니터링] CloudFormation 스택 상태 : 삭제 확인</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> </span><br><span class="line">  <span class="built_in">date</span></span><br><span class="line">  AWS_PAGER=<span class="string">&quot;&quot;</span> aws cloudformation list-stacks \</span><br><span class="line">    --stack-status-filter CREATE_IN_PROGRESS CREATE_COMPLETE CREATE_FAILED DELETE_IN_PROGRESS DELETE_FAILED \</span><br><span class="line">    --query <span class="string">&quot;StackSummaries[*].&#123;StackName:StackName, StackStatus:StackStatus&#125;&quot;</span> \</span><br><span class="line">    --output table</span><br><span class="line">  <span class="built_in">sleep</span> 1</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

























































</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-12-01T01:00:35.000Z" title="2024. 12. 1. 오전 10:00:35">2024-12-01</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-12-01T13:47:29.064Z" title="2024. 12. 1. 오후 10:47:29">2024-12-01</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/gateway-gloo/">gateway/gloo</a></span><span class="level-item">16 minutes read (About 2338 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/12/01/docs/gateway/gloo/">gloo</a></h1><div class="content"><p><strong>Install KinD Cluster</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">**<span class="built_in">cat</span> &lt;&lt;<span class="string">EOT&gt; kind-1node.yaml**</span></span><br><span class="line"><span class="string">kind: Cluster</span></span><br><span class="line"><span class="string">apiVersion: kind.x-k8s.io/v1alpha4</span></span><br><span class="line"><span class="string">nodes:</span></span><br><span class="line"><span class="string">- role: **control-plane**</span></span><br><span class="line"><span class="string">  extraPortMappings:</span></span><br><span class="line"><span class="string">  - containerPort: 30000</span></span><br><span class="line"><span class="string">    hostPort: 30000</span></span><br><span class="line"><span class="string">  - containerPort: 30001</span></span><br><span class="line"><span class="string">    hostPort: 30001</span></span><br><span class="line"><span class="string">  - containerPort: 30002</span></span><br><span class="line"><span class="string">    hostPort: 30002</span></span><br><span class="line"><span class="string">**EOT</span>**</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install KinD Cluster</span></span><br><span class="line">kind create cluster --image **kindest/node:v1.30.0** --config **kind-1node.yaml** --name **myk8s**</span><br><span class="line"></span><br><span class="line"><span class="comment"># 노드에 기본 툴 설치</span></span><br><span class="line">docker <span class="built_in">exec</span> -it **myk8s-control-plane sh -c <span class="string">&#x27;**apt update &amp;&amp; apt install tree psmisc lsof wget bsdmainutils bridge-utils net-tools dnsutils tcpdump ngrep iputils-ping **git vim** -y&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 노드/파드 확인</span></span><br><span class="line">kubectl get nodes -o wide</span><br><span class="line">kubectl get pod -A</span><br></pre></td></tr></table></figure>

<p><strong>Install Gateway API CRDs</strong> : The Kubernetes Gateway API abstractions are expressed using Kubernetes CRDs.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CRDs 설치 및 확인</span></span><br><span class="line">**kubectl apply -f &lt;https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.0.0/standard-install.yaml**&gt;</span><br><span class="line">kubectl get crd</span><br></pre></td></tr></table></figure>

<p><strong>Install Glooctl Utility</strong> : GLOOCTL is a command-line utility that allows users to view, manage, and debug Gloo Gateway deployments - <a target="_blank" rel="noopener" href="https://docs.solo.io/gloo-edge/latest/installation/glooctl_setup/">Link</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># [신규 터미널] 아래 bash 진입 후 glooctl 툴 사용</span></span><br><span class="line">**docker <span class="built_in">exec</span> -it myk8s-control-plane bash**</span><br><span class="line">----------------------------------------</span><br><span class="line"><span class="comment"># Install Glooctl Utility</span></span><br><span class="line"><span class="comment">## glooctl install gateway     # install gloo&#x27;s function gateway functionality into the &#x27;gloo-system&#x27; namespace</span></span><br><span class="line"><span class="comment">## glooctl install ingress     # install very basic Kubernetes Ingress support with Gloo into namespace gloo-system</span></span><br><span class="line"><span class="comment">## glooctl install knative     # install Knative serving with Gloo configured as the default cluster ingress</span></span><br><span class="line"><span class="comment">## curl -sL &lt;https://run.solo.io/gloo/install&gt; | sh</span></span><br><span class="line">**curl -sL &lt;https://run.solo.io/gloo/install&gt; | GLOO_VERSION=v1.17.7 sh**</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$HOME</span>/.gloo/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 버전 확인</span></span><br><span class="line">**glooctl version**</span><br><span class="line"></span><br><span class="line">----------------------------------------</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;client&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: <span class="string">&quot;1.17.7&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;kubernetesCluster&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;major&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;minor&quot;</span>: <span class="string">&quot;30&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gitVersion&quot;</span>: <span class="string">&quot;v1.30.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;buildDate&quot;</span>: <span class="string">&quot;2024-05-13T22:02:25Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;platform&quot;</span>: <span class="string">&quot;linux/arm64&quot;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>gloo 설치 </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># [신규 터미널] 모니터링</span></span><br><span class="line">watch -d kubectl get pod,svc,endpointslices,ep -n gloo-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install Gloo Gateway</span></span><br><span class="line"><span class="comment">## --set kubeGateway.enabled=true: Kubernetes Gateway 기능을 활성화합니다.</span></span><br><span class="line"><span class="comment">## --set gloo.disableLeaderElection=true: Gloo의 리더 선출 기능을 비활성화합니다. (단일 인스턴스에서 Gloo를 실행 시 유용)</span></span><br><span class="line"><span class="comment">## --set discovery.enabled=false: 서비스 디스커버리 기능을 비활성화합니다.</span></span><br><span class="line">helm repo add gloo https://storage.googleapis.com/solo-public-helm</span><br><span class="line">helm repo update</span><br><span class="line">helm install -n gloo-system gloo-gateway gloo/gloo \</span><br><span class="line">--create-namespace \</span><br><span class="line">--version 1.17.7 \</span><br><span class="line">--<span class="built_in">set</span> kubeGateway.enabled=<span class="literal">true</span> \</span><br><span class="line">--<span class="built_in">set</span> gloo.disableLeaderElection=<span class="literal">true</span> \</span><br><span class="line">--<span class="built_in">set</span> discovery.enabled=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Confirm that the Gloo control plane has successfully been deployed using this command</span></span><br><span class="line">kubectl rollout status deployment/gloo -n gloo-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 설치 확인</span></span><br><span class="line">kubectl get crd | grep <span class="string">&#x27;networking.k8s.io&#x27;</span></span><br><span class="line">kubectl get crd | grep -v <span class="string">&#x27;networking.k8s.io&#x27;</span></span><br><span class="line">kubectl get pod,svc,endpointslices -n gloo-system</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl explain gatewayclasses</span><br><span class="line">kubectl get gatewayclasses</span><br><span class="line">NAME           CONTROLLER             ACCEPTED   AGE</span><br><span class="line">gloo-gateway   solo.io/gloo-gateway   True       21m</span><br><span class="line"></span><br><span class="line">kubectl get gatewayclasses -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">items:</span><br><span class="line">- apiVersion: gateway.networking.k8s.io/v1</span><br><span class="line">  kind: GatewayClass</span><br><span class="line">  metadata:</span><br><span class="line">    labels:</span><br><span class="line">      app: gloo</span><br><span class="line">    name: gloo-gateway</span><br><span class="line">  spec:</span><br><span class="line">    controllerName: solo.io/gloo-gateway</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/gateway-03.png"></p>
<p>접속확인</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">watch -d kubectl get pod,svc,endpointslices,ep -n httpbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install Httpbin Application</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/solo-io/solo-blog/main/gateway-api-tutorial/01-httpbin-svc.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 설치 확인</span></span><br><span class="line">kubectl get deploy,pod,svc,endpointslices,sa -n httpbin</span><br><span class="line">kubectl rollout status deploy/httpbin -n httpbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># (옵션) NodePort 설정</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl apply -f -</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: httpbin</span></span><br><span class="line"><span class="string">    service: httpbin</span></span><br><span class="line"><span class="string">  name: httpbin</span></span><br><span class="line"><span class="string">  namespace: httpbin</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  type: NodePort</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">  - name: http</span></span><br><span class="line"><span class="string">    port: 8000</span></span><br><span class="line"><span class="string">    targetPort: 80</span></span><br><span class="line"><span class="string">    nodePort: 30000</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: httpbin</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (옵션) 로컬 접속 확인</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;httpbin web - http://localhost:30000&quot;</span>     <span class="comment"># macOS 사용자</span></span><br><span class="line"></span><br><span class="line">httpbin web - http://localhost:30000</span><br></pre></td></tr></table></figure>



<h3 id="Configure-a-Gateway-Listener"><a href="#Configure-a-Gateway-Listener" class="headerlink" title="Configure a Gateway Listener"></a>Configure a Gateway Listener</h3><ul>
<li>Let’s begin by establishing a Gateway resource that sets up an HTTP listener on port 8080 to expose routes from all our namespaces. Gateway custom resources like this are part of the Gateway API standard.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 02-gateway.yaml</span></span><br><span class="line">kind: Gateway</span><br><span class="line">apiVersion: gateway.networking.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: http</span><br><span class="line">spec:</span><br><span class="line">  gatewayClassName: gloo-gateway</span><br><span class="line">  listeners:</span><br><span class="line">  - protocol: HTTP</span><br><span class="line">    port: 8080</span><br><span class="line">    name: http</span><br><span class="line">    allowedRoutes:</span><br><span class="line">      namespaces:</span><br><span class="line">        from: All</span><br><span class="line"></span><br><span class="line"><span class="comment"># gateway 리소스 생성</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/02-gateway.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인 : Now we can confirm that the Gateway has been activated</span></span><br><span class="line">kubectl get gateway -n gloo-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># You can also confirm that Gloo Gateway has spun up an Envoy proxy instance in response to the creation of this Gateway object by deploying gloo-proxy-http:</span></span><br><span class="line">kubectl get deployment gloo-proxy-http -n gloo-system</span><br><span class="line">NAME              READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">gloo-proxy-http   1/1     1            1           5m22s</span><br><span class="line"></span><br><span class="line"><span class="comment"># envoy 사용 확인</span></span><br><span class="line">kubectl get pod -n gloo-system</span><br><span class="line">kubectl describe pod -n gloo-system  |grep Image:</span><br><span class="line">    Image:         quay.io/solo-io/gloo-envoy-wrapper:1.17.7</span><br><span class="line">    Image:          quay.io/solo-io/gloo:1.17.7</span><br><span class="line">    Image:         quay.io/solo-io/gloo-envoy-wrapper:1.17.7</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># gloo-proxy-http 서비스는 External-IP는 Pending 상태</span></span><br><span class="line">kubectl get svc -n gloo-system gloo-proxy-http</span><br><span class="line">NAME              TYPE           CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">gloo-proxy-http   LoadBalancer   10.96.71.22   &lt;pending&gt;     8080:31555/TCP   2m4s</span><br><span class="line"></span><br><span class="line"><span class="comment"># gloo-proxy-http NodePort 30001 설정</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl apply -f -</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app.kubernetes.io/instance: http</span></span><br><span class="line"><span class="string">    app.kubernetes.io/managed-by: Helm</span></span><br><span class="line"><span class="string">    app.kubernetes.io/name: gloo-proxy-http</span></span><br><span class="line"><span class="string">    app.kubernetes.io/version: 1.17.7</span></span><br><span class="line"><span class="string">    gateway.networking.k8s.io/gateway-name: http</span></span><br><span class="line"><span class="string">    gloo: kube-gateway</span></span><br><span class="line"><span class="string">    helm.sh/chart: gloo-gateway-1.17.7</span></span><br><span class="line"><span class="string">  name: gloo-proxy-http</span></span><br><span class="line"><span class="string">  namespace: gloo-system</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">  - name: http</span></span><br><span class="line"><span class="string">    nodePort: 30001</span></span><br><span class="line"><span class="string">    port: 8080</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app.kubernetes.io/instance: http</span></span><br><span class="line"><span class="string">    app.kubernetes.io/name: gloo-proxy-http</span></span><br><span class="line"><span class="string">    gateway.networking.k8s.io/gateway-name: http</span></span><br><span class="line"><span class="string">  type: LoadBalancer</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">kubectl get svc -n gloo-system gloo-proxy-http</span><br><span class="line"></span><br><span class="line">NAME              TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">gloo-proxy-http   LoadBalancer   10.96.227.35   &lt;pending&gt;     8080:30001/TCP   51s</span><br></pre></td></tr></table></figure>







<h4 id="Configure-Simple-Routing-with-an-HTTPRoute"><a href="#Configure-Simple-Routing-with-an-HTTPRoute" class="headerlink" title="Configure Simple Routing with an HTTPRoute"></a>Configure Simple Routing with an HTTPRoute</h4><p><img src="/blog/img/gateway-04.png"></p>
<p><code>HTTPRoute</code> is one of the new Kubernetes CRDs introduced by the Gateway API, as documented <a target="_blank" rel="noopener" href="https://gateway-api.sigs.k8s.io/api-types/httproute/">here</a>. We’ll start by introducing a simple HTTPRoute for our service.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">gateway.networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HTTPRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">httpbin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">httpbin</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">example:</span> <span class="string">httpbin-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">parentRefs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">gloo-system</span></span><br><span class="line">  <span class="attr">hostnames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;api.example.com&quot;</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">matches:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Exact</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">/get</span></span><br><span class="line">    <span class="attr">backendRefs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">httpbin</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8000</span></span><br></pre></td></tr></table></figure>

<p>This example attaches to the default Gateway object created for us when we installed Gloo Gateway earlier.<br>See the gloo-system&#x2F;http reference in the parentRefs stanza. </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Our route watches for HTTP requests directed at the host api.example.com with the request path /get and then forwards the request to the httpbin service on port 8000.</span></span><br><span class="line"><span class="comment"># Let’s establish this route now:</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/03-httpbin-route.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl get httproute -n httpbin</span><br><span class="line">NAME      HOSTNAMES             AGE</span><br><span class="line">httpbin   [<span class="string">&quot;api.example.com&quot;</span>]   3m15s</span><br><span class="line"></span><br><span class="line">kubectl describe httproute -n httpbin</span><br></pre></td></tr></table></figure>



<h4 id="Test-the-Simple-Route-with-Curl"><a href="#Test-the-Simple-Route-with-Curl" class="headerlink" title="Test the Simple Route with Curl"></a>Test the Simple Route with Curl</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># let’s use curl to display the response with the -i option to additionally show the HTTP response code and headers.</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;127.0.0.1 api.example.com&quot;</span> | sudo <span class="built_in">tee</span> -a /etc/hosts</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;httproute - http://api.example.com:30001/get&quot;</span> <span class="comment"># 웹브라우저</span></span><br><span class="line">혹은</span><br><span class="line">curl -is -H <span class="string">&quot;Host: api.example.com&quot;</span> http://localhost:8080/get <span class="comment"># kubectl port-forward 사용 시</span></span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/gateway-05.png"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 호출 응답 왜 그럴까?</span></span><br><span class="line">curl -is -H <span class="string">&quot;Host: api.example.com&quot;</span> http://localhost:8080/delay/1</span><br><span class="line">HTTP/1.1 404 Not Found</span><br><span class="line"><span class="built_in">date</span>: Wed, 03 Jul 2024 07:19:21 GMT</span><br><span class="line">server: envoy</span><br><span class="line">content-length: 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># nodeport 직접 접속</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;httproute - http://api.example.com:30000/delay/1&quot;</span> <span class="comment"># 1초 후 응답</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;httproute - http://api.example.com:30000/delay/5&quot;</span> <span class="comment"># 5초 후 응답</span></span><br></pre></td></tr></table></figure>





<p><img src="/blog/img/gateway-06.png"></p>
<h3 id="정규식-패턴-매칭-Explore-Routing-with-Regex-Matching-Patterns"><a href="#정규식-패턴-매칭-Explore-Routing-with-Regex-Matching-Patterns" class="headerlink" title="[정규식 패턴 매칭] Explore Routing with Regex Matching Patterns"></a>[정규식 패턴 매칭] Explore Routing with Regex Matching Patterns</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;httproute - http://api.example.com:30001/api/httpbin/get&quot;</span> <span class="comment"># 웹브라우저</span></span><br><span class="line">혹은</span><br><span class="line">curl -is -H <span class="string">&quot;Host: api.example.com&quot;</span> http://localhost:8080/api/httpbin/get <span class="comment"># kubectl port-forward 사용 시</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">server: envoy</span><br><span class="line"><span class="built_in">date</span>: Sun, 06 Oct 2024 08:08:09 GMT</span><br><span class="line">content-type: application/json</span><br><span class="line">content-length: 289</span><br><span class="line">access-control-allow-origin: *</span><br><span class="line">access-control-allow-credentials: <span class="literal">true</span></span><br><span class="line">x-envoy-upstream-service-time: 18  <span class="comment"># envoy 가 업스트림 httpbin 요청 처리에 걸리 시간 0.018초</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;args&quot;</span>: &#123;&#125;, </span><br><span class="line">  <span class="string">&quot;headers&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;Host&quot;</span>: <span class="string">&quot;api.example.com&quot;</span>, </span><br><span class="line">    <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;curl/8.7.1&quot;</span>, </span><br><span class="line">    <span class="string">&quot;X-Envoy-Expected-Rq-Timeout-Ms&quot;</span>: <span class="string">&quot;15000&quot;</span>, </span><br><span class="line">    <span class="string">&quot;X-Envoy-Original-Path&quot;</span>: <span class="string">&quot;/api/httpbin/get&quot;</span></span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="string">&quot;origin&quot;</span>: <span class="string">&quot;10.244.0.11&quot;</span>, </span><br><span class="line">  <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://api.example.com/get&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 아래 NodePort 와 GW API 통한 접속 비교</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;httproute - http://api.example.com:30001/api/httpbin/get&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;httproute - http://api.example.com:30000/api/httpbin/get&quot;</span> <span class="comment"># NodePort 직접 접근</span></span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/gateway-07.png"></p>
<p><img src="/blog/img/gateway-08.png"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;httproute - http://api.example.com:30001/api/httpbin/delay/1&quot;</span> <span class="comment"># 웹브라우저</span></span><br><span class="line">혹은</span><br><span class="line">curl -is -H <span class="string">&quot;Host: api.example.com&quot;</span> http://localhost:8080/api/httpbin/delay/1 <span class="comment"># kubectl port-forward 사용 시</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">server: envoy</span><br><span class="line"><span class="built_in">date</span>: Wed, 03 Jul 2024 07:31:47 GMT</span><br><span class="line">content-type: application/json</span><br><span class="line">content-length: 342</span><br><span class="line">access-control-allow-origin: *</span><br><span class="line">access-control-allow-credentials: <span class="literal">true</span></span><br><span class="line">x-envoy-upstream-service-time: 1023   <span class="comment"># envoy 가 업스트림 httpbin 요청 처리에 걸리 시간 1초 이상</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;args&quot;</span>: &#123;&#125;, </span><br><span class="line">  <span class="string">&quot;data&quot;</span>: <span class="string">&quot;&quot;</span>, </span><br><span class="line">  <span class="string">&quot;files&quot;</span>: &#123;&#125;, </span><br><span class="line">  <span class="string">&quot;form&quot;</span>: &#123;&#125;, </span><br><span class="line">  <span class="string">&quot;headers&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;Host&quot;</span>: <span class="string">&quot;api.example.com&quot;</span>, </span><br><span class="line">    <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;curl/8.6.0&quot;</span>, </span><br><span class="line">    <span class="string">&quot;X-Envoy-Expected-Rq-Timeout-Ms&quot;</span>: <span class="string">&quot;15000&quot;</span>, </span><br><span class="line">    <span class="string">&quot;X-Envoy-Original-Path&quot;</span>: <span class="string">&quot;/api/httpbin/delay/1&quot;</span></span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="string">&quot;origin&quot;</span>: <span class="string">&quot;10.244.0.7&quot;</span>, </span><br><span class="line">  <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://api.example.com/delay/1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="/blog/img/gateway-09.png"></p>
<p><img src="/blog/img/gateway-10.png"></p>
<h3 id="업스트림-베어러-토큰을-사용한-변환-Test-Transformations-with-Upstream-Bearer-Tokens"><a href="#업스트림-베어러-토큰을-사용한-변환-Test-Transformations-with-Upstream-Bearer-Tokens" class="headerlink" title="[업스트림 베어러 토큰을 사용한 변환] Test Transformations with Upstream Bearer Tokens"></a>[업스트림 베어러 토큰을 사용한 변환] Test Transformations with Upstream Bearer Tokens</h3><ul>
<li>목적 : 요청을 라우팅하는 백엔드 시스템 중 하나에서 인증해야 하는 요구 사항이 있는 경우는 어떻게 할까요? 이 업스트림 시스템에는 권한 부여를 위한 API 키가 필요하고, 이를 소비하는 클라이언트에 직접 노출하고 싶지 않다고 가정해 보겠습니다. 즉, 프록시 계층에서 요청에 주입할 간단한 베어러 토큰을 구성하고 싶습니다. (정적 API 키 토큰을 직접 주입)</li>
</ul>
<p>설치</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/05-httpbin-rewrite-xform.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl describe httproute -n httpbin</span><br><span class="line">...</span><br><span class="line">Spec:</span><br><span class="line">  ...</span><br><span class="line">  Rules:</span><br><span class="line">    Backend Refs:</span><br><span class="line">      Group:   </span><br><span class="line">      Kind:    Service</span><br><span class="line">      Name:    httpbin</span><br><span class="line">      Port:    8000</span><br><span class="line">      Weight:  1</span><br><span class="line">    Filters:</span><br><span class="line">      Type:  URLRewrite</span><br><span class="line">      URL Rewrite:</span><br><span class="line">        Path:</span><br><span class="line">          Replace Prefix Match:  /</span><br><span class="line">          Type:                  ReplacePrefixMatch</span><br><span class="line">      Request Header Modifier:</span><br><span class="line">        Add:</span><br><span class="line">          Name:   Authorization</span><br><span class="line">          Value:  Bearer my-api-key</span><br><span class="line">      Type:       RequestHeaderModifier</span><br><span class="line">    Matches:</span><br><span class="line">      Path:</span><br><span class="line">        Type:   PathPrefix</span><br><span class="line">        Value:  /api/httpbin/</span><br></pre></td></tr></table></figure>

<p>테스트</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;httproute - http://api.example.com:30001/api/httpbin/get&quot;</span> <span class="comment"># 웹브라우저</span></span><br><span class="line">혹은</span><br><span class="line">curl -is -H <span class="string">&quot;Host: api.example.com&quot;</span> http://localhost:8080/api/httpbin/get <span class="comment"># kubectl port-forward 사용 시</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">server: envoy</span><br><span class="line"><span class="built_in">date</span>: Sun, 06 Oct 2024 08:20:00 GMT</span><br><span class="line">content-type: application/json</span><br><span class="line">content-length: 332</span><br><span class="line">access-control-allow-origin: *</span><br><span class="line">access-control-allow-credentials: <span class="literal">true</span></span><br><span class="line">x-envoy-upstream-service-time: 11</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;args&quot;</span>: &#123;&#125;, </span><br><span class="line">  <span class="string">&quot;headers&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;Authorization&quot;</span>: <span class="string">&quot;Bearer my-api-key&quot;</span>, </span><br><span class="line">    <span class="string">&quot;Host&quot;</span>: <span class="string">&quot;api.example.com&quot;</span>, </span><br><span class="line">    <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;curl/8.7.1&quot;</span>, </span><br><span class="line">    <span class="string">&quot;X-Envoy-Expected-Rq-Timeout-Ms&quot;</span>: <span class="string">&quot;15000&quot;</span>, </span><br><span class="line">    <span class="string">&quot;X-Envoy-Original-Path&quot;</span>: <span class="string">&quot;/api/httpbin/get&quot;</span></span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="string">&quot;origin&quot;</span>: <span class="string">&quot;10.244.0.11&quot;</span>, </span><br><span class="line">  <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://api.example.com/get&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/gateway-11.png"></p>
<h3 id="Migrate"><a href="#Migrate" class="headerlink" title="Migrate"></a>Migrate</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># You should see the response below, indicating deployments for both v1 and v2 of my-workload have been created in the my-workload namespace.</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/06-workload-svcs.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># v1,v2 2가지 버전 워크로드 확인</span></span><br><span class="line">kubectl get deploy,pod,svc,endpointslices -n my-workload</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/gateway-12.png"></p>
<p>Test Simple V1 Routing</p>
<p><img src="/blog/img/gateway-13.png"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">gateway.networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HTTPRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-workload</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">my-workload</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">example:</span> <span class="string">my-workload-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">parentRefs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">gloo-system</span></span><br><span class="line">  <span class="attr">hostnames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;api.example.com&quot;</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">matches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">PathPrefix</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/api/my-workload</span></span><br><span class="line">      <span class="attr">backendRefs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-workload-v1</span></span><br><span class="line">          <span class="attr">namespace:</span> <span class="string">my-workload</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<p>HTTPRoute 설치</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/07-workload-route.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl get httproute -A</span><br><span class="line">NAMESPACE     NAME          HOSTNAMES             AGE</span><br><span class="line">httpbin       httpbin       [<span class="string">&quot;api.example.com&quot;</span>]   41m</span><br><span class="line">my-workload   my-workload   [<span class="string">&quot;api.example.com&quot;</span>]   39s</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl describe httproute -n my-workload</span><br><span class="line">...</span><br><span class="line">Spec:</span><br><span class="line">  Hostnames:</span><br><span class="line">    api.example.com</span><br><span class="line">  Parent Refs:</span><br><span class="line">    Group:      gateway.networking.k8s.io</span><br><span class="line">    Kind:       Gateway</span><br><span class="line">    Name:       http</span><br><span class="line">    Namespace:  gloo-system</span><br><span class="line">  Rules:</span><br><span class="line">    Backend Refs:</span><br><span class="line">      Group:      </span><br><span class="line">      Kind:       Service</span><br><span class="line">      Name:       my-workload-v1</span><br><span class="line">      Namespace:  my-workload</span><br><span class="line">      Port:       8080</span><br><span class="line">      Weight:     1</span><br><span class="line">    Matches:</span><br><span class="line">      Path:</span><br><span class="line">        Type:   PathPrefix</span><br><span class="line">        Value:  /api/my-workload</span><br></pre></td></tr></table></figure>

<p>workload-v1 에만 접속됨을 확인</p>
<p><img src="/blog/img/gateway-14.png"></p>
<h3 id="Simulate-a-v2-Dark-Launch-with-Header-Based-Routing"><a href="#Simulate-a-v2-Dark-Launch-with-Header-Based-Routing" class="headerlink" title="Simulate a v2 Dark Launch with Header-Based Routing"></a>Simulate a v2 Dark Launch with Header-Based Routing</h3><p>Dark Launch : 일부 사용자에게 새로운 기능을 출시하여 피드백을 수집하고 잠재적으로 더 큰 사용자 커뮤니티를 방해하기 전에 개선 사항을 실험하는 훌륭한 클라우드 마이그레이션 기술</p>
<p><img src="/blog/img/gateway-16.png"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">rules:</span><br><span class="line">  - matches:</span><br><span class="line">    - path:</span><br><span class="line">        <span class="built_in">type</span>: PathPrefix</span><br><span class="line">        value: /api/my-workload</span><br><span class="line">      <span class="comment"># Add a matcher to route requests with a v2 version header to v2</span></span><br><span class="line">      <span class="comment"># version=v2 헤더값이 있는 사용자만 v2 라우팅</span></span><br><span class="line">      headers:</span><br><span class="line">      - name: version</span><br><span class="line">        value: v2</span><br><span class="line">    backendRefs:</span><br><span class="line">      - name: my-workload-v2</span><br><span class="line">        namespace: my-workload</span><br><span class="line">        port: 8080      </span><br><span class="line">  - matches:</span><br><span class="line">    <span class="comment"># Route requests without the version header to v1 as before</span></span><br><span class="line">    <span class="comment"># 대다수 일반 사용자는 기존 처럼 v1 라우팅</span></span><br><span class="line">    - path:</span><br><span class="line">        <span class="built_in">type</span>: PathPrefix</span><br><span class="line">        value: /api/my-workload</span><br><span class="line">    backendRefs:</span><br><span class="line">      - name: my-workload-v1</span><br><span class="line">        namespace: my-workload</span><br><span class="line">        port: 8080</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/08-workload-route-header.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">kubectl describe httproute -n my-workload</span><br><span class="line">...</span><br><span class="line">Spec:</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/gateway-17.png"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Now we’ll test the original route, with no special headers supplied, and confirm that traffic still goes to v1:</span></span><br><span class="line">curl -is -H <span class="string">&quot;Host: api.example.com&quot;</span> http://localhost:8080/api/my-workload</span><br><span class="line">curl -is -H <span class="string">&quot;Host: api.example.com&quot;</span> http://localhost:8080/api/my-workload | grep body</span><br><span class="line"><span class="string">&quot;body&quot;</span>: <span class="string">&quot;Hello From My Workload (v1)!&quot;</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment"># But it we supply the version: v2 header, note that our gateway routes the request to v2 as expected:</span></span><br><span class="line">curl -is -H <span class="string">&quot;Host: api.example.com&quot;</span> -H <span class="string">&quot;version: v2&quot;</span> http://localhost:8080/api/my-workload</span><br><span class="line">curl -is -H <span class="string">&quot;Host: api.example.com&quot;</span> -H <span class="string">&quot;version: v2&quot;</span> http://localhost:8080/api/my-workload | grep body</span><br></pre></td></tr></table></figure>

<ul>
<li>헤더에 <code>version: v1</code> 혹은 <code>version: v2</code> 를 작성하면 해당하는 팟에 접근됨</li>
</ul>
<p><img src="/blog/img/gateway-18.png"></p>
<h3 id="Expand-V2-Testing-with-Percentage-Based-Routing"><a href="#Expand-V2-Testing-with-Percentage-Based-Routing" class="headerlink" title="Expand V2 Testing with Percentage-Based Routing"></a>Expand V2 Testing with Percentage-Based Routing</h3><p>성공적인 다크 런칭 이후, 우리는 점진적으로 이전 버전에서 새 버전으로 사용자 트래픽을 옮기는 블루-그린 전략을 사용하는 기간을 원할 수 있습니다. 트래픽을 균등하게 분할하고 트래픽의 절반을 로 보내고 v1나머지 절반을 로 보내는 라우팅 정책으로 이를 살펴보겠습니다 v2.</p>
<p><img src="/blog/img/gateway-15.png"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Apply this 50-50 routing policy with kubectl:</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/solo-io/gloo-gateway-use-cases/main/gateway-api-tutorial/09-workload-route-split.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl describe httproute -n my-workload</span><br><span class="line">...</span><br><span class="line">  rules:</span><br><span class="line">    - matches:</span><br><span class="line">      - path:</span><br><span class="line">          <span class="built_in">type</span>: PathPrefix</span><br><span class="line">          value: /api/my-workload</span><br><span class="line">      <span class="comment"># Configure a 50-50 traffic split across v1 and v2 : 버전 1,2 50:50 비율</span></span><br><span class="line">      backendRefs:</span><br><span class="line">        - name: my-workload-v1</span><br><span class="line">          namespace: my-workload</span><br><span class="line">          port: 8080</span><br><span class="line">          weight: 50</span><br><span class="line">        - name: my-workload-v2</span><br><span class="line">          namespace: my-workload</span><br><span class="line">          port: 8080</span><br><span class="line">          weight: 50</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;; <span class="keyword">do</span> curl -s -H <span class="string">&quot;Host: api.example.com&quot;</span> http://localhost:8080/api/my-workload/ | grep body; <span class="keyword">done</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br></pre></td></tr></table></figure>

<ul>
<li>트래픽 에 따라 my-workload-v1, my-workload-v2에 번갈아 접속됨</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-11-30T23:00:35.000Z" title="2024. 12. 1. 오전 8:00:35">2024-12-01</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-12-01T13:50:04.039Z" title="2024. 12. 1. 오후 10:50:04">2024-12-01</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/gateway-gatewayapi/">gateway/gatewayapi</a></span><span class="level-item">3 minutes read (About 497 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/12/01/docs/gateway/gateway-api/">gatewayapi concept</a></h1><div class="content"><h3 id="GateWay-API-주요기능"><a href="#GateWay-API-주요기능" class="headerlink" title="GateWay API 주요기능"></a>GateWay API 주요기능</h3><ol>
<li><p><strong>개선된 리소스 모델</strong></p>
<p>: API는 GatewayClass, Gateway 및 Route(HTTPRoute, TCPRoute 등)와 같은 새로운 사용자 정의 리소스를 도입하여 라우팅 규칙을 정의하는 보다 세부적이고 표현력 있는 방법을 제공합니다.</p>
</li>
<li><p><strong>프로토콜 독립적</strong></p>
<p>: 주로 HTTP용으로 설계된 Ingress와 달리 Gateway API는 TCP, UDP, TLS를 포함한 여러 프로토콜을 지원합니다.</p>
</li>
<li><p><strong>강화된 보안</strong></p>
<p>: TLS 구성 및 보다 세부적인 액세스 제어에 대한 기본 제공 지원.</p>
</li>
<li><p><strong>교차 네임스페이스 지원</strong></p>
<p>: 서로 다른 네임스페이스의 서비스로 트래픽을 라우팅하여 보다 유연한 아키텍처를 구축할 수 있는 기능을 제공합니다.</p>
</li>
<li><p><strong>확장성</strong></p>
<p>: API는 사용자 정의 리소스 및 정책으로 쉽게 확장할 수 있도록 설계되었습니다.</p>
</li>
<li><p><strong>역할 지향</strong></p>
<p>: 클러스터 운영자, 애플리케이션 개발자, 보안 팀 간의 우려를 명확하게 분리합니다.</p>
<p>이것은 제 겸손한 의견으로는 Gateway API의 가장 흥미로운 기능 중 하나일 것입니다.</p>
</li>
</ol>
<h3 id="Gateway-API-소개-기존의-Ingress-에-좀-더-기능을-추가-역할-분리-role-oriented-Docs"><a href="#Gateway-API-소개-기존의-Ingress-에-좀-더-기능을-추가-역할-분리-role-oriented-Docs" class="headerlink" title="Gateway API 소개 : 기존의 Ingress 에 좀 더 기능을 추가, 역할 분리(role-oriented) - Docs"></a>Gateway API 소개 : 기존의 Ingress 에 좀 더 기능을 추가, 역할 분리(role-oriented) - <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/gateway/">Docs</a></h3><ul>
<li>서비스 메시(istio)에서 제공하는 Rich 한 기능 중 일부 기능들과 혹은 운영 관리에 필요한 기능들을 추가</li>
<li>추가 기능 : 헤더 기반 라우팅, 헤더 변조, 트래픽 미러링(쉽게 트래픽 복제), 역할 기반</li>
</ul>
<p><img src="/blog/img/gateway-01.png"></p>
<ul>
<li><strong>Gateway API</strong> is a family of API kinds that provide dynamic infrastructure provisioning and advanced <strong>traffic routing.</strong></li>
<li>Make network services available by using an extensible, <strong>role-oriented</strong>, protocol-aware configuration mechanism.</li>
<li><a target="_blank" rel="noopener" href="https://gateway-api.sigs.k8s.io/">Gateway API</a> is an <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/cluster-administration/addons/">add-on</a> containing API <a target="_blank" rel="noopener" href="https://gateway-api.sigs.k8s.io/references/spec/">kinds</a> that provide dynamic infrastructure provisioning and advanced traffic routing.</li>
</ul>
<h3 id="구성-요소-Resource"><a href="#구성-요소-Resource" class="headerlink" title="구성 요소 (Resource)"></a>구성 요소 (Resource)</h3><ul>
<li>GatewayClass,Gateway, HTTPRoute, TCPRoute, Service</li>
</ul>
<p><img src="/blog/img/gateway-02.png"></p>
<p><img src="/blog/img/gateway-19.png"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-11-24T13:07:30.000Z" title="2024. 11. 24. 오후 10:07:30">2024-11-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-11-24T14:34:52.889Z" title="2024. 11. 24. 오후 11:34:52">2024-11-24</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/k8s-flannel/">k8s/flannel</a></span><span class="level-item">11 minutes read (About 1639 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/11/24/docs/flannel/">Flannel CNI Concept</a></h1><div class="content"><p>Flannel은 단일 바이너리 에이전트인 flanneld 가 각 노드에서 동작하여 작은 규모의 클러스터 환경에서</p>
<p>파드들 간 통신 환경을 구성하는 CNI이다.</p>
<p>Flannel은 노드간 통신에 VXLAN을 사용하며, UDP 8472 port를 사용한다.</p>
<h3 id="kind-amp-Flannel-배포"><a href="#kind-amp-Flannel-배포" class="headerlink" title="kind &amp; Flannel 배포"></a>kind &amp; Flannel 배포</h3><ul>
<li><code>disableDefaultCNI : true</code> 기본 CNI를 사용하지 않는다.</li>
<li>control-plane, worker node 2ea</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF&gt; kind-cni.yaml</span></span><br><span class="line"><span class="string">kind: Cluster</span></span><br><span class="line"><span class="string">apiVersion: kind.x-k8s.io/v1alpha4</span></span><br><span class="line"><span class="string">nodes:</span></span><br><span class="line"><span class="string">- role: control-plane</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    mynode: control-plane</span></span><br><span class="line"><span class="string">  extraPortMappings:</span></span><br><span class="line"><span class="string">  - containerPort: 30000</span></span><br><span class="line"><span class="string">    hostPort: 30000</span></span><br><span class="line"><span class="string">  - containerPort: 30001</span></span><br><span class="line"><span class="string">    hostPort: 30001</span></span><br><span class="line"><span class="string">  - containerPort: 30002</span></span><br><span class="line"><span class="string">    hostPort: 30002</span></span><br><span class="line"><span class="string">  kubeadmConfigPatches:</span></span><br><span class="line"><span class="string">  - |</span></span><br><span class="line"><span class="string">    kind: ClusterConfiguration</span></span><br><span class="line"><span class="string">    controllerManager:</span></span><br><span class="line"><span class="string">      extraArgs:</span></span><br><span class="line"><span class="string">        bind-address: 0.0.0.0</span></span><br><span class="line"><span class="string">    etcd:</span></span><br><span class="line"><span class="string">      local:</span></span><br><span class="line"><span class="string">        extraArgs:</span></span><br><span class="line"><span class="string">          listen-metrics-urls: http://0.0.0.0:2381</span></span><br><span class="line"><span class="string">    scheduler:</span></span><br><span class="line"><span class="string">      extraArgs:</span></span><br><span class="line"><span class="string">        bind-address: 0.0.0.0</span></span><br><span class="line"><span class="string">  - |</span></span><br><span class="line"><span class="string">    kind: KubeProxyConfiguration</span></span><br><span class="line"><span class="string">    metricsBindAddress: 0.0.0.0</span></span><br><span class="line"><span class="string">- role: worker</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    mynode: worker</span></span><br><span class="line"><span class="string">- role: worker</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    mynode: worker2</span></span><br><span class="line"><span class="string">networking:</span></span><br><span class="line"><span class="string">  disableDefaultCNI: true</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">kind create cluster --config kind-cni.yaml --name myk8s --image kindest/node:v1.30.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 배포 확인</span></span><br><span class="line">kind get clusters</span><br><span class="line">kind get nodes --name myk8s</span><br><span class="line">kubectl cluster-info</span><br><span class="line"></span><br><span class="line"><span class="comment"># 네트워크 확인</span></span><br><span class="line">kubectl cluster-info dump | grep -m 2 -E <span class="string">&quot;cluster-cidr|service-cluster-ip-range&quot;</span></span><br><span class="line">-----------------------</span><br><span class="line"><span class="string">&quot;--service-cluster-ip-range=10.96.0.0/16&quot;</span>, <span class="comment"># service ip 대역</span></span><br><span class="line"><span class="string">&quot;--cluster-cidr=10.244.0.0/16&quot;</span>, <span class="comment"># </span></span><br><span class="line">                            </span><br><span class="line">                            </span><br><span class="line"><span class="comment"># 노드 확인 : CRI</span></span><br><span class="line">kubectl get nodes -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 노드 라벨 확인</span></span><br><span class="line">kubectl get nodes myk8s-control-plane -o jsonpath=&#123;.metadata.labels&#125; | jq</span><br><span class="line">...</span><br><span class="line"><span class="string">&quot;mynode&quot;</span>: <span class="string">&quot;control-plane&quot;</span>,</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">kubectl get nodes myk8s-worker -o jsonpath=&#123;.metadata.labels&#125; | jq</span><br><span class="line">kubectl get nodes myk8s-worker2 -o jsonpath=&#123;.metadata.labels&#125; | jq</span><br><span class="line"></span><br><span class="line"><span class="comment"># 컨테이너 확인 : 컨테이너 갯수, 컨테이너 이름 확인</span></span><br><span class="line">docker ps</span><br><span class="line">docker port myk8s-control-plane</span><br><span class="line">docker port myk8s-worker</span><br><span class="line">docker port myk8s-worker2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 컨테이너 내부 정보 확인</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane ip -br -c -4 addr</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker  ip -br -c -4 addr</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2  ip -br -c -4 addr</span><br><span class="line"></span><br><span class="line"><span class="comment"># tool install</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane sh -c <span class="string">&#x27;apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump iputils-ping htop git nano -y&#x27;</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker  sh -c <span class="string">&#x27;apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump iputils-ping -y&#x27;</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2 sh -c <span class="string">&#x27;apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump iputils-ping -y&#x27;</span></span><br></pre></td></tr></table></figure>





<ul>
<li>CNI 를 disable 했기 때문에 kindnet 이 없고, coredns, sc가 실행되지 못한다.</li>
</ul>
<p><img src="/blog/img/flannel-01.png"></p>
<p><code>kubectl describe pod -n kube-system -l k8s-app=kube-dns</code></p>
<p><img src="/blog/img/flannel-02.png"></p>
<ul>
<li>flannel net-config</li>
</ul>
<p><img src="/blog/img/flannel-03.png"></p>
<ul>
<li>flannel 을 설치했으나 bridge 플러그인이 &#x2F;opt&#x2F;cni&#x2F;bin 에 없어서 추가해 주어야 한다.</li>
</ul>
<p><img src="/blog/img/flannel-04.png"></p>
<p><img src="/blog/img/flannel-05.png"></p>
<ul>
<li>권한에 유의하여 복사한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> bridge myk8s-control-plane:/opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">cp</span> bridge myk8s-worker:/opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">cp</span> bridge myk8s-worker2:/opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane  <span class="built_in">chmod</span> 755 /opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker         <span class="built_in">chmod</span> 755 /opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2        <span class="built_in">chmod</span> 755 /opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane  <span class="built_in">chown</span> root root /opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker         <span class="built_in">chown</span> root root /opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2        <span class="built_in">chown</span> root root /opt/cni/bin/bridge</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane  <span class="built_in">ls</span> -l /opt/cni/bin/</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker  <span class="built_in">ls</span> -l /opt/cni/bin/</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2 <span class="built_in">ls</span> -l /opt/cni/bin/</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> myk8s-control-plane myk8s-worker myk8s-worker2; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it <span class="variable">$i</span> <span class="built_in">ls</span> /opt/cni/bin/; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line">bridge	flannel  host-local  loopback  portmap	ptp</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl get pod -A -owide</span><br></pre></td></tr></table></figure>



<p>kubelet, pstree 확인</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubelet config 정보</span></span><br><span class="line">kubectl describe cm -n kube-system kubelet-config</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane <span class="built_in">cat</span> /var/lib/kubelet/config.yaml</span><br><span class="line">...</span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.96.0.10</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane <span class="built_in">cat</span> /var/lib/kubelet/kubeadm-flags.env</span><br><span class="line">KUBELET_KUBEADM_ARGS=<span class="string">&quot;--container-runtime-endpoint=unix:///run/containerd/containerd.sock --node-ip=172.18.0.2 --node-labels= --pod-infra-container-image=registry.k8s.io/pause:3.9 --provider-id=kind://docker/myk8s/myk8s-control-plane&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> myk8s-control-plane myk8s-worker myk8s-worker2; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it <span class="variable">$i</span> <span class="built_in">cat</span> /var/lib/kubelet/kubeadm-flags.env; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> myk8s-control-plane myk8s-worker myk8s-worker2; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it <span class="variable">$i</span> <span class="built_in">ls</span> /etc/kubernetes/manifests; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line">&gt;&gt; node myk8s-control-plane &lt;&lt;</span><br><span class="line"><span class="string">etcd.yaml  kube-apiserver.yaml	kube-controller-manager.yaml  kube-scheduler.yaml</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt;&gt; node myk8s-worker &lt;&lt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt;&gt; node myk8s-worker2 &lt;&lt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">kubectl describe pod -n kube-system kube-apiserver-myk8s-control-plane</span></span><br><span class="line"><span class="string">kubectl describe pod -n kube-system kube-controller-manager-myk8s-control-plane</span></span><br><span class="line"><span class="string">kubectl describe pod -n kube-system kube-scheduler-myk8s-control-plane</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">for i in myk8s-control-plane myk8s-worker myk8s-worker2; do echo &quot;&gt;&gt; node $i &lt;&lt;&quot;; docker exec -it $i pstree -aT; echo; done</span></span><br><span class="line"><span class="string">for i in myk8s-control-plane myk8s-worker myk8s-worker2; do echo &quot;&gt;&gt; node $i &lt;&lt;&quot;; docker exec -it $i pstree -atl; echo; done</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">docker exec -it myk8s-control-plane  systemctl status kubelet -l --no-pager</span></span><br><span class="line"><span class="string">docker exec -it myk8s-worker  systemctl status kubelet -l --no-pager</span></span><br><span class="line"><span class="string">docker exec -it myk8s-worker2 systemctl status kubelet -l --no-pager</span></span><br></pre></td></tr></table></figure>





<h3 id="flannel-정보-확인"><a href="#flannel-정보-확인" class="headerlink" title="flannel 정보 확인"></a>flannel 정보 확인</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl get ds,pod,cm -n kube-flannel -owide</span><br><span class="line">kubectl describe cm -n kube-flannel kube-flannel-cfg</span><br><span class="line"></span><br><span class="line"><span class="comment"># iptables 정보 확인</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> filter nat mangle raw ; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; IPTables Type : <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it myk8s-control-plane  iptables -t <span class="variable">$i</span> -S ; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> filter nat mangle raw ; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; IPTables Type : <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it myk8s-worker  iptables -t <span class="variable">$i</span> -S ; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> filter nat mangle raw ; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; IPTables Type : <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it myk8s-worker2 iptables -t <span class="variable">$i</span> -S ; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>FLANNEL_MTU 1450</code> 1500byte 에서 vxlan header 50byte 제외</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> myk8s-control-plane myk8s-worker myk8s-worker2; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it <span class="variable">$i</span> <span class="built_in">cat</span> /run/flannel/subnet.env ; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">&gt;&gt; node myk8s-control-plane &lt;&lt;</span><br><span class="line"><span class="string">FLANNEL_NETWORK=10.244.0.0/16</span></span><br><span class="line"><span class="string">FLANNEL_SUBNET=10.244.0.1/24 # 파드 네트워크 대역 정의, CNI inet</span></span><br><span class="line"><span class="string">FLANNEL_MTU=1450</span></span><br><span class="line"><span class="string">FLANNEL_IPMASQ=true # 파드가 외부(인터넷) 통신 시 해당 노드의 마스커레이딩을 사용</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt;&gt; node myk8s-worker &lt;&lt;</span></span><br><span class="line"><span class="string">FLANNEL_NETWORK</span>=10.244.0.0/16</span><br><span class="line">FLANNEL_SUBNET=10.244.2.1/24</span><br><span class="line">FLANNEL_MTU=1450</span><br><span class="line">FLANNEL_IPMASQ=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">&gt;&gt; node myk8s-worker2 &lt;&lt;</span><br><span class="line"><span class="string">FLANNEL_NETWORK=10.244.0.0/16</span></span><br><span class="line"><span class="string">FLANNEL_SUBNET=10.244.1.1/24</span></span><br><span class="line"><span class="string">FLANNEL_MTU=1450</span></span><br><span class="line"><span class="string">FLANNEL_IPMASQ=true</span></span><br></pre></td></tr></table></figure>



<h3 id="테스트-pod-생성"><a href="#테스트-pod-생성" class="headerlink" title="테스트 pod 생성"></a>테스트 pod 생성</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl create -f -</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: pod-1</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  nodeSelector:</span></span><br><span class="line"><span class="string">    kubernetes.io/hostname: myk8s-worker</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: netshoot-pod</span></span><br><span class="line"><span class="string">    image: nicolaka/netshoot</span></span><br><span class="line"><span class="string">    command: [&quot;tail&quot;]</span></span><br><span class="line"><span class="string">    args: [&quot;-f&quot;, &quot;/dev/null&quot;]</span></span><br><span class="line"><span class="string">  terminationGracePeriodSeconds: 0</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: pod-2</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  nodeSelector:</span></span><br><span class="line"><span class="string">    kubernetes.io/hostname: myk8s-worker2</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: netshoot-pod</span></span><br><span class="line"><span class="string">    image: nicolaka/netshoot</span></span><br><span class="line"><span class="string">    command: [&quot;tail&quot;]</span></span><br><span class="line"><span class="string">    args: [&quot;-f&quot;, &quot;/dev/null&quot;]</span></span><br><span class="line"><span class="string">  terminationGracePeriodSeconds: 0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 확인 : IP 확인</span></span><br><span class="line">kubectl get pod -o wide</span><br></pre></td></tr></table></figure>



<ul>
<li><p>worker node 의 여러 네트워크 정보를 파악할 수 있다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ip -c -br addr</span><br><span class="line">ip -c route <span class="comment"># 다른 노드의 파드 대역(podCIDR)의 라우팅 정보</span></span><br><span class="line">ip -c neigh show dev flannel.1 <span class="comment"># flannel.1 인터페이스를 통한 ARP 테이블 정보 확인</span></span><br><span class="line">bridge fdb show dev flannel.1 <span class="comment"># 브리지 fdb 정보에서 해당 MAC 주소와 통신 시 각 노드의 en0 dst</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="/blog/img/flannel-06.png"></p>
<h3 id="bridge-cni-정보-확인"><a href="#bridge-cni-정보-확인" class="headerlink" title="bridge, cni 정보 확인"></a>bridge, cni 정보 확인</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># [터미널1,2] 워커 노드1,2</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker  bash</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2 bash</span><br><span class="line">-----------------------------</span><br><span class="line"><span class="comment"># 브리지 정보 확인</span></span><br><span class="line">brctl show cni0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 브리지 연결 링크(veth) 확인</span></span><br><span class="line">bridge <span class="built_in">link</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 브리지 VLAN 정보 확인</span></span><br><span class="line">bridge vlan</span><br><span class="line"></span><br><span class="line"><span class="comment"># cbr(custom bridge) 정보 : kubenet CNI의 bridge - 링크</span></span><br><span class="line">tree /var/lib/cni/networks/cbr0</span><br><span class="line">	/var/lib/cni/networks/cbr0</span><br><span class="line">	├── 10.244.2.4.</span><br><span class="line">	├── last_reserved_ip.0</span><br><span class="line">	└── lock</span><br><span class="line"></span><br><span class="line"><span class="comment"># 네트워크 관련 정보들 확인</span></span><br><span class="line">ip -c addr | grep veth -A3</span><br><span class="line">-----------------------------</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/flannel-07.png"></p>
<h2 id="패킷-캡처"><a href="#패킷-캡처" class="headerlink" title="패킷 캡처"></a>패킷 캡처</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i cni0 -nn icmp</span><br><span class="line">tcpdump -i flannel.1 -nn icmp</span><br><span class="line">tcpdump -i eth0 -nn icmp</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># [터미널1,2] 워커 노드1,2</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker  bash</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2 bash</span><br><span class="line">-----------------------------</span><br><span class="line"></span><br><span class="line">tcpdump -i eth0 -nn udp port 8472 -w /root/vxlan.pcap </span><br><span class="line"><span class="comment"># CTRL+C 취소 후 확인 : ls -l /root/vxlan.pcap</span></span><br><span class="line"></span><br><span class="line">conntrack -L | grep -i icmp</span><br><span class="line">-----------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment"># [터미널3]</span></span><br><span class="line"><span class="comment"># 패킷캡처 후 호스트로 파일 이동 및 wireshark를 통해 패킷을 쉽게 확인할 수 있다.</span></span><br><span class="line">docker <span class="built_in">cp</span> myk8s-worker:/root/vxlan.pcap .</span><br><span class="line">wireshark vxlan.pcap</span><br></pre></td></tr></table></figure>

<ul>
<li>패킷 캡처</li>
</ul>
<p><img src="/blog/img/flannel-08.png"></p>
<p><img src="/blog/img/flannel-09.png"></p>
<p><img src="/blog/img/flannel-10.png"></p>
<ul>
<li>SRC, DST IP 확인</li>
</ul>
<p><img src="/blog/img/flannel-11.png"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-11-24T09:01:30.000Z" title="2024. 11. 24. 오후 6:01:30">2024-11-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-11-24T14:34:54.422Z" title="2024. 11. 24. 오후 11:34:54">2024-11-24</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-overlaynetwork/">container/overlaynetwork</a></span><span class="level-item">9 minutes read (About 1384 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/11/24/docs/overlaynetwork/overlay-network/">overlay network concept</a></h1><div class="content"><ul>
<li>가상화 또는 클라우드 기반의 네트워크는 유연하게 확장이 되어야 한다. </li>
<li>관리하는 Subnet들이 많아지고 연결되어 있는 host의 수가 증가하면 포워딩, 스위칭, 라우팅 과 같은 네트워크 구성이 복잡해진다.</li>
<li>따라서 물리적인 네트워크망은 고려하지 않고 가상으로 host와 host의 연결만을 고려해서 구현한 기술이 바로 Network Overlay이다.</li>
</ul>
<h3 id="오버레이-네트워크-종류"><a href="#오버레이-네트워크-종류" class="headerlink" title="오버레이 네트워크 종류"></a>오버레이 네트워크 종류</h3><ul>
<li><strong>Virtual Extensible Local Area Network (VxLAN)</strong></li>
<li>Generic Routing Encapsulation (GRE)</li>
<li>IP Security (IPsec)</li>
<li>Multiprotocol Label Switching (MPLS)</li>
<li>Ethernet Virtual Private Network(EVPN)</li>
<li>Software-Defined WAN (SD-WAN)</li>
<li>Software-Defined Access (SD-Access)</li>
<li>Application Centric Infrastructure (ACI)</li>
<li>Cisco Virtual Topology System (VTS)</li>
</ul>
<h2 id="practice"><a href="#practice" class="headerlink" title="practice"></a>practice</h2><ul>
<li>hostA 내부 veth와 hostB 내부 veth간 ICMP 통신을 실습</li>
<li>hostA : 192.168.64.27, hostB: 192.168.64.28</li>
</ul>
<h3 id="hostA-설정"><a href="#hostA-설정" class="headerlink" title="hostA 설정"></a>hostA 설정</h3><ul>
<li>namsepace, bridge, VxLAN을 설정한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># red: VxLAN을 설정한 namespace</span></span><br><span class="line">ip netns add red</span><br><span class="line"><span class="comment"># blue: 실제 통신을 위한 가상 단말기</span></span><br><span class="line">ip netns add blue</span><br><span class="line"></span><br><span class="line"><span class="comment"># red와 blue의 veth peer를 구성</span></span><br><span class="line"><span class="comment"># mtu 1450으로 설정</span></span><br><span class="line">ip <span class="built_in">link</span> add dev red-veth mtu 1450 netns red <span class="built_in">type</span> veth peer name blue-veth mtu 1450 netns blue</span><br><span class="line"></span><br><span class="line"><span class="comment"># 실제통신 단말기의 ip와 mac을 설정</span></span><br><span class="line">ip netns <span class="built_in">exec</span> blue ip <span class="built_in">link</span> <span class="built_in">set</span> dev blue-veth address 02:42:c0:a8:00:02</span><br><span class="line">ip netns <span class="built_in">exec</span> blue ip addr add dev blue-veth 7.7.7.2/24</span><br><span class="line"></span><br><span class="line"><span class="comment"># red에 bridge device설정 및 ip 세팅</span></span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> add dev br0 <span class="built_in">type</span> bridge</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip addr add dev br0 7.7.7.1/24</span><br><span class="line"></span><br><span class="line"><span class="comment"># endpoint 식별을 위해 id 설정 (VNI)</span></span><br><span class="line"><span class="comment"># proxy옵션: arp 쿼리에 응답</span></span><br><span class="line"><span class="comment"># learning: bridge fdb entry 자동갱신 (수정설정할 필요 없음)</span></span><br><span class="line"><span class="comment"># dstport 4789: UDP port 터널링</span></span><br><span class="line">ip <span class="built_in">link</span> add dev vxlan1 netns red <span class="built_in">type</span> vxlan <span class="built_in">id</span> 42 proxy learning dstport 4789</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># red 내부에 VxLAN, peer veth 장비를 bridge와 연결한다.</span></span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> red-veth master br0</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> vxlan1 master br0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 모든 가상장치를 실행한다.</span></span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> br0 up</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> vxlan1 up</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> red-veth up</span><br><span class="line">ip netns <span class="built_in">exec</span> blue ip <span class="built_in">link</span> <span class="built_in">set</span> blue-veth up</span><br></pre></td></tr></table></figure>



<h3 id="hostB-설정"><a href="#hostB-설정" class="headerlink" title="hostB 설정"></a>hostB 설정</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ip netns add red</span><br><span class="line">ip netns add blue</span><br><span class="line"></span><br><span class="line">ip <span class="built_in">link</span> add dev red-veth mtu 1450 netns red <span class="built_in">type</span> veth peer name blue-veth mtu 1450 netns blue</span><br><span class="line"></span><br><span class="line">ip netns <span class="built_in">exec</span> blue ip <span class="built_in">link</span> <span class="built_in">set</span> dev blue-veth address 02:42:c0:a8:00:03</span><br><span class="line">ip netns <span class="built_in">exec</span> blue ip addr add dev blue-veth 7.7.7.3/24</span><br><span class="line"></span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> add dev br0 <span class="built_in">type</span> bridge</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip addr add dev br0 7.7.7.1/24</span><br><span class="line"></span><br><span class="line">ip <span class="built_in">link</span> add dev vxlan1 netns red <span class="built_in">type</span> vxlan <span class="built_in">id</span> 42 proxy learning dstport 4789</span><br><span class="line"></span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> red-veth master br0</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> vxlan1 master br0</span><br><span class="line"></span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> br0 up</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> vxlan1 up</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> red-veth up</span><br><span class="line">ip netns <span class="built_in">exec</span> blue ip <span class="built_in">link</span> <span class="built_in">set</span> blue-veth up</span><br></pre></td></tr></table></figure>



<h3 id="hostA-gt-blue"><a href="#hostA-gt-blue" class="headerlink" title="hostA &gt; blue"></a>hostA &gt; blue</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># nsenter --net=/var/run/netns/blue</span></span><br><span class="line">ping 7.7.7.3 <span class="comment"># 실패</span></span><br><span class="line"></span><br><span class="line">\<span class="comment"># ip neigh # arp에 등록이 안되어있음.</span></span><br><span class="line">7.7.7.3 dev blue-veth  FAILED</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># nsenter --net=/var/run/netns/red</span></span><br><span class="line">tcpdump -i br0 <span class="comment"># 로그 확인</span></span><br><span class="line">05:28:15.024947 ARP, Request who-has 7.7.7.3 tell 7.7.7.2, length 28 <span class="comment"># arp 요청만 한다.</span></span><br></pre></td></tr></table></figure>





<h3 id="mac-추가"><a href="#mac-추가" class="headerlink" title="mac 추가"></a>mac 추가</h3><ul>
<li>VxLAN이 통신을 해야하는데, 해당 ip는 host 내부에 없다.</li>
<li>hostA의 VxLAN에 통신할 arp 정보를 수동으로 등록해준다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># nsenter --net=/var/run/netns/red</span></span><br><span class="line">\<span class="comment"># ip neigh add 7.7.7.3 lladdr 02:42:c0:a8:00:03 dev vxlan1 # in red namespace</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\<span class="comment"># ip neigh show</span></span><br><span class="line">7.7.7.3 dev vxlan1 lladdr 02:42:c0:a8:00:03 PERMANENT</span><br></pre></td></tr></table></figure>

<ul>
<li>arp table state</li>
</ul>
<p><img src="/blog/img/overlay-network-01.png"></p>
<ul>
<li>다시 테스트하면 ARP 통신이 된다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># ping 7.7.7.3</span></span><br><span class="line">PING 7.7.7.3 (7.7.7.3) 56(84) bytes of data.</span><br><span class="line">--- 7.7.7.3 ping statistics ---</span><br><span class="line">5 packets transmitted, 0 received, 100% packet loss, time 4087ms</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># ip neigh # arp테이블에 업데이트됨을 확인</span></span><br><span class="line">7.7.7.3 dev blue-veth lladdr 02:42:c0:a8:00:03 REACHABLE</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>hostA &gt; red</strong></li>
<li>ARP 통신 이후 ICMP 통신이 실패함을 알 수 있다.</li>
<li>ICMP (Internet Control Message Protocol) - L3 (Network Layer) 프로토콜</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># tcpdump -i br0</span></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on br0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">05:32:09.944756 ARP, Request who-has 7.7.7.3 tell 7.7.7.2, length 28</span><br><span class="line">05:32:09.944784 ARP, Reply 7.7.7.3 is-at 02:42:c0:a8:00:03 (oui Unknown), length 28</span><br><span class="line">05:32:09.944861 IP 7.7.7.2 &gt; 7.7.7.3: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 1821, <span class="built_in">seq</span> 1, length 64</span><br><span class="line">05:32:10.964330 IP 7.7.7.2 &gt; 7.7.7.3: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 1821, <span class="built_in">seq</span> 2, length 64</span><br><span class="line">05:32:11.987056 IP 7.7.7.2 &gt; 7.7.7.3: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 1821, <span class="built_in">seq</span> 3, length 64</span><br><span class="line">05:32:13.011901 IP 7.7.7.2 &gt; 7.7.7.3: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 1821, <span class="built_in">seq</span> 4, length 64</span><br></pre></td></tr></table></figure>





<h3 id="hostA-gt-blue-1"><a href="#hostA-gt-blue-1" class="headerlink" title="hostA &gt; blue"></a>hostA &gt; blue</h3><ul>
<li>br0 존재하는 blue 에서 netfilter 룰을 조회.</li>
<li>FORWARD 가 ACCEPT 임을 확인.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># iptables -t filter -L | grep policy</span></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br></pre></td></tr></table></figure>

<ul>
<li>route 조회</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># ip route</span></span><br><span class="line">7.7.7.0/24 dev br0 proto kernel scope <span class="built_in">link</span> src 7.7.7.1</span><br></pre></td></tr></table></figure>

<ul>
<li>bridge fdb 조회<ul>
<li>vxlan1의 정보를 확인할 수 있다.</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># bridge fdb | grep 02:42:c0:a8:00:03</span></span><br><span class="line">02:42:c0:a8:00:03 dev vxlan1 master br0</span><br></pre></td></tr></table></figure>

<ul>
<li>정확한 목적지 ip, VxLAN ip 등을 명시해 fdb entry에 추가한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># bridge fdb add 02:42:c0:a8:00:03 dev vxlan1 self dst 192.168.64.28 vni 42 port 4789</span></span><br><span class="line"></span><br><span class="line">root@seongtki:~<span class="comment"># bridge fdb | grep 02:42:c0:a8:00:03</span></span><br><span class="line">02:42:c0:a8:00:03 dev vxlan1 master br0</span><br><span class="line">02:42:c0:a8:00:03 dev vxlan1 dst 192.168.64.28 link-netnsid 1 self permanent</span><br></pre></td></tr></table></figure>





<h3 id="hostB-gt-red"><a href="#hostB-gt-red" class="headerlink" title="hostB &gt; red"></a>hostB &gt; red</h3><ul>
<li>hostB에도 필요한 정보가 전부 존재하는지 조회를 해보자.</li>
<li>arp는 수동으로 추가해주어야 한다.</li>
<li>fdb는 이미 추가되어 있다. -&gt; vxlan1 추가 시 learning 키워드를 추가해주면, fdb는 필요한 정보를 자동으로 업데이트 한다.<br>(hostA에서 이미 추가되어있어 요청했을 때 자동으로 추가됨)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># nsenter --net=/var/run/netns/red</span></span><br><span class="line">root@seongtki:~<span class="comment"># ip neigh</span></span><br><span class="line">root@seongtki:~<span class="comment"># ip route</span></span><br><span class="line">7.7.7.0/24 dev br0 proto kernel scope <span class="built_in">link</span> src 7.7.7.1</span><br><span class="line">root@seongtki:~<span class="comment"># bridge fdb | grep 02:42:c0:a8:00:02</span></span><br><span class="line">02:42:c0:a8:00:02 dev vxlan1 master br0</span><br><span class="line">02:42:c0:a8:00:02 dev vxlan1 dst 192.168.64.27 link-netnsid 1 self</span><br></pre></td></tr></table></figure>

<ul>
<li>arp 정보 추가</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># ip neigh add 7.7.7.2 lladdr 02:42:c0:a8:00:02 dev vxlan1</span></span><br><span class="line"></span><br><span class="line">root@seongtki:~<span class="comment"># ip neigh show</span></span><br><span class="line">7.7.7.2 dev vxlan1 lladdr 02:42:c0:a8:00:02 PERMANENT</span><br></pre></td></tr></table></figure>



<h3 id="최종-테스트"><a href="#최종-테스트" class="headerlink" title="최종 테스트"></a>최종 테스트</h3><p>hostA &gt; blue</p>
<ul>
<li>정상적으로 응답</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~# ping 7.7.7.3</span><br><span class="line">PING 7.7.7.3 (7.7.7.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from 7.7.7.3: icmp_seq=153 ttl=64 time=1008 ms</span><br><span class="line">64 bytes from 7.7.7.3: icmp_seq=154 ttl=64 time=4.79 ms</span><br><span class="line">64 bytes from 7.7.7.3: icmp_seq=155 ttl=64 time=3.85 ms</span><br><span class="line">64 bytes from 7.7.7.3: icmp_seq=156 ttl=64 time=3.37 ms</span><br></pre></td></tr></table></figure>

<p>hostB &gt; red</p>
<ul>
<li>정상적인 통신로그 조회</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~# tcpdump -i br0</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">listening on br0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">03:12:11.488557 IP 7.7.7.2 &gt; 7.7.7.3: ICMP echo request, id 1958, seq 174, length 64</span><br><span class="line">03:12:11.488648 IP 7.7.7.3 &gt; 7.7.7.2: ICMP echo reply, id 1958, seq 174, length 64</span><br><span class="line">03:12:12.490214 IP 7.7.7.2 &gt; 7.7.7.3: ICMP echo request, id 1958, seq 175, length 64</span><br><span class="line">03:12:12.490423 IP 7.7.7.3 &gt; 7.7.7.2: ICMP echo reply, id 1958, seq 175, length 64</span><br><span class="line">03:12:13.495586 IP 7.7.7.2 &gt; 7.7.7.3: ICMP echo request, id 1958, seq 176, length 64</span><br><span class="line">03:12:13.495828 IP 7.7.7.3 &gt; 7.7.7.2: ICMP echo reply, id 1958, seq 176, length 64</span><br></pre></td></tr></table></figure>



<ul>
<li>지금까지 구성한 overlay network 구성도.</li>
</ul>
<p><img src="/blog/img/overlay-network-02.png"></p>
<h3 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h3><p><a target="_blank" rel="noopener" href="https://ebt-forti.tistory.com/m/145?category=849281">https://ebt-forti.tistory.com/m/145?category=849281</a></p>
<p><a target="_blank" rel="noopener" href="https://netpple.github.io/docs/make-container-without-docker/">https://netpple.github.io/docs/make-container-without-docker/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-11-24T05:02:30.000Z" title="2024. 11. 24. 오후 2:02:30">2024-11-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-11-24T14:34:20.550Z" title="2024. 11. 24. 오후 11:34:20">2024-11-24</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-overlaynetwork/">container/overlaynetwork</a></span><span class="level-item">3 minutes read (About 429 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/11/24/docs/overlaynetwork/vxlan/">vxlan concept</a></h1><div class="content"><ul>
<li>VxLAN은 VLAN을 확장한 개념으로 기존의 VLAN에서 만들 수 있는 네트워크보다 훨씬 더 많은 네트워크를 생성할 수 있다.</li>
<li>VxLAN에서 x는 eXtensible으로 이름에서도 확장을 나타내고 있다.</li>
<li>VLAN은 이더넷 프레임에 16bit(vlan, option, id)를 추가로 구성하여 Tag를 기반으로 동작하는데 이때 id로 사용할 수 있는 비트가 12bit이기 때문에 만들 수 있는 네트워크가 최대 4096개만 생성할 수 있었다.</li>
<li>VxLAN은 VLAN의 문제를 해결하기 위해 50byte 헤더(Mac over IP, UDP Header, 24bit VLAN ID)를 추가로 구성하여 16,000,000개 이상의 VLAN을 제공할 수 있다.</li>
</ul>
<h3 id="VNI-virtual-Network-Identifier"><a href="#VNI-virtual-Network-Identifier" class="headerlink" title="VNI (virtual Network Identifier)"></a>VNI (virtual Network Identifier)</h3><ul>
<li>VLAN과 VxLAN segment간 mapping 구분자</li>
<li>같은 VLAN에 대해 여러 개의 VNI mapping이 가능하다.</li>
</ul>
<h3 id="VTEP-VXLAN-Tunnel-End-Point"><a href="#VTEP-VXLAN-Tunnel-End-Point" class="headerlink" title="VTEP ( VXLAN Tunnel End Point )"></a>VTEP ( VXLAN Tunnel End Point )</h3><ul>
<li>VXLAN Tunnel 종단 역할을 수행한다</li>
<li>인캡슐레이션과 터미네이션 의 end point 역활을 수행한다.</li>
</ul>
<p><img src="/blog/img/overlay-network-03.png"></p>
<ul>
<li><p>Original L2 frame 이외의 모든 헤더가 VXLAN 관련 헤더이다.</p>
</li>
<li><p>VXLAN 헤더 에는 VNI 라는 24비트 VLAN 을 생성할 수 있다.</p>
<p>일반적인 VLAN ID 가 16비트의 기반이라면, VXLAN의 VNI 에서 표현되는 VLAN 은 24비트의 기반으로, 16,000,000 개의 VLAN 을 생성 할 수 있다.</p>
</li>
<li><p>L2 over L3 : UDP 패킷 내부에 L2 프레임을  캡슐화 하는 <em>터널링</em>  기술</p>
</li>
<li><p>Mac in UDP </p>
<ul>
<li>VXLAN 패킷 사이즈 : 50byte</li>
<li>VXLAN L2 정보 (MAC address)를 L3에 넣어서 통신</li>
</ul>
</li>
</ul>
<h3 id="MTU"><a href="#MTU" class="headerlink" title="MTU"></a>MTU</h3><ul>
<li>원래는 1500byte 를 사용하는데 VXLAN 패킷에 50byte를 썼으므로</li>
<li>1450byte 를 세팅해서 사용하도록 MTU를 세팅한다.</li>
</ul>
<h3 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h3><p><a target="_blank" rel="noopener" href="https://skstp35.tistory.com/227">https://skstp35.tistory.com/227</a></p>
<p><a target="_blank" rel="noopener" href="https://atthis.tistory.com/7?category=750237">https://atthis.tistory.com/7?category=750237</a></p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/blog/page/0/">Previous</a></div><div class="pagination-next"><a href="/blog/page/2/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/blog/">1</a></li><li><a class="pagination-link" href="/blog/page/2/">2</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/blog/page/5/">5</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/blog/img/avatar.png" alt="Seongtaek Kim"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Seongtaek Kim</p><p class="is-size-6 is-block">Blog</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/blog/archives"><p class="title">45</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/blog/categories"><p class="title">34</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/blog/tags"><p class="title">0</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/seongtaekkim"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Linkedin" href="https://linkedin.com/in/staek"><i class="fab fa-linkedin"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/blog/categories/calico-communication/"><span class="level-start"><span class="level-item">calico/communication</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/calico-concept/"><span class="level-start"><span class="level-item">calico/concept</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/calico-networkmode/"><span class="level-start"><span class="level-item">calico/networkmode</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/cilium-cilium/"><span class="level-start"><span class="level-item">cilium/cilium</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/cilium-communication/"><span class="level-start"><span class="level-item">cilium/communication</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/cilium-install/"><span class="level-start"><span class="level-item">cilium/install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-cgroup/"><span class="level-start"><span class="level-item">container/cgroup</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-namespace/"><span class="level-start"><span class="level-item">container/namespace</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-overlayFS/"><span class="level-start"><span class="level-item">container/overlayFS</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-overlaynetwork/"><span class="level-start"><span class="level-item">container/overlaynetwork</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/gateway-gatewayapi/"><span class="level-start"><span class="level-item">gateway/gatewayapi</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/gateway-gloo/"><span class="level-start"><span class="level-item">gateway/gloo</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/ingress-ingress/"><span class="level-start"><span class="level-item">ingress/ingress</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-bookinfo/"><span class="level-start"><span class="level-item">istio/bookinfo</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-envoy/"><span class="level-start"><span class="level-item">istio/envoy</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-istio-outline/"><span class="level-start"><span class="level-item">istio/istio-outline</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-istio-test/"><span class="level-start"><span class="level-item">istio/istio-test</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-istio-traffic/"><span class="level-start"><span class="level-item">istio/istio-traffic</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/java-Enumeration/"><span class="level-start"><span class="level-item">java/Enumeration</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/java-flyweight/"><span class="level-start"><span class="level-item">java/flyweight</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/java-interface/"><span class="level-start"><span class="level-item">java/interface</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/k8s-PAUSE-Container/"><span class="level-start"><span class="level-item">k8s/PAUSE-Container</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/k8s-flannel/"><span class="level-start"><span class="level-item">k8s/flannel</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/k8s-kind/"><span class="level-start"><span class="level-item">k8s/kind</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-ipvs/"><span class="level-start"><span class="level-item">loadbaleancer/ipvs</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-ipvs-install/"><span class="level-start"><span class="level-item">loadbaleancer/ipvs-install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-metalLB/"><span class="level-start"><span class="level-item">loadbaleancer/metalLB</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-metalLB-install/"><span class="level-start"><span class="level-item">loadbaleancer/metalLB-install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/serivce-clusterip/"><span class="level-start"><span class="level-item">serivce/clusterip</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/serivce-install/"><span class="level-start"><span class="level-item">serivce/install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/serivce-nodeport/"><span class="level-start"><span class="level-item">serivce/nodeport</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/vpccni-vpccni/"><span class="level-start"><span class="level-item">vpccni/vpccni</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/vpccni-vpccni-install/"><span class="level-start"><span class="level-item">vpccni/vpccni-install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/vpccni-vpccni2/"><span class="level-start"><span class="level-item">vpccni/vpccni2</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-12-08T06:40:35.000Z">2024-12-08</time></p><p class="title"><a href="/blog/2024/12/08/docs/namespace/user-namespace/">user namespace</a></p><p class="categories"><a href="/blog/categories/container-namespace/">container/namespace</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-12-08T03:40:35.000Z">2024-12-08</time></p><p class="title"><a href="/blog/2024/12/08/docs/namespace/pid-namespace/">pid namespace</a></p><p class="categories"><a href="/blog/categories/container-namespace/">container/namespace</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-12-07T23:40:35.000Z">2024-12-08</time></p><p class="title"><a href="/blog/2024/12/08/docs/namespace/mount-namespace/">mount namespace</a></p><p class="categories"><a href="/blog/categories/container-namespace/">container/namespace</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-12-07T20:40:35.000Z">2024-12-08</time></p><p class="title"><a href="/blog/2024/12/08/docs/namespace/bridge/">bridge</a></p><p class="categories"><a href="/blog/categories/container-namespace/">container/namespace</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-12-01T06:00:35.000Z">2024-12-01</time></p><p class="title"><a href="/blog/2024/12/01/docs/ingress/ingress/">ingress concept</a></p><p class="categories"><a href="/blog/categories/ingress-ingress/">ingress/ingress</a></p></div></article></div></div><!--!--></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/blog/">Blog</a><p class="is-size-7"><span>&copy; 2024 Seongtaek Kim</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/blog/js/column.js"></script><script src="/blog/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/blog/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/blog/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/blog/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/blog/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>