<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>Category: container/namespace - Blog</title><link rel="manifest" href="/blog/manifest.json"><meta name="application-name" content="Blog"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Blog"><meta property="og:url" content="https://seongtaekkim.github.io/blog"><meta property="og:site_name" content="Blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://seongtaekkim.github.io/blog/img/og_image.png"><meta property="article:author" content="Seongtaek Kim"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://seongtaekkim.github.io/blog/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://seongtaekkim.github.io/blog"},"headline":"Blog","image":["https://seongtaekkim.github.io/blog/img/og_image.png"],"author":{"@type":"Person","name":"Seongtaek Kim"},"publisher":{"@type":"Organization","name":"Blog","logo":{"@type":"ImageObject"}},"description":""}</script><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/blog/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/blog/">Blog</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/blog/">Home</a><a class="navbar-item" href="/blog/archives">Archives</a><a class="navbar-item" href="/blog/categories">Categories</a><a class="navbar-item" href="/blog/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/blog/categories">Categories</a></li><li class="is-active"><a href="#" aria-current="page">container/namespace</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-12-08T06:40:35.000Z" title="2024. 12. 8. 오후 3:40:35">2024-12-08</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-12-08T12:33:14.081Z" title="2024. 12. 8. 오후 9:33:14">2024-12-08</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-namespace/">container/namespace</a></span><span class="level-item">8 minutes read (About 1229 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/12/08/docs/namespace/user-namespace/">user namespace</a></h1><div class="content"><ul>
<li><p>프로세스의 UID&#x2F;GID Isolation</p>
</li>
<li><p>중첩(nested) 구조 (최대 32레벨)</p>
</li>
<li><p>보안 상 중요 </p>
</li>
<li><p>컨테이너의 “root 권한” 문제를 해결</p>
</li>
<li><p>네임스페이스 안과 밖의 UID&#x2F;GID를 다르게 설정할 수 있음</p>
</li>
</ul>
<h3 id="Linux-USER"><a href="#Linux-USER" class="headerlink" title="Linux USER"></a>Linux USER</h3><ul>
<li><p>User name? 커널이 취급하는 값이 아닙니다<br>(managed by external tools, &#x2F;etc&#x2F;passwd, LDAP, Kerberos, …)</p>
</li>
<li><p>커널이 아는 것은 UID, GID</p>
</li>
<li><p>UID, GID space ~ 커널이 관리</p>
</li>
<li><p>프로세스와 호스트 사이의 UID&#x2F;GID 매핑 ~ Secure 측면에서 중요</p>
</li>
<li><p>권한(permission) 체크 ~ UID, GID를 검사</p>
</li>
<li><p>컨테이너? isolated processes로 호스트의 “커널”을 공유</p>
</li>
<li><p>Same UID, Same User</p>
</li>
</ul>
<h2 id="Linux-USER-namespace-isolation"><a href="#Linux-USER-namespace-isolation" class="headerlink" title="Linux USER namespace isolation"></a>Linux USER namespace isolation</h2><ul>
<li>-U : user namespace 격리</li>
<li>–map-root-user : user id를 remap 해서 usernamespace 를 생성</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unshare -U --map-root-user /bin/sh</span><br></pre></td></tr></table></figure>

<ul>
<li>namespace 가 격리되어 inode가 다름을 알 수 있다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) <span class="built_in">groups</span>=0(root),65534(nogroup)</span><br><span class="line"><span class="comment"># readlink /proc/$$/ns/user</span></span><br><span class="line">user:[4026532670]</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">seongtki@seongtki:~$  <span class="built_in">id</span></span><br><span class="line">uid=1000(seongtki) gid=1000(seongtki) <span class="built_in">groups</span>=1000(seongtki),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lxd),118(docker)</span><br><span class="line">seongtki@seongtki:~$</span><br><span class="line">seongtki@seongtki:~$ ps -ef | grep /bin/sh</span><br><span class="line">seongtki    1898    1415  0 00:35 pts/0    00:00:00 /bin/sh</span><br><span class="line">seongtki    1902    1662  0 00:35 pts/1    00:00:00 grep --color=auto /bin/sh</span><br><span class="line"></span><br><span class="line">seongtki@seongtki:~$ <span class="built_in">readlink</span> /proc/$$/ns/user</span><br><span class="line">user:[4026531837]</span><br></pre></td></tr></table></figure>

<ul>
<li>컨테이너 안에서는 root이지만 실제로 host에서 보면 seongtki로 실행이 되었고, inode도 다르다.</li>
<li>USER 네임스페이스 간 UID&#x2F;GID Remap 되어잇음.</li>
</ul>
<h2 id="Docker-Container와-User-namespace"><a href="#Docker-Container와-User-namespace" class="headerlink" title="Docker Container와 User namespace"></a>Docker Container와 User namespace</h2><h3 id="docker-run-일반-계정"><a href="#docker-run-일반-계정" class="headerlink" title="docker run (일반 계정)"></a>docker run (일반 계정)</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name <span class="built_in">test</span> --<span class="built_in">rm</span> -d ubuntu <span class="built_in">sleep</span> 3600</span><br></pre></td></tr></table></figure>

<ul>
<li>컨테이너가 root로 실행됨</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">seongtki@seongtki:~$ docker <span class="built_in">exec</span> <span class="built_in">test</span> ps aux |grep <span class="built_in">sleep</span></span><br><span class="line">root           1  0.0  0.0   2200   768 ?        Ss   05:14   0:00 <span class="built_in">sleep</span> 3600</span><br><span class="line">seongtki@seongtki:~$ ps aux | grep <span class="built_in">sleep</span></span><br><span class="line">root        4629  0.0  0.0   2200   768 ?        Ss   05:14   0:00 <span class="built_in">sleep</span> 3600</span><br></pre></td></tr></table></figure>

<ul>
<li>Dockerfile에서 실행 시 USER를 정해본다.</li>
</ul>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dockerfile</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:latest</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> useradd -r -u 1000 testuser</span></span><br><span class="line"><span class="keyword">USER</span> testuser</span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;sleep&quot;</span>, <span class="string">&quot;3600&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t testuser -f Dockerfile .</span><br><span class="line">$ docker run --name test2 --<span class="built_in">rm</span> -d testuser</span><br></pre></td></tr></table></figure>

<ul>
<li>도커를 그냥 실행했을 때와 USER를 지정하고 실행했을 때 차이.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">seongtki@seongtki:~$ docker <span class="built_in">exec</span> <span class="built_in">test</span> <span class="built_in">id</span></span><br><span class="line">uid=0(root) gid=0(root) <span class="built_in">groups</span>=0(root)</span><br><span class="line">seongtki@seongtki:~$ docker <span class="built_in">exec</span> test2 <span class="built_in">id</span></span><br><span class="line">uid=1000(testuser) gid=999(testuser) <span class="built_in">groups</span>=999(testuser)</span><br></pre></td></tr></table></figure>

<ul>
<li>test 컨테이너 - root (uid 0) 으로 실행됨</li>
<li>test2 -&gt; seongtki (uid 1000) 으로 실행됨<ul>
<li>test2 는 testuser로 보이고 host에서는 seongtki 로보임</li>
<li>커널에서는 둘 다  uid &#x3D; 1000 으로 취급된다. (&#x2F;etc&#x2F;passwd)</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">seongtki@seongtki:~$ ps aux | grep <span class="built_in">sleep</span></span><br><span class="line">root        4629  0.0  0.0   2200   768 ?        Ss   05:14   0:00 <span class="built_in">sleep</span> 3600</span><br><span class="line">seongtki    4884  0.0  0.0   2200   784 ?        Ss   05:16   0:00 <span class="built_in">sleep</span> 3600</span><br></pre></td></tr></table></figure>

<ul>
<li>user namespace inode 가 같으므로 같은 호스트임을 알 수 있다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># lsns -t user -p 4629</span></span><br><span class="line">        NS TYPE  NPROCS PID USER COMMAND</span><br><span class="line">4026531837 user     154   1 root /sbin/init</span><br><span class="line">root@seongtki:~<span class="comment"># lsns -t user -p 4884</span></span><br><span class="line">        NS TYPE  NPROCS PID USER COMMAND</span><br><span class="line">4026531837 user     154   1 root /sbin/init</span><br></pre></td></tr></table></figure>

<ul>
<li>도커 명령어로 user 접근해보기<ul>
<li>그런데, –user 0 으로 하면 root 로 실행된다.</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker run --name test3 -d --user 1000 --<span class="built_in">rm</span> ubuntu <span class="built_in">sleep</span> 3600</span><br><span class="line"></span><br><span class="line">seongtki@seongtki:~$ ps aux | grep <span class="built_in">sleep</span></span><br><span class="line">root        4629  0.0  0.0   2200   768 ?        Ss   05:14   0:00 <span class="built_in">sleep</span> 3600</span><br><span class="line">seongtki    4884  0.0  0.0   2200   784 ?        Ss   05:16   0:00 <span class="built_in">sleep</span> 3600</span><br><span class="line">seongtki    5034  0.0  0.0   2200   780 ?        Ss   05:21   0:00 <span class="built_in">sleep</span> 3600</span><br><span class="line"></span><br><span class="line">seongtki@seongtki:~$ docker <span class="built_in">exec</span> test3 <span class="built_in">id</span></span><br><span class="line">uid=1000 gid=0(root) <span class="built_in">groups</span>=0(root)</span><br><span class="line"></span><br><span class="line">seongtki@seongtki:~$ sudo lsns -t user -p 5034</span><br><span class="line">        NS TYPE  NPROCS PID USER COMMAND</span><br><span class="line">4026531837 user     155   1 root /sbin/init</span><br></pre></td></tr></table></figure>



<h3 id="도커의-root-사용"><a href="#도커의-root-사용" class="headerlink" title="도커의 root 사용"></a>도커의 root 사용</h3><ul>
<li>패키지인스톨이 쉬움</li>
<li>시스템리소스 사용에 제약이 없음</li>
<li>도커 v1.10+ 에서 user namespace 제공</li>
<li>호스트의 uid&#x2F;gid를 다른 uid&#x2F;gid로 매핑하는 방식</li>
<li>보안관점에서 큰 진보</li>
</ul>
<h3 id="도커-root-보안취약점"><a href="#도커-root-보안취약점" class="headerlink" title="도커 root 보안취약점"></a>도커 root 보안취약점</h3><ul>
<li>실제 root 권한으로 host 파일시스템을 조작할 수 있다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">seongtki@seongtki:~$ docker run --<span class="built_in">rm</span> -v /etc:/root/etc -it ubuntu</span><br><span class="line">root@1608149fa966:/<span class="comment"># echo &quot;127.0.0.1  hello&quot; &gt;&gt; /root/etc/hosts # root 권한이 있어 가능함.</span></span><br></pre></td></tr></table></figure>

<ul>
<li>host에서 실제 값이 입력됨을 확인.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1 localhost</span><br><span class="line">127.0.1.1 seongtki</span><br><span class="line"></span><br><span class="line"><span class="comment"># The following lines are desirable for IPv6 capable hosts</span></span><br><span class="line">::1     ip6-localhost ip6-loopback</span><br><span class="line">fe00::0 ip6-localnet</span><br><span class="line">ff00::0 ip6-mcastprefix</span><br><span class="line">ff02::1 ip6-allnodes</span><br><span class="line">ff02::2 ip6-allrouters</span><br><span class="line">127.0.0.1  hello <span class="comment"># 컨테이너에서 입력한 값이 실제로 입력됨.</span></span><br></pre></td></tr></table></figure>



<h3 id="docker-remap"><a href="#docker-remap" class="headerlink" title="docker remap"></a>docker remap</h3><ul>
<li>docker에서 user namespace를 적용해보자.</li>
<li>uid, gid를 remap할 대역을 정의한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo sh -c <span class="string">&#x27;echo dockremap:500000:65536 &gt; /etc/subuid&#x27;</span> <span class="comment"># &#123;username&#125;:&#123;start&#125;:&#123;count&#125; </span></span><br><span class="line">sudo sh -c <span class="string">&#x27;echo dockremap:500000:65536 &gt; /etc/subgid&#x27;</span> <span class="comment"># &#123;groupname&#125;:&#123;start&#125;:&#123;count&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">seongtki@seongtki:~$ sudo <span class="built_in">cat</span> /etc/subuid</span><br><span class="line">dockremap:500000:65536</span><br><span class="line">seongtki@seongtki:~$ sudo <span class="built_in">cat</span> /etc/subgid</span><br><span class="line">dockremap:500000:65536</span><br></pre></td></tr></table></figure>

<ul>
<li>실행 옵션에 remap 설정</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">seongtki@seongtki:~$  sudo vi /etc/systemd/system/docker.service</span><br><span class="line"></span><br><span class="line">[Service] <span class="comment"># add line</span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// -H tcp://127.0.0.1:2375 --userns-remap=default <span class="comment"># add line</span></span><br><span class="line"></span><br><span class="line">seongtki@seongtki:~$ sudo systemctl daemon-reload</span><br><span class="line">seongtki@seongtki:~$ sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 설정을 다시 없애려면</span></span><br><span class="line">/etc/systemd/system/docker.service <span class="comment"># 내부에 내용을 모두 지우고</span></span><br><span class="line">sudo systemctl unmask docker <span class="comment"># 실행하고 docker 재실행 하면 된다.</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.funtoo.org/LXD/What_are_subuids_and_subgids%3F">subuid, subgid</a></p>
<ul>
<li>컨테이너 실행</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --<span class="built_in">rm</span> -v /etc:/root/etc -it ubuntu</span><br></pre></td></tr></table></figure>

<ul>
<li>컨테이너에</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 권한제한 확인</span></span><br><span class="line">root@cb4263e1b582:/<span class="comment"># echo &quot;127.0.0.1    hello2&quot; &gt;&gt; /root/etc/hosts</span></span><br><span class="line">bash: /root/etc/hosts: Permission denied</span><br><span class="line"></span><br><span class="line">root@cb4263e1b582:/<span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) <span class="built_in">groups</span>=0(root) <span class="comment"># 컨테이너 내부에서는 root 이다.</span></span><br><span class="line"></span><br><span class="line">root@cb4263e1b582:/<span class="comment"># ls -al /root</span></span><br><span class="line">total 20</span><br><span class="line">drwx------   1 root   root    4096 Oct 12 02:57 .</span><br><span class="line">drwxr-xr-x   1 root   root    4096 Oct 12 02:57 ..</span><br><span class="line">-rw-r--r--   1 root   root    3106 Oct 15  2021 .bashrc</span><br><span class="line">-rw-r--r--   1 root   root     161 Jul  9  2019 .profile</span><br><span class="line">drwxr-xr-x 110 nobody nogroup 4096 Oct 12 02:54 etc <span class="comment"># root 권한이 아니다.</span></span><br><span class="line"></span><br><span class="line">root@cb4263e1b582:/<span class="comment"># ps aux</span></span><br><span class="line">USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root           1  0.0  0.0   4132  3404 pts/0    Ss   02:57   0:00 /bin/bash <span class="comment"># pid 1 확인</span></span><br><span class="line">root          10  0.0  0.0   6408  1632 pts/0    R+   02:57   0:00 ps aux</span><br><span class="line"></span><br><span class="line">root@cb4263e1b582:/<span class="comment"># lsns -t user -p $$</span></span><br><span class="line">        NS TYPE  NPROCS PID USER COMMAND</span><br><span class="line">4026532389 user       2   1 root /bin/bash <span class="comment"># user namespace inode 확인</span></span><br></pre></td></tr></table></figure>

<ul>
<li>host의 user namespace inode 확인 (<strong>격리되어 있으므로 다르다</strong>)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># ps aux | grep /bin/bash</span></span><br><span class="line">500000      3343  0.0  0.0   4132  3404 pts/0    Ss+  02:57   0:00 /bin/bash</span><br><span class="line">root        3385  0.0  0.0   5968   660 pts/1    S+   02:58   0:00 grep --color=auto /bin/bash</span><br><span class="line"></span><br><span class="line">root@seongtki:~<span class="comment"># lsns -t user -p $$</span></span><br><span class="line">        NS TYPE  NPROCS PID USER COMMAND</span><br><span class="line">4026531837 user     168   1 root /sbin/init <span class="comment"># 컨테이너의 user namespace inode 값과 다르다.</span></span><br><span class="line"></span><br><span class="line">root@seongtki:~<span class="comment"># readlink /proc/$$/ns/user</span></span><br><span class="line">user:[4026531837]</span><br></pre></td></tr></table></figure>



<p><img src="/blog/img/user-01.png"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-12-08T03:40:35.000Z" title="2024. 12. 8. 오후 12:40:35">2024-12-08</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-12-08T12:33:07.065Z" title="2024. 12. 8. 오후 9:33:07">2024-12-08</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-namespace/">container/namespace</a></span><span class="level-item">6 minutes read (About 956 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/12/08/docs/namespace/pid-namespace/">pid namespace</a></h1><div class="content"><ul>
<li>Process ID 넘버스페이스를 isolate 한다.</li>
<li>부모,자식 네임스페이스 중첩구조</li>
<li>부모 네임스페이스 (see) -&gt; 자식 네임스페이스</li>
</ul>
<h3 id="host-pid-1"><a href="#host-pid-1" class="headerlink" title="host pid 1"></a>host pid 1</h3><ul>
<li>init 프로세스 (커널이 생성해준다)</li>
<li>시그널 처리</li>
<li>좀비, 고아프로세스 처리</li>
<li>kill 1 되면, 시스템 패닉되어 reboot해야함</li>
</ul>
<h3 id="컨테이너-pid-1"><a href="#컨테이너-pid-1" class="headerlink" title="컨테이너 pid 1"></a>컨테이너 pid 1</h3><ul>
<li>unshare 할 때 fork 하여 자식 pid namespace의 pid 1 로 실행</li>
<li>시그널 처리</li>
<li>좀비, 고아프로세스 처리</li>
<li>죽으면 컨테이너가 종료됨</li>
</ul>
<h3 id="unshare"><a href="#unshare" class="headerlink" title="unshare"></a>unshare</h3><ul>
<li>-p : pid namespace</li>
<li>-f : fork</li>
<li>–mount-proc : proc 파일시스템 마운트</li>
</ul>
<h3 id="x2F-proc"><a href="#x2F-proc" class="headerlink" title="&#x2F;proc"></a>&#x2F;proc</h3><ul>
<li>메모리 기반의 가상파일 시스템<ul>
<li>pseudo filesystem (memory based virtual filesystem)</li>
</ul>
</li>
<li>커널이 관리하는 시스템 정보를 제공</li>
<li>시스템 모니터링과 분석에 활용</li>
<li>커널 데이터 구조의 접근을 쉽게 할 수 있음</li>
<li>ps, mount ,umount 할 때 &#x2F;proc 파일시스템을 통해서 명령어가 실행됨.</li>
<li>컨테이너 (pid namespace) 안에서 프로세스 정보를 조회하고 제어하기 위해 사용한다.</li>
</ul>
<h3 id="예제"><a href="#예제" class="headerlink" title="예제"></a>예제</h3><ul>
<li>fork하면서 pid namespace 로 격리함</li>
<li>proc 파일시스템을 마운트 하지 않으면 proc 정보가 보임</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp<span class="comment"># unshare -fp --mount-proc /bin/sh</span></span><br><span class="line">\<span class="comment">#</span></span><br></pre></td></tr></table></figure>



<ul>
<li>컨테이너<ul>
<li>pid 1은 &#x2F;bin&#x2F;sh이다.</li>
<li>namespace inode 조회.</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 컨테이너</span></span><br><span class="line"><span class="comment"># ps -ef</span></span><br><span class="line">UID          PID    PPID  C STIME TTY          TIME CMD</span><br><span class="line">root           1       0  0 04:41 pts/0    00:00:00 /bin/sh</span><br><span class="line">root           2       1  0 04:42 pts/0    00:00:00 ps -ef</span><br><span class="line"></span><br><span class="line"><span class="comment"># lsns -t pid -p 1</span></span><br><span class="line">        NS TYPE NPROCS PID USER COMMAND</span><br><span class="line">4026532398 pid       2   1 root /bin/sh</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="host"><a href="#host" class="headerlink" title="host"></a>host</h3><ul>
<li>pid 1은 &#x2F;sbin&#x2F;init 이다. (컨테이너와 다름)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># ps -ef</span></span><br><span class="line">UID          PID    PPID  C STIME TTY          TIME CMD</span><br><span class="line">root           1       0  0 03:21 ?        00:00:01 /sbin/init</span><br><span class="line">root           2       0  0 03:21 ?        00:00:00 [kthreadd]</span><br></pre></td></tr></table></figure>

<ul>
<li>unshare명령에 대한 프로세스의 자식에 &#x2F;bin&#x2F;sh 가 있다. </li>
<li>&#x2F;bin&#x2F;sh의 inode 를 조회해 보면, 컨테이너의 pid 1의 inode와 같음을 알 수 있다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># ps -ef | grep /bin/sh</span></span><br><span class="line">root       15787   15768  0 04:41 pts/0    00:00:00 unshare -fp --mount-proc /bin/sh</span><br><span class="line">root       15788   15787  0 04:41 pts/0    00:00:00 /bin/sh</span><br><span class="line">root       15952   15938  0 04:43 pts/2    00:00:00 grep --color=auto /bin/sh</span><br><span class="line"></span><br><span class="line">root@seongtki:~<span class="comment"># lsns -t pid -p 15788</span></span><br><span class="line">        NS TYPE NPROCS   PID USER COMMAND</span><br><span class="line">4026532398 pid       1 15788 root /bin/sh</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>위 예제의 pid namespace 구조도는 아래와 같다.</li>
</ul>
<p><img src="/blog/img/pid-01.png"></p>
<h2 id="signal-handler"><a href="#signal-handler" class="headerlink" title="signal handler"></a>signal handler</h2><h3 id="pid-namespace"><a href="#pid-namespace" class="headerlink" title="pid namespace"></a>pid namespace</h3><p>컨테이너의 pid 1을 SIGKILL 하면 컨테이너가 종료되는 것을 알 수 있다.</p>
<ul>
<li>컨테이너로 시그널을 보낼 때, 핸들링하는 프로그램 데몬이 존재해야 하지만, 없기 때문에 SIGKILL을 제외한 시그널을 무시된다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># kill -SIGHUP 15788 # ignore </span></span><br><span class="line">root@seongtki:~<span class="comment"># kill -SIGINT 15788 # ignore </span></span><br><span class="line">root@seongtki:~<span class="comment"># kill -SIGTERM 15788 # ignore </span></span><br><span class="line">root@seongtki:~<span class="comment"># kill -SIGKILL 15788 # ignore </span></span><br><span class="line">root@seongtki:~<span class="comment"># kill -SIGKILL 15788 # pid namespace 종료</span></span><br></pre></td></tr></table></figure>



<h3 id="docker-pid"><a href="#docker-pid" class="headerlink" title="docker pid"></a>docker pid</h3><ul>
<li>busybox 를 실행하고 sleep 3600 cmd 실행하도록 컨테이너를 생성하였다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># docker run --rm --name busybox busybox sleep 3600</span></span><br></pre></td></tr></table></figure>

<ul>
<li>host에서 sleep 3600 가 실행중인걸 알 수 있다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># ps aux | grep sleep</span></span><br><span class="line">root       16005  0.3  0.5 1326556 22572 pts/0   Sl+  05:20   0:00 docker run --<span class="built_in">rm</span> --name busybox busybox <span class="built_in">sleep</span> 3600</span><br><span class="line">root       16067  0.0  0.0   3852   400 ?        Ss   05:20   0:00 <span class="built_in">sleep</span> 3600</span><br><span class="line">root       16100  0.0  0.0   5968   668 pts/2    S+   05:20   0:00 grep --color=auto <span class="built_in">sleep</span></span><br></pre></td></tr></table></figure>

<ul>
<li>컨테이너 내부에서 pid1 은 cmd임을 알 수 있다.</li>
<li>이는 시그널을 컨트롤하는 사용자 프로그램이 없다는 뜻이어서, kill을 제외한 다른 시그널에대한 핸들링이 없다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># docker exec busybox ps -ef</span></span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 <span class="built_in">sleep</span> 3600</span><br><span class="line">    7 root      0:00 ps -ef</span><br><span class="line">    </span><br><span class="line">root@seongtki:~<span class="comment"># kill -SIGHUP 16067 # ignore </span></span><br><span class="line">root@seongtki:~<span class="comment"># kill -SIGINT 16067 # ignore</span></span><br><span class="line">root@seongtki:~<span class="comment"># kill -SIGTERM 16067 # ignore</span></span><br><span class="line">root@seongtki:~<span class="comment"># kill -SIGKILL 16067 # ignore</span></span><br><span class="line">root@seongtki:~<span class="comment"># kill -SIGTERM 16067 # 컨테이너 종료</span></span><br></pre></td></tr></table></figure>





<h3 id="docker-init-process"><a href="#docker-init-process" class="headerlink" title="docker init process"></a>docker init process</h3><ul>
<li>–init : docker 에서 제공하는 컨테이너 init process</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment">#  docker run --rm --name busybox --init busybox sleep 3600</span></span><br></pre></td></tr></table></figure>

<ul>
<li>cmd 인 sleep 3600 부모로 &#x2F;sbin&#x2F;docker-init이 존재하는걸 알수 있다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># ps aux | grep sleep</span></span><br><span class="line">root       16182  0.2  0.5 1326812 22972 pts/0   Sl+  05:22   0:00 docker run --<span class="built_in">rm</span> --name busybox --init busybox <span class="built_in">sleep</span> 3600</span><br><span class="line">root       16230  0.0  0.0    812     4 ?        Ss   05:22   0:00 /sbin/docker-init -- <span class="built_in">sleep</span> 3600</span><br><span class="line">root       16265  0.0  0.0   3852   412 ?        S    05:22   0:00 <span class="built_in">sleep</span> 3600</span><br><span class="line">root       16267  0.0  0.0   5968   672 pts/2    S+   05:22   0:00 grep --color=auto <span class="built_in">sleep</span></span><br></pre></td></tr></table></figure>

<ul>
<li>컨테이너 내부의 ps역시 initprocess 자식으로 cmd가 존재한다.</li>
<li>SIGHUP을 날렸을 때, docker-init 프로그램에서 시그널을 핸들링하여 컨테이너가 종료되는 걸 알 수 있다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># docker exec busybox ps -ef</span></span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 /sbin/docker-init -- <span class="built_in">sleep</span> 3600</span><br><span class="line">    6 root      0:00 <span class="built_in">sleep</span> 3600</span><br><span class="line">    7 root      0:00 ps -ef</span><br><span class="line"></span><br><span class="line">root@seongtki:~<span class="comment"># kill -SIGHUP 16230</span></span><br></pre></td></tr></table></figure>





























</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-12-07T23:40:35.000Z" title="2024. 12. 8. 오전 8:40:35">2024-12-08</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-12-08T12:32:57.298Z" title="2024. 12. 8. 오후 9:32:57">2024-12-08</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-namespace/">container/namespace</a></span><span class="level-item">9 minutes read (About 1362 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/12/08/docs/namespace/mount-namespace/">mount namespace</a></h1><div class="content"><h2 id="네임스페이스-namespace"><a href="#네임스페이스-namespace" class="headerlink" title="네임스페이스(namespace)"></a>네임스페이스(namespace)</h2><ul>
<li>하나의 시스템에서 수행되지만, 각각 별개의 독립된 공간인 것처럼 <strong>격리된 환경을 제공</strong>하는 *<em>경량 프로세스 가상화 기술</em></li>
<li>경량 프로세스는 부모 프로세스와 자원을 공유하는 프로세스를 의미</li>
</ul>
<h3 id="LXC-LinuX-Container-의-네임스페이스는-6-종류와-플래그"><a href="#LXC-LinuX-Container-의-네임스페이스는-6-종류와-플래그" class="headerlink" title="LXC(LinuX Container)의 네임스페이스는 6 종류와 플래그"></a>LXC(LinuX Container)의 네임스페이스는 6 종류와 플래그</h3><ul>
<li><p>마운트 네임스페이스 : CLONE_NEWNS</p>
</li>
<li><p>UTS 네임스페이스 : CLONE_NEWUTS</p>
</li>
<li><p>IPC 네임스페이스 : CLONE_NEWIPC</p>
</li>
<li><p>PID 네임스페이스 : CLONE_NEWPID</p>
</li>
<li><p>사용자 네임스페이스 : CLONE_NEWUSER</p>
</li>
<li><p>네트워크 네임스페이스 : CLONE_NEWNET</p>
</li>
<li><p>상수플래그 정의 (&#x2F;usr&#x2F;include&#x2F;linux&#x2F;sched.h)</p>
</li>
</ul>
<p><img src="/blog/img/layer-12.png"></p>
<h3 id="마운트-mount-네임스페이스란"><a href="#마운트-mount-네임스페이스란" class="headerlink" title="마운트(mount) 네임스페이스란?"></a>마운트(mount) 네임스페이스란?</h3><ul>
<li>프로세스와 그 자식 프로세스가 각기 다른 파일시스템 마운트 지점을 제공</li>
<li>기본적으로 모든 프로세스는 동일한 기본 네임스페이스를 공유하기 때문에, 파일 시스템을 마운트하거나 마운트를 해제하는 등의 변경을 모든 프로세스가 인지할 수 있음</li>
<li>만약 clone() 시스템 콜을 통해 프로세스를 생성할 때 CLONE_NEWNS 플래그가 전달되면, 새로 생성되는 프로세스는 호출한 프로세스가 갖고있는 마운트 트리의 사본을 가져옴</li>
<li>이 사본은 부모 프로세스에 영향을 미치지 않고 새로 생성된 프로세스가 파일시스템을 마운트 or 언마운트 등의 변경을 할 수 있도록 함</li>
<li>이 시점부터 기본 네임스페이스의 모든 파일시스템 마운트 및 언마운트는 새로운 네임스페이스에서 볼 수 있지만, 각각의 프로세스 별 마운트 네임스페이스 내부에서의 변경을 해당 프로세스의 네임스페이스 밖에서는 알 수 없음</li>
</ul>
<p>마운트 네임스페이스는 “mount point”를 격리 한다.<br>여기서 mount란 루트파일시스템에 서브파일시스템을 부착하는 시스템콜이고, mount point는 파일시스템이 부착(mount) 될 위치(디렉터리)다.</p>
<p>mount 하면 원래 디렉터리가 포함하고 있던 파일, 하위 디렉터리 등이 보이지 않고, 새로 부착된 파일시스템의 파일들이 보이게 됩니다. 예를 들어 USB 드라이브를 지정한 mount point로 부착을 시키면, 해당 위치에는 부착된 USB의 파일들이 보이게 됩니다. </p>
<p>마운트 네임스페이스가 mount point를 격리한다는 것은 파일시스템 마운트와 해제 등의 변경사항들이 네임스페이스 밖에서는 보이지 않고, 외부에 전혀 영향을 주지 않음을 의미합니다. 마운트 네임스페이스가 생김으로써 컨테이너를 위해 pivot_root를 안전하게 실행할 수 있게 되었습니다.</p>
<h3 id="unshare-mount-namespace"><a href="#unshare-mount-namespace" class="headerlink" title="unshare mount namespace"></a>unshare mount namespace</h3><h3 id="mount-플래그를-unshared-시스템-콜에-전달"><a href="#mount-플래그를-unshared-시스템-콜에-전달" class="headerlink" title="mount 플래그를 unshared 시스템 콜에 전달"></a>mount 플래그를 unshared 시스템 콜에 전달</h3><ul>
<li>부모 프로세스의 mounts를 복제</li>
<li>현재 bash 프로세스를 자체 마운트 네임스페이스로 이동</li>
<li>“-m”옵션 -&gt; 마운트 네임스페이스</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unshare -m</span><br><span class="line">root@seongtki:/tmp<span class="comment"># mkdir tmp1</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>root filesystem이 같기 때문에 양쪽다 폴더가 보임</p>
</li>
<li><p>mount는 namespace 내부에서만 적용되어 보인다.</p>
</li>
<li><p>tmp1 : mount point</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp<span class="comment"># mount -o size=1m -t tmpfs tmpfs tmp1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp<span class="comment"># mount | grep tmp1</span></span><br><span class="line">tmpfs on /tmp/tmp1 <span class="built_in">type</span> tmpfs (rw,relatime,size=1024k)</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># readlink 심폴릭링크를 통해 namepsace id를 가져올 수 있다.</span></span><br><span class="line"><span class="comment"># /proc/$$ 는 현재 bash 쉘의 프로세스 ID(PID)</span></span><br><span class="line">$ <span class="built_in">readlink</span> /proc/$$/ns/mnt</span><br><span class="line">mnt:[4026532211]</span><br></pre></td></tr></table></figure>





<ul>
<li>host</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp<span class="comment"># mount | grep tmp1</span></span><br><span class="line">root@seongtki:/tmp<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<ul>
<li>mount namespace는 per-process mount isolation을 제공 (프로세스에 격리된 파일시스템 마운트 제공)</li>
</ul>
<h3 id="per-process-mount-isolation"><a href="#per-process-mount-isolation" class="headerlink" title="per-process mount isolation"></a>per-process mount isolation</h3><ul>
<li>new-root 에 nginx를 설치한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">export</span> $(docker create nginx:latest) | tar -C new-root -xvf -</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">1 directory, 0 files</span><br><span class="line">root@seongtki:/tmp/tmp1<span class="comment"># tree -L 1 new-root</span></span><br><span class="line">new-root</span><br><span class="line">├── bin -&gt; usr/bin</span><br><span class="line">├── boot</span><br><span class="line">├── dev</span><br><span class="line">├── docker-entrypoint.d</span><br><span class="line">├── docker-entrypoint.sh</span><br><span class="line">├── etc</span><br><span class="line">├── hello</span><br><span class="line">├── home</span><br><span class="line">├── lib -&gt; usr/lib</span><br><span class="line">├── media</span><br><span class="line">├── mnt</span><br><span class="line">├── opt</span><br><span class="line">├── proc</span><br><span class="line">├── root</span><br><span class="line">├── run</span><br><span class="line">├── sbin -&gt; usr/sbin</span><br><span class="line">├── srv</span><br><span class="line">├── sys</span><br><span class="line">├── tmp</span><br><span class="line">├── usr</span><br><span class="line">├── var</span><br><span class="line">└── world</span><br></pre></td></tr></table></figure>

<ul>
<li>mount</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp/tmp1<span class="comment"># mount -t tmpfs none new-root</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp/tmp1<span class="comment"># df -h | grep new</span></span><br><span class="line">none                               2.0G     0  2.0G   0% /tmp/tmp1/new-root</span><br></pre></td></tr></table></figure>



<h3 id="pivot-root-적용"><a href="#pivot-root-적용" class="headerlink" title="pivot_root 적용"></a>pivot_root 적용</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/<span class="comment"># mkdir old-root</span></span><br><span class="line">/<span class="comment"># pivot_root . old-root # 현재디렉토리를 루트파일시스템으로 하고, old-root 폴더에 기존 루트디렉토리를 마운트시킨다.</span></span><br><span class="line"></span><br><span class="line">/<span class="comment"># nginx -g &quot;daemon off;&quot; # nginx 실행</span></span><br></pre></td></tr></table></figure>



<ul>
<li>host에서 nginx pid를 이용해서 namespace id를 가져와 해당 파일시스템을 조회해본다.</li>
<li>lsns: 현존하는 namespace를 확인하기 위해 사용하는 명령어</li>
</ul>
<p><img src="/blog/img/layer-13.png"></p>
<ul>
<li>자체적인 루트파일시스템이 보장되므로 서버 환경 (시스템 파일, 의존성 라이브러리 충돌, 경로 설정 등) 으로 부터 자유롭다.</li>
<li>서버의 파일시스템으로 부터 완전하게 분리됨으로써 보안상 안전함</li>
<li>컨테이너 내에서 자유롭게 마운트 변경이 가능하고 파일시스템을 확장할 수 있다.</li>
</ul>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/blog/categories/container-namespace/page/0/">Previous</a></div><div class="pagination-next"><a href="/blog/categories/container-namespace/page/2/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/blog/categories/container-namespace/">1</a></li><li><a class="pagination-link" href="/blog/categories/container-namespace/page/2/">2</a></li><li><a class="pagination-link" href="/blog/categories/container-namespace/page/3/">3</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/blog/img/avatar.png" alt="Seongtaek Kim"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Seongtaek Kim</p><p class="is-size-6 is-block">Blog</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/blog/archives"><p class="title">51</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/blog/categories"><p class="title">40</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/blog/tags"><p class="title">0</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/seongtaekkim"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Linkedin" href="https://linkedin.com/in/staek"><i class="fab fa-linkedin"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/blog/categories/calico-communication/"><span class="level-start"><span class="level-item">calico/communication</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/calico-concept/"><span class="level-start"><span class="level-item">calico/concept</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/calico-networkmode/"><span class="level-start"><span class="level-item">calico/networkmode</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/cilium-cilium/"><span class="level-start"><span class="level-item">cilium/cilium</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/cilium-communication/"><span class="level-start"><span class="level-item">cilium/communication</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/cilium-install/"><span class="level-start"><span class="level-item">cilium/install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-cgroup/"><span class="level-start"><span class="level-item">container/cgroup</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-namespace/"><span class="level-start"><span class="level-item">container/namespace</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-overlayFS/"><span class="level-start"><span class="level-item">container/overlayFS</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-overlaynetwork/"><span class="level-start"><span class="level-item">container/overlaynetwork</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/gateway-gatewayapi/"><span class="level-start"><span class="level-item">gateway/gatewayapi</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/gateway-gloo/"><span class="level-start"><span class="level-item">gateway/gloo</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/ingress-ingress/"><span class="level-start"><span class="level-item">ingress/ingress</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-bookinfo/"><span class="level-start"><span class="level-item">istio/bookinfo</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-envoy/"><span class="level-start"><span class="level-item">istio/envoy</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-istio-outline/"><span class="level-start"><span class="level-item">istio/istio-outline</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-istio-test/"><span class="level-start"><span class="level-item">istio/istio-test</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-istio-traffic/"><span class="level-start"><span class="level-item">istio/istio-traffic</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/java-Enumeration/"><span class="level-start"><span class="level-item">java/Enumeration</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/java-flyweight/"><span class="level-start"><span class="level-item">java/flyweight</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/java-interface/"><span class="level-start"><span class="level-item">java/interface</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/k8s-PAUSE-Container/"><span class="level-start"><span class="level-item">k8s/PAUSE-Container</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/k8s-flannel/"><span class="level-start"><span class="level-item">k8s/flannel</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/k8s-kind/"><span class="level-start"><span class="level-item">k8s/kind</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/kafka-C-IO-multiplexing-test/"><span class="level-start"><span class="level-item">kafka/C-IO multiplexing-test</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/kafka-consumer-async/"><span class="level-start"><span class="level-item">kafka/consumer-async</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/kafka-kafka-poll/"><span class="level-start"><span class="level-item">kafka/kafka-poll</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/kafka-tx-outline/"><span class="level-start"><span class="level-item">kafka/tx-outline</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/kafka-tx-test-amd/"><span class="level-start"><span class="level-item">kafka/tx-test-amd</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/kafka-tx-test-arm64/"><span class="level-start"><span class="level-item">kafka/tx-test-arm64</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-ipvs/"><span class="level-start"><span class="level-item">loadbaleancer/ipvs</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-ipvs-install/"><span class="level-start"><span class="level-item">loadbaleancer/ipvs-install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-metalLB/"><span class="level-start"><span class="level-item">loadbaleancer/metalLB</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-metalLB-install/"><span class="level-start"><span class="level-item">loadbaleancer/metalLB-install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/serivce-clusterip/"><span class="level-start"><span class="level-item">serivce/clusterip</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/serivce-install/"><span class="level-start"><span class="level-item">serivce/install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/serivce-nodeport/"><span class="level-start"><span class="level-item">serivce/nodeport</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/vpccni-vpccni/"><span class="level-start"><span class="level-item">vpccni/vpccni</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/vpccni-vpccni-install/"><span class="level-start"><span class="level-item">vpccni/vpccni-install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/vpccni-vpccni2/"><span class="level-start"><span class="level-item">vpccni/vpccni2</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-01-19T06:00:35.000Z">2025-01-19</time></p><p class="title"><a href="/blog/2025/01/19/docs/kafka/consumer-async/">consumer-async</a></p><p class="categories"><a href="/blog/categories/kafka-consumer-async/">kafka/consumer-async</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-01-19T04:00:35.000Z">2025-01-19</time></p><p class="title"><a href="/blog/2025/01/19/docs/kafka/kafka-poll/">kafka-poll</a></p><p class="categories"><a href="/blog/categories/kafka-kafka-poll/">kafka/kafka-poll</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-01-19T02:00:35.000Z">2025-01-19</time></p><p class="title"><a href="/blog/2025/01/19/docs/kafka/io-multiplexing-test/">C-IO multiplexing-test</a></p><p class="categories"><a href="/blog/categories/kafka-C-IO-multiplexing-test/">kafka/C-IO multiplexing-test</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-01-12T09:00:35.000Z">2025-01-12</time></p><p class="title"><a href="/blog/2025/01/12/docs/kafka/tx-test-arm64/">tx-test-arm64</a></p><p class="categories"><a href="/blog/categories/kafka-tx-test-arm64/">kafka/tx-test-arm64</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-01-12T05:00:35.000Z">2025-01-12</time></p><p class="title"><a href="/blog/2025/01/12/docs/kafka/tx-test-amd/">tx-test-amd</a></p><p class="categories"><a href="/blog/categories/kafka-tx-test-amd/">kafka/tx-test-amd</a></p></div></article></div></div><!--!--></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/blog/">Blog</a><p class="is-size-7"><span>&copy; 2025 Seongtaek Kim</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/blog/js/column.js"></script><script src="/blog/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/blog/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/blog/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/blog/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/blog/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>