<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Blog</title><link rel="manifest" href="/blog/manifest.json"><meta name="application-name" content="Blog"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Blog"><meta property="og:url" content="https://seongtaekkim.github.io/blog"><meta property="og:site_name" content="Blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://seongtaekkim.github.io/blog/img/og_image.png"><meta property="article:author" content="Seongtaek Kim"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://seongtaekkim.github.io/blog/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://seongtaekkim.github.io/blog"},"headline":"Blog","image":["https://seongtaekkim.github.io/blog/img/og_image.png"],"author":{"@type":"Person","name":"Seongtaek Kim"},"publisher":{"@type":"Organization","name":"Blog","logo":{"@type":"ImageObject"}},"description":""}</script><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/blog/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/blog/">Blog</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/blog/">Home</a><a class="navbar-item" href="/blog/archives">Archives</a><a class="navbar-item" href="/blog/categories">Categories</a><a class="navbar-item" href="/blog/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-09-07T15:07:32.000Z" title="2024. 9. 8. 오전 12:07:32">2024-09-08</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-21T22:20:08.967Z" title="2024. 9. 22. 오전 7:20:08">2024-09-22</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/k8s-kind/">k8s/kind</a></span><span class="level-item">9 minutes read (About 1355 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/09/08/docs/kind/">kind</a></h1><div class="content"><p><a target="_blank" rel="noopener" href="https://kind.sigs.k8s.io/">kind</a> 는 Docker 컨테이너 노드를 사용하여 로컬 쿠버네티스 클러스터를 실행하기 위한 도구이다.</p>
<p>테스트환경: m1</p>
<p>아래는 kind의 k8s가 DIND 구조로 동작함을 도식화 한 것</p>
<p><img src="/blog/img/kind-01.png"></p>
<p>kind 및 툴 설치</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Install Kind</span></span><br><span class="line">brew install kind</span><br><span class="line">kind --version</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install kubectl</span></span><br><span class="line">brew install kubernetes-cli</span><br><span class="line">kubectl version --client=<span class="literal">true</span></span><br></pre></td></tr></table></figure>



<p>kind 기본사용</p>
<ul>
<li>cluster 생성 (control-plane 1ea)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 클러스터 배포 전 확인</span></span><br><span class="line">docker ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a cluster</span></span><br><span class="line">kind create cluster</span><br><span class="line"></span><br><span class="line"><span class="comment"># 클러스터 배포 확인</span></span><br><span class="line">kind get clusters</span><br><span class="line"></span><br><span class="line"><span class="comment"># 컨트롤플레인 노드 1개 확인</span></span><br><span class="line">kind get nodes</span><br><span class="line">kubectl cluster-info</span><br><span class="line"></span><br><span class="line"><span class="comment"># 노드 정보 확인</span></span><br><span class="line">kubectl get node -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 정보 확인</span></span><br><span class="line">kubectl get pod -A</span><br><span class="line"><span class="comment"># controller-manager, scheduler, etcd-0</span></span><br><span class="line">kubectl get componentstatuses</span><br><span class="line"></span><br><span class="line"><span class="comment"># kube config 파일 확인</span></span><br><span class="line"><span class="built_in">cat</span> ~/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx 파드 배포 및 확인</span></span><br><span class="line">kubectl run nginx --image=nginx:alpine</span><br><span class="line">kubectl get pod -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 노드에 Taints 정보 확인</span></span><br><span class="line">kubectl describe node | grep Taints</span><br><span class="line">Taints:             &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 클러스터 삭제</span></span><br><span class="line">kind delete cluster</span><br><span class="line"></span><br><span class="line"><span class="comment"># kube config 삭제 확인</span></span><br><span class="line"><span class="built_in">cat</span> ~/.kube/config</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/kind-02.png"></p>
<p>cluster 생성 (control-plane, worker node)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 클러스터 배포 전 확인</span></span><br><span class="line">docker ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># kind 는 별도 도커 네트워크 생성 후 사용 : 기본값 172.18.0.0/16</span></span><br><span class="line">docker network <span class="built_in">ls</span></span><br><span class="line">docker inspect kind | jq</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a cluster with kind</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOT &gt; kind-2node.yaml </span></span><br><span class="line"><span class="string"># two node (one workers) cluster config</span></span><br><span class="line"><span class="string">kind: Cluster</span></span><br><span class="line"><span class="string">apiVersion: kind.x-k8s.io/v1alpha4</span></span><br><span class="line"><span class="string">nodes:</span></span><br><span class="line"><span class="string">- role: control-plane</span></span><br><span class="line"><span class="string">- role: worker</span></span><br><span class="line"><span class="string">EOT</span></span><br><span class="line">kind create cluster --config kind-2node.yaml --name myk8s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인</span></span><br><span class="line">kind get nodes --name myk8s</span><br><span class="line"></span><br><span class="line"><span class="comment"># k8s api 주소 확인 : 어떻게 로컬에서 접속이 되는 걸까?</span></span><br><span class="line">kubectl cluster-info</span><br><span class="line">docker ps <span class="comment"># 포트 포워딩 정보 확인</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane ss -tnlp | grep 6443</span><br><span class="line">kubectl get pod -n kube-system -l component=kube-apiserver -owide <span class="comment"># 파드 IP 확인</span></span><br><span class="line">kubectl describe  pod -n kube-system -l component=kube-apiserver</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane curl -k https://localhost:6443/livez ;<span class="built_in">echo</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane curl -k https://localhost:6443/readyz ;<span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 노드 정보 확인 : CRI 는 containerd 사용</span></span><br><span class="line">kubectl get node -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 정보 확인 : CNI 는 kindnet 사용</span></span><br><span class="line">kubectl get pod -A -owide</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 디버그용 내용 출력에 ~/.kube/config 권한 인증 로드</span></span><br><span class="line">kubectl get pod -v6</span><br><span class="line"></span><br><span class="line"><span class="comment"># kube config 파일 확인</span></span><br><span class="line"><span class="built_in">cat</span> ~/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># local-path 라는 StorageClass 가 설치, local-path 는 노드의 로컬 저장소를 활용함</span></span><br><span class="line"><span class="comment"># 로컬 호스트의 path 를 지정할 필요 없이 local-path provisioner 이 볼륨을 관리</span></span><br><span class="line">kubectl get sc</span><br><span class="line">kubectl get deploy -n local-path-storage</span><br><span class="line"></span><br><span class="line"><span class="comment"># 툴 설치</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane sh -c <span class="string">&#x27;apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump htop git nano -y&#x27;</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker sh -c <span class="string">&#x27;apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump htop git nano -y&#x27;</span></span><br></pre></td></tr></table></figure>







<p>pod 생성</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 파드 생성</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl create -f -</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: netpod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: netshoot-pod</span></span><br><span class="line"><span class="string">    image: nicolaka/netshoot</span></span><br><span class="line"><span class="string">    command: [&quot;tail&quot;]</span></span><br><span class="line"><span class="string">    args: [&quot;-f&quot;, &quot;/dev/null&quot;]</span></span><br><span class="line"><span class="string">  terminationGracePeriodSeconds: 0</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: nginx</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: nginx-pod</span></span><br><span class="line"><span class="string">    image: nginx:alpine</span></span><br><span class="line"><span class="string">  terminationGracePeriodSeconds: 0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 확인</span></span><br><span class="line">kubectl get pod -owide</span><br><span class="line"></span><br><span class="line"><span class="comment"># netpod 파드에서 nginx 웹 접속</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it netpod -- curl -s $(kubectl get pod nginx -o jsonpath=&#123;.status.podIP&#125;) | grep -o <span class="string">&quot;&lt;title&gt;.*&lt;/title&gt;&quot;</span></span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br></pre></td></tr></table></figure>





<p>도커 컨테이너 확인</p>
<ul>
<li>k8s node인 docker container 는 init process 를 포함하는 Entrypoint 가 정의되어 있음</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 도커 컨테이너 확인</span></span><br><span class="line">docker ps</span><br><span class="line">docker inspect myk8s-control-plane | jq</span><br><span class="line">...</span><br><span class="line">      <span class="string">&quot;Entrypoint&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;/usr/local/bin/entrypoint&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/sbin/init&quot;</span></span><br><span class="line">      ],</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<p>컨트롤플레인 컨테이너 bash 접속 후 확인</p>
<ul>
<li>각 노드는 cpu type에 호환되는 모델로 구동됨</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane bash</span><br><span class="line">-------------------------------------------</span><br><span class="line"><span class="comment"># CPU 정보 확인</span></span><br><span class="line"><span class="built_in">arch</span></span><br><span class="line">aarch64  <span class="comment"># mac m1~m3</span></span><br><span class="line">혹은</span><br><span class="line">x86_64   <span class="comment"># intel/호환 cpu</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 기본 사용자 확인</span></span><br><span class="line"><span class="built_in">whoami</span></span><br><span class="line">root</span><br></pre></td></tr></table></figure>

<p>네트워크 정보 확인</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ip -br -c -4 addr</span><br><span class="line">ip -c route</span><br><span class="line"><span class="built_in">cat</span> /etc/resolv.conf</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/kind-03.png"></p>
<p>Pod정보 확인</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Entrypoint 정보 확인</span></span><br><span class="line"><span class="built_in">cat</span> /usr/local/bin/entrypoint</span><br><span class="line"></span><br><span class="line"><span class="comment"># 프로세스 확인 : PID 1 은 /sbin/init</span></span><br><span class="line">ps -ef</span><br><span class="line"></span><br><span class="line"><span class="comment"># 컨테이터 런타임 정보 확인</span></span><br><span class="line">systemctl status containerd</span><br><span class="line"></span><br><span class="line"><span class="comment"># DinD 컨테이너 확인 : crictl 사용</span></span><br><span class="line">crictl version</span><br><span class="line">crictl info</span><br><span class="line">crictl ps -o json | jq -r <span class="string">&#x27;.containers[] | &#123;NAME: .metadata.name, POD: .labels[&quot;io.kubernetes.pod.name&quot;]&#125;&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;NAME&quot;</span>: <span class="string">&quot;netshoot-pod&quot;</span>,</span><br><span class="line">  <span class="string">&quot;POD&quot;</span>: <span class="string">&quot;netpod&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;NAME&quot;</span>: <span class="string">&quot;nginx-pod&quot;</span>,</span><br><span class="line">  <span class="string">&quot;POD&quot;</span>: <span class="string">&quot;nginx&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;NAME&quot;</span>: <span class="string">&quot;kindnet-cni&quot;</span>,</span><br><span class="line">  <span class="string">&quot;POD&quot;</span>: <span class="string">&quot;kindnet-fvtvf&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;NAME&quot;</span>: <span class="string">&quot;kube-proxy&quot;</span>,</span><br><span class="line">  <span class="string">&quot;POD&quot;</span>: <span class="string">&quot;kube-proxy-5pmzr&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 이미지 확인</span></span><br><span class="line">crictl images</span><br><span class="line">IMAGE                                           TAG                  IMAGE ID            SIZE</span><br><span class="line">docker.io/library/nginx                         alpine               b887aca7aed61       19.6MB</span><br><span class="line">docker.io/nicolaka/netshoot                     latest               e286c635d1232       189MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl 확인</span></span><br><span class="line">kubectl get node -v6</span><br><span class="line"><span class="built_in">cat</span> /etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">-------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment"># 도커 컨테이너 확인 : 다시 한번 자신의 호스트PC에서 도커 컨테이너 확인, DinD 컨테이너가 호스트에서 보이는지 확인</span></span><br><span class="line">docker ps</span><br><span class="line">docker port myk8s-control-plane</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl 확인 : k8s api 호출 주소 확인</span></span><br><span class="line">kubectl get node -v6 </span><br><span class="line">---------------------</span><br><span class="line">I0907 20:43:02.142592    2766 loader.go:395] Config loaded from file:  /etc/kubernetes/admin.conf</span><br><span class="line">I0907 20:43:02.151778    2766 round_trippers.go:553] GET https://myk8s-control-plane:6443/api/v1/nodes?<span class="built_in">limit</span>=500 200 OK <span class="keyword">in</span> 5 milliseconds</span><br></pre></td></tr></table></figure>



<p>클러스터 삭제</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kind delete cluster --name myk8s</span><br></pre></td></tr></table></figure>







<h2 id="Multi-Node-Cluster-Control-plane-Nodes"><a href="#Multi-Node-Cluster-Control-plane-Nodes" class="headerlink" title="Multi-Node Cluster (Control-plane, Nodes)"></a>Multi-Node Cluster (Control-plane, Nodes)</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOT&gt; kind-2node.yaml</span></span><br><span class="line"><span class="string"># two node (one workers) cluster config</span></span><br><span class="line"><span class="string">kind: Cluster</span></span><br><span class="line"><span class="string">apiVersion: kind.x-k8s.io/v1alpha4</span></span><br><span class="line"><span class="string">nodes:</span></span><br><span class="line"><span class="string">- role: control-plane</span></span><br><span class="line"><span class="string">- role: worker</span></span><br><span class="line"><span class="string">  extraPortMappings:</span></span><br><span class="line"><span class="string">  - containerPort: 31000</span></span><br><span class="line"><span class="string">    hostPort: 31000</span></span><br><span class="line"><span class="string">    listenAddress: &quot;0.0.0.0&quot; # Optional, defaults to &quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="string">    protocol: tcp # Optional, defaults to tcp</span></span><br><span class="line"><span class="string">  - containerPort: 31001</span></span><br><span class="line"><span class="string">    hostPort: 31001</span></span><br><span class="line"><span class="string">EOT</span></span><br><span class="line"></span><br><span class="line">CLUSTERNAME=myk8s</span><br><span class="line">kind create cluster --config kind-2node.yaml --name <span class="variable">$CLUSTERNAME</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 배포 확인</span></span><br><span class="line">kind get clusters</span><br><span class="line">kind get nodes --name <span class="variable">$CLUSTERNAME</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 노드 확인</span></span><br><span class="line">kubectl get nodes -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 노드에 Taints 정보 확인</span></span><br><span class="line">kubectl describe node <span class="variable">$CLUSTERNAME</span>-control-plane | grep Taints</span><br><span class="line">Taints:             node-role.kubernetes.io/control-plane:NoSchedule</span><br><span class="line"></span><br><span class="line">kubectl describe node <span class="variable">$CLUSTERNAME</span>-worker | grep Taints</span><br><span class="line">Taints:             &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 컨테이너 확인 : 컨테이너 갯수, 컨테이너 이름 확인</span></span><br><span class="line"><span class="comment"># kind manifests 파일에 정의한 nodePort로 접근 가능.</span></span><br><span class="line">docker ps</span><br><span class="line">docker port <span class="variable">$CLUSTERNAME</span>-worker</span><br><span class="line">31000/tcp -&gt; 0.0.0.0:31000</span><br><span class="line">31001/tcp -&gt; 0.0.0.0:31001</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 컨테이너 내부 정보 확인 : 필요 시 각각의 노드에 bash로 접속하여 확인.</span></span><br><span class="line">docker <span class="built_in">exec</span> -it <span class="variable">$CLUSTERNAME</span>-control-plane ip -br -c -4 addr</span><br><span class="line">docker <span class="built_in">exec</span> -it <span class="variable">$CLUSTERNAME</span>-worker  ip -br -c -4 addr</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/kind-04.png"></p>
<p>kube-ops-view 설치</p>
<ul>
<li>호스트에서 노트포트로 접근가능</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kube-ops-view</span></span><br><span class="line"><span class="comment"># helm show values geek-cookbook/kube-ops-view</span></span><br><span class="line">helm repo add geek-cookbook https://geek-cookbook.github.io/charts/</span><br><span class="line">helm install kube-ops-view geek-cookbook/kube-ops-view --version 1.2.2 --<span class="built_in">set</span> service.main.type=NodePort,service.main.ports.http.nodePort=31000 --<span class="built_in">set</span> env.TZ=<span class="string">&quot;Asia/Seoul&quot;</span> --namespace kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 설치 확인</span></span><br><span class="line">kubectl get deploy,pod,svc,ep -n kube-system -l app.kubernetes.io/instance=kube-ops-view</span><br><span class="line"></span><br><span class="line"><span class="comment"># kube-ops-view 접속 URL 확인 (1.5 , 2 배율)</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;KUBE-OPS-VIEW URL = http://localhost:31000/#scale=1.5&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;KUBE-OPS-VIEW URL = http://localhost:31000/#scale=2&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/kind-05.png"></p>
<p>클러스터 삭제</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kind delete cluster --name <span class="variable">$CLUSTERNAME</span></span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-09-07T15:07:31.000Z" title="2024. 9. 8. 오전 12:07:31">2024-09-08</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-21T22:20:08.969Z" title="2024. 9. 22. 오전 7:20:08">2024-09-22</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/k8s-PAUSE-Container/">k8s/PAUSE-Container</a></span><span class="level-item">5 minutes read (About 776 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/09/08/docs/pause-container/">PAUSE 컨테이너</a></h1><div class="content"><ul>
<li>파드는 1개 이상의 컨테이너로 구성된 컨테이너의 집합이며, PAUSE 컨테이너가 Network&#x2F;IPC&#x2F;UTS 네임스페이스를 생성하고 유지&#x2F;공유한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># &#x27;컨트롤플레인, 워커 노드 1대&#x27; 클러스터 배포 : 파드에 접속하기 위한 포트 맵핑 설정</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOT&gt; kind-2node.yaml</span></span><br><span class="line"><span class="string">kind: Cluster</span></span><br><span class="line"><span class="string">apiVersion: kind.x-k8s.io/v1alpha4</span></span><br><span class="line"><span class="string">nodes:</span></span><br><span class="line"><span class="string">- role: control-plane</span></span><br><span class="line"><span class="string">- role: worker</span></span><br><span class="line"><span class="string">  extraPortMappings:</span></span><br><span class="line"><span class="string">  - containerPort: 30000</span></span><br><span class="line"><span class="string">    hostPort: 30000</span></span><br><span class="line"><span class="string">  - containerPort: 30001</span></span><br><span class="line"><span class="string">    hostPort: 30001</span></span><br><span class="line"><span class="string">EOT</span></span><br><span class="line">kind create cluster --config kind-2node.yaml --name myk8s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 툴 설치</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane sh -c <span class="string">&#x27;apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump htop git nano -y&#x27;</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker        sh -c <span class="string">&#x27;apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump htop -y&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인</span></span><br><span class="line">kubectl get nodes -o wide</span><br><span class="line">docker ps</span><br><span class="line">docker port myk8s-worker</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane ip -br -c -4 addr</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker  ip -br -c -4 addr</span><br><span class="line"></span><br><span class="line"><span class="comment"># kube-ops-view</span></span><br><span class="line">helm repo add geek-cookbook https://geek-cookbook.github.io/charts/</span><br><span class="line">helm install kube-ops-view geek-cookbook/kube-ops-view --version 1.2.2 --<span class="built_in">set</span> service.main.type=NodePort,service.main.ports.http.nodePort=30000 --<span class="built_in">set</span> env.TZ=<span class="string">&quot;Asia/Seoul&quot;</span> --namespace kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 설치 확인</span></span><br><span class="line">kubectl get deploy,pod,svc,ep -n kube-system -l app.kubernetes.io/instance=kube-ops-view<span class="string">&quot;</span></span><br></pre></td></tr></table></figure>





<h3 id="격리자원-확인"><a href="#격리자원-확인" class="headerlink" title="격리자원 확인"></a>격리자원 확인</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># [터미널1] myk8s-worker bash 진입 후 실행 및 확인</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker bash</span><br><span class="line">----------------------------------</span><br><span class="line">systemctl list-unit-files | grep <span class="string">&#x27;enabled         enabled&#x27;</span></span><br><span class="line">containerd.service                                                                    enabled         enabled</span><br><span class="line">kubelet.service                                                                       enabled         enabled</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인 : 파드내에 pause 컨테이너와 metrics-server 컨테이너, 네임스페이스 정보</span></span><br><span class="line"><span class="comment"># pgrep metrics-server</span></span><br><span class="line">pstree -aclnpsS</span><br><span class="line">...</span><br><span class="line">	\-containerd-shim,1776 -namespace k8s.io -<span class="built_in">id</span> 6bd147995b3a6c17384459eb4d3ceab4369329e6b57c009bdc6257b72254e1fb -address /run/containerd/containerd.sock</span><br><span class="line">	|-&#123;containerd-shim&#125;,1777</span><br><span class="line">  ...</span><br><span class="line">	|-pause,1797,ipc,mnt,net,pid,uts</span><br><span class="line">	|-metrics-server,1896,cgroup,ipc,mnt,net,pid,uts --cert-dir=/tmp --secure-port=10250 --kubelet-insecure-tls --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --kubelet-use-node-status-port --metric-resolution=15s</span><br><span class="line">	|   |-&#123;metrics-server&#125;,1912</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 특정 소켓 파일을 사용하는 프로세스 확인</span></span><br><span class="line">lsof /run/containerd/containerd.sock</span><br><span class="line"></span><br><span class="line">ss -xl | egrep <span class="string">&#x27;Netid|containerd&#x27;</span></span><br><span class="line"></span><br><span class="line">findmnt -A</span><br><span class="line">TARGET                                                  SOURCE                 FSTYPE    OPTIONS</span><br><span class="line">/                                                       overlay                overlay   rw,relatime,lowerdir=/var/lib/docker/overlay2/l/HW4BGGJ4LV6M5</span><br><span class="line">...</span><br><span class="line">|-/sys                                                  sysfs                  sysfs     ro,nosuid,nodev,noexec,relatime</span><br><span class="line">| |-/sys/kernel/debug                                   debugfs                debugfs   rw,nosuid,nodev,noexec,relatime</span><br><span class="line">| |-/sys/kernel/tracing                                 tracefs                tracefs   rw,nosuid,nodev,noexec,relatime</span><br><span class="line">| |-/sys/fs/fuse/connections                            fusectl                fusectl   rw,nosuid,nodev,noexec,relatime</span><br><span class="line">| |-/sys/kernel/config                                  configfs               configfs  rw,nosuid,nodev,noexec,relatime</span><br><span class="line">| \-/sys/fs/cgroup                                      cgroup                 cgroup2   rw,nosuid,nodev,noexec,relatime</span><br><span class="line"></span><br><span class="line">findmnt -t cgroup2</span><br><span class="line">grep cgroup /proc/filesystems</span><br><span class="line"><span class="built_in">stat</span> -<span class="built_in">fc</span> %T /sys/fs/cgroup/</span><br><span class="line"></span><br><span class="line">----------------------------------</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pstree -aclnpsS</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/pause-01.png"></p>
<h3 id="containers-test"><a href="#containers-test" class="headerlink" title="containers test"></a>containers test</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myweb2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myweb2-nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myweb2-netshoot</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nicolaka/netshoot</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/bash&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while true; do sleep 5; curl localhost; done&quot;</span>] <span class="comment"># 포드가 종료되지 않도록 유지합니다</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f myweb2.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> myweb2 -c myweb2-netshoot -- ip addr</span><br><span class="line">kubectl <span class="built_in">exec</span> myweb2 -c myweb2-nginx -- apt update</span><br><span class="line">kubectl <span class="built_in">exec</span> myweb2 -c myweb2-nginx -- apt install -y net-tools</span><br><span class="line">kubectl <span class="built_in">exec</span> myweb2 -c myweb2-nginx -- ifconfig</span><br><span class="line"></span><br><span class="line">NGINXPID=$(ps -ef | grep <span class="string">&#x27;nginx -g&#x27;</span> | grep -v grep | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$NGINXPID</span></span><br><span class="line"></span><br><span class="line">NETSHPID=$(ps -ef | grep <span class="string">&#x27;curl&#x27;</span> | grep -v grep | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$NETSHPID</span></span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/pause-02.png"></p>
<h4 id="ns-ip-비교"><a href="#ns-ip-비교" class="headerlink" title="ns, ip 비교"></a>ns, ip 비교</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 개별 컨테이너에 명령 실행 : IP 동일 확인</span></span><br><span class="line">crictl ps</span><br><span class="line">crictl ps -q</span><br><span class="line">crictl <span class="built_in">exec</span> -its &lt;myweb2-nginx    컨테이너ID&gt; ifconfig</span><br><span class="line">crictl <span class="built_in">exec</span> -its &lt;myweb2-netshoot 컨테이너ID&gt; ifconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># PAUSE 의 NET 네임스페이스 PID 확인 및 IP 정보 확인</span></span><br><span class="line">lsns -t net</span><br><span class="line">nsenter -t <span class="variable">$PAUSEPID</span> -n ip -c addr</span><br><span class="line">nsenter -t <span class="variable">$NGINXPID</span> -n ip -c addr</span><br><span class="line">nsenter -t <span class="variable">$NETSHPID</span> -n ip -c addr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2개의 네임스페이스 비교 , 아래 2112 프로세스의 정제는?</span></span><br><span class="line">crictl inspect &lt;myweb2-nginx    컨테이너ID&gt; | jq</span><br><span class="line">crictl inspect &lt;myweb2-netshoot 컨테이너ID&gt; | jq</span><br></pre></td></tr></table></figure>





<h3 id="자원정리"><a href="#자원정리" class="headerlink" title="자원정리"></a>자원정리</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod myweb2</span><br><span class="line">kind delete cluster --name myk8s</span><br></pre></td></tr></table></figure>









</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-08-31T14:40:35.000Z" title="2024. 8. 31. 오후 11:40:35">2024-08-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-21T22:20:08.966Z" title="2024. 9. 22. 오전 7:20:08">2024-09-22</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-cgroup/">container/cgroup</a></span><span class="level-item">4 minutes read (About 600 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/08/31/docs/cgroup/cgroup/">cgroups</a></h1><div class="content"><ul>
<li>Cgroups, Control Groups</li>
<li>컨테이너 별로 자원을 분배하고 limit 내에서 운용</li>
<li>하나 또는 복수의 장치를 묶어서 그룹</li>
<li>프로세스가 사용하는 리소스 통제</li>
</ul>
<h3 id="Cgroup-파일시스템"><a href="#Cgroup-파일시스템" class="headerlink" title="Cgroup 파일시스템"></a>Cgroup 파일시스템</h3><ul>
<li>자원할당과 제어를 파일시스템으로 제공</li>
<li>cgroup 네임스페이스로 격리할 수 있다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">seongtki@seongtki:~$ tree -L 1 /sys/fs/cgroup/cpu</span><br><span class="line">/sys/fs/cgroup/cpu</span><br><span class="line">├── cgroup.clone_children</span><br><span class="line">├── cgroup.procs</span><br><span class="line">├── cgroup.sane_behavior</span><br><span class="line">├── cpuacct.stat</span><br><span class="line">├── cpuacct.usage</span><br><span class="line">├── cpuacct.usage_all</span><br><span class="line">├── cpuacct.usage_percpu</span><br><span class="line">├── cpuacct.usage_percpu_sys</span><br><span class="line">├── cpuacct.usage_percpu_user</span><br></pre></td></tr></table></figure>



<h3 id="cgroup-tools-stress-설치"><a href="#cgroup-tools-stress-설치" class="headerlink" title="cgroup-tools,  stress 설치"></a>cgroup-tools,  stress 설치</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># apt install -y cgroup-tools</span></span><br><span class="line">root@seongtki:~<span class="comment"># apt install -y stress</span></span><br></pre></td></tr></table></figure>



<h3 id="프로세스-실행-및-cpu-사용률-확인"><a href="#프로세스-실행-및-cpu-사용률-확인" class="headerlink" title="프로세스 실행 및 cpu 사용률 확인"></a>프로세스 실행 및 cpu 사용률 확인</h3><ul>
<li>top으로 CPU 100% 확인</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># stress -c 1</span></span><br><span class="line">stress: info: [2328] dispatching hogs: 1 cpu, 0 io, 0 vm, 0 hdd</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/cgroup-01.png"></p>
<h3 id="자원제한을-위한-cgroup-제어그룹-생성"><a href="#자원제한을-위한-cgroup-제어그룹-생성" class="headerlink" title="자원제한을 위한 cgroup 제어그룹 생성"></a>자원제한을 위한 cgroup 제어그룹 생성</h3><ul>
<li>-a : 소유자 정의 (<agid>:<auid>)</li>
<li>-g : 추가할 그룹을 정의한다. (<controllers>:<path>)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># cgcreate -a root -g cpu:mycgroup</span></span><br></pre></td></tr></table></figure>

<ul>
<li>디렉토리만 만들면 내용은 커널이 다만들어준다 (mycgroup이 관리할 내용을)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># tree /sys/fs/cgroup/cpu/mycgroup/</span></span><br><span class="line">/sys/fs/cgroup/cpu/mycgroup/</span><br><span class="line">├── cgroup.clone_children</span><br><span class="line">├── cgroup.procs</span><br><span class="line">├── cpuacct.stat</span><br><span class="line">├── cpuacct.usage</span><br><span class="line">├── cpuacct.usage_all</span><br><span class="line">├── cpuacct.usage_percpu</span><br><span class="line">├── cpuacct.usage_percpu_sys</span><br><span class="line">├── cpuacct.usage_percpu_user</span><br><span class="line">├── cpuacct.usage_sys</span><br><span class="line">├── cpuacct.usage_user</span><br><span class="line">├── cpu.cfs_period_us</span><br><span class="line">├── cpu.cfs_quota_us</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h3 id="리소스-설정-및-프로세스-할당"><a href="#리소스-설정-및-프로세스-할당" class="headerlink" title="리소스 설정 및 프로세스 할당"></a>리소스 설정 및 프로세스 할당</h3><ul>
<li>cpu.cfs_period_us : CPU 할당량을 사용할 수 있는 기간을 마이크로초(µs) 단위로 설정<ul>
<li>기본값이 100000</li>
</ul>
</li>
<li>cpu.cfs_quota_us : 프로세스 그룹에 할당되는 CPU 시간의 한계를 마이크로초(µs) 단위로 설정<ul>
<li>cpu.cfs_quota_us &#x2F; cfs_period_us  * 100 &#x3D;&gt; 30000 &#x2F; 100000 * 100 &#x3D; 30%</li>
</ul>
</li>
<li><strong>30%가 넘지 않게 커널이 cgroup정보를 활용해서 쓰로틀링을 걸어준다</strong></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># cgset -r cpu.cfs_quota_us=30000 mycgroup;</span></span><br><span class="line">root@seongtki:~<span class="comment"># cgexec -g cpu:mycgroup stress -c 1</span></span><br><span class="line">stress: info: [2352] dispatching hogs: 1 cpu, 0 io, 0 vm, 0 hdd</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/cgroup-02.png"></p>
<h3 id="cgroups-삭제"><a href="#cgroups-삭제" class="headerlink" title="cgroups 삭제"></a>cgroups 삭제</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cgdelete cpu:mycgroup</span><br></pre></td></tr></table></figure>





<h3 id="Cgroup-파일-시스템으로-리소스-관리-요약"><a href="#Cgroup-파일-시스템으로-리소스-관리-요약" class="headerlink" title="Cgroup 파일 시스템으로 리소스 관리 요약"></a>Cgroup 파일 시스템으로 리소스 관리 요약</h3><ul>
<li>제어그룹(controller group) 생성<ul>
<li>우리 예제는 mycgroup이라는 제어그룹을 생성</li>
</ul>
</li>
<li>제어그룹 리소스 설정<ul>
<li>cpu.cfs_quota_us 을 통해 사용률을 설정</li>
</ul>
</li>
<li>제어그룹 프로세스 할당<ul>
<li>cgexec 를사용해서 mycgroup 에 stress 프로세스를 할당해서 실행.</li>
</ul>
</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-08-31T14:20:30.000Z" title="2024. 8. 31. 오후 11:20:30">2024-08-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-21T22:20:08.969Z" title="2024. 9. 22. 오전 7:20:08">2024-09-22</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-overlayFS/">container/overlayFS</a></span><span class="level-item">4 minutes read (About 645 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/08/31/docs/overlayFS/overlayFS/">Overlay Filesystem</a></h1><div class="content"><ul>
<li><p>여러 filesystem을 하나로 mount하는 기능.</p>
</li>
<li><p>두 파일시스템에 동일한 파일이 있는경우</p>
<ul>
<li>나중에 마운트 되는 파일시스템의 파일을 오버레이한다.</li>
</ul>
</li>
<li><p>하위 파일시스템에 대한 쓰기 작업 시</p>
<ul>
<li>그 시점에 Copy-on-write 실시 () 복사본을 생성하여 수행 (원본유지))</li>
</ul>
</li>
<li><p>이령, 상속 파일시스템으로 불린다.</p>
</li>
</ul>
<h3 id="OverlayFS2"><a href="#OverlayFS2" class="headerlink" title="OverlayFS2"></a>OverlayFS2</h3><ul>
<li>Merged Dir: 통합 뷰 (<strong>mount point</strong>)</li>
<li>Upper Dir: Writable. 컨테이너에서의 변경된 내용이 쓰이는 레이어</li>
<li>Lower Dir: Read only, 기존 이미지 영역</li>
<li>Work Dir: “atomic action”을 보장하기 위해 merge에 반영되기 전에 파일을 준비하는 데 사용된다.</li>
</ul>
<p><img src="/blog/img/overlayfs2-01.png"></p>
<h2 id="overlay-test"><a href="#overlay-test" class="headerlink" title="overlay test"></a>overlay test</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> overlay-test</span><br><span class="line"><span class="built_in">cd</span> overlay-test</span><br><span class="line"><span class="built_in">mkdir</span> image1 image2 container work merge</span><br><span class="line"><span class="built_in">touch</span> image1/a image1/b image2/c</span><br><span class="line"></span><br><span class="line"><span class="comment"># merge: mount point</span></span><br><span class="line">mount -t overlay overlay -o lowerdir=image2:image1,upperdir=container,workdir=work merge</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/<span class="comment"># mount | grep overlay-test/</span></span><br><span class="line">overlay on /overlay-test/merge <span class="built_in">type</span> overlay (rw,relatime,lowerdir=image2:image1,upperdir=container,workdir=work)</span><br></pre></td></tr></table></figure>

<ul>
<li>파일구조</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/overlay-test<span class="comment"># tree -I .</span></span><br><span class="line">├── container</span><br><span class="line">├── image1</span><br><span class="line">│   ├── a</span><br><span class="line">│   └── b</span><br><span class="line">├── image2</span><br><span class="line">│   └── c</span><br><span class="line">├── merge</span><br><span class="line">│   ├── a</span><br><span class="line">│   ├── b</span><br><span class="line">│   └── c</span><br><span class="line">└── work</span><br><span class="line">    └── work</span><br></pre></td></tr></table></figure>

<ul>
<li>merge&#x2F;a 삭제 후 디렉토리</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/overlay-test<span class="comment"># rm merge/a</span></span><br><span class="line">root@seongtki:/overlay-test<span class="comment"># tree -I .</span></span><br><span class="line">├── container</span><br><span class="line">│   └── a <span class="comment"># 삭제파일이 upperdir 에 적용되어 보인다 (RW)</span></span><br><span class="line">├── image1</span><br><span class="line">│   ├── a <span class="comment"># lowerdir는 변경이 단됨 (RO)</span></span><br><span class="line">│   └── b</span><br><span class="line">├── image2</span><br><span class="line">│   └── c</span><br><span class="line">├── merge</span><br><span class="line">│   ├── b</span><br><span class="line">│   └── c</span><br><span class="line">└── work</span><br><span class="line">    └── work</span><br></pre></td></tr></table></figure>

<ul>
<li>lowerdir 에 파일 수정 시 merge에도 적용되어 보인다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/overlay-test<span class="comment"># echo &#x27;hello bb&#x27; &gt; image1/b</span></span><br><span class="line"></span><br><span class="line">root@seongtki:/overlay-test<span class="comment"># cat image1/b</span></span><br><span class="line">hello bbb</span><br><span class="line">root@seongtki:/overlay-test<span class="comment"># cat merge/b</span></span><br><span class="line">hello bbb</span><br></pre></td></tr></table></figure>

<ul>
<li>merge파일을 수정하면, lowerdir은 더이상 변경되지 않는다.</li>
<li>Copy-On-Write 가 발생하기 때문이다. (실제 파일이 사용될 때 카피를 하고 수정하기 때문.)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/overlay-test<span class="comment"># echo &#x27;hello m&#x27; &gt; merge/b</span></span><br><span class="line">root@seongtki:/overlay-test<span class="comment"># cat merge/b</span></span><br><span class="line">hello m</span><br><span class="line">root@seongtki:/overlay-test<span class="comment"># cat image1/b</span></span><br><span class="line">hello bbb</span><br></pre></td></tr></table></figure>

<ul>
<li>이후 lowerdir파일을 변경해도 merge파일을 변경되지 않는다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/overlay-test<span class="comment">#  echo &#x27;hello bbbb&#x27; &gt; image1/b</span></span><br><span class="line"></span><br><span class="line">root@seongtki:/overlay-test<span class="comment"># cat image1/b</span></span><br><span class="line">hello bbbb</span><br><span class="line">root@seongtki:/overlay-test<span class="comment"># cat merge/b</span></span><br><span class="line">hello m</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/overlay-test<span class="comment"># tree -I .</span></span><br><span class="line">.</span><br><span class="line">├── container</span><br><span class="line">│   ├── a</span><br><span class="line">│   └── b</span><br><span class="line">├── image1</span><br><span class="line">│   ├── a</span><br><span class="line">│   └── b</span><br><span class="line">├── image2</span><br><span class="line">│   └── c</span><br><span class="line">├── merge</span><br><span class="line">│   ├── b</span><br><span class="line">│   └── c</span><br><span class="line">└── work</span><br><span class="line">    └── work</span><br></pre></td></tr></table></figure>



</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-08-31T14:10:30.000Z" title="2024. 8. 31. 오후 11:10:30">2024-08-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-21T22:20:08.968Z" title="2024. 9. 22. 오전 7:20:08">2024-09-22</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-overlayFS/">container/overlayFS</a></span><span class="level-item">13 minutes read (About 1959 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/08/31/docs/overlayFS/container-layer-stack/">Container Layer Stack</a></h1><div class="content"><ul>
<li><p>컨테이너 설치 시 이미지가 어떤 방식, 구조로 저장되는지 알아보자</p>
</li>
<li><p>도커 컨테이너 , 이미지 삭제</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># docker rm $(docker ps -a -q)</span></span><br><span class="line">\<span class="comment"># docker rmi -f $(docker images -q)</span></span><br></pre></td></tr></table></figure>



<ul>
<li>docker pull nginx:latest</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/<span class="comment"># docker pull nginx:latest</span></span><br><span class="line">latest: Pulling from library/nginx</span><br><span class="line">e886f0f47ef5: Pull complete <span class="comment"># 배포id (distribution id)</span></span><br><span class="line">9a9138853e32: Pull complete</span><br><span class="line">598a42ec6587: Pull complete</span><br><span class="line">82e490cc2043: Pull complete</span><br><span class="line">948128637a91: Pull complete</span><br><span class="line">e4cad15ac3f6: Pull complete</span><br><span class="line">096332b242c2: Pull complete</span><br><span class="line">Digest: sha256:32da30332506740a2f7c34d5dc70467b7f14ec67d912703568daff790ab3f755</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> nginx:latest</span><br><span class="line">docker.io/library/nginx:latest</span><br></pre></td></tr></table></figure>

<ul>
<li>image id 확인</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED      SIZE</span><br><span class="line">nginx        latest    2a4fbb36e966   9 days ago   192MB</span><br></pre></td></tr></table></figure>

<ul>
<li>layer id 확인 (image id 조회)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/<span class="comment"># docker image inspect 2a4fbb36e966 | jq &#x27;.[].RootFS&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;layers&quot;</span>,</span><br><span class="line">  <span class="string">&quot;Layers&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;sha256:311627f8702d2d97e63b916cad711aa9f962a1f20da5572d68b8f223ff051e73&quot;</span>, <span class="comment"># layer id</span></span><br><span class="line">    <span class="string">&quot;sha256:674ca5344f959090515e9eac79055d8630851b21bbd584ac32765315284c05c5&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sha256:7f8881cae5296e2ef0103706a326235494b5f1dcd9ea960656165cf7643ddd47&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sha256:f21128d548a5122f430a58f123deb9c8b80f70b9fc98df280a9619b7e38b6a32&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sha256:dca0e6f80e8df5d85d45426101fefba3d41abe4fc90be994074066d4b135bef5&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sha256:d9664e6da0f787fb8c04e80f1e731223f8ef93f6e097e934442e1792da614dff&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sha256:ed44ff7a11e0afd3e5b58c730514faeac7d6a12faff3f52aa33d33e0369e7aad&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>도커는 다운로드한 이미지를 로컬에 저장하고 관리하기 위해 **”레이어 DB”**를 사용한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/image/overlay2<span class="comment"># tree -L 2</span></span><br><span class="line">.</span><br><span class="line">├── distribution</span><br><span class="line">│   ├── diffid-by-digest</span><br><span class="line">│   └── v2metadata-by-diffid</span><br><span class="line">├── imagedb</span><br><span class="line">│   ├── content</span><br><span class="line">│   └── metadata</span><br><span class="line">├── layerdb  <span class="comment"># 레이어 스택 정보</span></span><br><span class="line">│   ├── mounts</span><br><span class="line">│   ├── sha256</span><br><span class="line">│   └── tmp</span><br><span class="line">└── repositories.json</span><br></pre></td></tr></table></figure>



<table>
<thead>
<tr>
<th>레이어디비 항목</th>
<th>내용</th>
</tr>
</thead>
<tbody><tr>
<td>db id</td>
<td>로컬에서 레이어식별을 위한 레이어디비 id<br />이미지를 pull 받을 때 레이어 별로 생성됨. (받을 때마다 달라짐)</td>
</tr>
<tr>
<td>cache id</td>
<td>레이어가 저장된 로컬경로 id (경로를 식별)<br />- &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;{cache-id}</td>
</tr>
<tr>
<td>diff</td>
<td>layer id (레이어를 식별)</td>
</tr>
<tr>
<td>parent</td>
<td>부모레이어를 가리키는 포인터 (db id) 어떤 레이어 위로 올라갈지 지정</td>
</tr>
</tbody></table>
<h3 id="db-id"><a href="#db-id" class="headerlink" title="db id"></a>db id</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/image/overlay2/layerdb<span class="comment"># tree -L 2 sha256 -I &quot;tar-*|size&quot;</span></span><br><span class="line">sha256</span><br><span class="line">├── 311627f8702d2d97e63b916cad711aa9f962a1f20da5572d68b8f223ff051e73 <span class="comment"># db id</span></span><br><span class="line">│   ├── cache-id</span><br><span class="line">│   └── diff <span class="comment"># layer id</span></span><br><span class="line">├── 807d78e4cdc589c2cdefb7bb6049a31bcc7bf0f90f335a8a8de1abeb0e6a3993</span><br><span class="line">│   ├── cache-id</span><br><span class="line">│   ├── diff</span><br><span class="line">│   └── parent</span><br><span class="line">├── 89b7e61557f3502dc01aeae499b451574376c3e4c46e49294c72e22cd2d9634c</span><br><span class="line">│   ├── cache-id</span><br><span class="line">│   ├── diff</span><br><span class="line">│   └── parent</span><br><span class="line">├── 9f55692205d904037fbc69a1d59354665af3c0c2a767b5e799e719170085bc11</span><br><span class="line">│   ├── cache-id</span><br><span class="line">│   ├── diff</span><br><span class="line">│   └── parent</span><br><span class="line">├── a0e6c2974935e56e8d57d6fea041399b290da1566d82ea1a7d9c3ec7ef60a366</span><br><span class="line">│   ├── cache-id</span><br><span class="line">│   ├── diff</span><br><span class="line">│   └── parent</span><br><span class="line">├── a216b497301a9fc6283077c0906140e22b8f3a67ba92ab6253f036f48e1ff4b1</span><br><span class="line">│   ├── cache-id</span><br><span class="line">│   ├── diff</span><br><span class="line">│   └── parent</span><br><span class="line">└── a3169fdf28b9329e3f1882c095bf11e12a465419c759169682ca706de81bef84</span><br><span class="line">    ├── cache-id</span><br><span class="line">    ├── diff</span><br><span class="line">    └── parent</span><br></pre></td></tr></table></figure>

<ul>
<li>tree -L 2 sha256 -I “tar-*|size” 에서 -I 는 제외항목을 작성</li>
</ul>
<h3 id="cache-id-db-id"><a href="#cache-id-db-id" class="headerlink" title="cache-id : db-id"></a>cache-id : db-id</h3><ul>
<li>cache-id 리스트<ul>
<li>포맷: “cache-id” .&#x2F;sha256&#x2F;“db id”</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/image/overlay2/layerdb<span class="comment"># find . -name cache-id -exec cat &#123;&#125; \; -print</span></span><br><span class="line">52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d./sha256/311627f8702d2d97e63b916cad711aa9f962a1f20da5572d68b8f223ff051e73/cache-id</span><br><span class="line">bd58ec4c3b456591049ce5ad929fac42a96ad23fc28836a29917039d07295ed4./sha256/a0e6c2974935e56e8d57d6fea041399b290da1566d82ea1a7d9c3ec7ef60a366/cache-id</span><br><span class="line">5ebc10176fffee11727b0baa5f552146a74a4fa53935268e2c10726f08f61aa7./sha256/89b7e61557f3502dc01aeae499b451574376c3e4c46e49294c72e22cd2d9634c/cache-id</span><br><span class="line">20fae55020e28561082510b431ec0f85a8bb3a1cebb34f36916b91acc3833c84./sha256/807d78e4cdc589c2cdefb7bb6049a31bcc7bf0f90f335a8a8de1abeb0e6a3993/cache-id</span><br><span class="line">f3453bed47cc62a3d58d00327b6a76fbf15612220a7b1b4825936296fd0b845f./sha256/9f55692205d904037fbc69a1d59354665af3c0c2a767b5e799e719170085bc11/cache-id</span><br><span class="line">64c2e72761ef2dbf88db1e27bf590f901f5d0e7b3f778635ee976a2f834478ba./sha256/a216b497301a9fc6283077c0906140e22b8f3a67ba92ab6253f036f48e1ff4b1/cache-id</span><br><span class="line">067ec145f89b61cd0b6fd41745163c76e04f86db5b4a59a5358cc82a3099526a./sha256/a3169fdf28b9329e3f1882c095bf11e12a465419c759169682ca706de81bef84/cache-id</span><br></pre></td></tr></table></figure>

<ul>
<li>레이어의 로컬 저장 경로(&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;{cache-id})</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/overlay2<span class="comment"># ls -l</span></span><br><span class="line">total 32</span><br><span class="line">drwx--x--- 4 root root 4096 Sep 30 12:31 067ec145f89b61cd0b6fd41745163c76e04f86db5b4a59a5358cc82a3099526a</span><br><span class="line">drwx--x--- 4 root root 4096 Sep 30 12:31 20fae55020e28561082510b431ec0f85a8bb3a1cebb34f36916b91acc3833c84</span><br><span class="line">drwx--x--- 3 root root 4096 Sep 30 12:31 52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d</span><br><span class="line">drwx--x--- 4 root root 4096 Sep 30 12:31 5ebc10176fffee11727b0baa5f552146a74a4fa53935268e2c10726f08f61aa7</span><br><span class="line">drwx--x--- 4 root root 4096 Sep 30 12:31 64c2e72761ef2dbf88db1e27bf590f901f5d0e7b3f778635ee976a2f834478ba</span><br><span class="line">drwx--x--- 4 root root 4096 Sep 30 12:31 bd58ec4c3b456591049ce5ad929fac42a96ad23fc28836a29917039d07295ed4</span><br><span class="line">drwx--x--- 4 root root 4096 Sep 30 12:31 f3453bed47cc62a3d58d00327b6a76fbf15612220a7b1b4825936296fd0b845f</span><br><span class="line">drwx------ 2 root root 4096 Sep 30 12:31 l</span><br></pre></td></tr></table></figure>



<h3 id="layer-id-db-id"><a href="#layer-id-db-id" class="headerlink" title="layer id : db id"></a>layer id : db id</h3><ul>
<li>앞에가 <strong>layer id</strong>, 뒤에가 db id 이다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/image/overlay2/layerdb<span class="comment"># find . -name diff -exec cat &#123;&#125; \; -print</span></span><br><span class="line">sha256:311627f8702d2d97e63b916cad711aa9f962a1f20da5572d68b8f223ff051e73./sha256/311627f8702d2d97e63b916cad711aa9f962a1f20da5572d68b8f223ff051e73/diff</span><br><span class="line">sha256:674ca5344f959090515e9eac79055d8630851b21bbd584ac32765315284c05c5./sha256/a0e6c2974935e56e8d57d6fea041399b290da1566d82ea1a7d9c3ec7ef60a366/diff</span><br><span class="line">sha256:d9664e6da0f787fb8c04e80f1e731223f8ef93f6e097e934442e1792da614dff./sha256/89b7e61557f3502dc01aeae499b451574376c3e4c46e49294c72e22cd2d9634c/diff</span><br><span class="line">sha256:ed44ff7a11e0afd3e5b58c730514faeac7d6a12faff3f52aa33d33e0369e7aad./sha256/807d78e4cdc589c2cdefb7bb6049a31bcc7bf0f90f335a8a8de1abeb0e6a3993/diff</span><br><span class="line">sha256:7f8881cae5296e2ef0103706a326235494b5f1dcd9ea960656165cf7643ddd47./sha256/9f55692205d904037fbc69a1d59354665af3c0c2a767b5e799e719170085bc11/diff</span><br><span class="line">sha256:dca0e6f80e8df5d85d45426101fefba3d41abe4fc90be994074066d4b135bef5./sha256/a216b497301a9fc6283077c0906140e22b8f3a67ba92ab6253f036f48e1ff4b1/diff</span><br><span class="line">sha256:f21128d548a5122f430a58f123deb9c8b80f70b9fc98df280a9619b7e38b6a32./sha256/a3169fdf28b9329e3f1882c095bf11e12a465419c759169682ca706de81bef84/diff</span><br></pre></td></tr></table></figure>





<h3 id="parent-id-db-id"><a href="#parent-id-db-id" class="headerlink" title="parent id : db id"></a>parent id : db id</h3><ul>
<li><p>parent 파일은 부모레이어의 db id를 갖고 있음 (가장 밑바닥은 parent 없음)</p>
</li>
<li><p>sha256:”db-id”.&#x2F;sha256&#x2F;“parent-id”</p>
</li>
<li><p>311627f8702d2d97e63b916cad711aa9f962a1f20da5572d68b8f223ff051e73 가 최상위 부모 db -id 이다.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/image/overlay2/layerdb<span class="comment"># find . -name parent -exec cat &#123;&#125; \; -print</span></span><br><span class="line">sha256:311627f8702d2d97e63b916cad711aa9f962a1f20da5572d68b8f223ff051e73./sha256/a0e6c2974935e56e8d57d6fea041399b290da1566d82ea1a7d9c3ec7ef60a366/parent</span><br><span class="line">sha256:a216b497301a9fc6283077c0906140e22b8f3a67ba92ab6253f036f48e1ff4b1./sha256/89b7e61557f3502dc01aeae499b451574376c3e4c46e49294c72e22cd2d9634c/parent</span><br><span class="line">sha256:89b7e61557f3502dc01aeae499b451574376c3e4c46e49294c72e22cd2d9634c./sha256/807d78e4cdc589c2cdefb7bb6049a31bcc7bf0f90f335a8a8de1abeb0e6a3993/parent</span><br><span class="line">sha256:a0e6c2974935e56e8d57d6fea041399b290da1566d82ea1a7d9c3ec7ef60a366./sha256/9f55692205d904037fbc69a1d59354665af3c0c2a767b5e799e719170085bc11/parent</span><br><span class="line">sha256:a3169fdf28b9329e3f1882c095bf11e12a465419c759169682ca706de81bef84./sha256/a216b497301a9fc6283077c0906140e22b8f3a67ba92ab6253f036f48e1ff4b1/parent</span><br><span class="line">sha256:9f55692205d904037fbc69a1d59354665af3c0c2a767b5e799e719170085bc11./sha256/a3169fdf28b9329e3f1882c095bf11e12a465419c759169682ca706de81bef84/parent</span><br></pre></td></tr></table></figure>



<h3 id="레이어-스택"><a href="#레이어-스택" class="headerlink" title="레이어 스택"></a>레이어 스택</h3><ul>
<li>layer id : 레이어 식별</li>
<li>db id : 레이어관리</li>
<li>cache-id : 레이어 저장</li>
</ul>
<p><img src="/blog/img/layer-01.png"></p>
<h3 id="실제저장-위치"><a href="#실제저장-위치" class="headerlink" title="실제저장 위치"></a>실제저장 위치</h3><ul>
<li>cache id 폴더이름</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/overlay2<span class="comment"># tree -L 1</span></span><br><span class="line">.</span><br><span class="line">├── 067ec145f89b61cd0b6fd41745163c76e04f86db5b4a59a5358cc82a3099526a</span><br><span class="line">├── 20fae55020e28561082510b431ec0f85a8bb3a1cebb34f36916b91acc3833c84</span><br><span class="line">├── 52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d</span><br><span class="line">├── 5ebc10176fffee11727b0baa5f552146a74a4fa53935268e2c10726f08f61aa7</span><br><span class="line">├── 64c2e72761ef2dbf88db1e27bf590f901f5d0e7b3f778635ee976a2f834478ba</span><br><span class="line">├── bd58ec4c3b456591049ce5ad929fac42a96ad23fc28836a29917039d07295ed4</span><br><span class="line">├── f3453bed47cc62a3d58d00327b6a76fbf15612220a7b1b4825936296fd0b845f</span><br><span class="line">└── l</span><br></pre></td></tr></table></figure>

<ul>
<li>l 디렉터리에는 레이어 저장소(cache-id) 심볼릭 링크가 존재</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-08-31T14:00:30.000Z" title="2024. 8. 31. 오후 11:00:30">2024-08-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-21T22:20:08.968Z" title="2024. 9. 22. 오전 7:20:08">2024-09-22</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-overlayFS/">container/overlayFS</a></span><span class="level-item">13 minutes read (About 1996 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/08/31/docs/overlayFS/container-layer/">container layer</a></h1><div class="content"><ul>
<li>컨테이너 레이어구조 (overlayFS)를 알아보고, 장점에 대해 알아보자</li>
</ul>
<h3 id="docker-info-overlay2"><a href="#docker-info-overlay2" class="headerlink" title="docker info (overlay2)"></a>docker info (overlay2)</h3><ul>
<li>Storage Driver: overlay2</li>
<li>Docker Root Dir: &#x2F;var&#x2F;lib&#x2F;docker</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/<span class="comment"># docker info</span></span><br><span class="line">...</span><br><span class="line"> Storage Driver: overlay2</span><br><span class="line">...</span><br><span class="line"> Cgroup Driver: cgroupfs</span><br><span class="line">...</span><br><span class="line"> Docker Root Dir: /var/lib/docker</span><br><span class="line">...</span><br><span class="line">WARNING: No swap <span class="built_in">limit</span> support</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/<span class="comment"># docker info | grep Storage</span></span><br><span class="line">WARNING: No swap <span class="built_in">limit</span> support</span><br><span class="line"> Storage Driver: overlay2</span><br></pre></td></tr></table></figure>





<h2 id="도커-이미지-레이어-구조"><a href="#도커-이미지-레이어-구조" class="headerlink" title="도커 이미지 레이어 구조"></a>도커 이미지 레이어 구조</h2><ul>
<li>오버레이 파일시스템과 같음</li>
</ul>
<p>Image layers &#x3D;&#x3D; Lower Dir R&#x2F;O (Read Only, 읽기 전용)<br>Container layer &#x3D;&#x3D; Upper Dir  R&#x2F;W (Read-Write) - 컨테이너 실행 시 image layer 위에 올라감</p>
<ul>
<li>레이어 구조는 중복도 최소화하고 동일한 레이어를 사용할 경우 공유할 수 있어 저장공간을 절약한다.</li>
<li>대신 컨테이너에서 Image layer의 파일을 변경해야 할 경우에는 CoW (Copy-On-Write)로 동작한다.<ul>
<li>이 때, 변경할 파일을 Container layer(Thin R&#x2F;W layer)로 복사해 와서 처리해야 하므로, 일반적인 write와 비교해서 속도도 느리고 오버헤드가 발생한다. (따라서 Image layer의 파일 변경은 되도록 피해야 한다)</li>
</ul>
</li>
</ul>
<h3 id="도커-이미지삭제"><a href="#도커-이미지삭제" class="headerlink" title="도커 이미지삭제"></a>도커 이미지삭제</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">\# docker rm $(docker ps -a -q)</span><br><span class="line">\# docker rmi -f $(docker images -q)</span><br></pre></td></tr></table></figure>





<h3 id="레이어-구조"><a href="#레이어-구조" class="headerlink" title="레이어 구조"></a>레이어 구조</h3><ul>
<li>도커 이미지의 레이어 구조는 “GraphDriver”에 나타나 있다.</li>
<li>LowerDir 옵션은 콜론(:) 을 기준으로 여러개 레이어를 설정할 수 있다. 맨 뒤가 베이스레이어 이다.</li>
</ul>
<p><img src="/blog/img/layer-03.png"></p>
<p><img src="/blog/img/layer-04.png"></p>
<ul>
<li><p>베이스레이어 cache-id 로 들어가면 이미지 디렉토리가 보임</p>
</li>
<li><p>도커는 내부적으로 Debian 12 slim</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/overlay2/52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d/diff/etc<span class="comment"># cat issue</span></span><br><span class="line">Debian GNU/Linux 12 \n \l</span><br></pre></td></tr></table></figure>

<ul>
<li>debian:12-slim 는 nginx 이미지레이어에 이미 존재하므로 새로 받지 않는다.<ul>
<li>레이어는 받지 않지만, 이미지 정보에는 추가됨 (docker images)</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># docker pull debian:12-slim</span></span><br><span class="line">12-slim: Pulling from library/debian</span><br><span class="line">e886f0f47ef5: Already exists <span class="comment"># 해당 distribution id 는 이미 있다고 받지 않음</span></span><br><span class="line">Digest: sha256:24c92a69df28b21676d721fe18c0bf64138bfc69b486746ad935b49cc31b0b91</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> debian:12-slim</span><br><span class="line">docker.io/library/debian:12-slim</span><br></pre></td></tr></table></figure>

<ul>
<li>두 개 이미지의 레이어를 조회했을 때, 데비안은 nginx 의 레이어 중 하나와 공유한다.</li>
</ul>
<p><img src="/blog/img/layer-05.png"></p>
<p><img src="/blog/img/layer-06.png"></p>
<h3 id="이미지레이어-공유-확인"><a href="#이미지레이어-공유-확인" class="headerlink" title="이미지레이어 공유 확인"></a>이미지레이어 공유 확인</h3><ul>
<li>lowerDir의 실제 저장소에서 파일을 저장해본다<ul>
<li>** lowerDir는 RO인데, 이렇게 host권한을 이용하는건 어쩔수 없다. 컨테이너 실행중에 실제로 이런식으로 사용하면 안됨</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/overlay2/52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d/diff<span class="comment"># echo &quot;hello worled&quot; &gt; world</span></span><br></pre></td></tr></table></figure>

<ul>
<li>debian:12-slim 컨테이너실행 (두개실행한다)<ul>
<li>lowerDir에서 변경한 데이터 확인 가능</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># docker run -it debian:12-slim</span></span><br><span class="line">root@c267289b8c2b:/<span class="comment"># cat world</span></span><br><span class="line">hello worled</span><br></pre></td></tr></table></figure>



<ul>
<li>컨테이너 두개 구조를 살펴보면, LowerDir 은 Debian의 cache-id 에 있던 id와 같음을 알 수 있다.</li>
</ul>
<p><img src="/blog/img/layer-07.png"></p>
<p><img src="/blog/img/layer-02.png"></p>
<ul>
<li>컨테이너의 overlay 구조를 mount에서 파악 가능</li>
</ul>
<p><img src="/blog/img/layer-08.png"></p>
<ul>
<li>위 명령어결과에서 lowerDir 는 심볼릭링크 되어있는데, 따라가보면 실제 이미지저장장소가 나옴</li>
</ul>
<p><img src="/blog/img/layer-09.png"></p>
<h3 id="컨테이너-데이터-변경"><a href="#컨테이너-데이터-변경" class="headerlink" title="컨테이너 데이터 변경"></a>컨테이너 데이터 변경</h3><p>컨테이너의 쓰기는 UpperDir에서 이루어진다.</p>
<ul>
<li>컨테이너1에서 hello파일을 변경하면, 컨테이너1의 UpperDir에서 COW 가 이루어져 쓰기가 발생하고, 변경내용을 읽을 수 있다.</li>
<li>하지만 컨테이너2에서 world 파일을 변경한 내용은 읽을 수 없다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@c267289b8c2b:/<span class="comment"># cat world</span></span><br><span class="line">hello worled</span><br><span class="line">root@c267289b8c2b:/<span class="comment"># echo &quot;container mod&quot; &gt; hello</span></span><br><span class="line">root@c267289b8c2b:/<span class="comment"># cat hello</span></span><br><span class="line">container mod</span><br><span class="line">root@c267289b8c2b:/<span class="comment"># cat world</span></span><br><span class="line">hello worled</span><br></pre></td></tr></table></figure>

<ul>
<li>컨테이너2도 마찬가지.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@d082030bfc8f:/<span class="comment"># cat hello</span></span><br><span class="line">hello</span><br><span class="line">root@d082030bfc8f:/<span class="comment"># echo &quot;container2 mod&quot; &gt; world</span></span><br><span class="line">root@d082030bfc8f:/<span class="comment"># cat hello</span></span><br><span class="line">hello</span><br><span class="line">root@d082030bfc8f:/<span class="comment"># cat world</span></span><br><span class="line">container2 mod</span><br></pre></td></tr></table></figure>

<ul>
<li>lowerDir  에서도 컨테이너가 변경한 내용을 볼 수 없다.<ul>
<li>단지, lowerDir에서 다시 hello 파일 내용을 변경했을때, UpperDir 가존재하는 컨테이너1에서는 변경내용을 못읽지만</li>
<li>UpperDir가 없는 container2는 읽을 수 있다.</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/overlay2/52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d/diff<span class="comment"># cat hello</span></span><br><span class="line">hello</span><br><span class="line">root@seongtki:/var/lib/docker/overlay2/52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d/diff<span class="comment"># cat world</span></span><br><span class="line">hello worled</span><br></pre></td></tr></table></figure>

<ul>
<li>overlayFS 와 같은 개념이라고 보면 된다.</li>
</ul>
<p><img src="/blog/img/overlayfs2-01.png"></p>
<ul>
<li>history 로 이미지 distribution id 확인 가능.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/overlay2<span class="comment"># docker history nginx</span></span><br><span class="line">IMAGE          CREATED       CREATED BY                                      SIZE      COMMENT</span><br><span class="line">2a4fbb36e966   9 days ago    /bin/sh -c <span class="comment">#(nop)  CMD [&quot;nginx&quot; &quot;-g&quot; &quot;daemon…   0B</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop)  STOPSIGNAL SIGQUIT           0B</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop)  EXPOSE 80                    0B</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop)  ENTRYPOINT [&quot;/docker-entr…   0B</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop) COPY file:9e3b2b63db9f8fc7…   4.62kB</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop) COPY file:57846632accc8975…   3.02kB</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop) COPY file:3b1b9915b7dd898a…   298B</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop) COPY file:caec368f5a54f70a…   2.12kB</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop) COPY file:01e75c6dd0ce317d…   1.62kB</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="built_in">set</span> -x     &amp;&amp; groupadd --system -…   94.9MB</span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop)  ENV PKG_RELEASE=1~bookworm   0B</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop)  ENV NJS_VERSION=0.8.0        0B</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop)  ENV NGINX_VERSION=1.25.2     0B</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop)  LABEL maintainer=NGINX Do…   0B</span></span><br><span class="line">&lt;missing&gt;      10 days ago   /bin/sh -c <span class="comment">#(nop)  CMD [&quot;bash&quot;]                 0B</span></span><br><span class="line">&lt;missing&gt;      10 days ago   /bin/sh -c <span class="comment">#(nop) ADD file:ec1a6e0aedd76c8fd…   97.1M</span></span><br></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~# docker run --nginx=nginx --rm -it 2a4fbb36e966</span><br><span class="line">unknown flag: --nginx</span><br><span class="line">See &#x27;docker run --help&#x27;.</span><br><span class="line">root@seongtki:~# docker run --nginx=nginx --rm -it 2a4fbb36e966 /bin/bash</span><br><span class="line">unknown flag: --nginx</span><br><span class="line">See &#x27;docker run --help&#x27;.</span><br><span class="line">root@seongtki:~# docker run --name=nginx --rm -it 2a4fbb36e966 /bin/bash</span><br><span class="line">root@0d2ed11b96f0:/# rm /bin/</span><br><span class="line">Display all 281 possibilities? (y or n)^C</span><br><span class="line">root@0d2ed11b96f0:/# rm /bin/cat</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/overlay2/52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d# docker container diff nginx</span><br><span class="line">C /usr</span><br><span class="line">C /usr/bin</span><br><span class="line">D /usr/bin/cat</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/overlay2/52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d# docker container commit nginx nginx:rm_cat</span><br><span class="line">sha256:6f8e2630eee109051d1878733b1d064b5e5158af1eae73f5a5a44a8b6c032d76</span><br><span class="line">root@seongtki:/var/lib/docker/overlay2/52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d# docker imsages</span><br><span class="line">docker: &#x27;imsages&#x27; is not a docker command.</span><br><span class="line">See &#x27;docker --help&#x27;</span><br><span class="line">root@seongtki:/var/lib/docker/overlay2/52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d# docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">nginx        rm_cat    6f8e2630eee1   9 seconds ago   192MB</span><br><span class="line">nginx        latest    2a4fbb36e966   10 days ago     192MB</span><br><span class="line">debian       12-slim   217435774160   10 days ago     97.1MB</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/overlay2/52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d# docker history nginx:rm_cat</span><br><span class="line">IMAGE          CREATED          CREATED BY                                      SIZE      COMMENT</span><br><span class="line">6f8e2630eee1   29 seconds ago   /bin/bash                                       0B</span><br><span class="line">2a4fbb36e966   10 days ago      /bin/sh -c #(nop)  CMD [&quot;nginx&quot; &quot;-g&quot; &quot;daemon…   0B</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop)  STOPSIGNAL SIGQUIT           0B</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop)  EXPOSE 80                    0B</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop)  ENTRYPOINT [&quot;/docker-entr…   0B</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop) COPY file:9e3b2b63db9f8fc7…   4.62kB</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop) COPY file:57846632accc8975…   3.02kB</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop) COPY file:3b1b9915b7dd898a…   298B</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop) COPY file:caec368f5a54f70a…   2.12kB</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop) COPY file:01e75c6dd0ce317d…   1.62kB</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c set -x     &amp;&amp; groupadd --system -…   94.9MB</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop)  ENV PKG_RELEASE=1~bookworm   0B</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop)  ENV NJS_VERSION=0.8.0        0B</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop)  ENV NGINX_VERSION=1.25.2     0B</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop)  LABEL maintainer=NGINX Do…   0B</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop)  CMD [&quot;bash&quot;]                 0B</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop) ADD file:ec1a6e0aedd76c8fd…   97.1M</span><br></pre></td></tr></table></figure>





<h2 id="기존-이미지에-레이어-추가"><a href="#기존-이미지에-레이어-추가" class="headerlink" title="기존 이미지에 레이어 추가"></a>기존 이미지에 레이어 추가</h2><ul>
<li>컨테이너 실행후, 파일변경</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># docker run --name=nginx --rm -it 2a4fbb36e966 /bin/bash</span></span><br><span class="line">root@db6d1638925b:/<span class="comment"># rm /bin/ta</span></span><br><span class="line">tabs     <span class="built_in">tac</span>      <span class="built_in">tail</span>     tar      taskset</span><br><span class="line">root@db6d1638925b:/<span class="comment"># rm /bin/ta</span></span><br><span class="line">tabs     <span class="built_in">tac</span>      <span class="built_in">tail</span>     tar      taskset</span><br><span class="line">root@db6d1638925b:/<span class="comment"># rm /bin/tar</span></span><br></pre></td></tr></table></figure>

<ul>
<li>호스트에서 파일 변경 확인하고, 새로운 이미지로 커밋한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker container diff nginx</span><br><span class="line">docker container commit nginx nginx:rm_tar</span><br></pre></td></tr></table></figure>

<ul>
<li>새로운 레이어를 확인한다.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image inspect nginx:rm_tar | jq &#x27;.[].RootFS&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/layer-10.png"></p>
<ul>
<li><p>마지막에 layerid 하나가 추가되었다.</p>
</li>
<li><p>layerid 에대한 db-id 확인후, cacheid 를 확인해서 실제 레이어 저장소로 이동한다.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /var/lib/docker/image/overlay2/layerdb -name <span class="string">&quot;diff&quot;</span> -<span class="built_in">exec</span> <span class="built_in">cat</span> &#123;&#125; \; -<span class="built_in">print</span></span><br></pre></td></tr></table></figure>

<ul>
<li>writeout 정보가 있음을 확인.</li>
</ul>
<p><img src="/blog/img/layer-11.png"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-08-31T10:50:35.000Z" title="2024. 8. 31. 오후 7:50:35">2024-08-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-21T22:20:08.967Z" title="2024. 9. 22. 오전 7:20:08">2024-09-22</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-namespace/">container/namespace</a></span><span class="level-item">9 minutes read (About 1362 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/08/31/docs/namespace/mount-namespace/">mount namespace</a></h1><div class="content"><h2 id="네임스페이스-namespace"><a href="#네임스페이스-namespace" class="headerlink" title="네임스페이스(namespace)"></a>네임스페이스(namespace)</h2><ul>
<li>하나의 시스템에서 수행되지만, 각각 별개의 독립된 공간인 것처럼 <strong>격리된 환경을 제공</strong>하는 *<em>경량 프로세스 가상화 기술</em></li>
<li>경량 프로세스는 부모 프로세스와 자원을 공유하는 프로세스를 의미</li>
</ul>
<h3 id="LXC-LinuX-Container-의-네임스페이스는-6-종류와-플래그"><a href="#LXC-LinuX-Container-의-네임스페이스는-6-종류와-플래그" class="headerlink" title="LXC(LinuX Container)의 네임스페이스는 6 종류와 플래그"></a>LXC(LinuX Container)의 네임스페이스는 6 종류와 플래그</h3><ul>
<li><p>마운트 네임스페이스 : CLONE_NEWNS</p>
</li>
<li><p>UTS 네임스페이스 : CLONE_NEWUTS</p>
</li>
<li><p>IPC 네임스페이스 : CLONE_NEWIPC</p>
</li>
<li><p>PID 네임스페이스 : CLONE_NEWPID</p>
</li>
<li><p>사용자 네임스페이스 : CLONE_NEWUSER</p>
</li>
<li><p>네트워크 네임스페이스 : CLONE_NEWNET</p>
</li>
<li><p>상수플래그 정의 (&#x2F;usr&#x2F;include&#x2F;linux&#x2F;sched.h)</p>
</li>
</ul>
<p><img src="/blog/img/layer-12.png"></p>
<h3 id="마운트-mount-네임스페이스란"><a href="#마운트-mount-네임스페이스란" class="headerlink" title="마운트(mount) 네임스페이스란?"></a>마운트(mount) 네임스페이스란?</h3><ul>
<li>프로세스와 그 자식 프로세스가 각기 다른 파일시스템 마운트 지점을 제공</li>
<li>기본적으로 모든 프로세스는 동일한 기본 네임스페이스를 공유하기 때문에, 파일 시스템을 마운트하거나 마운트를 해제하는 등의 변경을 모든 프로세스가 인지할 수 있음</li>
<li>만약 clone() 시스템 콜을 통해 프로세스를 생성할 때 CLONE_NEWNS 플래그가 전달되면, 새로 생성되는 프로세스는 호출한 프로세스가 갖고있는 마운트 트리의 사본을 가져옴</li>
<li>이 사본은 부모 프로세스에 영향을 미치지 않고 새로 생성된 프로세스가 파일시스템을 마운트 or 언마운트 등의 변경을 할 수 있도록 함</li>
<li>이 시점부터 기본 네임스페이스의 모든 파일시스템 마운트 및 언마운트는 새로운 네임스페이스에서 볼 수 있지만, 각각의 프로세스 별 마운트 네임스페이스 내부에서의 변경을 해당 프로세스의 네임스페이스 밖에서는 알 수 없음</li>
</ul>
<p>마운트 네임스페이스는 “mount point”를 격리 한다.<br>여기서 mount란 루트파일시스템에 서브파일시스템을 부착하는 시스템콜이고, mount point는 파일시스템이 부착(mount) 될 위치(디렉터리)다.</p>
<p>mount 하면 원래 디렉터리가 포함하고 있던 파일, 하위 디렉터리 등이 보이지 않고, 새로 부착된 파일시스템의 파일들이 보이게 됩니다. 예를 들어 USB 드라이브를 지정한 mount point로 부착을 시키면, 해당 위치에는 부착된 USB의 파일들이 보이게 됩니다. </p>
<p>마운트 네임스페이스가 mount point를 격리한다는 것은 파일시스템 마운트와 해제 등의 변경사항들이 네임스페이스 밖에서는 보이지 않고, 외부에 전혀 영향을 주지 않음을 의미합니다. 마운트 네임스페이스가 생김으로써 컨테이너를 위해 pivot_root를 안전하게 실행할 수 있게 되었습니다.</p>
<h3 id="unshare-mount-namespace"><a href="#unshare-mount-namespace" class="headerlink" title="unshare mount namespace"></a>unshare mount namespace</h3><h3 id="mount-플래그를-unshared-시스템-콜에-전달"><a href="#mount-플래그를-unshared-시스템-콜에-전달" class="headerlink" title="mount 플래그를 unshared 시스템 콜에 전달"></a>mount 플래그를 unshared 시스템 콜에 전달</h3><ul>
<li>부모 프로세스의 mounts를 복제</li>
<li>현재 bash 프로세스를 자체 마운트 네임스페이스로 이동</li>
<li>“-m”옵션 -&gt; 마운트 네임스페이스</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unshare -m</span><br><span class="line">root@seongtki:/tmp<span class="comment"># mkdir tmp1</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>root filesystem이 같기 때문에 양쪽다 폴더가 보임</p>
</li>
<li><p>mount는 namespace 내부에서만 적용되어 보인다.</p>
</li>
<li><p>tmp1 : mount point</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp<span class="comment"># mount -o size=1m -t tmpfs tmpfs tmp1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp<span class="comment"># mount | grep tmp1</span></span><br><span class="line">tmpfs on /tmp/tmp1 <span class="built_in">type</span> tmpfs (rw,relatime,size=1024k)</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># readlink 심폴릭링크를 통해 namepsace id를 가져올 수 있다.</span></span><br><span class="line"><span class="comment"># /proc/$$ 는 현재 bash 쉘의 프로세스 ID(PID)</span></span><br><span class="line">$ <span class="built_in">readlink</span> /proc/$$/ns/mnt</span><br><span class="line">mnt:[4026532211]</span><br></pre></td></tr></table></figure>





<ul>
<li>host</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp<span class="comment"># mount | grep tmp1</span></span><br><span class="line">root@seongtki:/tmp<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<ul>
<li>mount namespace는 per-process mount isolation을 제공 (프로세스에 격리된 파일시스템 마운트 제공)</li>
</ul>
<h3 id="per-process-mount-isolation"><a href="#per-process-mount-isolation" class="headerlink" title="per-process mount isolation"></a>per-process mount isolation</h3><ul>
<li>new-root 에 nginx를 설치한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">export</span> $(docker create nginx:latest) | tar -C new-root -xvf -</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">1 directory, 0 files</span><br><span class="line">root@seongtki:/tmp/tmp1<span class="comment"># tree -L 1 new-root</span></span><br><span class="line">new-root</span><br><span class="line">├── bin -&gt; usr/bin</span><br><span class="line">├── boot</span><br><span class="line">├── dev</span><br><span class="line">├── docker-entrypoint.d</span><br><span class="line">├── docker-entrypoint.sh</span><br><span class="line">├── etc</span><br><span class="line">├── hello</span><br><span class="line">├── home</span><br><span class="line">├── lib -&gt; usr/lib</span><br><span class="line">├── media</span><br><span class="line">├── mnt</span><br><span class="line">├── opt</span><br><span class="line">├── proc</span><br><span class="line">├── root</span><br><span class="line">├── run</span><br><span class="line">├── sbin -&gt; usr/sbin</span><br><span class="line">├── srv</span><br><span class="line">├── sys</span><br><span class="line">├── tmp</span><br><span class="line">├── usr</span><br><span class="line">├── var</span><br><span class="line">└── world</span><br></pre></td></tr></table></figure>

<ul>
<li>mount</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp/tmp1<span class="comment"># mount -t tmpfs none new-root</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp/tmp1<span class="comment"># df -h | grep new</span></span><br><span class="line">none                               2.0G     0  2.0G   0% /tmp/tmp1/new-root</span><br></pre></td></tr></table></figure>



<h3 id="pivot-root-적용"><a href="#pivot-root-적용" class="headerlink" title="pivot_root 적용"></a>pivot_root 적용</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/<span class="comment"># mkdir old-root</span></span><br><span class="line">/<span class="comment"># pivot_root . old-root # 현재디렉토리를 루트파일시스템으로 하고, old-root 폴더에 기존 루트디렉토리를 마운트시킨다.</span></span><br><span class="line"></span><br><span class="line">/<span class="comment"># nginx -g &quot;daemon off;&quot; # nginx 실행</span></span><br></pre></td></tr></table></figure>



<ul>
<li>host에서 nginx pid를 이용해서 namespace id를 가져와 해당 파일시스템을 조회해본다.</li>
<li>lsns: 현존하는 namespace를 확인하기 위해 사용하는 명령어</li>
</ul>
<p><img src="/blog/img/layer-13.png"></p>
<ul>
<li>자체적인 루트파일시스템이 보장되므로 서버 환경 (시스템 파일, 의존성 라이브러리 충돌, 경로 설정 등) 으로 부터 자유롭다.</li>
<li>서버의 파일시스템으로 부터 완전하게 분리됨으로써 보안상 안전함</li>
<li>컨테이너 내에서 자유롭게 마운트 변경이 가능하고 파일시스템을 확장할 수 있다.</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-08-31T10:46:35.000Z" title="2024. 8. 31. 오후 7:46:35">2024-08-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-21T22:20:08.968Z" title="2024. 9. 22. 오전 7:20:08">2024-09-22</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-namespace/">container/namespace</a></span><span class="level-item">4 minutes read (About 666 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/08/31/docs/namespace/namespace/">network namespace</a></h1><div class="content"><ul>
<li>network namespace 개념에 대해 알아보고</li>
<li>namespace와 veth를 생성해서 1:1 통신 및 가상장치에 대한 테스트를 해보자</li>
</ul>
<h2 id="이더넷"><a href="#이더넷" class="headerlink" title="이더넷"></a>이더넷</h2><ul>
<li><p>컴퓨터 네트워킹의 한 방식이다,.</p>
</li>
<li><p>Layer 1(물리계층) - 신호&#x2F;배선 담당</p>
</li>
<li><p>Layer 2(데이터링크) - MAC 프로토콜 담당</p>
</li>
</ul>
<h2 id="MAC-address"><a href="#MAC-address" class="headerlink" title="MAC address"></a>MAC address</h2><ul>
<li>Media Access Control adress</li>
<li>Physical Address</li>
<li>16진수 옥텟 6개로 구분되어 있음</li>
</ul>
<p><img src="/blog/img/namespace-01.png"></p>
<h2 id="ARP-Address-Resolution-Protocol"><a href="#ARP-Address-Resolution-Protocol" class="headerlink" title="ARP (Address Resolution Protocol)"></a>ARP (Address Resolution Protocol)</h2><ul>
<li>ARP 프로토콜은 같은 같은 네트워크 대역에서 통신을 하기 위해 필요한 MAC주소를 IP주소를 이용해서 알아오는 프로토콜이다.</li>
<li>같은 네트워크 대역에서 통신을 한다고 하더라도 데이터를 보내기 위해서는 7계층부터 캡슐화를 통해 데이터를 보내기 때문에 IP주소와 MAC주소가 모두 필요하다.</li>
<li>이 때 IP주소는 알고 MAC주소는 모르더라도 ARP를 통해 통신이 가능하다.</li>
<li>브로드 캐스트 (FF:FF:FF:FF:FF:FF)</li>
<li>라우터는 자신의 MAC을 알려준다.</li>
</ul>
<p><img src="/blog/img/namespace-02.png"></p>
<h2 id="Network-namespace"><a href="#Network-namespace" class="headerlink" title="Network namespace"></a>Network namespace</h2><ul>
<li><p>호스트  안에 가상 네트워크를 생성할 수 있다.</p>
</li>
<li><p>네트워크를 isolation 하고 네트워크 stack (OSL 7Layer)을 가상화한다.</p>
<ul>
<li>Isolates network and virtualize network stack</li>
</ul>
</li>
<li><p>ip주소, 라우트 테이블, 소켓, 방화벽 등이 별도 가상화 네트워크에 준비된다.</p>
</li>
</ul>
<p><img src="/blog/img/namespace-03.png"></p>
<h3 id="Network-interface-랜카드-라고-생각하면-편하다"><a href="#Network-interface-랜카드-라고-생각하면-편하다" class="headerlink" title="Network interface (랜카드 라고 생각하면 편하다)"></a>Network interface (랜카드 라고 생각하면 편하다)</h3><ul>
<li>가상의 디바이스를 생성하고 마치 랜카드 끼우는 것 처럼 옮겨다니며 장착할 수 있다.<ul>
<li>Network interface is present in exactly 1 namespace</li>
<li>Network interface can ve moved between namespaces</li>
</ul>
</li>
</ul>
<h3 id="Delete-Network-interface"><a href="#Delete-Network-interface" class="headerlink" title="Delete Network interface"></a>Delete Network interface</h3><ul>
<li>네트워크 네임스페이스를 삭제하면 포함된 모든 가상장치가 삭제된다.</li>
</ul>
<h2 id="namespace-1-1-통신"><a href="#namespace-1-1-통신" class="headerlink" title="namespace 1:1 통신"></a>namespace 1:1 통신</h2><h4 id="veth-virtual-etcernet-두-개가-서로-통신을-할-수-있다"><a href="#veth-virtual-etcernet-두-개가-서로-통신을-할-수-있다" class="headerlink" title="veth(virtual etcernet) 두 개가 서로 통신을 할 수 있다."></a>veth(virtual etcernet) 두 개가 서로 통신을 할 수 있다.</h4><ul>
<li>랜카드 두 개를 랜선으로 연결 했다고 생각하면 된다.</li>
</ul>
<h3 id="통신-준비작업"><a href="#통신-준비작업" class="headerlink" title="통신 준비작업"></a>통신 준비작업</h3><ul>
<li>네트워크 네임스페이스 2개 생성 (red, blue)</li>
<li>veth 두개를 pair 로 생성해준다</li>
<li>네임스페이스에 각각의 veth를 링크해준다.</li>
<li>링크 후 veth의 전원을 켜준다.</li>
<li>해당 네임스페이스의 veth에 ip를 할당해준다.<ul>
<li>dev: “name” # 주소를 정할 장치 명</li>
</ul>
</li>
<li><a href="./namespace-test.md">테스트 내용</a></li>
</ul>
<p><img src="/blog/img/namespace-04.png"></p>
<h2 id="리눅스-참고-프로그램"><a href="#리눅스-참고-프로그램" class="headerlink" title="리눅스 참고 프로그램"></a>리눅스 참고 프로그램</h2><h3 id="nsenter"><a href="#nsenter" class="headerlink" title="nsenter"></a>nsenter</h3><ul>
<li><p>네임스페이스에 attach하여 지정한 프로그램을 실행한다.</p>
</li>
<li><p>COMMAND: 지정하지 않으면 $shell 실행</p>
</li>
<li><p>Option: –net: “net namespace”</p>
</li>
<li><p>man nsenter</p>
</li>
<li><pre><code>$ nsenter --net=/var/run/netns/red
</code></pre>
</li>
</ul>
<h3 id="ip-addr-show-ip-addr"><a href="#ip-addr-show-ip-addr" class="headerlink" title="ip addr show (ip addr)"></a>ip addr show (ip addr)</h3><ul>
<li>네트워크 장치를 확인</li>
</ul>
<h3 id="ip-neigh-show-default-show"><a href="#ip-neigh-show-default-show" class="headerlink" title="ip neigh show(default show)"></a>ip neigh show(default show)</h3><ul>
<li>arp tables management</li>
<li>Man ip-neighbour</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-08-31T10:43:35.000Z" title="2024. 8. 31. 오후 7:43:35">2024-08-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-21T22:20:08.968Z" title="2024. 9. 22. 오전 7:20:08">2024-09-22</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-namespace/">container/namespace</a></span><span class="level-item">4 minutes read (About 634 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/08/31/docs/namespace/namespace-test/">network namespace test</a></h1><div class="content"><ul>
<li>namespace, veth 등을 생성해서 1:1 통신을 해보자.</li>
</ul>
<h2 id="테스트"><a href="#테스트" class="headerlink" title="테스트"></a>테스트</h2><h3 id="namespace-virture-ethernet-ip-설정"><a href="#namespace-virture-ethernet-ip-설정" class="headerlink" title="namespace, virture ethernet, ip 설정"></a>namespace, virture ethernet, ip 설정</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ip link</span><br><span class="line">$ ip netns</span><br><span class="line">$ ip netns add red</span><br><span class="line">$ ip netns add blue</span><br><span class="line">$ ip link add veth-red type veth peer name veth-blue</span><br><span class="line">$ ip link set veth-red netns red</span><br><span class="line">$ ip link set veth-blue netns blue</span><br><span class="line">$ ip netns exec red ip link set veth-red up</span><br><span class="line">$ ip netns exec blue ip link set veth-blue up</span><br><span class="line">$ ip netns exec red ip addr add 1.1.1.1/24 dev veth-red</span><br><span class="line">$ ip netns exec blue ip addr add 1.1.1.2/24 dev veth-blue</span><br></pre></td></tr></table></figure>



<h3 id="Blue-namesace"><a href="#Blue-namesace" class="headerlink" title="Blue namesace"></a>Blue namesace</h3><ul>
<li>tcpdump 실행</li>
<li>red ns 에서 ping 요청을 하면, arp table에 등록 후, 해당 mac 으로 응답을 보내고</li>
<li>이 후 icmp 요청에 대한 응답을 처리한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ nsenter --net=/var/run/netns/blue</span><br><span class="line">$ tcpdump -li veth-blue</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on veth-blue, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">07:12:35.267019 ARP, Request who-has 1.1.1.2 tell 1.1.1.1, length 28</span><br><span class="line">07:12:35.267034 ARP, Reply 1.1.1.2 is-at 4e:87:56:0c:9e:d0 (oui Unknown), length 28</span><br><span class="line">07:12:35.267037 IP 1.1.1.1 &gt; 1.1.1.2: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 1758, <span class="built_in">seq</span> 1, length 64</span><br><span class="line">07:12:35.267045 IP 1.1.1.2 &gt; 1.1.1.1: ICMP <span class="built_in">echo</span> reply, <span class="built_in">id</span> 1758, <span class="built_in">seq</span> 1, length 64</span><br><span class="line">07:12:36.268644 IP 1.1.1.1 &gt; 1.1.1.2: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 1758, <span class="built_in">seq</span> 2, length 64</span><br></pre></td></tr></table></figure>

<ul>
<li>arp 정보 조회</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ip neigh show</span><br><span class="line">1.1.1.1 dev veth-blue lladdr f6:e9:d4:cf:26:3a STALE</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~# arp</span><br><span class="line">Address                  HWtype  HWaddress           Flags Mask            Iface</span><br><span class="line">1.1.1.1                  ether   f6:e9:d4:cf:26:3a   C                     veth-blue</span><br></pre></td></tr></table></figure>

<ul>
<li>각종 정보 조회</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ ip address show</span><br><span class="line">1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">5: veth-blue@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether 4e:87:56:0c:9e:d0 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 1.1.1.2/24 scope global veth-blue</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::4c87:56ff:fe0c:9ed0/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line">$ bridge fdb show</span><br><span class="line">33:33:00:00:00:01 dev veth-blue self permanent</span><br><span class="line">01:00:5e:00:00:01 dev veth-blue self permanent</span><br><span class="line">33:33:ff:0c:9e:d0 dev veth-blue self permanent</span><br><span class="line"></span><br><span class="line">$ ip route show</span><br><span class="line">1.1.1.0/24 dev veth-blue proto kernel scope link src 1.1.1.2</span><br><span class="line"></span><br><span class="line">$ iptables -S</span><br><span class="line">-P INPUT ACCEPT</span><br><span class="line">-P FORWARD ACCEPT</span><br><span class="line">-P OUTPUT ACCEPT</span><br></pre></td></tr></table></figure>





<h3 id="red-namesace"><a href="#red-namesace" class="headerlink" title="red namesace"></a>red namesace</h3><ul>
<li>blue ns로 ping을 보낸다. </li>
<li>처음엔 arp 정보가 없는데, arp 응답이 오게 되면 arp table 등록 후 icmp 통시을 하게 된다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ nsenter --net=/var/run/netns/red</span><br><span class="line"></span><br><span class="line">PING 1.1.1.2 (1.1.1.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 1.1.1.2: icmp_seq=1 ttl=64 time=0.041 ms</span><br><span class="line">64 bytes from 1.1.1.2: icmp_seq=2 ttl=64 time=0.045 ms</span><br><span class="line">64 bytes from 1.1.1.2: icmp_seq=3 ttl=64 time=0.061 ms</span><br></pre></td></tr></table></figure>

<ul>
<li>arp 정보 조회</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ip neigh show</span><br><span class="line">1.1.1.2 dev veth-red lladdr 4e:87:56:0c:9e:d0 STAL</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ arp</span><br><span class="line">Address                  HWtype  HWaddress           Flags Mask            Iface</span><br><span class="line">1.1.1.2                  ether   4e:87:56:0c:9e:d0   C                     veth-red</span><br></pre></td></tr></table></figure>

<ul>
<li>각종 정보 조회</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ ip address show</span><br><span class="line">1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">6: veth-red@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether f6:e9:d4:cf:26:3a brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class="line">    inet 1.1.1.1/24 scope global veth-red</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::f4e9:d4ff:fecf:263a/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line">$ bridge fdb show</span><br><span class="line">33:33:00:00:00:01 dev veth-red self permanent</span><br><span class="line">01:00:5e:00:00:01 dev veth-red self permanent</span><br><span class="line">33:33:ff:cf:26:3a dev veth-red self permanent</span><br><span class="line"></span><br><span class="line">$ ip route show</span><br><span class="line">1.1.1.0/24 dev veth-red proto kernel scope <span class="built_in">link</span> src 1.1.1.1</span><br><span class="line"></span><br><span class="line">$ iptables -S</span><br><span class="line">-P INPUT ACCEPT</span><br><span class="line">-P FORWARD ACCEPT</span><br><span class="line">-P OUTPUT ACCEPT</span><br></pre></td></tr></table></figure>





<h3 id="삭제"><a href="#삭제" class="headerlink" title="삭제"></a>삭제</h3><ul>
<li>테스트를 후 생성한 리소들을 삭제해준다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ip -n <span class="string">&quot;netns name&quot;</span> <span class="built_in">link</span> del <span class="string">&quot;veth-red&quot;</span></span><br><span class="line">$ ip netns del <span class="string">&quot;name&quot;</span></span><br></pre></td></tr></table></figure>















</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-08-31T10:40:35.000Z" title="2024. 8. 31. 오후 7:40:35">2024-08-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-21T22:20:08.967Z" title="2024. 9. 22. 오전 7:20:08">2024-09-22</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-namespace/">container/namespace</a></span><span class="level-item">7 minutes read (About 1072 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/08/31/docs/namespace/bridge/">bridge</a></h1><div class="content"><h3 id="bridge"><a href="#bridge" class="headerlink" title="bridge?"></a>bridge?</h3><ul>
<li>하나의 LAN 내부에서 단말이 많아질 경우 bridge를 사용하여 개선할 수 있다.</li>
<li>단말기가 많아졌을 경우 발생하는 Collision Domain을 분리해 주는 역할을 한다.</li>
<li>2계층 송수신을 처리한다.</li>
</ul>
<h3 id="Ethenet-Frame"><a href="#Ethenet-Frame" class="headerlink" title="Ethenet Frame"></a>Ethenet Frame</h3><ul>
<li>OSI L2계층 (data link) 을 처리 한다.</li>
<li>패킷 유입 &gt; 목적지 MAC 주소확인 &gt; 주소 테이블과 비교 &gt; 해당 디바이스가 연결된 포트로 패킷 전달.</li>
</ul>
<p><img src="/blog/img/bridge-01.png"></p>
<h3 id="bridge-기능"><a href="#bridge-기능" class="headerlink" title="bridge 기능"></a>bridge 기능</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Learning.</span><br><span class="line">출발지의 맥 어드레스를 배운다.</span><br><span class="line">브리지/스위치는 포트에 연결된 PC &quot;A&quot;가 통신을 위해 프레임을 내보내면</span><br><span class="line">그때 이 PC의 MAC 주소를 읽어서 자신의 bridge table에 저장한다.</span><br><span class="line">** bridge-table: 스위치나 브리지에 연결된 사용자들의 맥 주소를 저장하는 데이터베이스</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Flooding.</span><br><span class="line">들어온 포트를 제외한 나머지를 모든 포트로 데이터를 뿌린다.</span><br><span class="line">PC &quot;A&quot;가 통신하고자 하는 목적지 PC의 맥 주소가 브리지 테이블에 없으면</span><br><span class="line">모든 포트에 데이터를 전송한다. (브로드캐스트 라고 생각해도 됨. 브로드캐스트도 Flooding이 발생함)</span><br><span class="line"></span><br><span class="line">Forwarding</span><br><span class="line">Flooding과 반대로 목적지 PC의 맥 주소를 알고 그 목적지가 브릿지를 건너야 할때</span><br><span class="line">오직 그 해당 포트쪽으로만 데이터를 전송한다.</span><br><span class="line"> </span><br><span class="line">Filtering</span><br><span class="line">브릿지를 넘어가지 못하게 막는것.</span><br><span class="line">출발지와 목적지가 같은 세그먼트에 있을때 일어남.</span><br><span class="line">[세그먼트: 브릿지, 라우터, 허브 또는 스위치에 의해 묶어있는 네트워크의 한 부분]</span><br><span class="line">이 Filtering 기능 때문에 허브와 다르게 콜리젼 도메인을 나눌 수 있다.</span><br><span class="line"></span><br><span class="line">Aging</span><br><span class="line">브리지 테이블에 출발지의 MAC 주소가 들어오면 300초 동안 타이머를 설정한다.</span><br><span class="line">300초가 지나도록 다시 그 출발지 주소의 프레임이 들어오지 않으면 브리지 테이블에서 삭제한다.</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/bridge-02.png"></p>
<h2 id="Netfilter"><a href="#Netfilter" class="headerlink" title="Netfilter"></a>Netfilter</h2><p>커널 모듈로 <strong>네트워크 패킷을 처리</strong>하는 프레임워크이다.<br>네트워크 연산을 핸들러 형태로 처리할 수 있도록 hook 지점을 제공<br>패킷이 어떻게 <strong>전송될 지</strong>에 대한 결정 방법을 제공한다.</p>
<p><img src="/blog/img/bridge-03.png"></p>
<h3 id="Netfilter-항목"><a href="#Netfilter-항목" class="headerlink" title="Netfilter 항목"></a>Netfilter 항목</h3><table>
<thead>
<tr>
<th>항목</th>
<th>내용</th>
<th>키워드</th>
</tr>
</thead>
<tbody><tr>
<td>table</td>
<td>용도별 rule 모음</td>
<td>filter, nat, mangle</td>
</tr>
<tr>
<td>chain</td>
<td>패팃이 지나가는 hook 별로 존재</td>
<td>PREROUTING, FORWARD, INPUT (netfilter의 hook에 매핑)</td>
</tr>
<tr>
<td>rule</td>
<td>table과 chain matrix에 대해서 정의함</td>
<td>protocol type, dest&#x2F;src address ..</td>
</tr>
<tr>
<td>action(target)</td>
<td>패킷이 룰에 매칭되면 트리거 됨</td>
<td>ACCEPT, DROP, REJECT</td>
</tr>
</tbody></table>
<h3 id="red-gt-bridge-gt-blue-통신"><a href="#red-gt-bridge-gt-blue-통신" class="headerlink" title="red -&gt; bridge -&gt; blue 통신"></a>red -&gt; bridge -&gt; blue 통신</h3><ul>
<li><p>bridge 관점에서 보자.</p>
</li>
<li><p>패킷은 netfilter에서 파놓은 여러 hook을 통과하는데 hook별로 iptables에 정의한 각 체인룰을 점검한다.</p>
</li>
<li><p>hook에 정의된 체인은 테이블 순서대로 등록된 룰을 체크하고 조건을 만족하면 action(target)을 트리거한다.</p>
</li>
<li><p>외부(src) -&gt; 외부(dst) 패킷이므로 FORWARD 체인의 filter 테이블 룰을 봐야 한다.</p>
<ul>
<li>FORWARD: NF_IP_FORWARD (hook) 에 등록된 체인</li>
<li>NF_IP_FORWARD: incoming 패킷이 다른 호스트로 포워딩 되는 경우 트리거되는 netfilter hook</li>
<li>filter(table): 패킷을 목적지로 전송여부를 결정</li>
</ul>
</li>
<li><p><strong>rule 설정</strong></p>
<ul>
<li><p><strong>테이블 filter 에서 FORWARD 체인을 추가한다. 출발지가 1.1.1.0&#x2F;24 이면, ACCEPT 로 설정한다.</strong></p>
</li>
<li><pre><code class="sh">iptables -t filter -A FORWARD -s 1.1.1.0/24 -j ACCEPT
</code></pre>
</li>
</ul>
</li>
</ul>
<h3 id="iptalbes"><a href="#iptalbes" class="headerlink" title="iptalbes"></a>iptalbes</h3><ul>
<li>netfilter가 파놓은 hook에 룰을 등록하고 관리하는 방법을 제공하는 툴</li>
<li>netfilter에 내가 원하는 정책을 넣어야 하는데 그럴 때 사용하는 프로그램. 룰을 넣고 조회하는 역할을 한다.</li>
</ul>
<h3 id="정리"><a href="#정리" class="headerlink" title="정리"></a>정리</h3><p>A ns 에서 B ns 로 통신하기 위해 중간에 bridge 를 통과한다.<br>bridge 는 2계층 데이터 를 처리하는데, A, B 사이의 ARP 테이블을 채워주게 한다.<br>ping의 경우, ICMP를 이용해 송수신하는데 이 때 Netfilter 의 hook이 트리거 되어 ACCEPT 인 경우에만<br>송수신이 가능하다.<br>결국은 arp, bridge fdb 정보를 이용해서 통신하고 iptables rule에 따라 전송여부가 결정된다.</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/blog/page/3/">Previous</a></div><div class="pagination-next"><a href="/blog/page/5/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/blog/">1</a></li><li><a class="pagination-link" href="/blog/page/2/">2</a></li><li><a class="pagination-link" href="/blog/page/3/">3</a></li><li><a class="pagination-link is-current" href="/blog/page/4/">4</a></li><li><a class="pagination-link" href="/blog/page/5/">5</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/blog/img/avatar.png" alt="Seongtaek Kim"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Seongtaek Kim</p><p class="is-size-6 is-block">Blog</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/blog/archives"><p class="title">45</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/blog/categories"><p class="title">34</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/blog/tags"><p class="title">0</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/seongtaekkim"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Linkedin" href="https://linkedin.com/in/staek"><i class="fab fa-linkedin"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/blog/categories/calico-communication/"><span class="level-start"><span class="level-item">calico/communication</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/calico-concept/"><span class="level-start"><span class="level-item">calico/concept</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/calico-networkmode/"><span class="level-start"><span class="level-item">calico/networkmode</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/cilium-cilium/"><span class="level-start"><span class="level-item">cilium/cilium</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/cilium-communication/"><span class="level-start"><span class="level-item">cilium/communication</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/cilium-install/"><span class="level-start"><span class="level-item">cilium/install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-cgroup/"><span class="level-start"><span class="level-item">container/cgroup</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-namespace/"><span class="level-start"><span class="level-item">container/namespace</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-overlayFS/"><span class="level-start"><span class="level-item">container/overlayFS</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-overlaynetwork/"><span class="level-start"><span class="level-item">container/overlaynetwork</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/gateway-gatewayapi/"><span class="level-start"><span class="level-item">gateway/gatewayapi</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/gateway-gloo/"><span class="level-start"><span class="level-item">gateway/gloo</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/ingress-ingress/"><span class="level-start"><span class="level-item">ingress/ingress</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-bookinfo/"><span class="level-start"><span class="level-item">istio/bookinfo</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-envoy/"><span class="level-start"><span class="level-item">istio/envoy</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-istio-outline/"><span class="level-start"><span class="level-item">istio/istio-outline</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-istio-test/"><span class="level-start"><span class="level-item">istio/istio-test</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-istio-traffic/"><span class="level-start"><span class="level-item">istio/istio-traffic</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/java-Enumeration/"><span class="level-start"><span class="level-item">java/Enumeration</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/java-flyweight/"><span class="level-start"><span class="level-item">java/flyweight</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/java-interface/"><span class="level-start"><span class="level-item">java/interface</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/k8s-PAUSE-Container/"><span class="level-start"><span class="level-item">k8s/PAUSE-Container</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/k8s-flannel/"><span class="level-start"><span class="level-item">k8s/flannel</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/k8s-kind/"><span class="level-start"><span class="level-item">k8s/kind</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-ipvs/"><span class="level-start"><span class="level-item">loadbaleancer/ipvs</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-ipvs-install/"><span class="level-start"><span class="level-item">loadbaleancer/ipvs-install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-metalLB/"><span class="level-start"><span class="level-item">loadbaleancer/metalLB</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-metalLB-install/"><span class="level-start"><span class="level-item">loadbaleancer/metalLB-install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/serivce-clusterip/"><span class="level-start"><span class="level-item">serivce/clusterip</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/serivce-install/"><span class="level-start"><span class="level-item">serivce/install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/serivce-nodeport/"><span class="level-start"><span class="level-item">serivce/nodeport</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/vpccni-vpccni/"><span class="level-start"><span class="level-item">vpccni/vpccni</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/vpccni-vpccni-install/"><span class="level-start"><span class="level-item">vpccni/vpccni-install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/vpccni-vpccni2/"><span class="level-start"><span class="level-item">vpccni/vpccni2</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-11-24T13:07:30.000Z">2024-11-24</time></p><p class="title"><a href="/blog/2024/11/24/docs/flannel/">Flannel CNI Concept</a></p><p class="categories"><a href="/blog/categories/k8s-flannel/">k8s/flannel</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-11-24T09:01:30.000Z">2024-11-24</time></p><p class="title"><a href="/blog/2024/11/24/docs/overlaynetwork/overlay-network/">overlay network concept</a></p><p class="categories"><a href="/blog/categories/container-overlaynetwork/">container/overlaynetwork</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-11-24T05:02:30.000Z">2024-11-24</time></p><p class="title"><a href="/blog/2024/11/24/docs/overlaynetwork/vxlan/">vxlan concept</a></p><p class="categories"><a href="/blog/categories/container-overlaynetwork/">container/overlaynetwork</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-11-10T11:40:35.000Z">2024-11-10</time></p><p class="title"><a href="/blog/2024/11/10/docs/java/interface/">interface</a></p><p class="categories"><a href="/blog/categories/java-interface/">java/interface</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-11-10T11:30:35.000Z">2024-11-10</time></p><p class="title"><a href="/blog/2024/11/10/docs/java/flyweight/">flyweight</a></p><p class="categories"><a href="/blog/categories/java-flyweight/">java/flyweight</a></p></div></article></div></div><!--!--></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/blog/">Blog</a><p class="is-size-7"><span>&copy; 2024 Seongtaek Kim</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/blog/js/column.js"></script><script src="/blog/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/blog/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/blog/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/blog/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/blog/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>