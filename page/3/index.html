<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Blog</title><link rel="manifest" href="/blog/manifest.json"><meta name="application-name" content="Blog"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Blog"><meta property="og:url" content="https://seongtaekkim.github.io/blog"><meta property="og:site_name" content="Blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://seongtaekkim.github.io/blog/img/og_image.png"><meta property="article:author" content="Seongtaek Kim"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://seongtaekkim.github.io/blog/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://seongtaekkim.github.io/blog"},"headline":"Blog","image":["https://seongtaekkim.github.io/blog/img/og_image.png"],"author":{"@type":"Person","name":"Seongtaek Kim"},"publisher":{"@type":"Organization","name":"Blog","logo":{"@type":"ImageObject"}},"description":""}</script><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/blog/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/blog/">Blog</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/blog/">Home</a><a class="navbar-item" href="/blog/archives">Archives</a><a class="navbar-item" href="/blog/categories">Categories</a><a class="navbar-item" href="/blog/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-09-07T15:07:30.000Z" title="2024. 9. 8. 오전 12:07:30">2024-09-08</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-21T22:20:08.967Z" title="2024. 9. 22. 오전 7:20:08">2024-09-22</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/k8s-flannel/">k8s/flannel</a></span><span class="level-item">11 minutes read (About 1639 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/09/08/docs/flannel/">Flannel CNI</a></h1><div class="content"><p>Flannel은 단일 바이너리 에이전트인 flanneld 가 각 노드에서 동작하여 작은 규모의 클러스터 환경에서</p>
<p>파드들 간 통신 환경을 구성하는 CNI이다.</p>
<p>Flannel은 노드간 통신에 VXLAN을 사용하며, UDP 8472 port를 사용한다.</p>
<h3 id="kind-amp-Flannel-배포"><a href="#kind-amp-Flannel-배포" class="headerlink" title="kind &amp; Flannel 배포"></a>kind &amp; Flannel 배포</h3><ul>
<li><code>disableDefaultCNI : true</code> 기본 CNI를 사용하지 않는다.</li>
<li>control-plane, worker node 2ea</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF&gt; kind-cni.yaml</span></span><br><span class="line"><span class="string">kind: Cluster</span></span><br><span class="line"><span class="string">apiVersion: kind.x-k8s.io/v1alpha4</span></span><br><span class="line"><span class="string">nodes:</span></span><br><span class="line"><span class="string">- role: control-plane</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    mynode: control-plane</span></span><br><span class="line"><span class="string">  extraPortMappings:</span></span><br><span class="line"><span class="string">  - containerPort: 30000</span></span><br><span class="line"><span class="string">    hostPort: 30000</span></span><br><span class="line"><span class="string">  - containerPort: 30001</span></span><br><span class="line"><span class="string">    hostPort: 30001</span></span><br><span class="line"><span class="string">  - containerPort: 30002</span></span><br><span class="line"><span class="string">    hostPort: 30002</span></span><br><span class="line"><span class="string">  kubeadmConfigPatches:</span></span><br><span class="line"><span class="string">  - |</span></span><br><span class="line"><span class="string">    kind: ClusterConfiguration</span></span><br><span class="line"><span class="string">    controllerManager:</span></span><br><span class="line"><span class="string">      extraArgs:</span></span><br><span class="line"><span class="string">        bind-address: 0.0.0.0</span></span><br><span class="line"><span class="string">    etcd:</span></span><br><span class="line"><span class="string">      local:</span></span><br><span class="line"><span class="string">        extraArgs:</span></span><br><span class="line"><span class="string">          listen-metrics-urls: http://0.0.0.0:2381</span></span><br><span class="line"><span class="string">    scheduler:</span></span><br><span class="line"><span class="string">      extraArgs:</span></span><br><span class="line"><span class="string">        bind-address: 0.0.0.0</span></span><br><span class="line"><span class="string">  - |</span></span><br><span class="line"><span class="string">    kind: KubeProxyConfiguration</span></span><br><span class="line"><span class="string">    metricsBindAddress: 0.0.0.0</span></span><br><span class="line"><span class="string">- role: worker</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    mynode: worker</span></span><br><span class="line"><span class="string">- role: worker</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    mynode: worker2</span></span><br><span class="line"><span class="string">networking:</span></span><br><span class="line"><span class="string">  disableDefaultCNI: true</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">kind create cluster --config kind-cni.yaml --name myk8s --image kindest/node:v1.30.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 배포 확인</span></span><br><span class="line">kind get clusters</span><br><span class="line">kind get nodes --name myk8s</span><br><span class="line">kubectl cluster-info</span><br><span class="line"></span><br><span class="line"><span class="comment"># 네트워크 확인</span></span><br><span class="line">kubectl cluster-info dump | grep -m 2 -E <span class="string">&quot;cluster-cidr|service-cluster-ip-range&quot;</span></span><br><span class="line">-----------------------</span><br><span class="line"><span class="string">&quot;--service-cluster-ip-range=10.96.0.0/16&quot;</span>, <span class="comment"># service ip 대역</span></span><br><span class="line"><span class="string">&quot;--cluster-cidr=10.244.0.0/16&quot;</span>, <span class="comment"># </span></span><br><span class="line">                            </span><br><span class="line">                            </span><br><span class="line"><span class="comment"># 노드 확인 : CRI</span></span><br><span class="line">kubectl get nodes -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 노드 라벨 확인</span></span><br><span class="line">kubectl get nodes myk8s-control-plane -o jsonpath=&#123;.metadata.labels&#125; | jq</span><br><span class="line">...</span><br><span class="line"><span class="string">&quot;mynode&quot;</span>: <span class="string">&quot;control-plane&quot;</span>,</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">kubectl get nodes myk8s-worker -o jsonpath=&#123;.metadata.labels&#125; | jq</span><br><span class="line">kubectl get nodes myk8s-worker2 -o jsonpath=&#123;.metadata.labels&#125; | jq</span><br><span class="line"></span><br><span class="line"><span class="comment"># 컨테이너 확인 : 컨테이너 갯수, 컨테이너 이름 확인</span></span><br><span class="line">docker ps</span><br><span class="line">docker port myk8s-control-plane</span><br><span class="line">docker port myk8s-worker</span><br><span class="line">docker port myk8s-worker2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 컨테이너 내부 정보 확인</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane ip -br -c -4 addr</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker  ip -br -c -4 addr</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2  ip -br -c -4 addr</span><br><span class="line"></span><br><span class="line"><span class="comment"># tool install</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane sh -c <span class="string">&#x27;apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump iputils-ping htop git nano -y&#x27;</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker  sh -c <span class="string">&#x27;apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump iputils-ping -y&#x27;</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2 sh -c <span class="string">&#x27;apt update &amp;&amp; apt install tree jq psmisc lsof wget bridge-utils tcpdump iputils-ping -y&#x27;</span></span><br></pre></td></tr></table></figure>





<ul>
<li>CNI 를 disable 했기 때문에 kindnet 이 없고, coredns, sc가 실행되지 못한다.</li>
</ul>
<p><img src="/blog/img/flannel-01.png"></p>
<p><code>kubectl describe pod -n kube-system -l k8s-app=kube-dns</code></p>
<p><img src="/blog/img/flannel-02.png"></p>
<ul>
<li>flannel net-config</li>
</ul>
<p><img src="/blog/img/flannel-03.png"></p>
<ul>
<li>flannel 을 설치했으나 bridge 플러그인이 &#x2F;opt&#x2F;cni&#x2F;bin 에 없어서 추가해 주어야 한다.</li>
</ul>
<p><img src="/blog/img/flannel-04.png"></p>
<p><img src="/blog/img/flannel-05.png"></p>
<ul>
<li>권한에 유의하여 복사한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> bridge myk8s-control-plane:/opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">cp</span> bridge myk8s-worker:/opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">cp</span> bridge myk8s-worker2:/opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane  <span class="built_in">chmod</span> 755 /opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker         <span class="built_in">chmod</span> 755 /opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2        <span class="built_in">chmod</span> 755 /opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane  <span class="built_in">chown</span> root root /opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker         <span class="built_in">chown</span> root root /opt/cni/bin/bridge</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2        <span class="built_in">chown</span> root root /opt/cni/bin/bridge</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane  <span class="built_in">ls</span> -l /opt/cni/bin/</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker  <span class="built_in">ls</span> -l /opt/cni/bin/</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2 <span class="built_in">ls</span> -l /opt/cni/bin/</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> myk8s-control-plane myk8s-worker myk8s-worker2; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it <span class="variable">$i</span> <span class="built_in">ls</span> /opt/cni/bin/; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line">bridge	flannel  host-local  loopback  portmap	ptp</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl get pod -A -owide</span><br></pre></td></tr></table></figure>



<p>kubelet, pstree 확인</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubelet config 정보</span></span><br><span class="line">kubectl describe cm -n kube-system kubelet-config</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane <span class="built_in">cat</span> /var/lib/kubelet/config.yaml</span><br><span class="line">...</span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.96.0.10</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-control-plane <span class="built_in">cat</span> /var/lib/kubelet/kubeadm-flags.env</span><br><span class="line">KUBELET_KUBEADM_ARGS=<span class="string">&quot;--container-runtime-endpoint=unix:///run/containerd/containerd.sock --node-ip=172.18.0.2 --node-labels= --pod-infra-container-image=registry.k8s.io/pause:3.9 --provider-id=kind://docker/myk8s/myk8s-control-plane&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> myk8s-control-plane myk8s-worker myk8s-worker2; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it <span class="variable">$i</span> <span class="built_in">cat</span> /var/lib/kubelet/kubeadm-flags.env; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> myk8s-control-plane myk8s-worker myk8s-worker2; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it <span class="variable">$i</span> <span class="built_in">ls</span> /etc/kubernetes/manifests; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line">&gt;&gt; node myk8s-control-plane &lt;&lt;</span><br><span class="line"><span class="string">etcd.yaml  kube-apiserver.yaml	kube-controller-manager.yaml  kube-scheduler.yaml</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt;&gt; node myk8s-worker &lt;&lt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt;&gt; node myk8s-worker2 &lt;&lt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">kubectl describe pod -n kube-system kube-apiserver-myk8s-control-plane</span></span><br><span class="line"><span class="string">kubectl describe pod -n kube-system kube-controller-manager-myk8s-control-plane</span></span><br><span class="line"><span class="string">kubectl describe pod -n kube-system kube-scheduler-myk8s-control-plane</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">for i in myk8s-control-plane myk8s-worker myk8s-worker2; do echo &quot;&gt;&gt; node $i &lt;&lt;&quot;; docker exec -it $i pstree -aT; echo; done</span></span><br><span class="line"><span class="string">for i in myk8s-control-plane myk8s-worker myk8s-worker2; do echo &quot;&gt;&gt; node $i &lt;&lt;&quot;; docker exec -it $i pstree -atl; echo; done</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">docker exec -it myk8s-control-plane  systemctl status kubelet -l --no-pager</span></span><br><span class="line"><span class="string">docker exec -it myk8s-worker  systemctl status kubelet -l --no-pager</span></span><br><span class="line"><span class="string">docker exec -it myk8s-worker2 systemctl status kubelet -l --no-pager</span></span><br></pre></td></tr></table></figure>





<h3 id="flannel-정보-확인"><a href="#flannel-정보-확인" class="headerlink" title="flannel 정보 확인"></a>flannel 정보 확인</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl get ds,pod,cm -n kube-flannel -owide</span><br><span class="line">kubectl describe cm -n kube-flannel kube-flannel-cfg</span><br><span class="line"></span><br><span class="line"><span class="comment"># iptables 정보 확인</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> filter nat mangle raw ; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; IPTables Type : <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it myk8s-control-plane  iptables -t <span class="variable">$i</span> -S ; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> filter nat mangle raw ; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; IPTables Type : <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it myk8s-worker  iptables -t <span class="variable">$i</span> -S ; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> filter nat mangle raw ; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; IPTables Type : <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it myk8s-worker2 iptables -t <span class="variable">$i</span> -S ; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>FLANNEL_MTU 1450</code> 1500byte 에서 vxlan header 50byte 제외</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> myk8s-control-plane myk8s-worker myk8s-worker2; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;&gt;&gt; node <span class="variable">$i</span> &lt;&lt;&quot;</span>; docker <span class="built_in">exec</span> -it <span class="variable">$i</span> <span class="built_in">cat</span> /run/flannel/subnet.env ; <span class="built_in">echo</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">&gt;&gt; node myk8s-control-plane &lt;&lt;</span><br><span class="line"><span class="string">FLANNEL_NETWORK=10.244.0.0/16</span></span><br><span class="line"><span class="string">FLANNEL_SUBNET=10.244.0.1/24 # 파드 네트워크 대역 정의, CNI inet</span></span><br><span class="line"><span class="string">FLANNEL_MTU=1450</span></span><br><span class="line"><span class="string">FLANNEL_IPMASQ=true # 파드가 외부(인터넷) 통신 시 해당 노드의 마스커레이딩을 사용</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt;&gt; node myk8s-worker &lt;&lt;</span></span><br><span class="line"><span class="string">FLANNEL_NETWORK</span>=10.244.0.0/16</span><br><span class="line">FLANNEL_SUBNET=10.244.2.1/24</span><br><span class="line">FLANNEL_MTU=1450</span><br><span class="line">FLANNEL_IPMASQ=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">&gt;&gt; node myk8s-worker2 &lt;&lt;</span><br><span class="line"><span class="string">FLANNEL_NETWORK=10.244.0.0/16</span></span><br><span class="line"><span class="string">FLANNEL_SUBNET=10.244.1.1/24</span></span><br><span class="line"><span class="string">FLANNEL_MTU=1450</span></span><br><span class="line"><span class="string">FLANNEL_IPMASQ=true</span></span><br></pre></td></tr></table></figure>



<h3 id="테스트-pod-생성"><a href="#테스트-pod-생성" class="headerlink" title="테스트 pod 생성"></a>테스트 pod 생성</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl create -f -</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: pod-1</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  nodeSelector:</span></span><br><span class="line"><span class="string">    kubernetes.io/hostname: myk8s-worker</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: netshoot-pod</span></span><br><span class="line"><span class="string">    image: nicolaka/netshoot</span></span><br><span class="line"><span class="string">    command: [&quot;tail&quot;]</span></span><br><span class="line"><span class="string">    args: [&quot;-f&quot;, &quot;/dev/null&quot;]</span></span><br><span class="line"><span class="string">  terminationGracePeriodSeconds: 0</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: pod-2</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  nodeSelector:</span></span><br><span class="line"><span class="string">    kubernetes.io/hostname: myk8s-worker2</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: netshoot-pod</span></span><br><span class="line"><span class="string">    image: nicolaka/netshoot</span></span><br><span class="line"><span class="string">    command: [&quot;tail&quot;]</span></span><br><span class="line"><span class="string">    args: [&quot;-f&quot;, &quot;/dev/null&quot;]</span></span><br><span class="line"><span class="string">  terminationGracePeriodSeconds: 0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 확인 : IP 확인</span></span><br><span class="line">kubectl get pod -o wide</span><br></pre></td></tr></table></figure>



<ul>
<li><p>worker node 의 여러 네트워크 정보를 파악할 수 있다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ip -c -br addr</span><br><span class="line">ip -c route <span class="comment"># 다른 노드의 파드 대역(podCIDR)의 라우팅 정보</span></span><br><span class="line">ip -c neigh show dev flannel.1 <span class="comment"># flannel.1 인터페이스를 통한 ARP 테이블 정보 확인</span></span><br><span class="line">bridge fdb show dev flannel.1 <span class="comment"># 브리지 fdb 정보에서 해당 MAC 주소와 통신 시 각 노드의 en0 dst</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="/blog/img/flannel-06.png"></p>
<h3 id="bridge-cni-정보-확인"><a href="#bridge-cni-정보-확인" class="headerlink" title="bridge, cni 정보 확인"></a>bridge, cni 정보 확인</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># [터미널1,2] 워커 노드1,2</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker  bash</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2 bash</span><br><span class="line">-----------------------------</span><br><span class="line"><span class="comment"># 브리지 정보 확인</span></span><br><span class="line">brctl show cni0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 브리지 연결 링크(veth) 확인</span></span><br><span class="line">bridge <span class="built_in">link</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 브리지 VLAN 정보 확인</span></span><br><span class="line">bridge vlan</span><br><span class="line"></span><br><span class="line"><span class="comment"># cbr(custom bridge) 정보 : kubenet CNI의 bridge - 링크</span></span><br><span class="line">tree /var/lib/cni/networks/cbr0</span><br><span class="line">	/var/lib/cni/networks/cbr0</span><br><span class="line">	├── 10.244.2.4.</span><br><span class="line">	├── last_reserved_ip.0</span><br><span class="line">	└── lock</span><br><span class="line"></span><br><span class="line"><span class="comment"># 네트워크 관련 정보들 확인</span></span><br><span class="line">ip -c addr | grep veth -A3</span><br><span class="line">-----------------------------</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/flannel-07.png"></p>
<h2 id="패킷-캡처"><a href="#패킷-캡처" class="headerlink" title="패킷 캡처"></a>패킷 캡처</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i cni0 -nn icmp</span><br><span class="line">tcpdump -i flannel.1 -nn icmp</span><br><span class="line">tcpdump -i eth0 -nn icmp</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># [터미널1,2] 워커 노드1,2</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker  bash</span><br><span class="line">docker <span class="built_in">exec</span> -it myk8s-worker2 bash</span><br><span class="line">-----------------------------</span><br><span class="line"></span><br><span class="line">tcpdump -i eth0 -nn udp port 8472 -w /root/vxlan.pcap </span><br><span class="line"><span class="comment"># CTRL+C 취소 후 확인 : ls -l /root/vxlan.pcap</span></span><br><span class="line"></span><br><span class="line">conntrack -L | grep -i icmp</span><br><span class="line">-----------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment"># [터미널3]</span></span><br><span class="line"><span class="comment"># 패킷캡처 후 호스트로 파일 이동 및 wireshark를 통해 패킷을 쉽게 확인할 수 있다.</span></span><br><span class="line">docker <span class="built_in">cp</span> myk8s-worker:/root/vxlan.pcap .</span><br><span class="line">wireshark vxlan.pcap</span><br></pre></td></tr></table></figure>

<ul>
<li>패킷 캡처</li>
</ul>
<p><img src="/blog/img/flannel-08.png"></p>
<p><img src="/blog/img/flannel-09.png"></p>
<p><img src="/blog/img/flannel-10.png"></p>
<ul>
<li>SRC, DST IP 확인</li>
</ul>
<p><img src="/blog/img/flannel-11.png"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-08-31T15:02:30.000Z" title="2024. 9. 1. 오전 12:02:30">2024-09-01</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-21T22:20:08.969Z" title="2024. 9. 22. 오전 7:20:08">2024-09-22</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-overlaynetwork/">container/overlaynetwork</a></span><span class="level-item">3 minutes read (About 429 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/09/01/docs/overlaynetwork/vxlan/">vxlan</a></h1><div class="content"><ul>
<li>VxLAN은 VLAN을 확장한 개념으로 기존의 VLAN에서 만들 수 있는 네트워크보다 훨씬 더 많은 네트워크를 생성할 수 있다.</li>
<li>VxLAN에서 x는 eXtensible으로 이름에서도 확장을 나타내고 있다.</li>
<li>VLAN은 이더넷 프레임에 16bit(vlan, option, id)를 추가로 구성하여 Tag를 기반으로 동작하는데 이때 id로 사용할 수 있는 비트가 12bit이기 때문에 만들 수 있는 네트워크가 최대 4096개만 생성할 수 있었다.</li>
<li>VxLAN은 VLAN의 문제를 해결하기 위해 50byte 헤더(Mac over IP, UDP Header, 24bit VLAN ID)를 추가로 구성하여 16,000,000개 이상의 VLAN을 제공할 수 있다.</li>
</ul>
<h3 id="VNI-virtual-Network-Identifier"><a href="#VNI-virtual-Network-Identifier" class="headerlink" title="VNI (virtual Network Identifier)"></a>VNI (virtual Network Identifier)</h3><ul>
<li>VLAN과 VxLAN segment간 mapping 구분자</li>
<li>같은 VLAN에 대해 여러 개의 VNI mapping이 가능하다.</li>
</ul>
<h3 id="VTEP-VXLAN-Tunnel-End-Point"><a href="#VTEP-VXLAN-Tunnel-End-Point" class="headerlink" title="VTEP ( VXLAN Tunnel End Point )"></a>VTEP ( VXLAN Tunnel End Point )</h3><ul>
<li>VXLAN Tunnel 종단 역할을 수행한다</li>
<li>인캡슐레이션과 터미네이션 의 end point 역활을 수행한다.</li>
</ul>
<p><img src="/blog/img/overlay-network-03.png"></p>
<ul>
<li><p>Original L2 frame 이외의 모든 헤더가 VXLAN 관련 헤더이다.</p>
</li>
<li><p>VXLAN 헤더 에는 VNI 라는 24비트 VLAN 을 생성할 수 있다.</p>
<p>일반적인 VLAN ID 가 16비트의 기반이라면, VXLAN의 VNI 에서 표현되는 VLAN 은 24비트의 기반으로, 16,000,000 개의 VLAN 을 생성 할 수 있다.</p>
</li>
<li><p>L2 over L3 : UDP 패킷 내부에 L2 프레임을  캡슐화 하는 <em>터널링</em>  기술</p>
</li>
<li><p>Mac in UDP </p>
<ul>
<li>VXLAN 패킷 사이즈 : 50byte</li>
<li>VXLAN L2 정보 (MAC address)를 L3에 넣어서 통신</li>
</ul>
</li>
</ul>
<h3 id="MTU"><a href="#MTU" class="headerlink" title="MTU"></a>MTU</h3><ul>
<li>원래는 1500byte 를 사용하는데 VXLAN 패킷에 50byte를 썼으므로</li>
<li>1450byte 를 세팅해서 사용하도록 MTU를 세팅한다.</li>
</ul>
<h3 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h3><p><a target="_blank" rel="noopener" href="https://skstp35.tistory.com/227">https://skstp35.tistory.com/227</a></p>
<p><a target="_blank" rel="noopener" href="https://atthis.tistory.com/7?category=750237">https://atthis.tistory.com/7?category=750237</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-08-31T15:01:30.000Z" title="2024. 9. 1. 오전 12:01:30">2024-09-01</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-21T22:20:08.969Z" title="2024. 9. 22. 오전 7:20:08">2024-09-22</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-overlaynetwork/">container/overlaynetwork</a></span><span class="level-item">9 minutes read (About 1384 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/09/01/docs/overlaynetwork/overlay-network/">overlay network</a></h1><div class="content"><ul>
<li>가상화 또는 클라우드 기반의 네트워크는 유연하게 확장이 되어야 한다. </li>
<li>관리하는 Subnet들이 많아지고 연결되어 있는 host의 수가 증가하면 포워딩, 스위칭, 라우팅 과 같은 네트워크 구성이 복잡해진다.</li>
<li>따라서 물리적인 네트워크망은 고려하지 않고 가상으로 host와 host의 연결만을 고려해서 구현한 기술이 바로 Network Overlay이다.</li>
</ul>
<h3 id="오버레이-네트워크-종류"><a href="#오버레이-네트워크-종류" class="headerlink" title="오버레이 네트워크 종류"></a>오버레이 네트워크 종류</h3><ul>
<li><strong>Virtual Extensible Local Area Network (VxLAN)</strong></li>
<li>Generic Routing Encapsulation (GRE)</li>
<li>IP Security (IPsec)</li>
<li>Multiprotocol Label Switching (MPLS)</li>
<li>Ethernet Virtual Private Network(EVPN)</li>
<li>Software-Defined WAN (SD-WAN)</li>
<li>Software-Defined Access (SD-Access)</li>
<li>Application Centric Infrastructure (ACI)</li>
<li>Cisco Virtual Topology System (VTS)</li>
</ul>
<h2 id="practice"><a href="#practice" class="headerlink" title="practice"></a>practice</h2><ul>
<li>hostA 내부 veth와 hostB 내부 veth간 ICMP 통신을 실습</li>
<li>hostA : 192.168.64.27, hostB: 192.168.64.28</li>
</ul>
<h3 id="hostA-설정"><a href="#hostA-설정" class="headerlink" title="hostA 설정"></a>hostA 설정</h3><ul>
<li>namsepace, bridge, VxLAN을 설정한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># red: VxLAN을 설정한 namespace</span></span><br><span class="line">ip netns add red</span><br><span class="line"><span class="comment"># blue: 실제 통신을 위한 가상 단말기</span></span><br><span class="line">ip netns add blue</span><br><span class="line"></span><br><span class="line"><span class="comment"># red와 blue의 veth peer를 구성</span></span><br><span class="line"><span class="comment"># mtu 1450으로 설정</span></span><br><span class="line">ip <span class="built_in">link</span> add dev red-veth mtu 1450 netns red <span class="built_in">type</span> veth peer name blue-veth mtu 1450 netns blue</span><br><span class="line"></span><br><span class="line"><span class="comment"># 실제통신 단말기의 ip와 mac을 설정</span></span><br><span class="line">ip netns <span class="built_in">exec</span> blue ip <span class="built_in">link</span> <span class="built_in">set</span> dev blue-veth address 02:42:c0:a8:00:02</span><br><span class="line">ip netns <span class="built_in">exec</span> blue ip addr add dev blue-veth 7.7.7.2/24</span><br><span class="line"></span><br><span class="line"><span class="comment"># red에 bridge device설정 및 ip 세팅</span></span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> add dev br0 <span class="built_in">type</span> bridge</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip addr add dev br0 7.7.7.1/24</span><br><span class="line"></span><br><span class="line"><span class="comment"># endpoint 식별을 위해 id 설정 (VNI)</span></span><br><span class="line"><span class="comment"># proxy옵션: arp 쿼리에 응답</span></span><br><span class="line"><span class="comment"># learning: bridge fdb entry 자동갱신 (수정설정할 필요 없음)</span></span><br><span class="line"><span class="comment"># dstport 4789: UDP port 터널링</span></span><br><span class="line">ip <span class="built_in">link</span> add dev vxlan1 netns red <span class="built_in">type</span> vxlan <span class="built_in">id</span> 42 proxy learning dstport 4789</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># red 내부에 VxLAN, peer veth 장비를 bridge와 연결한다.</span></span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> red-veth master br0</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> vxlan1 master br0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 모든 가상장치를 실행한다.</span></span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> br0 up</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> vxlan1 up</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> red-veth up</span><br><span class="line">ip netns <span class="built_in">exec</span> blue ip <span class="built_in">link</span> <span class="built_in">set</span> blue-veth up</span><br></pre></td></tr></table></figure>



<h3 id="hostB-설정"><a href="#hostB-설정" class="headerlink" title="hostB 설정"></a>hostB 설정</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ip netns add red</span><br><span class="line">ip netns add blue</span><br><span class="line"></span><br><span class="line">ip <span class="built_in">link</span> add dev red-veth mtu 1450 netns red <span class="built_in">type</span> veth peer name blue-veth mtu 1450 netns blue</span><br><span class="line"></span><br><span class="line">ip netns <span class="built_in">exec</span> blue ip <span class="built_in">link</span> <span class="built_in">set</span> dev blue-veth address 02:42:c0:a8:00:03</span><br><span class="line">ip netns <span class="built_in">exec</span> blue ip addr add dev blue-veth 7.7.7.3/24</span><br><span class="line"></span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> add dev br0 <span class="built_in">type</span> bridge</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip addr add dev br0 7.7.7.1/24</span><br><span class="line"></span><br><span class="line">ip <span class="built_in">link</span> add dev vxlan1 netns red <span class="built_in">type</span> vxlan <span class="built_in">id</span> 42 proxy learning dstport 4789</span><br><span class="line"></span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> red-veth master br0</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> vxlan1 master br0</span><br><span class="line"></span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> br0 up</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> vxlan1 up</span><br><span class="line">ip netns <span class="built_in">exec</span> red ip <span class="built_in">link</span> <span class="built_in">set</span> red-veth up</span><br><span class="line">ip netns <span class="built_in">exec</span> blue ip <span class="built_in">link</span> <span class="built_in">set</span> blue-veth up</span><br></pre></td></tr></table></figure>



<h3 id="hostA-gt-blue"><a href="#hostA-gt-blue" class="headerlink" title="hostA &gt; blue"></a>hostA &gt; blue</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># nsenter --net=/var/run/netns/blue</span></span><br><span class="line">ping 7.7.7.3 <span class="comment"># 실패</span></span><br><span class="line"></span><br><span class="line">\<span class="comment"># ip neigh # arp에 등록이 안되어있음.</span></span><br><span class="line">7.7.7.3 dev blue-veth  FAILED</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># nsenter --net=/var/run/netns/red</span></span><br><span class="line">tcpdump -i br0 <span class="comment"># 로그 확인</span></span><br><span class="line">05:28:15.024947 ARP, Request who-has 7.7.7.3 tell 7.7.7.2, length 28 <span class="comment"># arp 요청만 한다.</span></span><br></pre></td></tr></table></figure>





<h3 id="mac-추가"><a href="#mac-추가" class="headerlink" title="mac 추가"></a>mac 추가</h3><ul>
<li>VxLAN이 통신을 해야하는데, 해당 ip는 host 내부에 없다.</li>
<li>hostA의 VxLAN에 통신할 arp 정보를 수동으로 등록해준다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># nsenter --net=/var/run/netns/red</span></span><br><span class="line">\<span class="comment"># ip neigh add 7.7.7.3 lladdr 02:42:c0:a8:00:03 dev vxlan1 # in red namespace</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\<span class="comment"># ip neigh show</span></span><br><span class="line">7.7.7.3 dev vxlan1 lladdr 02:42:c0:a8:00:03 PERMANENT</span><br></pre></td></tr></table></figure>

<ul>
<li>arp table state</li>
</ul>
<p><img src="/blog/img/overlay-network-01.png"></p>
<ul>
<li>다시 테스트하면 ARP 통신이 된다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># ping 7.7.7.3</span></span><br><span class="line">PING 7.7.7.3 (7.7.7.3) 56(84) bytes of data.</span><br><span class="line">--- 7.7.7.3 ping statistics ---</span><br><span class="line">5 packets transmitted, 0 received, 100% packet loss, time 4087ms</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># ip neigh # arp테이블에 업데이트됨을 확인</span></span><br><span class="line">7.7.7.3 dev blue-veth lladdr 02:42:c0:a8:00:03 REACHABLE</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>hostA &gt; red</strong></li>
<li>ARP 통신 이후 ICMP 통신이 실패함을 알 수 있다.</li>
<li>ICMP (Internet Control Message Protocol) - L3 (Network Layer) 프로토콜</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># tcpdump -i br0</span></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on br0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">05:32:09.944756 ARP, Request who-has 7.7.7.3 tell 7.7.7.2, length 28</span><br><span class="line">05:32:09.944784 ARP, Reply 7.7.7.3 is-at 02:42:c0:a8:00:03 (oui Unknown), length 28</span><br><span class="line">05:32:09.944861 IP 7.7.7.2 &gt; 7.7.7.3: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 1821, <span class="built_in">seq</span> 1, length 64</span><br><span class="line">05:32:10.964330 IP 7.7.7.2 &gt; 7.7.7.3: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 1821, <span class="built_in">seq</span> 2, length 64</span><br><span class="line">05:32:11.987056 IP 7.7.7.2 &gt; 7.7.7.3: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 1821, <span class="built_in">seq</span> 3, length 64</span><br><span class="line">05:32:13.011901 IP 7.7.7.2 &gt; 7.7.7.3: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 1821, <span class="built_in">seq</span> 4, length 64</span><br></pre></td></tr></table></figure>





<h3 id="hostA-gt-blue-1"><a href="#hostA-gt-blue-1" class="headerlink" title="hostA &gt; blue"></a>hostA &gt; blue</h3><ul>
<li>br0 존재하는 blue 에서 netfilter 룰을 조회.</li>
<li>FORWARD 가 ACCEPT 임을 확인.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># iptables -t filter -L | grep policy</span></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br></pre></td></tr></table></figure>

<ul>
<li>route 조회</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># ip route</span></span><br><span class="line">7.7.7.0/24 dev br0 proto kernel scope <span class="built_in">link</span> src 7.7.7.1</span><br></pre></td></tr></table></figure>

<ul>
<li>bridge fdb 조회<ul>
<li>vxlan1의 정보를 확인할 수 있다.</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># bridge fdb | grep 02:42:c0:a8:00:03</span></span><br><span class="line">02:42:c0:a8:00:03 dev vxlan1 master br0</span><br></pre></td></tr></table></figure>

<ul>
<li>정확한 목적지 ip, VxLAN ip 등을 명시해 fdb entry에 추가한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># bridge fdb add 02:42:c0:a8:00:03 dev vxlan1 self dst 192.168.64.28 vni 42 port 4789</span></span><br><span class="line"></span><br><span class="line">root@seongtki:~<span class="comment"># bridge fdb | grep 02:42:c0:a8:00:03</span></span><br><span class="line">02:42:c0:a8:00:03 dev vxlan1 master br0</span><br><span class="line">02:42:c0:a8:00:03 dev vxlan1 dst 192.168.64.28 link-netnsid 1 self permanent</span><br></pre></td></tr></table></figure>





<h3 id="hostB-gt-red"><a href="#hostB-gt-red" class="headerlink" title="hostB &gt; red"></a>hostB &gt; red</h3><ul>
<li>hostB에도 필요한 정보가 전부 존재하는지 조회를 해보자.</li>
<li>arp는 수동으로 추가해주어야 한다.</li>
<li>fdb는 이미 추가되어 있다. -&gt; vxlan1 추가 시 learning 키워드를 추가해주면, fdb는 필요한 정보를 자동으로 업데이트 한다.<br>(hostA에서 이미 추가되어있어 요청했을 때 자동으로 추가됨)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># nsenter --net=/var/run/netns/red</span></span><br><span class="line">root@seongtki:~<span class="comment"># ip neigh</span></span><br><span class="line">root@seongtki:~<span class="comment"># ip route</span></span><br><span class="line">7.7.7.0/24 dev br0 proto kernel scope <span class="built_in">link</span> src 7.7.7.1</span><br><span class="line">root@seongtki:~<span class="comment"># bridge fdb | grep 02:42:c0:a8:00:02</span></span><br><span class="line">02:42:c0:a8:00:02 dev vxlan1 master br0</span><br><span class="line">02:42:c0:a8:00:02 dev vxlan1 dst 192.168.64.27 link-netnsid 1 self</span><br></pre></td></tr></table></figure>

<ul>
<li>arp 정보 추가</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># ip neigh add 7.7.7.2 lladdr 02:42:c0:a8:00:02 dev vxlan1</span></span><br><span class="line"></span><br><span class="line">root@seongtki:~<span class="comment"># ip neigh show</span></span><br><span class="line">7.7.7.2 dev vxlan1 lladdr 02:42:c0:a8:00:02 PERMANENT</span><br></pre></td></tr></table></figure>



<h3 id="최종-테스트"><a href="#최종-테스트" class="headerlink" title="최종 테스트"></a>최종 테스트</h3><p>hostA &gt; blue</p>
<ul>
<li>정상적으로 응답</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~# ping 7.7.7.3</span><br><span class="line">PING 7.7.7.3 (7.7.7.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from 7.7.7.3: icmp_seq=153 ttl=64 time=1008 ms</span><br><span class="line">64 bytes from 7.7.7.3: icmp_seq=154 ttl=64 time=4.79 ms</span><br><span class="line">64 bytes from 7.7.7.3: icmp_seq=155 ttl=64 time=3.85 ms</span><br><span class="line">64 bytes from 7.7.7.3: icmp_seq=156 ttl=64 time=3.37 ms</span><br></pre></td></tr></table></figure>

<p>hostB &gt; red</p>
<ul>
<li>정상적인 통신로그 조회</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~# tcpdump -i br0</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">listening on br0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">03:12:11.488557 IP 7.7.7.2 &gt; 7.7.7.3: ICMP echo request, id 1958, seq 174, length 64</span><br><span class="line">03:12:11.488648 IP 7.7.7.3 &gt; 7.7.7.2: ICMP echo reply, id 1958, seq 174, length 64</span><br><span class="line">03:12:12.490214 IP 7.7.7.2 &gt; 7.7.7.3: ICMP echo request, id 1958, seq 175, length 64</span><br><span class="line">03:12:12.490423 IP 7.7.7.3 &gt; 7.7.7.2: ICMP echo reply, id 1958, seq 175, length 64</span><br><span class="line">03:12:13.495586 IP 7.7.7.2 &gt; 7.7.7.3: ICMP echo request, id 1958, seq 176, length 64</span><br><span class="line">03:12:13.495828 IP 7.7.7.3 &gt; 7.7.7.2: ICMP echo reply, id 1958, seq 176, length 64</span><br></pre></td></tr></table></figure>



<ul>
<li>지금까지 구성한 overlay network 구성도.</li>
</ul>
<p><img src="/blog/img/overlay-network-02.png"></p>
<h3 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h3><p><a target="_blank" rel="noopener" href="https://ebt-forti.tistory.com/m/145?category=849281">https://ebt-forti.tistory.com/m/145?category=849281</a></p>
<p><a target="_blank" rel="noopener" href="https://netpple.github.io/docs/make-container-without-docker/">https://netpple.github.io/docs/make-container-without-docker/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-08-31T14:40:35.000Z" title="2024. 8. 31. 오후 11:40:35">2024-08-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-21T22:20:08.966Z" title="2024. 9. 22. 오전 7:20:08">2024-09-22</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-cgroup/">container/cgroup</a></span><span class="level-item">4 minutes read (About 600 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/08/31/docs/cgroup/cgroup/">cgroups</a></h1><div class="content"><ul>
<li>Cgroups, Control Groups</li>
<li>컨테이너 별로 자원을 분배하고 limit 내에서 운용</li>
<li>하나 또는 복수의 장치를 묶어서 그룹</li>
<li>프로세스가 사용하는 리소스 통제</li>
</ul>
<h3 id="Cgroup-파일시스템"><a href="#Cgroup-파일시스템" class="headerlink" title="Cgroup 파일시스템"></a>Cgroup 파일시스템</h3><ul>
<li>자원할당과 제어를 파일시스템으로 제공</li>
<li>cgroup 네임스페이스로 격리할 수 있다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">seongtki@seongtki:~$ tree -L 1 /sys/fs/cgroup/cpu</span><br><span class="line">/sys/fs/cgroup/cpu</span><br><span class="line">├── cgroup.clone_children</span><br><span class="line">├── cgroup.procs</span><br><span class="line">├── cgroup.sane_behavior</span><br><span class="line">├── cpuacct.stat</span><br><span class="line">├── cpuacct.usage</span><br><span class="line">├── cpuacct.usage_all</span><br><span class="line">├── cpuacct.usage_percpu</span><br><span class="line">├── cpuacct.usage_percpu_sys</span><br><span class="line">├── cpuacct.usage_percpu_user</span><br></pre></td></tr></table></figure>



<h3 id="cgroup-tools-stress-설치"><a href="#cgroup-tools-stress-설치" class="headerlink" title="cgroup-tools,  stress 설치"></a>cgroup-tools,  stress 설치</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># apt install -y cgroup-tools</span></span><br><span class="line">root@seongtki:~<span class="comment"># apt install -y stress</span></span><br></pre></td></tr></table></figure>



<h3 id="프로세스-실행-및-cpu-사용률-확인"><a href="#프로세스-실행-및-cpu-사용률-확인" class="headerlink" title="프로세스 실행 및 cpu 사용률 확인"></a>프로세스 실행 및 cpu 사용률 확인</h3><ul>
<li>top으로 CPU 100% 확인</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># stress -c 1</span></span><br><span class="line">stress: info: [2328] dispatching hogs: 1 cpu, 0 io, 0 vm, 0 hdd</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/cgroup-01.png"></p>
<h3 id="자원제한을-위한-cgroup-제어그룹-생성"><a href="#자원제한을-위한-cgroup-제어그룹-생성" class="headerlink" title="자원제한을 위한 cgroup 제어그룹 생성"></a>자원제한을 위한 cgroup 제어그룹 생성</h3><ul>
<li>-a : 소유자 정의 (<agid>:<auid>)</li>
<li>-g : 추가할 그룹을 정의한다. (<controllers>:<path>)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># cgcreate -a root -g cpu:mycgroup</span></span><br></pre></td></tr></table></figure>

<ul>
<li>디렉토리만 만들면 내용은 커널이 다만들어준다 (mycgroup이 관리할 내용을)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># tree /sys/fs/cgroup/cpu/mycgroup/</span></span><br><span class="line">/sys/fs/cgroup/cpu/mycgroup/</span><br><span class="line">├── cgroup.clone_children</span><br><span class="line">├── cgroup.procs</span><br><span class="line">├── cpuacct.stat</span><br><span class="line">├── cpuacct.usage</span><br><span class="line">├── cpuacct.usage_all</span><br><span class="line">├── cpuacct.usage_percpu</span><br><span class="line">├── cpuacct.usage_percpu_sys</span><br><span class="line">├── cpuacct.usage_percpu_user</span><br><span class="line">├── cpuacct.usage_sys</span><br><span class="line">├── cpuacct.usage_user</span><br><span class="line">├── cpu.cfs_period_us</span><br><span class="line">├── cpu.cfs_quota_us</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h3 id="리소스-설정-및-프로세스-할당"><a href="#리소스-설정-및-프로세스-할당" class="headerlink" title="리소스 설정 및 프로세스 할당"></a>리소스 설정 및 프로세스 할당</h3><ul>
<li>cpu.cfs_period_us : CPU 할당량을 사용할 수 있는 기간을 마이크로초(µs) 단위로 설정<ul>
<li>기본값이 100000</li>
</ul>
</li>
<li>cpu.cfs_quota_us : 프로세스 그룹에 할당되는 CPU 시간의 한계를 마이크로초(µs) 단위로 설정<ul>
<li>cpu.cfs_quota_us &#x2F; cfs_period_us  * 100 &#x3D;&gt; 30000 &#x2F; 100000 * 100 &#x3D; 30%</li>
</ul>
</li>
<li><strong>30%가 넘지 않게 커널이 cgroup정보를 활용해서 쓰로틀링을 걸어준다</strong></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># cgset -r cpu.cfs_quota_us=30000 mycgroup;</span></span><br><span class="line">root@seongtki:~<span class="comment"># cgexec -g cpu:mycgroup stress -c 1</span></span><br><span class="line">stress: info: [2352] dispatching hogs: 1 cpu, 0 io, 0 vm, 0 hdd</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/cgroup-02.png"></p>
<h3 id="cgroups-삭제"><a href="#cgroups-삭제" class="headerlink" title="cgroups 삭제"></a>cgroups 삭제</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cgdelete cpu:mycgroup</span><br></pre></td></tr></table></figure>





<h3 id="Cgroup-파일-시스템으로-리소스-관리-요약"><a href="#Cgroup-파일-시스템으로-리소스-관리-요약" class="headerlink" title="Cgroup 파일 시스템으로 리소스 관리 요약"></a>Cgroup 파일 시스템으로 리소스 관리 요약</h3><ul>
<li>제어그룹(controller group) 생성<ul>
<li>우리 예제는 mycgroup이라는 제어그룹을 생성</li>
</ul>
</li>
<li>제어그룹 리소스 설정<ul>
<li>cpu.cfs_quota_us 을 통해 사용률을 설정</li>
</ul>
</li>
<li>제어그룹 프로세스 할당<ul>
<li>cgexec 를사용해서 mycgroup 에 stress 프로세스를 할당해서 실행.</li>
</ul>
</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-08-31T14:20:30.000Z" title="2024. 8. 31. 오후 11:20:30">2024-08-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-21T22:20:08.969Z" title="2024. 9. 22. 오전 7:20:08">2024-09-22</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-overlayFS/">container/overlayFS</a></span><span class="level-item">4 minutes read (About 645 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/08/31/docs/overlayFS/overlayFS/">Overlay Filesystem</a></h1><div class="content"><ul>
<li><p>여러 filesystem을 하나로 mount하는 기능.</p>
</li>
<li><p>두 파일시스템에 동일한 파일이 있는경우</p>
<ul>
<li>나중에 마운트 되는 파일시스템의 파일을 오버레이한다.</li>
</ul>
</li>
<li><p>하위 파일시스템에 대한 쓰기 작업 시</p>
<ul>
<li>그 시점에 Copy-on-write 실시 () 복사본을 생성하여 수행 (원본유지))</li>
</ul>
</li>
<li><p>이령, 상속 파일시스템으로 불린다.</p>
</li>
</ul>
<h3 id="OverlayFS2"><a href="#OverlayFS2" class="headerlink" title="OverlayFS2"></a>OverlayFS2</h3><ul>
<li>Merged Dir: 통합 뷰 (<strong>mount point</strong>)</li>
<li>Upper Dir: Writable. 컨테이너에서의 변경된 내용이 쓰이는 레이어</li>
<li>Lower Dir: Read only, 기존 이미지 영역</li>
<li>Work Dir: “atomic action”을 보장하기 위해 merge에 반영되기 전에 파일을 준비하는 데 사용된다.</li>
</ul>
<p><img src="/blog/img/overlayfs2-01.png"></p>
<h2 id="overlay-test"><a href="#overlay-test" class="headerlink" title="overlay test"></a>overlay test</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> overlay-test</span><br><span class="line"><span class="built_in">cd</span> overlay-test</span><br><span class="line"><span class="built_in">mkdir</span> image1 image2 container work merge</span><br><span class="line"><span class="built_in">touch</span> image1/a image1/b image2/c</span><br><span class="line"></span><br><span class="line"><span class="comment"># merge: mount point</span></span><br><span class="line">mount -t overlay overlay -o lowerdir=image2:image1,upperdir=container,workdir=work merge</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/<span class="comment"># mount | grep overlay-test/</span></span><br><span class="line">overlay on /overlay-test/merge <span class="built_in">type</span> overlay (rw,relatime,lowerdir=image2:image1,upperdir=container,workdir=work)</span><br></pre></td></tr></table></figure>

<ul>
<li>파일구조</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/overlay-test<span class="comment"># tree -I .</span></span><br><span class="line">├── container</span><br><span class="line">├── image1</span><br><span class="line">│   ├── a</span><br><span class="line">│   └── b</span><br><span class="line">├── image2</span><br><span class="line">│   └── c</span><br><span class="line">├── merge</span><br><span class="line">│   ├── a</span><br><span class="line">│   ├── b</span><br><span class="line">│   └── c</span><br><span class="line">└── work</span><br><span class="line">    └── work</span><br></pre></td></tr></table></figure>

<ul>
<li>merge&#x2F;a 삭제 후 디렉토리</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/overlay-test<span class="comment"># rm merge/a</span></span><br><span class="line">root@seongtki:/overlay-test<span class="comment"># tree -I .</span></span><br><span class="line">├── container</span><br><span class="line">│   └── a <span class="comment"># 삭제파일이 upperdir 에 적용되어 보인다 (RW)</span></span><br><span class="line">├── image1</span><br><span class="line">│   ├── a <span class="comment"># lowerdir는 변경이 단됨 (RO)</span></span><br><span class="line">│   └── b</span><br><span class="line">├── image2</span><br><span class="line">│   └── c</span><br><span class="line">├── merge</span><br><span class="line">│   ├── b</span><br><span class="line">│   └── c</span><br><span class="line">└── work</span><br><span class="line">    └── work</span><br></pre></td></tr></table></figure>

<ul>
<li>lowerdir 에 파일 수정 시 merge에도 적용되어 보인다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/overlay-test<span class="comment"># echo &#x27;hello bb&#x27; &gt; image1/b</span></span><br><span class="line"></span><br><span class="line">root@seongtki:/overlay-test<span class="comment"># cat image1/b</span></span><br><span class="line">hello bbb</span><br><span class="line">root@seongtki:/overlay-test<span class="comment"># cat merge/b</span></span><br><span class="line">hello bbb</span><br></pre></td></tr></table></figure>

<ul>
<li>merge파일을 수정하면, lowerdir은 더이상 변경되지 않는다.</li>
<li>Copy-On-Write 가 발생하기 때문이다. (실제 파일이 사용될 때 카피를 하고 수정하기 때문.)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/overlay-test<span class="comment"># echo &#x27;hello m&#x27; &gt; merge/b</span></span><br><span class="line">root@seongtki:/overlay-test<span class="comment"># cat merge/b</span></span><br><span class="line">hello m</span><br><span class="line">root@seongtki:/overlay-test<span class="comment"># cat image1/b</span></span><br><span class="line">hello bbb</span><br></pre></td></tr></table></figure>

<ul>
<li>이후 lowerdir파일을 변경해도 merge파일을 변경되지 않는다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/overlay-test<span class="comment">#  echo &#x27;hello bbbb&#x27; &gt; image1/b</span></span><br><span class="line"></span><br><span class="line">root@seongtki:/overlay-test<span class="comment"># cat image1/b</span></span><br><span class="line">hello bbbb</span><br><span class="line">root@seongtki:/overlay-test<span class="comment"># cat merge/b</span></span><br><span class="line">hello m</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/overlay-test<span class="comment"># tree -I .</span></span><br><span class="line">.</span><br><span class="line">├── container</span><br><span class="line">│   ├── a</span><br><span class="line">│   └── b</span><br><span class="line">├── image1</span><br><span class="line">│   ├── a</span><br><span class="line">│   └── b</span><br><span class="line">├── image2</span><br><span class="line">│   └── c</span><br><span class="line">├── merge</span><br><span class="line">│   ├── b</span><br><span class="line">│   └── c</span><br><span class="line">└── work</span><br><span class="line">    └── work</span><br></pre></td></tr></table></figure>



</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-08-31T14:10:30.000Z" title="2024. 8. 31. 오후 11:10:30">2024-08-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-21T22:20:08.968Z" title="2024. 9. 22. 오전 7:20:08">2024-09-22</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-overlayFS/">container/overlayFS</a></span><span class="level-item">13 minutes read (About 1959 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/08/31/docs/overlayFS/container-layer-stack/">Container Layer Stack</a></h1><div class="content"><ul>
<li><p>컨테이너 설치 시 이미지가 어떤 방식, 구조로 저장되는지 알아보자</p>
</li>
<li><p>도커 컨테이너 , 이미지 삭제</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># docker rm $(docker ps -a -q)</span></span><br><span class="line">\<span class="comment"># docker rmi -f $(docker images -q)</span></span><br></pre></td></tr></table></figure>



<ul>
<li>docker pull nginx:latest</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/<span class="comment"># docker pull nginx:latest</span></span><br><span class="line">latest: Pulling from library/nginx</span><br><span class="line">e886f0f47ef5: Pull complete <span class="comment"># 배포id (distribution id)</span></span><br><span class="line">9a9138853e32: Pull complete</span><br><span class="line">598a42ec6587: Pull complete</span><br><span class="line">82e490cc2043: Pull complete</span><br><span class="line">948128637a91: Pull complete</span><br><span class="line">e4cad15ac3f6: Pull complete</span><br><span class="line">096332b242c2: Pull complete</span><br><span class="line">Digest: sha256:32da30332506740a2f7c34d5dc70467b7f14ec67d912703568daff790ab3f755</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> nginx:latest</span><br><span class="line">docker.io/library/nginx:latest</span><br></pre></td></tr></table></figure>

<ul>
<li>image id 확인</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED      SIZE</span><br><span class="line">nginx        latest    2a4fbb36e966   9 days ago   192MB</span><br></pre></td></tr></table></figure>

<ul>
<li>layer id 확인 (image id 조회)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/<span class="comment"># docker image inspect 2a4fbb36e966 | jq &#x27;.[].RootFS&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;layers&quot;</span>,</span><br><span class="line">  <span class="string">&quot;Layers&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;sha256:311627f8702d2d97e63b916cad711aa9f962a1f20da5572d68b8f223ff051e73&quot;</span>, <span class="comment"># layer id</span></span><br><span class="line">    <span class="string">&quot;sha256:674ca5344f959090515e9eac79055d8630851b21bbd584ac32765315284c05c5&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sha256:7f8881cae5296e2ef0103706a326235494b5f1dcd9ea960656165cf7643ddd47&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sha256:f21128d548a5122f430a58f123deb9c8b80f70b9fc98df280a9619b7e38b6a32&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sha256:dca0e6f80e8df5d85d45426101fefba3d41abe4fc90be994074066d4b135bef5&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sha256:d9664e6da0f787fb8c04e80f1e731223f8ef93f6e097e934442e1792da614dff&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sha256:ed44ff7a11e0afd3e5b58c730514faeac7d6a12faff3f52aa33d33e0369e7aad&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>도커는 다운로드한 이미지를 로컬에 저장하고 관리하기 위해 **”레이어 DB”**를 사용한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/image/overlay2<span class="comment"># tree -L 2</span></span><br><span class="line">.</span><br><span class="line">├── distribution</span><br><span class="line">│   ├── diffid-by-digest</span><br><span class="line">│   └── v2metadata-by-diffid</span><br><span class="line">├── imagedb</span><br><span class="line">│   ├── content</span><br><span class="line">│   └── metadata</span><br><span class="line">├── layerdb  <span class="comment"># 레이어 스택 정보</span></span><br><span class="line">│   ├── mounts</span><br><span class="line">│   ├── sha256</span><br><span class="line">│   └── tmp</span><br><span class="line">└── repositories.json</span><br></pre></td></tr></table></figure>



<table>
<thead>
<tr>
<th>레이어디비 항목</th>
<th>내용</th>
</tr>
</thead>
<tbody><tr>
<td>db id</td>
<td>로컬에서 레이어식별을 위한 레이어디비 id<br />이미지를 pull 받을 때 레이어 별로 생성됨. (받을 때마다 달라짐)</td>
</tr>
<tr>
<td>cache id</td>
<td>레이어가 저장된 로컬경로 id (경로를 식별)<br />- &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;{cache-id}</td>
</tr>
<tr>
<td>diff</td>
<td>layer id (레이어를 식별)</td>
</tr>
<tr>
<td>parent</td>
<td>부모레이어를 가리키는 포인터 (db id) 어떤 레이어 위로 올라갈지 지정</td>
</tr>
</tbody></table>
<h3 id="db-id"><a href="#db-id" class="headerlink" title="db id"></a>db id</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/image/overlay2/layerdb<span class="comment"># tree -L 2 sha256 -I &quot;tar-*|size&quot;</span></span><br><span class="line">sha256</span><br><span class="line">├── 311627f8702d2d97e63b916cad711aa9f962a1f20da5572d68b8f223ff051e73 <span class="comment"># db id</span></span><br><span class="line">│   ├── cache-id</span><br><span class="line">│   └── diff <span class="comment"># layer id</span></span><br><span class="line">├── 807d78e4cdc589c2cdefb7bb6049a31bcc7bf0f90f335a8a8de1abeb0e6a3993</span><br><span class="line">│   ├── cache-id</span><br><span class="line">│   ├── diff</span><br><span class="line">│   └── parent</span><br><span class="line">├── 89b7e61557f3502dc01aeae499b451574376c3e4c46e49294c72e22cd2d9634c</span><br><span class="line">│   ├── cache-id</span><br><span class="line">│   ├── diff</span><br><span class="line">│   └── parent</span><br><span class="line">├── 9f55692205d904037fbc69a1d59354665af3c0c2a767b5e799e719170085bc11</span><br><span class="line">│   ├── cache-id</span><br><span class="line">│   ├── diff</span><br><span class="line">│   └── parent</span><br><span class="line">├── a0e6c2974935e56e8d57d6fea041399b290da1566d82ea1a7d9c3ec7ef60a366</span><br><span class="line">│   ├── cache-id</span><br><span class="line">│   ├── diff</span><br><span class="line">│   └── parent</span><br><span class="line">├── a216b497301a9fc6283077c0906140e22b8f3a67ba92ab6253f036f48e1ff4b1</span><br><span class="line">│   ├── cache-id</span><br><span class="line">│   ├── diff</span><br><span class="line">│   └── parent</span><br><span class="line">└── a3169fdf28b9329e3f1882c095bf11e12a465419c759169682ca706de81bef84</span><br><span class="line">    ├── cache-id</span><br><span class="line">    ├── diff</span><br><span class="line">    └── parent</span><br></pre></td></tr></table></figure>

<ul>
<li>tree -L 2 sha256 -I “tar-*|size” 에서 -I 는 제외항목을 작성</li>
</ul>
<h3 id="cache-id-db-id"><a href="#cache-id-db-id" class="headerlink" title="cache-id : db-id"></a>cache-id : db-id</h3><ul>
<li>cache-id 리스트<ul>
<li>포맷: “cache-id” .&#x2F;sha256&#x2F;“db id”</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/image/overlay2/layerdb<span class="comment"># find . -name cache-id -exec cat &#123;&#125; \; -print</span></span><br><span class="line">52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d./sha256/311627f8702d2d97e63b916cad711aa9f962a1f20da5572d68b8f223ff051e73/cache-id</span><br><span class="line">bd58ec4c3b456591049ce5ad929fac42a96ad23fc28836a29917039d07295ed4./sha256/a0e6c2974935e56e8d57d6fea041399b290da1566d82ea1a7d9c3ec7ef60a366/cache-id</span><br><span class="line">5ebc10176fffee11727b0baa5f552146a74a4fa53935268e2c10726f08f61aa7./sha256/89b7e61557f3502dc01aeae499b451574376c3e4c46e49294c72e22cd2d9634c/cache-id</span><br><span class="line">20fae55020e28561082510b431ec0f85a8bb3a1cebb34f36916b91acc3833c84./sha256/807d78e4cdc589c2cdefb7bb6049a31bcc7bf0f90f335a8a8de1abeb0e6a3993/cache-id</span><br><span class="line">f3453bed47cc62a3d58d00327b6a76fbf15612220a7b1b4825936296fd0b845f./sha256/9f55692205d904037fbc69a1d59354665af3c0c2a767b5e799e719170085bc11/cache-id</span><br><span class="line">64c2e72761ef2dbf88db1e27bf590f901f5d0e7b3f778635ee976a2f834478ba./sha256/a216b497301a9fc6283077c0906140e22b8f3a67ba92ab6253f036f48e1ff4b1/cache-id</span><br><span class="line">067ec145f89b61cd0b6fd41745163c76e04f86db5b4a59a5358cc82a3099526a./sha256/a3169fdf28b9329e3f1882c095bf11e12a465419c759169682ca706de81bef84/cache-id</span><br></pre></td></tr></table></figure>

<ul>
<li>레이어의 로컬 저장 경로(&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;{cache-id})</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/overlay2<span class="comment"># ls -l</span></span><br><span class="line">total 32</span><br><span class="line">drwx--x--- 4 root root 4096 Sep 30 12:31 067ec145f89b61cd0b6fd41745163c76e04f86db5b4a59a5358cc82a3099526a</span><br><span class="line">drwx--x--- 4 root root 4096 Sep 30 12:31 20fae55020e28561082510b431ec0f85a8bb3a1cebb34f36916b91acc3833c84</span><br><span class="line">drwx--x--- 3 root root 4096 Sep 30 12:31 52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d</span><br><span class="line">drwx--x--- 4 root root 4096 Sep 30 12:31 5ebc10176fffee11727b0baa5f552146a74a4fa53935268e2c10726f08f61aa7</span><br><span class="line">drwx--x--- 4 root root 4096 Sep 30 12:31 64c2e72761ef2dbf88db1e27bf590f901f5d0e7b3f778635ee976a2f834478ba</span><br><span class="line">drwx--x--- 4 root root 4096 Sep 30 12:31 bd58ec4c3b456591049ce5ad929fac42a96ad23fc28836a29917039d07295ed4</span><br><span class="line">drwx--x--- 4 root root 4096 Sep 30 12:31 f3453bed47cc62a3d58d00327b6a76fbf15612220a7b1b4825936296fd0b845f</span><br><span class="line">drwx------ 2 root root 4096 Sep 30 12:31 l</span><br></pre></td></tr></table></figure>



<h3 id="layer-id-db-id"><a href="#layer-id-db-id" class="headerlink" title="layer id : db id"></a>layer id : db id</h3><ul>
<li>앞에가 <strong>layer id</strong>, 뒤에가 db id 이다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/image/overlay2/layerdb<span class="comment"># find . -name diff -exec cat &#123;&#125; \; -print</span></span><br><span class="line">sha256:311627f8702d2d97e63b916cad711aa9f962a1f20da5572d68b8f223ff051e73./sha256/311627f8702d2d97e63b916cad711aa9f962a1f20da5572d68b8f223ff051e73/diff</span><br><span class="line">sha256:674ca5344f959090515e9eac79055d8630851b21bbd584ac32765315284c05c5./sha256/a0e6c2974935e56e8d57d6fea041399b290da1566d82ea1a7d9c3ec7ef60a366/diff</span><br><span class="line">sha256:d9664e6da0f787fb8c04e80f1e731223f8ef93f6e097e934442e1792da614dff./sha256/89b7e61557f3502dc01aeae499b451574376c3e4c46e49294c72e22cd2d9634c/diff</span><br><span class="line">sha256:ed44ff7a11e0afd3e5b58c730514faeac7d6a12faff3f52aa33d33e0369e7aad./sha256/807d78e4cdc589c2cdefb7bb6049a31bcc7bf0f90f335a8a8de1abeb0e6a3993/diff</span><br><span class="line">sha256:7f8881cae5296e2ef0103706a326235494b5f1dcd9ea960656165cf7643ddd47./sha256/9f55692205d904037fbc69a1d59354665af3c0c2a767b5e799e719170085bc11/diff</span><br><span class="line">sha256:dca0e6f80e8df5d85d45426101fefba3d41abe4fc90be994074066d4b135bef5./sha256/a216b497301a9fc6283077c0906140e22b8f3a67ba92ab6253f036f48e1ff4b1/diff</span><br><span class="line">sha256:f21128d548a5122f430a58f123deb9c8b80f70b9fc98df280a9619b7e38b6a32./sha256/a3169fdf28b9329e3f1882c095bf11e12a465419c759169682ca706de81bef84/diff</span><br></pre></td></tr></table></figure>





<h3 id="parent-id-db-id"><a href="#parent-id-db-id" class="headerlink" title="parent id : db id"></a>parent id : db id</h3><ul>
<li><p>parent 파일은 부모레이어의 db id를 갖고 있음 (가장 밑바닥은 parent 없음)</p>
</li>
<li><p>sha256:”db-id”.&#x2F;sha256&#x2F;“parent-id”</p>
</li>
<li><p>311627f8702d2d97e63b916cad711aa9f962a1f20da5572d68b8f223ff051e73 가 최상위 부모 db -id 이다.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/image/overlay2/layerdb<span class="comment"># find . -name parent -exec cat &#123;&#125; \; -print</span></span><br><span class="line">sha256:311627f8702d2d97e63b916cad711aa9f962a1f20da5572d68b8f223ff051e73./sha256/a0e6c2974935e56e8d57d6fea041399b290da1566d82ea1a7d9c3ec7ef60a366/parent</span><br><span class="line">sha256:a216b497301a9fc6283077c0906140e22b8f3a67ba92ab6253f036f48e1ff4b1./sha256/89b7e61557f3502dc01aeae499b451574376c3e4c46e49294c72e22cd2d9634c/parent</span><br><span class="line">sha256:89b7e61557f3502dc01aeae499b451574376c3e4c46e49294c72e22cd2d9634c./sha256/807d78e4cdc589c2cdefb7bb6049a31bcc7bf0f90f335a8a8de1abeb0e6a3993/parent</span><br><span class="line">sha256:a0e6c2974935e56e8d57d6fea041399b290da1566d82ea1a7d9c3ec7ef60a366./sha256/9f55692205d904037fbc69a1d59354665af3c0c2a767b5e799e719170085bc11/parent</span><br><span class="line">sha256:a3169fdf28b9329e3f1882c095bf11e12a465419c759169682ca706de81bef84./sha256/a216b497301a9fc6283077c0906140e22b8f3a67ba92ab6253f036f48e1ff4b1/parent</span><br><span class="line">sha256:9f55692205d904037fbc69a1d59354665af3c0c2a767b5e799e719170085bc11./sha256/a3169fdf28b9329e3f1882c095bf11e12a465419c759169682ca706de81bef84/parent</span><br></pre></td></tr></table></figure>



<h3 id="레이어-스택"><a href="#레이어-스택" class="headerlink" title="레이어 스택"></a>레이어 스택</h3><ul>
<li>layer id : 레이어 식별</li>
<li>db id : 레이어관리</li>
<li>cache-id : 레이어 저장</li>
</ul>
<p><img src="/blog/img/layer-01.png"></p>
<h3 id="실제저장-위치"><a href="#실제저장-위치" class="headerlink" title="실제저장 위치"></a>실제저장 위치</h3><ul>
<li>cache id 폴더이름</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/overlay2<span class="comment"># tree -L 1</span></span><br><span class="line">.</span><br><span class="line">├── 067ec145f89b61cd0b6fd41745163c76e04f86db5b4a59a5358cc82a3099526a</span><br><span class="line">├── 20fae55020e28561082510b431ec0f85a8bb3a1cebb34f36916b91acc3833c84</span><br><span class="line">├── 52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d</span><br><span class="line">├── 5ebc10176fffee11727b0baa5f552146a74a4fa53935268e2c10726f08f61aa7</span><br><span class="line">├── 64c2e72761ef2dbf88db1e27bf590f901f5d0e7b3f778635ee976a2f834478ba</span><br><span class="line">├── bd58ec4c3b456591049ce5ad929fac42a96ad23fc28836a29917039d07295ed4</span><br><span class="line">├── f3453bed47cc62a3d58d00327b6a76fbf15612220a7b1b4825936296fd0b845f</span><br><span class="line">└── l</span><br></pre></td></tr></table></figure>

<ul>
<li>l 디렉터리에는 레이어 저장소(cache-id) 심볼릭 링크가 존재</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-08-31T14:00:30.000Z" title="2024. 8. 31. 오후 11:00:30">2024-08-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-21T22:20:08.968Z" title="2024. 9. 22. 오전 7:20:08">2024-09-22</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-overlayFS/">container/overlayFS</a></span><span class="level-item">13 minutes read (About 1996 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/08/31/docs/overlayFS/container-layer/">container layer</a></h1><div class="content"><ul>
<li>컨테이너 레이어구조 (overlayFS)를 알아보고, 장점에 대해 알아보자</li>
</ul>
<h3 id="docker-info-overlay2"><a href="#docker-info-overlay2" class="headerlink" title="docker info (overlay2)"></a>docker info (overlay2)</h3><ul>
<li>Storage Driver: overlay2</li>
<li>Docker Root Dir: &#x2F;var&#x2F;lib&#x2F;docker</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/<span class="comment"># docker info</span></span><br><span class="line">...</span><br><span class="line"> Storage Driver: overlay2</span><br><span class="line">...</span><br><span class="line"> Cgroup Driver: cgroupfs</span><br><span class="line">...</span><br><span class="line"> Docker Root Dir: /var/lib/docker</span><br><span class="line">...</span><br><span class="line">WARNING: No swap <span class="built_in">limit</span> support</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/<span class="comment"># docker info | grep Storage</span></span><br><span class="line">WARNING: No swap <span class="built_in">limit</span> support</span><br><span class="line"> Storage Driver: overlay2</span><br></pre></td></tr></table></figure>





<h2 id="도커-이미지-레이어-구조"><a href="#도커-이미지-레이어-구조" class="headerlink" title="도커 이미지 레이어 구조"></a>도커 이미지 레이어 구조</h2><ul>
<li>오버레이 파일시스템과 같음</li>
</ul>
<p>Image layers &#x3D;&#x3D; Lower Dir R&#x2F;O (Read Only, 읽기 전용)<br>Container layer &#x3D;&#x3D; Upper Dir  R&#x2F;W (Read-Write) - 컨테이너 실행 시 image layer 위에 올라감</p>
<ul>
<li>레이어 구조는 중복도 최소화하고 동일한 레이어를 사용할 경우 공유할 수 있어 저장공간을 절약한다.</li>
<li>대신 컨테이너에서 Image layer의 파일을 변경해야 할 경우에는 CoW (Copy-On-Write)로 동작한다.<ul>
<li>이 때, 변경할 파일을 Container layer(Thin R&#x2F;W layer)로 복사해 와서 처리해야 하므로, 일반적인 write와 비교해서 속도도 느리고 오버헤드가 발생한다. (따라서 Image layer의 파일 변경은 되도록 피해야 한다)</li>
</ul>
</li>
</ul>
<h3 id="도커-이미지삭제"><a href="#도커-이미지삭제" class="headerlink" title="도커 이미지삭제"></a>도커 이미지삭제</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">\# docker rm $(docker ps -a -q)</span><br><span class="line">\# docker rmi -f $(docker images -q)</span><br></pre></td></tr></table></figure>





<h3 id="레이어-구조"><a href="#레이어-구조" class="headerlink" title="레이어 구조"></a>레이어 구조</h3><ul>
<li>도커 이미지의 레이어 구조는 “GraphDriver”에 나타나 있다.</li>
<li>LowerDir 옵션은 콜론(:) 을 기준으로 여러개 레이어를 설정할 수 있다. 맨 뒤가 베이스레이어 이다.</li>
</ul>
<p><img src="/blog/img/layer-03.png"></p>
<p><img src="/blog/img/layer-04.png"></p>
<ul>
<li><p>베이스레이어 cache-id 로 들어가면 이미지 디렉토리가 보임</p>
</li>
<li><p>도커는 내부적으로 Debian 12 slim</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/overlay2/52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d/diff/etc<span class="comment"># cat issue</span></span><br><span class="line">Debian GNU/Linux 12 \n \l</span><br></pre></td></tr></table></figure>

<ul>
<li>debian:12-slim 는 nginx 이미지레이어에 이미 존재하므로 새로 받지 않는다.<ul>
<li>레이어는 받지 않지만, 이미지 정보에는 추가됨 (docker images)</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># docker pull debian:12-slim</span></span><br><span class="line">12-slim: Pulling from library/debian</span><br><span class="line">e886f0f47ef5: Already exists <span class="comment"># 해당 distribution id 는 이미 있다고 받지 않음</span></span><br><span class="line">Digest: sha256:24c92a69df28b21676d721fe18c0bf64138bfc69b486746ad935b49cc31b0b91</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> debian:12-slim</span><br><span class="line">docker.io/library/debian:12-slim</span><br></pre></td></tr></table></figure>

<ul>
<li>두 개 이미지의 레이어를 조회했을 때, 데비안은 nginx 의 레이어 중 하나와 공유한다.</li>
</ul>
<p><img src="/blog/img/layer-05.png"></p>
<p><img src="/blog/img/layer-06.png"></p>
<h3 id="이미지레이어-공유-확인"><a href="#이미지레이어-공유-확인" class="headerlink" title="이미지레이어 공유 확인"></a>이미지레이어 공유 확인</h3><ul>
<li>lowerDir의 실제 저장소에서 파일을 저장해본다<ul>
<li>** lowerDir는 RO인데, 이렇게 host권한을 이용하는건 어쩔수 없다. 컨테이너 실행중에 실제로 이런식으로 사용하면 안됨</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/overlay2/52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d/diff<span class="comment"># echo &quot;hello worled&quot; &gt; world</span></span><br></pre></td></tr></table></figure>

<ul>
<li>debian:12-slim 컨테이너실행 (두개실행한다)<ul>
<li>lowerDir에서 변경한 데이터 확인 가능</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># docker run -it debian:12-slim</span></span><br><span class="line">root@c267289b8c2b:/<span class="comment"># cat world</span></span><br><span class="line">hello worled</span><br></pre></td></tr></table></figure>



<ul>
<li>컨테이너 두개 구조를 살펴보면, LowerDir 은 Debian의 cache-id 에 있던 id와 같음을 알 수 있다.</li>
</ul>
<p><img src="/blog/img/layer-07.png"></p>
<p><img src="/blog/img/layer-02.png"></p>
<ul>
<li>컨테이너의 overlay 구조를 mount에서 파악 가능</li>
</ul>
<p><img src="/blog/img/layer-08.png"></p>
<ul>
<li>위 명령어결과에서 lowerDir 는 심볼릭링크 되어있는데, 따라가보면 실제 이미지저장장소가 나옴</li>
</ul>
<p><img src="/blog/img/layer-09.png"></p>
<h3 id="컨테이너-데이터-변경"><a href="#컨테이너-데이터-변경" class="headerlink" title="컨테이너 데이터 변경"></a>컨테이너 데이터 변경</h3><p>컨테이너의 쓰기는 UpperDir에서 이루어진다.</p>
<ul>
<li>컨테이너1에서 hello파일을 변경하면, 컨테이너1의 UpperDir에서 COW 가 이루어져 쓰기가 발생하고, 변경내용을 읽을 수 있다.</li>
<li>하지만 컨테이너2에서 world 파일을 변경한 내용은 읽을 수 없다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@c267289b8c2b:/<span class="comment"># cat world</span></span><br><span class="line">hello worled</span><br><span class="line">root@c267289b8c2b:/<span class="comment"># echo &quot;container mod&quot; &gt; hello</span></span><br><span class="line">root@c267289b8c2b:/<span class="comment"># cat hello</span></span><br><span class="line">container mod</span><br><span class="line">root@c267289b8c2b:/<span class="comment"># cat world</span></span><br><span class="line">hello worled</span><br></pre></td></tr></table></figure>

<ul>
<li>컨테이너2도 마찬가지.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@d082030bfc8f:/<span class="comment"># cat hello</span></span><br><span class="line">hello</span><br><span class="line">root@d082030bfc8f:/<span class="comment"># echo &quot;container2 mod&quot; &gt; world</span></span><br><span class="line">root@d082030bfc8f:/<span class="comment"># cat hello</span></span><br><span class="line">hello</span><br><span class="line">root@d082030bfc8f:/<span class="comment"># cat world</span></span><br><span class="line">container2 mod</span><br></pre></td></tr></table></figure>

<ul>
<li>lowerDir  에서도 컨테이너가 변경한 내용을 볼 수 없다.<ul>
<li>단지, lowerDir에서 다시 hello 파일 내용을 변경했을때, UpperDir 가존재하는 컨테이너1에서는 변경내용을 못읽지만</li>
<li>UpperDir가 없는 container2는 읽을 수 있다.</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/overlay2/52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d/diff<span class="comment"># cat hello</span></span><br><span class="line">hello</span><br><span class="line">root@seongtki:/var/lib/docker/overlay2/52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d/diff<span class="comment"># cat world</span></span><br><span class="line">hello worled</span><br></pre></td></tr></table></figure>

<ul>
<li>overlayFS 와 같은 개념이라고 보면 된다.</li>
</ul>
<p><img src="/blog/img/overlayfs2-01.png"></p>
<ul>
<li>history 로 이미지 distribution id 확인 가능.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/overlay2<span class="comment"># docker history nginx</span></span><br><span class="line">IMAGE          CREATED       CREATED BY                                      SIZE      COMMENT</span><br><span class="line">2a4fbb36e966   9 days ago    /bin/sh -c <span class="comment">#(nop)  CMD [&quot;nginx&quot; &quot;-g&quot; &quot;daemon…   0B</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop)  STOPSIGNAL SIGQUIT           0B</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop)  EXPOSE 80                    0B</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop)  ENTRYPOINT [&quot;/docker-entr…   0B</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop) COPY file:9e3b2b63db9f8fc7…   4.62kB</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop) COPY file:57846632accc8975…   3.02kB</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop) COPY file:3b1b9915b7dd898a…   298B</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop) COPY file:caec368f5a54f70a…   2.12kB</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop) COPY file:01e75c6dd0ce317d…   1.62kB</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="built_in">set</span> -x     &amp;&amp; groupadd --system -…   94.9MB</span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop)  ENV PKG_RELEASE=1~bookworm   0B</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop)  ENV NJS_VERSION=0.8.0        0B</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop)  ENV NGINX_VERSION=1.25.2     0B</span></span><br><span class="line">&lt;missing&gt;      9 days ago    /bin/sh -c <span class="comment">#(nop)  LABEL maintainer=NGINX Do…   0B</span></span><br><span class="line">&lt;missing&gt;      10 days ago   /bin/sh -c <span class="comment">#(nop)  CMD [&quot;bash&quot;]                 0B</span></span><br><span class="line">&lt;missing&gt;      10 days ago   /bin/sh -c <span class="comment">#(nop) ADD file:ec1a6e0aedd76c8fd…   97.1M</span></span><br></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~# docker run --nginx=nginx --rm -it 2a4fbb36e966</span><br><span class="line">unknown flag: --nginx</span><br><span class="line">See &#x27;docker run --help&#x27;.</span><br><span class="line">root@seongtki:~# docker run --nginx=nginx --rm -it 2a4fbb36e966 /bin/bash</span><br><span class="line">unknown flag: --nginx</span><br><span class="line">See &#x27;docker run --help&#x27;.</span><br><span class="line">root@seongtki:~# docker run --name=nginx --rm -it 2a4fbb36e966 /bin/bash</span><br><span class="line">root@0d2ed11b96f0:/# rm /bin/</span><br><span class="line">Display all 281 possibilities? (y or n)^C</span><br><span class="line">root@0d2ed11b96f0:/# rm /bin/cat</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/overlay2/52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d# docker container diff nginx</span><br><span class="line">C /usr</span><br><span class="line">C /usr/bin</span><br><span class="line">D /usr/bin/cat</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/overlay2/52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d# docker container commit nginx nginx:rm_cat</span><br><span class="line">sha256:6f8e2630eee109051d1878733b1d064b5e5158af1eae73f5a5a44a8b6c032d76</span><br><span class="line">root@seongtki:/var/lib/docker/overlay2/52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d# docker imsages</span><br><span class="line">docker: &#x27;imsages&#x27; is not a docker command.</span><br><span class="line">See &#x27;docker --help&#x27;</span><br><span class="line">root@seongtki:/var/lib/docker/overlay2/52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d# docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">nginx        rm_cat    6f8e2630eee1   9 seconds ago   192MB</span><br><span class="line">nginx        latest    2a4fbb36e966   10 days ago     192MB</span><br><span class="line">debian       12-slim   217435774160   10 days ago     97.1MB</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/var/lib/docker/overlay2/52943c6506870bd23a1bec337a8fcfc018fd0b6581be161ddc4d3bb0363b8b5d# docker history nginx:rm_cat</span><br><span class="line">IMAGE          CREATED          CREATED BY                                      SIZE      COMMENT</span><br><span class="line">6f8e2630eee1   29 seconds ago   /bin/bash                                       0B</span><br><span class="line">2a4fbb36e966   10 days ago      /bin/sh -c #(nop)  CMD [&quot;nginx&quot; &quot;-g&quot; &quot;daemon…   0B</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop)  STOPSIGNAL SIGQUIT           0B</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop)  EXPOSE 80                    0B</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop)  ENTRYPOINT [&quot;/docker-entr…   0B</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop) COPY file:9e3b2b63db9f8fc7…   4.62kB</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop) COPY file:57846632accc8975…   3.02kB</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop) COPY file:3b1b9915b7dd898a…   298B</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop) COPY file:caec368f5a54f70a…   2.12kB</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop) COPY file:01e75c6dd0ce317d…   1.62kB</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c set -x     &amp;&amp; groupadd --system -…   94.9MB</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop)  ENV PKG_RELEASE=1~bookworm   0B</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop)  ENV NJS_VERSION=0.8.0        0B</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop)  ENV NGINX_VERSION=1.25.2     0B</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop)  LABEL maintainer=NGINX Do…   0B</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop)  CMD [&quot;bash&quot;]                 0B</span><br><span class="line">&lt;missing&gt;      10 days ago      /bin/sh -c #(nop) ADD file:ec1a6e0aedd76c8fd…   97.1M</span><br></pre></td></tr></table></figure>





<h2 id="기존-이미지에-레이어-추가"><a href="#기존-이미지에-레이어-추가" class="headerlink" title="기존 이미지에 레이어 추가"></a>기존 이미지에 레이어 추가</h2><ul>
<li>컨테이너 실행후, 파일변경</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~<span class="comment"># docker run --name=nginx --rm -it 2a4fbb36e966 /bin/bash</span></span><br><span class="line">root@db6d1638925b:/<span class="comment"># rm /bin/ta</span></span><br><span class="line">tabs     <span class="built_in">tac</span>      <span class="built_in">tail</span>     tar      taskset</span><br><span class="line">root@db6d1638925b:/<span class="comment"># rm /bin/ta</span></span><br><span class="line">tabs     <span class="built_in">tac</span>      <span class="built_in">tail</span>     tar      taskset</span><br><span class="line">root@db6d1638925b:/<span class="comment"># rm /bin/tar</span></span><br></pre></td></tr></table></figure>

<ul>
<li>호스트에서 파일 변경 확인하고, 새로운 이미지로 커밋한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker container diff nginx</span><br><span class="line">docker container commit nginx nginx:rm_tar</span><br></pre></td></tr></table></figure>

<ul>
<li>새로운 레이어를 확인한다.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image inspect nginx:rm_tar | jq &#x27;.[].RootFS&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/layer-10.png"></p>
<ul>
<li><p>마지막에 layerid 하나가 추가되었다.</p>
</li>
<li><p>layerid 에대한 db-id 확인후, cacheid 를 확인해서 실제 레이어 저장소로 이동한다.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /var/lib/docker/image/overlay2/layerdb -name <span class="string">&quot;diff&quot;</span> -<span class="built_in">exec</span> <span class="built_in">cat</span> &#123;&#125; \; -<span class="built_in">print</span></span><br></pre></td></tr></table></figure>

<ul>
<li>writeout 정보가 있음을 확인.</li>
</ul>
<p><img src="/blog/img/layer-11.png"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-08-31T10:50:35.000Z" title="2024. 8. 31. 오후 7:50:35">2024-08-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-21T22:20:08.967Z" title="2024. 9. 22. 오전 7:20:08">2024-09-22</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-namespace/">container/namespace</a></span><span class="level-item">9 minutes read (About 1362 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/08/31/docs/namespace/mount-namespace/">mount namespace</a></h1><div class="content"><h2 id="네임스페이스-namespace"><a href="#네임스페이스-namespace" class="headerlink" title="네임스페이스(namespace)"></a>네임스페이스(namespace)</h2><ul>
<li>하나의 시스템에서 수행되지만, 각각 별개의 독립된 공간인 것처럼 <strong>격리된 환경을 제공</strong>하는 *<em>경량 프로세스 가상화 기술</em></li>
<li>경량 프로세스는 부모 프로세스와 자원을 공유하는 프로세스를 의미</li>
</ul>
<h3 id="LXC-LinuX-Container-의-네임스페이스는-6-종류와-플래그"><a href="#LXC-LinuX-Container-의-네임스페이스는-6-종류와-플래그" class="headerlink" title="LXC(LinuX Container)의 네임스페이스는 6 종류와 플래그"></a>LXC(LinuX Container)의 네임스페이스는 6 종류와 플래그</h3><ul>
<li><p>마운트 네임스페이스 : CLONE_NEWNS</p>
</li>
<li><p>UTS 네임스페이스 : CLONE_NEWUTS</p>
</li>
<li><p>IPC 네임스페이스 : CLONE_NEWIPC</p>
</li>
<li><p>PID 네임스페이스 : CLONE_NEWPID</p>
</li>
<li><p>사용자 네임스페이스 : CLONE_NEWUSER</p>
</li>
<li><p>네트워크 네임스페이스 : CLONE_NEWNET</p>
</li>
<li><p>상수플래그 정의 (&#x2F;usr&#x2F;include&#x2F;linux&#x2F;sched.h)</p>
</li>
</ul>
<p><img src="/blog/img/layer-12.png"></p>
<h3 id="마운트-mount-네임스페이스란"><a href="#마운트-mount-네임스페이스란" class="headerlink" title="마운트(mount) 네임스페이스란?"></a>마운트(mount) 네임스페이스란?</h3><ul>
<li>프로세스와 그 자식 프로세스가 각기 다른 파일시스템 마운트 지점을 제공</li>
<li>기본적으로 모든 프로세스는 동일한 기본 네임스페이스를 공유하기 때문에, 파일 시스템을 마운트하거나 마운트를 해제하는 등의 변경을 모든 프로세스가 인지할 수 있음</li>
<li>만약 clone() 시스템 콜을 통해 프로세스를 생성할 때 CLONE_NEWNS 플래그가 전달되면, 새로 생성되는 프로세스는 호출한 프로세스가 갖고있는 마운트 트리의 사본을 가져옴</li>
<li>이 사본은 부모 프로세스에 영향을 미치지 않고 새로 생성된 프로세스가 파일시스템을 마운트 or 언마운트 등의 변경을 할 수 있도록 함</li>
<li>이 시점부터 기본 네임스페이스의 모든 파일시스템 마운트 및 언마운트는 새로운 네임스페이스에서 볼 수 있지만, 각각의 프로세스 별 마운트 네임스페이스 내부에서의 변경을 해당 프로세스의 네임스페이스 밖에서는 알 수 없음</li>
</ul>
<p>마운트 네임스페이스는 “mount point”를 격리 한다.<br>여기서 mount란 루트파일시스템에 서브파일시스템을 부착하는 시스템콜이고, mount point는 파일시스템이 부착(mount) 될 위치(디렉터리)다.</p>
<p>mount 하면 원래 디렉터리가 포함하고 있던 파일, 하위 디렉터리 등이 보이지 않고, 새로 부착된 파일시스템의 파일들이 보이게 됩니다. 예를 들어 USB 드라이브를 지정한 mount point로 부착을 시키면, 해당 위치에는 부착된 USB의 파일들이 보이게 됩니다. </p>
<p>마운트 네임스페이스가 mount point를 격리한다는 것은 파일시스템 마운트와 해제 등의 변경사항들이 네임스페이스 밖에서는 보이지 않고, 외부에 전혀 영향을 주지 않음을 의미합니다. 마운트 네임스페이스가 생김으로써 컨테이너를 위해 pivot_root를 안전하게 실행할 수 있게 되었습니다.</p>
<h3 id="unshare-mount-namespace"><a href="#unshare-mount-namespace" class="headerlink" title="unshare mount namespace"></a>unshare mount namespace</h3><h3 id="mount-플래그를-unshared-시스템-콜에-전달"><a href="#mount-플래그를-unshared-시스템-콜에-전달" class="headerlink" title="mount 플래그를 unshared 시스템 콜에 전달"></a>mount 플래그를 unshared 시스템 콜에 전달</h3><ul>
<li>부모 프로세스의 mounts를 복제</li>
<li>현재 bash 프로세스를 자체 마운트 네임스페이스로 이동</li>
<li>“-m”옵션 -&gt; 마운트 네임스페이스</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unshare -m</span><br><span class="line">root@seongtki:/tmp<span class="comment"># mkdir tmp1</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>root filesystem이 같기 때문에 양쪽다 폴더가 보임</p>
</li>
<li><p>mount는 namespace 내부에서만 적용되어 보인다.</p>
</li>
<li><p>tmp1 : mount point</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp<span class="comment"># mount -o size=1m -t tmpfs tmpfs tmp1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp<span class="comment"># mount | grep tmp1</span></span><br><span class="line">tmpfs on /tmp/tmp1 <span class="built_in">type</span> tmpfs (rw,relatime,size=1024k)</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># readlink 심폴릭링크를 통해 namepsace id를 가져올 수 있다.</span></span><br><span class="line"><span class="comment"># /proc/$$ 는 현재 bash 쉘의 프로세스 ID(PID)</span></span><br><span class="line">$ <span class="built_in">readlink</span> /proc/$$/ns/mnt</span><br><span class="line">mnt:[4026532211]</span><br></pre></td></tr></table></figure>





<ul>
<li>host</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp<span class="comment"># mount | grep tmp1</span></span><br><span class="line">root@seongtki:/tmp<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<ul>
<li>mount namespace는 per-process mount isolation을 제공 (프로세스에 격리된 파일시스템 마운트 제공)</li>
</ul>
<h3 id="per-process-mount-isolation"><a href="#per-process-mount-isolation" class="headerlink" title="per-process mount isolation"></a>per-process mount isolation</h3><ul>
<li>new-root 에 nginx를 설치한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">export</span> $(docker create nginx:latest) | tar -C new-root -xvf -</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">1 directory, 0 files</span><br><span class="line">root@seongtki:/tmp/tmp1<span class="comment"># tree -L 1 new-root</span></span><br><span class="line">new-root</span><br><span class="line">├── bin -&gt; usr/bin</span><br><span class="line">├── boot</span><br><span class="line">├── dev</span><br><span class="line">├── docker-entrypoint.d</span><br><span class="line">├── docker-entrypoint.sh</span><br><span class="line">├── etc</span><br><span class="line">├── hello</span><br><span class="line">├── home</span><br><span class="line">├── lib -&gt; usr/lib</span><br><span class="line">├── media</span><br><span class="line">├── mnt</span><br><span class="line">├── opt</span><br><span class="line">├── proc</span><br><span class="line">├── root</span><br><span class="line">├── run</span><br><span class="line">├── sbin -&gt; usr/sbin</span><br><span class="line">├── srv</span><br><span class="line">├── sys</span><br><span class="line">├── tmp</span><br><span class="line">├── usr</span><br><span class="line">├── var</span><br><span class="line">└── world</span><br></pre></td></tr></table></figure>

<ul>
<li>mount</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp/tmp1<span class="comment"># mount -t tmpfs none new-root</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:/tmp/tmp1<span class="comment"># df -h | grep new</span></span><br><span class="line">none                               2.0G     0  2.0G   0% /tmp/tmp1/new-root</span><br></pre></td></tr></table></figure>



<h3 id="pivot-root-적용"><a href="#pivot-root-적용" class="headerlink" title="pivot_root 적용"></a>pivot_root 적용</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/<span class="comment"># mkdir old-root</span></span><br><span class="line">/<span class="comment"># pivot_root . old-root # 현재디렉토리를 루트파일시스템으로 하고, old-root 폴더에 기존 루트디렉토리를 마운트시킨다.</span></span><br><span class="line"></span><br><span class="line">/<span class="comment"># nginx -g &quot;daemon off;&quot; # nginx 실행</span></span><br></pre></td></tr></table></figure>



<ul>
<li>host에서 nginx pid를 이용해서 namespace id를 가져와 해당 파일시스템을 조회해본다.</li>
<li>lsns: 현존하는 namespace를 확인하기 위해 사용하는 명령어</li>
</ul>
<p><img src="/blog/img/layer-13.png"></p>
<ul>
<li>자체적인 루트파일시스템이 보장되므로 서버 환경 (시스템 파일, 의존성 라이브러리 충돌, 경로 설정 등) 으로 부터 자유롭다.</li>
<li>서버의 파일시스템으로 부터 완전하게 분리됨으로써 보안상 안전함</li>
<li>컨테이너 내에서 자유롭게 마운트 변경이 가능하고 파일시스템을 확장할 수 있다.</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-08-31T10:46:35.000Z" title="2024. 8. 31. 오후 7:46:35">2024-08-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-21T22:20:08.968Z" title="2024. 9. 22. 오전 7:20:08">2024-09-22</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-namespace/">container/namespace</a></span><span class="level-item">4 minutes read (About 666 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/08/31/docs/namespace/namespace/">network namespace</a></h1><div class="content"><ul>
<li>network namespace 개념에 대해 알아보고</li>
<li>namespace와 veth를 생성해서 1:1 통신 및 가상장치에 대한 테스트를 해보자</li>
</ul>
<h2 id="이더넷"><a href="#이더넷" class="headerlink" title="이더넷"></a>이더넷</h2><ul>
<li><p>컴퓨터 네트워킹의 한 방식이다,.</p>
</li>
<li><p>Layer 1(물리계층) - 신호&#x2F;배선 담당</p>
</li>
<li><p>Layer 2(데이터링크) - MAC 프로토콜 담당</p>
</li>
</ul>
<h2 id="MAC-address"><a href="#MAC-address" class="headerlink" title="MAC address"></a>MAC address</h2><ul>
<li>Media Access Control adress</li>
<li>Physical Address</li>
<li>16진수 옥텟 6개로 구분되어 있음</li>
</ul>
<p><img src="/blog/img/namespace-01.png"></p>
<h2 id="ARP-Address-Resolution-Protocol"><a href="#ARP-Address-Resolution-Protocol" class="headerlink" title="ARP (Address Resolution Protocol)"></a>ARP (Address Resolution Protocol)</h2><ul>
<li>ARP 프로토콜은 같은 같은 네트워크 대역에서 통신을 하기 위해 필요한 MAC주소를 IP주소를 이용해서 알아오는 프로토콜이다.</li>
<li>같은 네트워크 대역에서 통신을 한다고 하더라도 데이터를 보내기 위해서는 7계층부터 캡슐화를 통해 데이터를 보내기 때문에 IP주소와 MAC주소가 모두 필요하다.</li>
<li>이 때 IP주소는 알고 MAC주소는 모르더라도 ARP를 통해 통신이 가능하다.</li>
<li>브로드 캐스트 (FF:FF:FF:FF:FF:FF)</li>
<li>라우터는 자신의 MAC을 알려준다.</li>
</ul>
<p><img src="/blog/img/namespace-02.png"></p>
<h2 id="Network-namespace"><a href="#Network-namespace" class="headerlink" title="Network namespace"></a>Network namespace</h2><ul>
<li><p>호스트  안에 가상 네트워크를 생성할 수 있다.</p>
</li>
<li><p>네트워크를 isolation 하고 네트워크 stack (OSL 7Layer)을 가상화한다.</p>
<ul>
<li>Isolates network and virtualize network stack</li>
</ul>
</li>
<li><p>ip주소, 라우트 테이블, 소켓, 방화벽 등이 별도 가상화 네트워크에 준비된다.</p>
</li>
</ul>
<p><img src="/blog/img/namespace-03.png"></p>
<h3 id="Network-interface-랜카드-라고-생각하면-편하다"><a href="#Network-interface-랜카드-라고-생각하면-편하다" class="headerlink" title="Network interface (랜카드 라고 생각하면 편하다)"></a>Network interface (랜카드 라고 생각하면 편하다)</h3><ul>
<li>가상의 디바이스를 생성하고 마치 랜카드 끼우는 것 처럼 옮겨다니며 장착할 수 있다.<ul>
<li>Network interface is present in exactly 1 namespace</li>
<li>Network interface can ve moved between namespaces</li>
</ul>
</li>
</ul>
<h3 id="Delete-Network-interface"><a href="#Delete-Network-interface" class="headerlink" title="Delete Network interface"></a>Delete Network interface</h3><ul>
<li>네트워크 네임스페이스를 삭제하면 포함된 모든 가상장치가 삭제된다.</li>
</ul>
<h2 id="namespace-1-1-통신"><a href="#namespace-1-1-통신" class="headerlink" title="namespace 1:1 통신"></a>namespace 1:1 통신</h2><h4 id="veth-virtual-etcernet-두-개가-서로-통신을-할-수-있다"><a href="#veth-virtual-etcernet-두-개가-서로-통신을-할-수-있다" class="headerlink" title="veth(virtual etcernet) 두 개가 서로 통신을 할 수 있다."></a>veth(virtual etcernet) 두 개가 서로 통신을 할 수 있다.</h4><ul>
<li>랜카드 두 개를 랜선으로 연결 했다고 생각하면 된다.</li>
</ul>
<h3 id="통신-준비작업"><a href="#통신-준비작업" class="headerlink" title="통신 준비작업"></a>통신 준비작업</h3><ul>
<li>네트워크 네임스페이스 2개 생성 (red, blue)</li>
<li>veth 두개를 pair 로 생성해준다</li>
<li>네임스페이스에 각각의 veth를 링크해준다.</li>
<li>링크 후 veth의 전원을 켜준다.</li>
<li>해당 네임스페이스의 veth에 ip를 할당해준다.<ul>
<li>dev: “name” # 주소를 정할 장치 명</li>
</ul>
</li>
<li><a href="./namespace-test.md">테스트 내용</a></li>
</ul>
<p><img src="/blog/img/namespace-04.png"></p>
<h2 id="리눅스-참고-프로그램"><a href="#리눅스-참고-프로그램" class="headerlink" title="리눅스 참고 프로그램"></a>리눅스 참고 프로그램</h2><h3 id="nsenter"><a href="#nsenter" class="headerlink" title="nsenter"></a>nsenter</h3><ul>
<li><p>네임스페이스에 attach하여 지정한 프로그램을 실행한다.</p>
</li>
<li><p>COMMAND: 지정하지 않으면 $shell 실행</p>
</li>
<li><p>Option: –net: “net namespace”</p>
</li>
<li><p>man nsenter</p>
</li>
<li><pre><code>$ nsenter --net=/var/run/netns/red
</code></pre>
</li>
</ul>
<h3 id="ip-addr-show-ip-addr"><a href="#ip-addr-show-ip-addr" class="headerlink" title="ip addr show (ip addr)"></a>ip addr show (ip addr)</h3><ul>
<li>네트워크 장치를 확인</li>
</ul>
<h3 id="ip-neigh-show-default-show"><a href="#ip-neigh-show-default-show" class="headerlink" title="ip neigh show(default show)"></a>ip neigh show(default show)</h3><ul>
<li>arp tables management</li>
<li>Man ip-neighbour</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-08-31T10:43:35.000Z" title="2024. 8. 31. 오후 7:43:35">2024-08-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-21T22:20:08.968Z" title="2024. 9. 22. 오전 7:20:08">2024-09-22</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/container-namespace/">container/namespace</a></span><span class="level-item">4 minutes read (About 634 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2024/08/31/docs/namespace/namespace-test/">network namespace test</a></h1><div class="content"><ul>
<li>namespace, veth 등을 생성해서 1:1 통신을 해보자.</li>
</ul>
<h2 id="테스트"><a href="#테스트" class="headerlink" title="테스트"></a>테스트</h2><h3 id="namespace-virture-ethernet-ip-설정"><a href="#namespace-virture-ethernet-ip-설정" class="headerlink" title="namespace, virture ethernet, ip 설정"></a>namespace, virture ethernet, ip 설정</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ip link</span><br><span class="line">$ ip netns</span><br><span class="line">$ ip netns add red</span><br><span class="line">$ ip netns add blue</span><br><span class="line">$ ip link add veth-red type veth peer name veth-blue</span><br><span class="line">$ ip link set veth-red netns red</span><br><span class="line">$ ip link set veth-blue netns blue</span><br><span class="line">$ ip netns exec red ip link set veth-red up</span><br><span class="line">$ ip netns exec blue ip link set veth-blue up</span><br><span class="line">$ ip netns exec red ip addr add 1.1.1.1/24 dev veth-red</span><br><span class="line">$ ip netns exec blue ip addr add 1.1.1.2/24 dev veth-blue</span><br></pre></td></tr></table></figure>



<h3 id="Blue-namesace"><a href="#Blue-namesace" class="headerlink" title="Blue namesace"></a>Blue namesace</h3><ul>
<li>tcpdump 실행</li>
<li>red ns 에서 ping 요청을 하면, arp table에 등록 후, 해당 mac 으로 응답을 보내고</li>
<li>이 후 icmp 요청에 대한 응답을 처리한다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ nsenter --net=/var/run/netns/blue</span><br><span class="line">$ tcpdump -li veth-blue</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on veth-blue, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">07:12:35.267019 ARP, Request who-has 1.1.1.2 tell 1.1.1.1, length 28</span><br><span class="line">07:12:35.267034 ARP, Reply 1.1.1.2 is-at 4e:87:56:0c:9e:d0 (oui Unknown), length 28</span><br><span class="line">07:12:35.267037 IP 1.1.1.1 &gt; 1.1.1.2: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 1758, <span class="built_in">seq</span> 1, length 64</span><br><span class="line">07:12:35.267045 IP 1.1.1.2 &gt; 1.1.1.1: ICMP <span class="built_in">echo</span> reply, <span class="built_in">id</span> 1758, <span class="built_in">seq</span> 1, length 64</span><br><span class="line">07:12:36.268644 IP 1.1.1.1 &gt; 1.1.1.2: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 1758, <span class="built_in">seq</span> 2, length 64</span><br></pre></td></tr></table></figure>

<ul>
<li>arp 정보 조회</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ip neigh show</span><br><span class="line">1.1.1.1 dev veth-blue lladdr f6:e9:d4:cf:26:3a STALE</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@seongtki:~# arp</span><br><span class="line">Address                  HWtype  HWaddress           Flags Mask            Iface</span><br><span class="line">1.1.1.1                  ether   f6:e9:d4:cf:26:3a   C                     veth-blue</span><br></pre></td></tr></table></figure>

<ul>
<li>각종 정보 조회</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ ip address show</span><br><span class="line">1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">5: veth-blue@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether 4e:87:56:0c:9e:d0 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 1.1.1.2/24 scope global veth-blue</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::4c87:56ff:fe0c:9ed0/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line">$ bridge fdb show</span><br><span class="line">33:33:00:00:00:01 dev veth-blue self permanent</span><br><span class="line">01:00:5e:00:00:01 dev veth-blue self permanent</span><br><span class="line">33:33:ff:0c:9e:d0 dev veth-blue self permanent</span><br><span class="line"></span><br><span class="line">$ ip route show</span><br><span class="line">1.1.1.0/24 dev veth-blue proto kernel scope link src 1.1.1.2</span><br><span class="line"></span><br><span class="line">$ iptables -S</span><br><span class="line">-P INPUT ACCEPT</span><br><span class="line">-P FORWARD ACCEPT</span><br><span class="line">-P OUTPUT ACCEPT</span><br></pre></td></tr></table></figure>





<h3 id="red-namesace"><a href="#red-namesace" class="headerlink" title="red namesace"></a>red namesace</h3><ul>
<li>blue ns로 ping을 보낸다. </li>
<li>처음엔 arp 정보가 없는데, arp 응답이 오게 되면 arp table 등록 후 icmp 통시을 하게 된다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ nsenter --net=/var/run/netns/red</span><br><span class="line"></span><br><span class="line">PING 1.1.1.2 (1.1.1.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 1.1.1.2: icmp_seq=1 ttl=64 time=0.041 ms</span><br><span class="line">64 bytes from 1.1.1.2: icmp_seq=2 ttl=64 time=0.045 ms</span><br><span class="line">64 bytes from 1.1.1.2: icmp_seq=3 ttl=64 time=0.061 ms</span><br></pre></td></tr></table></figure>

<ul>
<li>arp 정보 조회</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ip neigh show</span><br><span class="line">1.1.1.2 dev veth-red lladdr 4e:87:56:0c:9e:d0 STAL</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ arp</span><br><span class="line">Address                  HWtype  HWaddress           Flags Mask            Iface</span><br><span class="line">1.1.1.2                  ether   4e:87:56:0c:9e:d0   C                     veth-red</span><br></pre></td></tr></table></figure>

<ul>
<li>각종 정보 조회</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ ip address show</span><br><span class="line">1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">6: veth-red@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether f6:e9:d4:cf:26:3a brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class="line">    inet 1.1.1.1/24 scope global veth-red</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::f4e9:d4ff:fecf:263a/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line">$ bridge fdb show</span><br><span class="line">33:33:00:00:00:01 dev veth-red self permanent</span><br><span class="line">01:00:5e:00:00:01 dev veth-red self permanent</span><br><span class="line">33:33:ff:cf:26:3a dev veth-red self permanent</span><br><span class="line"></span><br><span class="line">$ ip route show</span><br><span class="line">1.1.1.0/24 dev veth-red proto kernel scope <span class="built_in">link</span> src 1.1.1.1</span><br><span class="line"></span><br><span class="line">$ iptables -S</span><br><span class="line">-P INPUT ACCEPT</span><br><span class="line">-P FORWARD ACCEPT</span><br><span class="line">-P OUTPUT ACCEPT</span><br></pre></td></tr></table></figure>





<h3 id="삭제"><a href="#삭제" class="headerlink" title="삭제"></a>삭제</h3><ul>
<li>테스트를 후 생성한 리소들을 삭제해준다.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ip -n <span class="string">&quot;netns name&quot;</span> <span class="built_in">link</span> del <span class="string">&quot;veth-red&quot;</span></span><br><span class="line">$ ip netns del <span class="string">&quot;name&quot;</span></span><br></pre></td></tr></table></figure>















</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/blog/page/2/">Previous</a></div><div class="pagination-next"><a href="/blog/page/4/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/blog/">1</a></li><li><a class="pagination-link" href="/blog/page/2/">2</a></li><li><a class="pagination-link is-current" href="/blog/page/3/">3</a></li><li><a class="pagination-link" href="/blog/page/4/">4</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/blog/img/avatar.png" alt="Seongtaek Kim"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Seongtaek Kim</p><p class="is-size-6 is-block">Blog</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/blog/archives"><p class="title">36</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/blog/categories"><p class="title">25</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/blog/tags"><p class="title">0</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/seongtaekkim"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Linkedin" href="https://linkedin.com/in/staek"><i class="fab fa-linkedin"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/blog/categories/calico-communication/"><span class="level-start"><span class="level-item">calico/communication</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/calico-concept/"><span class="level-start"><span class="level-item">calico/concept</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/calico-networkmode/"><span class="level-start"><span class="level-item">calico/networkmode</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-cgroup/"><span class="level-start"><span class="level-item">container/cgroup</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-namespace/"><span class="level-start"><span class="level-item">container/namespace</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-overlayFS/"><span class="level-start"><span class="level-item">container/overlayFS</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-overlaynetwork/"><span class="level-start"><span class="level-item">container/overlaynetwork</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/gateway-gatewayapi/"><span class="level-start"><span class="level-item">gateway/gatewayapi</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/gateway-gloo/"><span class="level-start"><span class="level-item">gateway/gloo</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/ingress-ingress/"><span class="level-start"><span class="level-item">ingress/ingress</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-bookinfo/"><span class="level-start"><span class="level-item">istio/bookinfo</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-envoy/"><span class="level-start"><span class="level-item">istio/envoy</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-istio-outline/"><span class="level-start"><span class="level-item">istio/istio-outline</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-istio-test/"><span class="level-start"><span class="level-item">istio/istio-test</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-istio-traffic/"><span class="level-start"><span class="level-item">istio/istio-traffic</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/k8s-PAUSE-Container/"><span class="level-start"><span class="level-item">k8s/PAUSE-Container</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/k8s-flannel/"><span class="level-start"><span class="level-item">k8s/flannel</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/k8s-kind/"><span class="level-start"><span class="level-item">k8s/kind</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-ipvs/"><span class="level-start"><span class="level-item">loadbaleancer/ipvs</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-ipvs-install/"><span class="level-start"><span class="level-item">loadbaleancer/ipvs-install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-metalLB/"><span class="level-start"><span class="level-item">loadbaleancer/metalLB</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-metalLB-install/"><span class="level-start"><span class="level-item">loadbaleancer/metalLB-install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/serivce-clusterip/"><span class="level-start"><span class="level-item">serivce/clusterip</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/serivce-install/"><span class="level-start"><span class="level-item">serivce/install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/serivce-nodeport/"><span class="level-start"><span class="level-item">serivce/nodeport</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-10-19T19:30:35.000Z">2024-10-20</time></p><p class="title"><a href="/blog/2024/10/20/docs/istio/istio-traffic/">istio-traffic</a></p><p class="categories"><a href="/blog/categories/istio-istio-traffic/">istio/istio-traffic</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-10-19T18:30:35.000Z">2024-10-20</time></p><p class="title"><a href="/blog/2024/10/20/docs/istio/istio-install/">istio-test</a></p><p class="categories"><a href="/blog/categories/istio-istio-test/">istio/istio-test</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-10-19T18:00:35.000Z">2024-10-20</time></p><p class="title"><a href="/blog/2024/10/20/docs/istio/bookinfo/">bookinfo</a></p><p class="categories"><a href="/blog/categories/istio-bookinfo/">istio/bookinfo</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-10-19T17:30:35.000Z">2024-10-20</time></p><p class="title"><a href="/blog/2024/10/20/docs/istio/envoy/">envoy</a></p><p class="categories"><a href="/blog/categories/istio-envoy/">istio/envoy</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-10-19T17:00:35.000Z">2024-10-20</time></p><p class="title"><a href="/blog/2024/10/20/docs/istio/outline/">istio-outline</a></p><p class="categories"><a href="/blog/categories/istio-istio-outline/">istio/istio-outline</a></p></div></article></div></div><!--!--></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/blog/">Blog</a><p class="is-size-7"><span>&copy; 2024 Seongtaek Kim</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/blog/js/column.js"></script><script src="/blog/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/blog/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/blog/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/blog/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/blog/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>