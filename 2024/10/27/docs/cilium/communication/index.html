<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>communication - Blog</title><link rel="manifest" href="/blog/manifest.json"><meta name="application-name" content="Blog"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="노드 간 파드 통신 확인파드생성 및 확인 123456789101112131415161718192021222324252627282930313233343536373839404142cat &amp;lt;&amp;lt;EOF | kubectl create -f -apiVersion: v1kind: Podmetadata:  name: netpod  labels:    app: n"><meta property="og:type" content="blog"><meta property="og:title" content="communication"><meta property="og:url" content="https://seongtaekkim.github.io/blog/2024/10/27/docs/cilium/communication/"><meta property="og:site_name" content="Blog"><meta property="og:description" content="노드 간 파드 통신 확인파드생성 및 확인 123456789101112131415161718192021222324252627282930313233343536373839404142cat &amp;lt;&amp;lt;EOF | kubectl create -f -apiVersion: v1kind: Podmetadata:  name: netpod  labels:    app: n"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://seongtaekkim.github.io/blog/img/cilium-11.png"><meta property="og:image" content="https://seongtaekkim.github.io/blog/img/cilium-12.png"><meta property="og:image" content="https://seongtaekkim.github.io/blog/img/cilium-13.png"><meta property="og:image" content="https://seongtaekkim.github.io/blog/img/cilium-18.png"><meta property="og:image" content="https://seongtaekkim.github.io/blog/img/cilium-19.png"><meta property="og:image" content="https://seongtaekkim.github.io/blog/img/cilium-14.png"><meta property="og:image" content="https://seongtaekkim.github.io/blog/img/cilium-15.png"><meta property="og:image" content="https://seongtaekkim.github.io/blog/img/cilium-16.png"><meta property="og:image" content="https://seongtaekkim.github.io/blog/img/cilium-17.png"><meta property="article:published_time" content="2024-10-26T17:00:35.000Z"><meta property="article:modified_time" content="2024-10-26T17:22:26.773Z"><meta property="article:author" content="Seongtaek Kim"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://seongtaekkim.github.io/blog/img/cilium-11.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://seongtaekkim.github.io/blog/2024/10/27/docs/cilium/communication/"},"headline":"communication","image":["https://seongtaekkim.github.io/blog/img/cilium-11.png","https://seongtaekkim.github.io/blog/img/cilium-12.png","https://seongtaekkim.github.io/blog/img/cilium-13.png","https://seongtaekkim.github.io/blog/img/cilium-18.png","https://seongtaekkim.github.io/blog/img/cilium-19.png","https://seongtaekkim.github.io/blog/img/cilium-14.png","https://seongtaekkim.github.io/blog/img/cilium-15.png","https://seongtaekkim.github.io/blog/img/cilium-16.png","https://seongtaekkim.github.io/blog/img/cilium-17.png"],"datePublished":"2024-10-26T17:00:35.000Z","dateModified":"2024-10-26T17:22:26.773Z","author":{"@type":"Person","name":"Seongtaek Kim"},"publisher":{"@type":"Organization","name":"Blog","logo":{"@type":"ImageObject"}},"description":"노드 간 파드 통신 확인파드생성 및 확인 123456789101112131415161718192021222324252627282930313233343536373839404142cat &lt;&lt;EOF | kubectl create -f -apiVersion: v1kind: Podmetadata:  name: netpod  labels:    app: n"}</script><link rel="canonical" href="https://seongtaekkim.github.io/blog/2024/10/27/docs/cilium/communication/"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/blog/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/blog/">Blog</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/blog/">Home</a><a class="navbar-item" href="/blog/archives">Archives</a><a class="navbar-item" href="/blog/categories">Categories</a><a class="navbar-item" href="/blog/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-10-26T17:00:35.000Z" title="2024. 10. 27. 오전 2:00:35">2024-10-27</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-10-26T17:22:26.773Z" title="2024. 10. 27. 오전 2:22:26">2024-10-27</time></span><span class="level-item"><a class="link-muted" href="/blog/categories/cilium-communication/">cilium/communication</a></span><span class="level-item">23 minutes read (About 3411 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">communication</h1><div class="content"><h2 id="노드-간-파드-통신-확인"><a href="#노드-간-파드-통신-확인" class="headerlink" title="노드 간 파드 통신 확인"></a>노드 간 파드 통신 확인</h2><p>파드생성 및 확인</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl create -f -</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: netpod</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: netpod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  nodeName: k8s-s</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: netshoot-pod</span></span><br><span class="line"><span class="string">    image: nicolaka/netshoot</span></span><br><span class="line"><span class="string">    command: [&quot;tail&quot;]</span></span><br><span class="line"><span class="string">    args: [&quot;-f&quot;, &quot;/dev/null&quot;]</span></span><br><span class="line"><span class="string">  terminationGracePeriodSeconds: 0</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: webpod1</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: webpod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  nodeName: k8s-w1</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: container</span></span><br><span class="line"><span class="string">    image: traefik/whoami</span></span><br><span class="line"><span class="string">  terminationGracePeriodSeconds: 0</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: webpod2</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: webpod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  nodeName: k8s-w2</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: container</span></span><br><span class="line"><span class="string">    image: traefik/whoami</span></span><br><span class="line"><span class="string">  terminationGracePeriodSeconds: 0</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 확인</span></span><br><span class="line">kubectl get pod -o wide</span><br><span class="line">c0 status --verbose | grep Allocated -A5</span><br><span class="line">c1 status --verbose | grep Allocated -A5</span><br><span class="line">c2 status --verbose | grep Allocated -A5</span><br><span class="line"></span><br><span class="line">kubectl get ciliumendpoints</span><br><span class="line">kubectl get ciliumendpoints -A</span><br><span class="line">c0 endpoint list</span><br><span class="line">c0 bpf endpoint list</span><br><span class="line">c0 map get cilium_lxc</span><br><span class="line">c0 ip list</span><br></pre></td></tr></table></figure>

<p>파드 변수 지정</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 테스트 파드들 IP</span></span><br><span class="line">NETPODIP=$(kubectl get pods netpod -o jsonpath=<span class="string">&#x27;&#123;.status.podIP&#125;&#x27;</span>)</span><br><span class="line">WEBPOD1IP=$(kubectl get pods webpod1 -o jsonpath=<span class="string">&#x27;&#123;.status.podIP&#125;&#x27;</span>)</span><br><span class="line">WEBPOD2IP=$(kubectl get pods webpod2 -o jsonpath=<span class="string">&#x27;&#123;.status.podIP&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 단축키(alias) 지정</span></span><br><span class="line"><span class="built_in">alias</span> p0=<span class="string">&quot;kubectl exec -it netpod  -- &quot;</span></span><br><span class="line"><span class="built_in">alias</span> p1=<span class="string">&quot;kubectl exec -it webpod1 -- &quot;</span></span><br><span class="line"><span class="built_in">alias</span> p2=<span class="string">&quot;kubectl exec -it webpod2 -- &quot;</span></span><br></pre></td></tr></table></figure>



<p>파드의 ARP 동작 확인 ← Hubble Web UI 모니터링</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># netpod 네트워크 정보 확인</span></span><br><span class="line">p0 ip -c -4 addr</span><br><span class="line">p0 route -n</span><br><span class="line">p0 ping -c 1 <span class="variable">$WEBPOD1IP</span> &amp;&amp; p0 ping -c 1 <span class="variable">$WEBPOD2IP</span></span><br><span class="line">p0 curl -s <span class="variable">$WEBPOD1IP</span> &amp;&amp; p0 curl -s <span class="variable">$WEBPOD2IP</span></span><br><span class="line">p0 curl -s <span class="variable">$WEBPOD1IP</span>:8080 ; p0 curl -s <span class="variable">$WEBPOD2IP</span>:8080</span><br><span class="line">p0 ping -c 1 8.8.8.8 &amp;&amp; p0 curl -s wttr.in/seoul</span><br><span class="line">p0 ip -c neigh</span><br><span class="line"></span><br><span class="line"><span class="comment"># hubble cli 확인</span></span><br><span class="line">hubble observe --pod netpod</span><br><span class="line">hubble observe --pod webpod1</span><br><span class="line">hubble observe --pod webpod2</span><br><span class="line"></span><br><span class="line"><span class="comment"># BPF maps : 목적지 파드와 통신 시 어느곳으로 보내야 될지 확인할 수 있다</span></span><br><span class="line">c0 map get cilium_ipcache</span><br><span class="line">c0 map get cilium_ipcache | grep <span class="variable">$WEBPOD1IP</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># netpod 의 LXC 변수 지정</span></span><br><span class="line">LXC=&lt;k8s-s의 가장 나중에 lxc 이름&gt;</span><br><span class="line">LXC=lxc335e04832afa</span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드와 veth pair 에 IP가 없다! proxy_arp 도 없다! 하지만 GW MAC 요청 시 lxc(veth)의 MAC 으로 응답이 온다! &gt;&gt; eBPF Magic!</span></span><br><span class="line"><span class="comment"># Cilium hijacks ARP table of POD1, forces the next hop to be the peer end (host side) of the veth pair.</span></span><br><span class="line">ip -c addr show dev <span class="variable">$LXC</span></span><br></pre></td></tr></table></figure>



<p>Node’s eBPF programs</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># list of eBPF programs</span></span><br><span class="line">c0bpf net show</span><br><span class="line">c0bpf net show | grep <span class="variable">$LXC</span></span><br><span class="line">lxc335e04832afa(12) tcx/ingress cil_from_container prog_id 1529 link_id 26 </span><br><span class="line">lxc335e04832afa(12) tcx/egress cil_to_container prog_id 1531 link_id 27 </span><br><span class="line"></span><br><span class="line"><span class="comment"># Use bpftool prog show id to view additional information about a program, including a list of attached eBPF maps:</span></span><br><span class="line">c0bpf prog show <span class="built_in">id</span> &lt;출력된 prog <span class="built_in">id</span> 입력&gt;</span><br><span class="line">c0bpf prog show <span class="built_in">id</span> 1529</span><br><span class="line">1531: sched_cls  name cil_to_container  tag 3f1e92871a2c4013  gpl</span><br><span class="line">	loaded_at 2024-10-20T07:47:27+0000  uid 0</span><br><span class="line">	xlated 1712B  jited 1015B  memlock 4096B  map_ids 66,239</span><br><span class="line">	btf_id 474</span><br><span class="line"></span><br><span class="line">c0bpf map list</span><br><span class="line">...</span><br><span class="line">66: percpu_hash  name cilium_metrics  flags 0x1</span><br><span class="line">	key 8B  value 16B  max_entries 1024  memlock 19384B</span><br><span class="line">...</span><br><span class="line">239: prog_array  name cilium_calls_00  flags 0x0</span><br><span class="line">	key 4B  value 4B  max_entries 50  memlock 720B</span><br><span class="line">	owner_prog_type sched_cls  owner jited</span><br><span class="line">...</span><br></pre></td></tr></table></figure>





<h2 id="서비스-통신-확인"><a href="#서비스-통신-확인" class="headerlink" title="서비스 통신 확인"></a>서비스 통신 확인</h2><h3 id="Socket-Based-LoadBalancing-소개-한글-링크"><a href="#Socket-Based-LoadBalancing-소개-한글-링크" class="headerlink" title="Socket-Based LoadBalancing 소개 (한글) - 링크"></a>Socket-Based LoadBalancing 소개 (한글) - <a target="_blank" rel="noopener" href="https://velog.io/@haruband/K8SCilium-Socket-Based-LoadBalancing-%EA%B8%B0%EB%B2%95">링크</a></h3><p>그림 왼쪽(네트워크 기반 로드밸런싱) vs 오른쪽(소켓 기반 로드밸런싱)</p>
<p><img src="/blog/img/cilium-11.png"></p>
<p>Pod1 안에서 동작하는 앱이 connect() 시스템콜을 이용하여 소켓을 연결할 때 목적지 주소가 서비스 주소(10.10.8.55)이면 소켓의 목적지 주소를 바로 백엔드 주소(10.0.0.31)로 설정한다. 이후 앱에서 해당 소켓을 통해 보내는 모든 패킷의 목적지 주소는 이미 백엔드 주소(10.0.0.31)로 설정되어 있기 때문에 중간에 DNAT 변환 및 역변환 과정이 필요없어진다.</p>
<h3 id="서비스-생성-및-접속-확인-파드-내에서-바로-DNAT-Magic"><a href="#서비스-생성-및-접속-확인-파드-내에서-바로-DNAT-Magic" class="headerlink" title="서비스 생성 및 접속 확인 : 파드 내에서 바로 DNAT! Magic"></a>서비스 생성 및 접속 확인 : 파드 내에서 바로 DNAT! Magic</h3><p>서비스 생성</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&lt;&lt;EOF</span> <span class="string">|</span> <span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="bullet">-</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">svc-webport</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">webpod</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>



<p>서비스 접속 확인</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 서비스 생성 확인</span></span><br><span class="line">kubectl get svc,ep svc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 노드에 iptables 더이상 KUBE-SVC rule 이 생성되지 않는다!</span></span><br><span class="line">iptables-save | grep KUBE-SVC</span><br><span class="line">iptables-save | grep CILIUM</span><br><span class="line"></span><br><span class="line"><span class="comment"># 서비스IP를 변수에 지정</span></span><br><span class="line">SVCIP=$(kubectl get svc svc -o jsonpath=<span class="string">&#x27;&#123;.spec.clusterIP&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pod1 에서 Service(ClusterIP) 접속 트래픽 발생</span></span><br><span class="line">kubectl <span class="built_in">exec</span> netpod -- curl -s <span class="variable">$SVCIP</span></span><br><span class="line">kubectl <span class="built_in">exec</span> netpod -- curl -s <span class="variable">$SVCIP</span> | grep Hostname</span><br><span class="line"></span><br><span class="line"><span class="comment"># 지속적으로 접속 트래픽 발생</span></span><br><span class="line">SVCIP=$(kubectl get svc svc -o jsonpath=<span class="string">&#x27;&#123;.spec.clusterIP&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> kubectl <span class="built_in">exec</span> netpod -- curl -s <span class="variable">$SVCIP</span> | grep Hostname;<span class="built_in">echo</span> <span class="string">&quot;-----&quot;</span>;<span class="built_in">sleep</span> 1;<span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드에서 SVC(ClusterIP) 접속 시 tcpdump 로 확인 &gt;&gt; 파드 내부 캡쳐인데, SVC(10.108.12.195)는 보이지 않고, DNAT 된 web-pod 의 IP가 확인! Magic!</span></span><br><span class="line">kubectl <span class="built_in">exec</span> netpod -- tcpdump -enni any -q</span><br><span class="line">tcpdump: data <span class="built_in">link</span> <span class="built_in">type</span> LINUX_SLL2</span><br><span class="line">tcpdump: verbose output suppressed, use -v[v]... <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes</span><br><span class="line">16:04:05.292279 eth0  Out ifindex 13 e2:<span class="built_in">dd</span>:e4:3f:03:ba 172.16.0.13.47278 &gt; 172.16.2.11.80: tcp 0</span><br><span class="line">16:04:05.292795 eth0  In  ifindex 13 0a:62:8c:a5:1e:08 172.16.2.11.80 &gt; 172.16.0.13.47278: tcp 0</span><br><span class="line">16:04:05.292833 eth0  Out ifindex 13 e2:<span class="built_in">dd</span>:e4:3f:03:ba 172.16.0.13.47278 &gt; 172.16.2.11.80: tcp 0</span><br><span class="line">16:04:05.292886 eth0  Out ifindex 13 e2:<span class="built_in">dd</span>:e4:3f:03:ba 172.16.0.13.47278 &gt; 172.16.2.11.80: tcp 74</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl <span class="built_in">exec</span> netpod -- sh -c <span class="string">&quot;ngrep -tW byline -d eth0 &#x27;&#x27; &#x27;tcp port 80&#x27;&quot;</span></span><br><span class="line">T 2024/10/20 08:07:36.663329 172.16.0.132:59964 -&gt; 172.16.1.53:80 [AP] <span class="comment">#34</span></span><br><span class="line">GET / HTTP/1.1.</span><br><span class="line">Host: 10.10.124.15.</span><br><span class="line">User-Agent: curl/8.7.1.</span><br><span class="line">Accept: */*.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 서비스 정보 확인</span></span><br><span class="line">c0 service list</span><br><span class="line">ID   Frontend              Service Type   Backend</span><br><span class="line">16   10.108.12.195:80      ClusterIP      1 =&gt; 172.16.2.157:80</span><br><span class="line">                                          2 =&gt; 172.16.1.234:80</span><br><span class="line">c0 bpf lb list</span><br><span class="line">SERVICE ADDRESS       BACKEND ADDRESS</span><br><span class="line">10.108.12.195:80      0.0.0.0:0 (16) [ClusterIP, non-routable]</span><br><span class="line">                      172.16.1.234:80 (16)</span><br><span class="line">                      172.16.2.157:80 (16)</span><br><span class="line"><span class="comment"># BPF maps</span></span><br><span class="line">c0 map list --verbose</span><br><span class="line">c0 map list --verbose | grep lb</span><br><span class="line">c0 map get cilium_lb4_services_v2</span><br><span class="line">c0 map get cilium_lb4_backends_v3</span><br><span class="line">c0 map get cilium_lb4_reverse_nat</span><br><span class="line">c0 map get cilium_lb4_reverse_sk</span><br><span class="line">c0 map get cilium_lxc</span><br><span class="line">c0 map get cilium_ipcache</span><br></pre></td></tr></table></figure>



<p>Socket-Based LoadBalancing 관련 설정값 확인 및 Cgroup 관련 정보 확인</p>
<p><img src="/blog/img/cilium-12.png"></p>
<p><img src="/blog/img/cilium-13.png"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Socket-Based LoadBalancing 관련 설정들 확인</span></span><br><span class="line">c0 status --verbose</span><br><span class="line">...</span><br><span class="line">KubeProxyReplacement Details:</span><br><span class="line">  Status:                 True</span><br><span class="line">  Socket LB:              Enabled</span><br><span class="line">  Socket LB Tracing:      Enabled</span><br><span class="line">  Socket LB Coverage:     Full</span><br><span class="line">  Devices:                ens5   192.168.10.10 fe80::57:abff:fee3:da8d (Direct Routing)</span><br><span class="line">  Mode:                   SNAT</span><br><span class="line">  Backend Selection:      Random</span><br><span class="line">  Session Affinity:       Enabled</span><br><span class="line">  Graceful Termination:   Enabled</span><br><span class="line">  NAT46/64 Support:       Disabled</span><br><span class="line">  XDP Acceleration:       Disabled</span><br><span class="line">  Services:</span><br><span class="line">  - ClusterIP:      Enabled</span><br><span class="line">  - NodePort:       Enabled (Range: 30000-32767) </span><br><span class="line">  - LoadBalancer:   Enabled </span><br><span class="line">  - externalIPs:    Enabled </span><br><span class="line">  - HostPort:       Enabled</span><br><span class="line"></span><br><span class="line"><span class="comment"># cgroup root 경로 확인</span></span><br><span class="line">tree /run/cilium/cgroupv2 -L 1</span><br><span class="line">tree /run/cilium/cgroupv2 -L 2</span><br><span class="line">cilium config view | grep cgroup</span><br><span class="line">cgroup-root                                    /run/cilium/cgroupv2</span><br><span class="line"></span><br><span class="line"><span class="comment"># eBPF cgroup 확인 : Socket based LB 와 관련</span></span><br><span class="line">c0bpf cgroup tree</span><br><span class="line">CgroupPath</span><br><span class="line">ID       AttachType      AttachFlags     Name           </span><br><span class="line">/sys/fs/cgroup</span><br><span class="line">1081     cgroup_device   multi                                          </span><br><span class="line">1498     tcx_ingress                     cil_to_host                    </span><br><span class="line">1501     tcx_egress                      cil_from_host  </span><br><span class="line"></span><br><span class="line"><span class="comment"># cilium 파드의 Init Containers 에서 cgroup 마운트!</span></span><br><span class="line">Init Containers:</span><br><span class="line">  mount-cgroup:</span><br><span class="line">    Container ID:  containerd://72e9d2ee9731e3536c893f9daaa7674809638e3d137f9eb0f46fe916c2aa2839</span><br><span class="line">    Image:         quay.io/cilium/cilium:v1.16.3@sha256:62d2a09bbef840a46099ac4c69421c90f84f28d018d479749049011329aa7f28</span><br><span class="line">    Image ID:      quay.io/cilium/cilium@sha256:62d2a09bbef840a46099ac4c69421c90f84f28d018d479749049011329aa7f28</span><br><span class="line">    Port:          &lt;none&gt;</span><br><span class="line">    Host Port:     &lt;none&gt;</span><br><span class="line">    Command:</span><br><span class="line">      sh</span><br><span class="line">      -ec</span><br><span class="line">      <span class="built_in">cp</span> /usr/bin/cilium-mount /hostbin/cilium-mount;</span><br><span class="line">      nsenter --cgroup=/hostproc/1/ns/cgroup --mount=/hostproc/1/ns/mnt <span class="string">&quot;<span class="variable">$&#123;BIN_PATH&#125;</span>/cilium-mount&quot;</span> <span class="variable">$CGROUP_ROOT</span>;</span><br><span class="line">      <span class="built_in">rm</span> /hostbin/cilium-mount</span><br><span class="line">      </span><br><span class="line">    State:          Terminated</span><br><span class="line">      Reason:       Completed</span><br><span class="line">      Exit Code:    0</span><br><span class="line">      Started:      Sun, 20 Oct 2024 15:45:34 +0900</span><br><span class="line">      Finished:     Sun, 20 Oct 2024 15:45:34 +0900</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:</span><br><span class="line">      CGROUP_ROOT:  /run/cilium/cgroupv2</span><br><span class="line">      BIN_PATH:     /opt/cni/bin</span><br><span class="line">    Mounts:</span><br><span class="line">      /hostbin from cni-path (rw)</span><br><span class="line">      /hostproc from hostproc (rw)</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-p6bcr (ro)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># mount-cgroup 로그 확인</span></span><br><span class="line">kubetail -n kube-system -c mount-cgroup --since 12h</span><br><span class="line">...</span><br><span class="line">[cilium-2rkvc] time=<span class="string">&quot;2024-10-27T00:30:54+09:00&quot;</span> level=info msg=<span class="string">&quot;Mounted cgroupv2 filesystem at /run/cilium/cgroupv2&quot;</span> subsys=cgroups</span><br></pre></td></tr></table></figure>



<p>strace 시스템 콜 트레이싱 도구를 통해 파드 내에서 동작 확인*</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">Hostname: webpod2</span><br><span class="line">IP: 127.0.0.1</span><br><span class="line">IP: ::1</span><br><span class="line">IP: 172.16.2.11</span><br><span class="line">IP: fe80::dc:1cff:fe89:75f5</span><br><span class="line">RemoteAddr: 172.16.0.13:45966</span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: 10.10.39.26</span><br><span class="line">User-Agent: curl/8.7.1</span><br><span class="line">Accept: */*</span><br><span class="line"></span><br><span class="line">% time     seconds  usecs/call     calls    errors syscall</span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line"> 20.07    0.001076          13        79           mmap</span><br><span class="line"> 15.50    0.000831          14        56        32 open</span><br><span class="line">  8.69    0.000466          17        27           munmap</span><br><span class="line">  6.90    0.000370          13        27           close</span><br><span class="line">  5.78    0.000310          62         5           getrandom</span><br><span class="line">  5.69    0.000305           9        31           rt_sigaction</span><br><span class="line">  5.30    0.000284          10        27           <span class="built_in">read</span></span><br><span class="line">  4.85    0.000260          21        12           fstat</span><br><span class="line">  4.50    0.000241           7        31           lseek</span><br><span class="line">  3.68    0.000197         197         1           execve</span><br><span class="line">  3.21    0.000172          12        14           mprotect</span><br><span class="line">  2.87    0.000154           6        23           fcntl</span><br><span class="line">  2.41    0.000129         129         1         1 connect</span><br><span class="line">  1.60    0.000086           8        10           readv</span><br><span class="line">  1.34    0.000072           6        12           rt_sigprocmask</span><br><span class="line">  1.10    0.000059           9         6           poll</span><br><span class="line">  1.04    0.000056          56         1           sendto</span><br><span class="line">  0.97    0.000052          13         4           setsockopt</span><br><span class="line">  0.63    0.000034           8         4           getsockname</span><br><span class="line">  0.58    0.000031          10         3           brk</span><br><span class="line">  0.56    0.000030          30         1           socket</span><br><span class="line">  0.56    0.000030          10         3         3 ioctl</span><br><span class="line">  0.39    0.000021          21         1           getsockopt</span><br><span class="line">  0.34    0.000018          18         1           recvfrom</span><br><span class="line">  0.28    0.000015          15         1           pipe</span><br><span class="line">  0.28    0.000015           7         2           geteuid</span><br><span class="line">  0.22    0.000012          12         1           writev</span><br><span class="line">  0.15    0.000008           8         1           getuid</span><br><span class="line">  0.15    0.000008           8         1           getgid</span><br><span class="line">  0.13    0.000007           7         1           getegid</span><br><span class="line">  0.11    0.000006           6         1           arch_prctl</span><br><span class="line">  0.09    0.000005           5         1           set_tid_address</span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line">100.00    0.005360          13       389        36 total</span><br></pre></td></tr></table></figure>





<p>삭제</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod --all &amp;&amp; kubectl delete svc svc</span><br></pre></td></tr></table></figure>







<h2 id="Running-Prometheus-amp-Grafana"><a href="#Running-Prometheus-amp-Grafana" class="headerlink" title="Running Prometheus &amp; Grafana"></a>Running Prometheus &amp; Grafana</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 배포</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.16.3/examples/kubernetes/addons/prometheus/monitoring-example.yaml</span><br><span class="line">kubectl get all -n cilium-monitoring</span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드와 서비스 확인</span></span><br><span class="line">kubectl get pod,svc,ep -o wide -n cilium-monitoring</span><br><span class="line"></span><br><span class="line"><span class="comment"># NodePort 설정</span></span><br><span class="line">kubectl patch svc grafana -n cilium-monitoring -p <span class="string">&#x27;&#123;&quot;spec&quot;: &#123;&quot;type&quot;: &quot;NodePort&quot;&#125;&#125;&#x27;</span></span><br><span class="line">kubectl patch svc prometheus -n cilium-monitoring -p <span class="string">&#x27;&#123;&quot;spec&quot;: &#123;&quot;type&quot;: &quot;NodePort&quot;&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Grafana 웹 접속</span></span><br><span class="line">GPT=$(kubectl get svc -n cilium-monitoring grafana -o jsonpath=&#123;.spec.ports[0].nodePort&#125;)</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Grafana URL = http://<span class="subst">$(curl -s ipinfo.io/ip)</span>:<span class="variable">$GPT</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Prometheus 웹 접속 정보 확인</span></span><br><span class="line">PPT=$(kubectl get svc -n cilium-monitoring prometheus -o jsonpath=&#123;.spec.ports[0].nodePort&#125;)</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Prometheus URL = http://<span class="subst">$(curl -s ipinfo.io/ip)</span>:<span class="variable">$PPT</span>&quot;</span></span><br></pre></td></tr></table></figure>



<p><img src="/blog/img/cilium-18.png"></p>
<p><img src="/blog/img/cilium-19.png"></p>
<h2 id="Network-Policy-L3-L4-L7"><a href="#Network-Policy-L3-L4-L7" class="headerlink" title="Network Policy (L3, L4, L7)"></a>Network Policy (L3, L4, L7)</h2><h3 id="Deploy-the-Demo-Application-Docs"><a href="#Deploy-the-Demo-Application-Docs" class="headerlink" title="Deploy the Demo Application - Docs"></a>Deploy the Demo Application - <a target="_blank" rel="noopener" href="https://docs.cilium.io/en/stable/gettingstarted/demo/">Docs</a></h3><p>디플로이먼트(웹 서버, deathstar, replicas 2), 파드(xwing, tiefighter), 서비스(ClusterIP, service&#x2F;deathstar)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 배포</span></span><br><span class="line">kubectl create -f https://raw.githubusercontent.com/cilium/cilium/1.16.3/examples/minikube/http-sw-app.yaml</span><br><span class="line">kubectl get all</span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 라벨 확인</span></span><br><span class="line">kubectl get pod --show-labels</span><br><span class="line"></span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">deathstar-689f66b57d-lth25   1/1     Running   0          10s   app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=689f66b57d</span><br><span class="line">deathstar-689f66b57d-v5xqk   1/1     Running   0          10s   app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=689f66b57d</span><br><span class="line">netpod                       1/1     Running   0          36m   app=netpod</span><br><span class="line">tiefighter                   1/1     Running   0          10s   app.kubernetes.io/name=tiefighter,class=tiefighter,org=empire</span><br><span class="line">webpod1                      1/1     Running   0          36m   app=webpod</span><br><span class="line">webpod2                      1/1     Running   0          36m   app=webpod</span><br><span class="line">xwing                        1/1     Running   0          10s   app.kubernetes.io/name=xwing,class=xwing,org=alliance</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># cilium endpoint 확인</span></span><br><span class="line">kubectl get ciliumendpoints</span><br><span class="line">c1 endpoint list</span><br><span class="line">c2 endpoint list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 데스스타 SVC(ClusterIP) 접속하여 웹 파드 연결 확인 &gt;&gt; Hubble UI 에서 실시간 확인해보자!</span></span><br><span class="line">kubectl <span class="built_in">exec</span> xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing</span><br><span class="line">Ship landed</span><br><span class="line"></span><br><span class="line">kubectl <span class="built_in">exec</span> tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing</span><br><span class="line">Ship landed</span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인</span></span><br><span class="line">hubble observe</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/cilium-14.png"></p>
<h3 id="Identity-Aware-and-HTTP-Aware-Policy-Enforcement-Apply-an-L3-x2F-L4-Policy-Link-amp-Hubble-CLI-링크"><a href="#Identity-Aware-and-HTTP-Aware-Policy-Enforcement-Apply-an-L3-x2F-L4-Policy-Link-amp-Hubble-CLI-링크" class="headerlink" title="Identity-Aware and HTTP-Aware Policy Enforcement Apply an L3&#x2F;L4 Policy - Link &amp; Hubble CLI - 링크"></a>Identity-Aware and HTTP-Aware Policy Enforcement Apply an L3&#x2F;L4 Policy - <a target="_blank" rel="noopener" href="https://docs.cilium.io/en/stable/gettingstarted/demo/#apply-an-l3-l4-policy">Link</a> &amp; Hubble CLI - <a target="_blank" rel="noopener" href="https://docs.cilium.io/en/stable/gettingstarted/hubble_cli/">링크</a></h3><ul>
<li>Cilium 에서는 Endpoint IP 대신, <strong>파드</strong>의 **Labels(라벨)**을 사용(기준)하여 <strong>보안 정책을 적용</strong>합니다</li>
<li><strong>IP&#x2F;Port</strong> 필터링을 <strong>L3&#x2F;L4 네트워크 정책</strong>이라고 한다</li>
<li>아래 처럼 ‘org&#x3D;empire’ Labels(라벨) 부착된 파드만 허용해보자</li>
<li>Cilium performs <strong>stateful connection tracking</strong> 이므로 리턴 트래픽은 자동으로 허용됨</li>
</ul>
<p><img src="/blog/img/cilium-15.png"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># L3/L4 정책 생성</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl apply -f - </span></span><br><span class="line"><span class="string">apiVersion: &quot;cilium.io/v2&quot;</span></span><br><span class="line"><span class="string">kind: CiliumNetworkPolicy</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: &quot;rule1&quot;</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  description: &quot;L3-L4 policy to restrict deathstar access to empire ships only&quot;</span></span><br><span class="line"><span class="string">  endpointSelector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      org: empire</span></span><br><span class="line"><span class="string">      class: deathstar</span></span><br><span class="line"><span class="string">  ingress:</span></span><br><span class="line"><span class="string">  - fromEndpoints:</span></span><br><span class="line"><span class="string">    - matchLabels:</span></span><br><span class="line"><span class="string">        org: empire</span></span><br><span class="line"><span class="string">    toPorts:</span></span><br><span class="line"><span class="string">    - ports:</span></span><br><span class="line"><span class="string">      - port: &quot;80&quot;</span></span><br><span class="line"><span class="string">        protocol: TCP</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 정책 확인</span></span><br><span class="line">kubectl get cnp</span><br><span class="line">kc describe cnp rule1</span><br><span class="line">c0 policy get</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 파드 curl 접속 시도 시 파드 sh 접속 후 curl 시도하자!</span></span><br><span class="line"><span class="comment"># 데스스타 SVC(ClusterIP) 접속하여 웹 파드 연결 확인 &gt;&gt; Hubble UI 에서 drop 확인!</span></span><br><span class="line">kubectl <span class="built_in">exec</span> tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing</span><br><span class="line">Ship landed</span><br><span class="line"></span><br><span class="line">kubectl <span class="built_in">exec</span> xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing</span><br><span class="line">drop</span><br><span class="line"></span><br><span class="line"><span class="comment"># hubble cli 모니터링 </span></span><br><span class="line">hubble observe --pod xwing</span><br><span class="line">hubble observe --pod tiefighter</span><br><span class="line">hubble observe --pod deathstar</span><br><span class="line"></span><br><span class="line">Oct 26 16:22:16.631: default/xwing:40664 (ID:6016) &lt;&gt; default/deathstar-689f66b57d-v5xqk:80 (ID:44044) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)</span><br><span class="line">Oct 26 16:22:16.631: default/xwing:40664 (ID:6016) &lt;&gt; default/deathstar-689f66b57d-v5xqk:80 (ID:44044) Policy denied DROPPED (TCP Flags: SYN)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hubble observe --pod deathstar --verdict DROPPED</span><br><span class="line"></span><br><span class="line">Oct 26 16:22:17.675: default/xwing:40664 (ID:6016) &lt;&gt; default/deathstar-689f66b57d-v5xqk:80 (ID:44044) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)</span><br><span class="line">Oct 26 16:22:17.675: default/xwing:40664 (ID:6016) &lt;&gt; default/deathstar-689f66b57d-v5xqk:80 (ID:44044) Policy denied DROPPED (TCP Flags: SYN)</span><br><span class="line">Oct 26 16:22:18.699: default/xwing:40664 (ID:6016) &lt;&gt; default/deathstar-689f66b57d-v5xqk:80 (ID:44044) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)</span><br><span class="line">Oct 26 16:22:18.699: default/xwing:40664 (ID:6016) &lt;&gt; default/deathstar-689f66b57d-v5xqk:80 (ID:44044) Policy denied DROPPED (TCP Flags: SYN)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Inspecting the Policy</span><br><span class="line"><span class="comment"># If we run cilium endpoint list again we will see that the pods with the label org=empire and class=deathstar</span></span><br><span class="line"><span class="comment"># now have ingress policy enforcement enabled as per the policy above.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># endpoint list 에서 정책 적용 확인</span></span><br><span class="line">c1 endpoint list | grep deathstar</span><br><span class="line">c2 endpoint list</span><br><span class="line">ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (<span class="built_in">source</span>:key[=value])                                              IPv6   IPv4           STATUS</span><br><span class="line">           ENFORCEMENT        ENFORCEMENT</span><br><span class="line">312        Disabled           Disabled          18300      k8s:class=xwing                                                                 172.16.2.161   ready</span><br><span class="line">                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default</span><br><span class="line">                                                           k8s:io.cilium.k8s.policy.cluster=default</span><br><span class="line">                                                           k8s:io.cilium.k8s.policy.serviceaccount=default</span><br><span class="line">                                                           k8s:io.kubernetes.pod.namespace=default</span><br><span class="line">                                                           k8s:org=alliance</span><br><span class="line"></span><br><span class="line">1972       Enabled            Disabled          21144      k8s:class=deathstar                                                             172.16.2.66    ready</span><br><span class="line">                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default</span><br><span class="line">                                                           k8s:io.cilium.k8s.policy.cluster=default</span><br><span class="line">                                                           k8s:io.cilium.k8s.policy.serviceaccount=default</span><br><span class="line">                                                           k8s:io.kubernetes.pod.namespace=default</span><br><span class="line">                                                           k8s:org=empirec2 endpoint list</span><br></pre></td></tr></table></figure>

<p><img src="/blog/img/cilium-16.png"></p>
<h3 id="Identity-Aware-and-HTTP-Aware-Policy-Enforcement-Apply-and-Test-HTTP-aware-L7-Policy-Docs"><a href="#Identity-Aware-and-HTTP-Aware-Policy-Enforcement-Apply-and-Test-HTTP-aware-L7-Policy-Docs" class="headerlink" title="Identity-Aware and HTTP-Aware Policy Enforcement Apply and Test HTTP-aware L7 Policy - Docs"></a>Identity-Aware and HTTP-Aware Policy Enforcement Apply and Test HTTP-aware L7 Policy - <a target="_blank" rel="noopener" href="https://docs.cilium.io/en/stable/gettingstarted/demo/#apply-and-test-http-aware-l7-policy">Docs</a></h3><p>HTTP L7 필터링을 적용 : 아래 처럼 PUT &#x2F;v1&#x2F;exhaust-port 요청을 차단!</p>
<p><img src="/blog/img/cilium-17.png"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 데스스타 SVC(ClusterIP) 접속</span></span><br><span class="line">kubectl <span class="built_in">exec</span> tiefighter -- curl -s -XPUT deathstar.default.svc.cluster.local/v1/exhaust-port</span><br><span class="line">Panic: deathstar exploded</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># POST /v1/request-landing API 호출만 허용 정책으로 기존 정책 내용을 업데이트(configured)!</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl apply -f - </span></span><br><span class="line"><span class="string">apiVersion: &quot;cilium.io/v2&quot;</span></span><br><span class="line"><span class="string">kind: CiliumNetworkPolicy</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: &quot;rule1&quot;</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  description: &quot;L7 policy to restrict access to specific HTTP call&quot;</span></span><br><span class="line"><span class="string">  endpointSelector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      org: empire</span></span><br><span class="line"><span class="string">      class: deathstar</span></span><br><span class="line"><span class="string">  ingress:</span></span><br><span class="line"><span class="string">  - fromEndpoints:</span></span><br><span class="line"><span class="string">    - matchLabels:</span></span><br><span class="line"><span class="string">        org: empire</span></span><br><span class="line"><span class="string">    toPorts:</span></span><br><span class="line"><span class="string">    - ports:</span></span><br><span class="line"><span class="string">      - port: &quot;80&quot;</span></span><br><span class="line"><span class="string">        protocol: TCP</span></span><br><span class="line"><span class="string">      rules:</span></span><br><span class="line"><span class="string">        http:</span></span><br><span class="line"><span class="string">        - method: &quot;POST&quot;</span></span><br><span class="line"><span class="string">          path: &quot;/v1/request-landing&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 정책 확인</span></span><br><span class="line">kc describe ciliumnetworkpolicies</span><br><span class="line">c0 policy get</span><br><span class="line"></span><br><span class="line"><span class="comment"># 모니터링</span></span><br><span class="line">c1 monitor -v --<span class="built_in">type</span> l7</span><br><span class="line">c2 monitor -v --<span class="built_in">type</span> l7</span><br><span class="line">&lt;- Request http from 0 ([k8s:io.cilium.k8s.policy.cluster=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.kubernetes.pod.namespace=default k8s:org=empire k8s:class=tiefighter k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default]) to 1972 ([k8s:class=deathstar k8s:org=empire k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default k8s:io.kubernetes.pod.namespace=default k8s:io.cilium.k8s.policy.serviceaccount=default k8s:io.cilium.k8s.policy.cluster=default]), identity 42720-&gt;21144, verdict Denied PUT http://deathstar.default.svc.cluster.local/v1/exhaust-port =&gt; 403</span><br><span class="line"> =&gt; 403</span><br><span class="line">hubble observe --pod deathstar</span><br><span class="line">hubble observe --pod deathstar --verdict DROPPED</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 접근 테스트</span></span><br><span class="line">kubectl <span class="built_in">exec</span> tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing</span><br><span class="line">Ship landed</span><br><span class="line"></span><br><span class="line">kubectl <span class="built_in">exec</span> tiefighter -- curl -s -XPUT deathstar.default.svc.cluster.local/v1/exhaust-port</span><br><span class="line">Access denied</span><br><span class="line"></span><br><span class="line"><span class="comment">## hubble cli 에 차단 로그 확인</span></span><br><span class="line">hubble observe --pod deathstar --verdict DROPPED</span><br><span class="line"></span><br><span class="line">Oct 26 16:25:27.755: default/xwing:42756 (ID:6016) &lt;&gt; default/deathstar-689f66b57d-v5xqk:80 (ID:44044) policy-verdict:none INGRESS DENIED (TCP Flags: SYN)</span><br><span class="line">Oct 26 16:25:27.755: default/xwing:42756 (ID:6016) &lt;&gt; default/deathstar-689f66b57d-v5xqk:80 (ID:44044) Policy denied DROPPED (TCP Flags: SYN)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hubble observe --pod deathstar --protocol http</span><br><span class="line"></span><br><span class="line">Oct 26 16:27:18.903: default/tiefighter:51914 (ID:5305) -&gt; default/deathstar-689f66b57d-v5xqk:80 (ID:44044) http-request DROPPED (HTTP/1.1 PUT http://deathstar.default.svc.cluster.local/v1/exhaust-port)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 삭제</span></span><br><span class="line">kubectl delete -f https://raw.githubusercontent.com/cilium/cilium/1.16.3/examples/minikube/http-sw-app.yaml</span><br><span class="line">kubectl delete cnp rule1</span><br></pre></td></tr></table></figure>



<p>삭제</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f https://raw.githubusercontent.com/cilium/cilium/1.16.3/examples/minikube/http-sw-app.yaml</span><br><span class="line">kubectl delete cnp rule1</span><br></pre></td></tr></table></figure>





<h2 id="Bandwidth-Manager"><a href="#Bandwidth-Manager" class="headerlink" title="Bandwidth Manager"></a>Bandwidth Manager</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 인터페이스 tc qdisc 확인</span></span><br><span class="line">tc qdisc show dev ens5</span><br><span class="line">qdisc mq 0: root </span><br><span class="line">qdisc fq_codel 0: parent :4 <span class="built_in">limit</span> 10240p flows 1024 quantum 1514 target 5ms interval 100ms memory_limit 32Mb ecn drop_batch 64 </span><br><span class="line">qdisc fq_codel 0: parent :3 <span class="built_in">limit</span> 10240p flows 1024 quantum 1514 target 5ms interval 100ms memory_limit 32Mb ecn drop_batch 64 </span><br><span class="line">qdisc fq_codel 0: parent :2 <span class="built_in">limit</span> 10240p flows 1024 quantum 1514 target 5ms interval 100ms memory_limit 32Mb ecn drop_batch 64 </span><br><span class="line">qdisc fq_codel 0: parent :1 <span class="built_in">limit</span> 10240p flows 1024 quantum 1514 target 5ms interval 100ms memory_limit 32Mb ecn drop_batch 64 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 설정</span></span><br><span class="line">helm upgrade cilium cilium/cilium --namespace kube-system --reuse-values --<span class="built_in">set</span> bandwidthManager.enabled=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 적용 확인</span></span><br><span class="line">cilium config view | grep bandwidth</span><br><span class="line">enable-bandwidth-manager                       <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># egress bandwidth limitation 동작하는 인터페이스 확인</span></span><br><span class="line">c0 status | grep  BandwidthManager</span><br><span class="line">BandwidthManager:        EDT with BPF [CUBIC] [ens5]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 인터페이스 tc qdisc 확인 : 설정 전후 옵션값들이 상당히 추가된다</span></span><br><span class="line">tc qdisc</span><br><span class="line">tc qdisc show dev ens5</span><br><span class="line">qdisc mq 8002: root </span><br><span class="line">qdisc fq 8005: parent 8002:2 <span class="built_in">limit</span> 10000p flow_limit 100p buckets 32768 orphan_mask 1023 quantum 18030b initial_quantum 90150b low_rate_threshold 550Kbit refill_delay 40ms timer_slack 10us horizon 2s horizon_drop </span><br><span class="line">qdisc fq 8003: parent 8002:4 <span class="built_in">limit</span> 10000p flow_limit 100p buckets 32768 orphan_mask 1023 quantum 18030b initial_quantum 90150b low_rate_threshold 550Kbit refill_delay 40ms timer_slack 10us horizon 2s horizon_drop </span><br><span class="line">qdisc fq 8004: parent 8002:3 <span class="built_in">limit</span> 10000p flow_limit 100p buckets 32768 orphan_mask 1023 quantum 18030b initial_quantum 90150b low_rate_threshold 550Kbit refill_delay 40ms timer_slack 10us horizon 2s horizon_drop </span><br><span class="line">qdisc fq 8006: parent 8002:1 <span class="built_in">limit</span> 10000p flow_limit 100p buckets 32768 orphan_mask 1023 quantum 18030b initial_quantum 90150b low_rate_threshold 550Kbit refill_delay 40ms timer_slack 10us horizon 2s horizon_drop </span><br></pre></td></tr></table></figure>



<p>설정</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 테스트를 위한 트래픽 발생 서버/클라이언트 파드 생성</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl apply -f -</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  annotations:</span></span><br><span class="line"><span class="string">    # Limits egress bandwidth to 10Mbit/s.</span></span><br><span class="line"><span class="string">    kubernetes.io/egress-bandwidth: &quot;10M&quot;</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    # This pod will act as server.</span></span><br><span class="line"><span class="string">    app.kubernetes.io/name: netperf-server</span></span><br><span class="line"><span class="string">  name: netperf-server</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: netperf</span></span><br><span class="line"><span class="string">    image: cilium/netperf</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">    - containerPort: 12865</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  # This Pod will act as client.</span></span><br><span class="line"><span class="string">  name: netperf-client</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  affinity:</span></span><br><span class="line"><span class="string">    # Prevents the client from being scheduled to the</span></span><br><span class="line"><span class="string">    # same node as the server.</span></span><br><span class="line"><span class="string">    podAntiAffinity:</span></span><br><span class="line"><span class="string">      requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="string">      - labelSelector:</span></span><br><span class="line"><span class="string">          matchExpressions:</span></span><br><span class="line"><span class="string">          - key: app.kubernetes.io/name</span></span><br><span class="line"><span class="string">            operator: In</span></span><br><span class="line"><span class="string">            values:</span></span><br><span class="line"><span class="string">            - netperf-server</span></span><br><span class="line"><span class="string">        topologyKey: kubernetes.io/hostname</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: netperf</span></span><br><span class="line"><span class="string">    args:</span></span><br><span class="line"><span class="string">    - sleep</span></span><br><span class="line"><span class="string">    - infinity</span></span><br><span class="line"><span class="string">    image: cilium/netperf</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># egress BW 제한 정보 확인</span></span><br><span class="line">kubectl describe pod netperf-server | grep Annotations:</span><br><span class="line">Annotations:  kubernetes.io/egress-bandwidth: 10M</span><br><span class="line"></span><br><span class="line"><span class="comment"># egress BW 제한이 설정된 파드가 있는 cilium pod 에서 제한 정보 확인</span></span><br><span class="line">c1 bpf bandwidth list</span><br><span class="line">c2 bpf bandwidth list</span><br><span class="line">IDENTITY   EGRESS BANDWIDTH (BitsPerSec)</span><br><span class="line">904        10M</span><br><span class="line"></span><br><span class="line">c1 endpoint list</span><br><span class="line">c2 endpoint list</span><br><span class="line">ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (<span class="built_in">source</span>:key[=value])                 IPv6   IPv4           STATUS</span><br><span class="line">           ENFORCEMENT        ENFORCEMENT</span><br><span class="line">904        Disabled           Disabled          21565      k8s:app.kubernetes.io/name=netperf-server          172.16.2.153   ready</span><br><span class="line"></span><br><span class="line"><span class="comment"># 트래픽 발생 &gt;&gt; Hubble UI 에서 확인</span></span><br><span class="line"><span class="comment"># egress traffic of the netperf-server Pod has been limited to 10Mbit per second. </span></span><br><span class="line">NETPERF_SERVER_IP=$(kubectl get pod netperf-server -o jsonpath=<span class="string">&#x27;&#123;.status.podIP&#125;&#x27;</span>)</span><br><span class="line">kubectl <span class="built_in">exec</span> netperf-client -- netperf -t TCP_MAERTS -H <span class="string">&quot;<span class="variable">$&#123;NETPERF_SERVER_IP&#125;</span>&quot;</span></span><br><span class="line">Recv   Send    Send</span><br><span class="line">Socket Socket  Message  Elapsed</span><br><span class="line">Size   Size    Size     Time     Throughput</span><br><span class="line">bytes  bytes   bytes    secs.    10^6bits/sec  </span><br><span class="line">131072 16384   16384    10.00    9.54  <span class="comment"># 10Mbps 제한 확인!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5M 제한 설정 후 테스트</span></span><br><span class="line">kubectl get pod netperf-server -o json | sed -e <span class="string">&#x27;s|10M|5M|g&#x27;</span> | kubectl apply -f -</span><br><span class="line">c1 bpf bandwidth list</span><br><span class="line">c2 bpf bandwidth list</span><br><span class="line">kubectl <span class="built_in">exec</span> netperf-client -- netperf -t TCP_MAERTS -H <span class="string">&quot;<span class="variable">$&#123;NETPERF_SERVER_IP&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">MIGRATED TCP MAERTS TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 172.16.1.84 (172.16.) port 0 AF_INET</span><br><span class="line">Recv   Send    Send</span><br><span class="line">Socket Socket  Message  Elapsed</span><br><span class="line">Size   Size    Size     Time     Throughput</span><br><span class="line">bytes  bytes   bytes    secs.    10^6bits/sec</span><br><span class="line"></span><br><span class="line">131072  16384  16384    10.04       9.88   <span class="comment"># 9.88 Mbps 제한</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 10M -&gt; 20M 제한 설정 후 테스트</span></span><br><span class="line">kubectl get pod netperf-server -o json | sed -e <span class="string">&#x27;s|10M|20M|g&#x27;</span> | kubectl apply -f -</span><br><span class="line">kubectl <span class="built_in">exec</span> netperf-client -- netperf -t TCP_MAERTS -H <span class="string">&quot;<span class="variable">$&#123;NETPERF_SERVER_IP&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">MIGRATED TCP MAERTS TEST from 0.0.0.0 (0.0.0.0) port 0 AF_INET to 172.16.1.84 (172.16.) port 0 AF_INET</span><br><span class="line">Recv   Send    Send</span><br><span class="line">Socket Socket  Message  Elapsed</span><br><span class="line">Size   Size    Size     Time     Throughput</span><br><span class="line">bytes  bytes   bytes    secs.    10^6bits/sec</span><br><span class="line"></span><br><span class="line">131072  16384  16384    10.01      19.80  <span class="comment"># 19.80 Mbps 제한</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tc qdisc show dev ens5</span><br><span class="line"></span><br><span class="line">qdisc mq 8002: root</span><br><span class="line">qdisc fq 8005: parent 8002:2 <span class="built_in">limit</span> 10000p flow_limit 100p buckets 32768 orphan_mask 1023 quantum 18030b initial_quantum 90150b low_rate_threshold 550Kbit refill_delay 40ms timer_slack 10us horizon 2s horizon_drop</span><br><span class="line">qdisc fq 8003: parent 8002:4 <span class="built_in">limit</span> 10000p flow_limit 100p buckets 32768 orphan_mask 1023 quantum 18030b initial_quantum 90150b low_rate_threshold 550Kbit refill_delay 40ms timer_slack 10us horizon 2s horizon_drop</span><br><span class="line">qdisc fq 8004: parent 8002:3 <span class="built_in">limit</span> 10000p flow_limit 100p buckets 32768 orphan_mask 1023 quantum 18030b initial_quantum 90150b low_rate_threshold 550Kbit refill_delay 40ms timer_slack 10us horizon 2s horizon_drop</span><br><span class="line">qdisc fq 8006: parent 8002:1 <span class="built_in">limit</span> 10000p flow_limit 100p buckets 32768 orphan_mask 1023 quantum 18030b initial_quantum 90150b low_rate_threshold 550Kbit refill_delay 40ms timer_slack 10us horizon 2s horizon_drop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 삭제</span></span><br><span class="line">kubectl delete pod netperf-client netperf-server</span><br></pre></td></tr></table></figure>





<h2 id="L2-Announcements-x2F-L2-Aware-LB-Beta-Link"><a href="#L2-Announcements-x2F-L2-Aware-LB-Beta-Link" class="headerlink" title="L2 Announcements &#x2F; L2 Aware LB (Beta) - Link"></a>L2 Announcements &#x2F; L2 Aware LB (Beta) - <a target="_blank" rel="noopener" href="https://docs.cilium.io/en/stable/network/l2-announcements/">Link</a></h2><ul>
<li>L2 Announcements는 로컬 영역 네트워크에서 서비스를 표시하고 도달 가능하게 만드는 기능입니다. 이 기능은 주로 사무실 또는 캠퍼스 네트워크와 같이 BGP 기반 라우팅이 없는 네트워크 내에서 온프레미스 배포를 위해 고안되었습니다.</li>
<li>이 기능을 사용하면 ExternalIP 및&#x2F;또는 LoadBalancer IP에 대한 ARP 쿼리에 응답합니다. 이러한 IP는 여러 노드의 가상 IP(네트워크 장치에 설치되지 않음)이므로 각 서비스에 대해 한 번에 한 노드가 ARP 쿼리에 응답하고 MAC 주소로 응답합니다. 이 노드는 서비스 로드 밸런싱 기능으로 로드 밸런싱을 수행하여 북쪽&#x2F;남쪽 로드 밸런서 역할을 합니다.</li>
<li>NodePort 서비스에 비해 이 기능의 장점은 각 서비스가 고유한 IP를 사용할 수 있으므로 여러 서비스가 동일한 포트 번호를 사용할 수 있다는 것입니다. NodePort를 사용할 때 트래픽을 보낼 호스트를 결정하는 것은 클라이언트에게 달려 있으며 노드가 다운되면 IP+Port 콤보를 사용할 수 없게 됩니다. L2 공지를 사용하면 서비스 VIP가 다른 노드로 간단히 마이그레이션되고 계속 작동합니다.</li>
</ul>
<p>설정</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">helm upgrade cilium cilium/cilium --namespace kube-system --reuse-values \</span><br><span class="line">--<span class="built_in">set</span> l2announcements.enabled=<span class="literal">true</span> --<span class="built_in">set</span> externalIPs.enabled=<span class="literal">true</span> \</span><br><span class="line">--<span class="built_in">set</span> l2announcements.leaseDuration=3s --<span class="built_in">set</span> l2announcements.leaseRenewDeadline=1s --<span class="built_in">set</span> l2announcements.leaseRetryPeriod=200ms</span><br><span class="line"> </span><br><span class="line"><span class="comment">#</span></span><br><span class="line">c0 config --all  |grep L2</span><br><span class="line">EnableL2Announcements             : <span class="literal">true</span></span><br><span class="line">EnableL2NeighDiscovery            : <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CiliumL2AnnouncementPolicy 생성</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl apply -f - </span></span><br><span class="line"><span class="string">apiVersion: &quot;cilium.io/v2alpha1&quot;</span></span><br><span class="line"><span class="string">kind: CiliumL2AnnouncementPolicy</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: policy1</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  serviceSelector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      color: blue</span></span><br><span class="line"><span class="string">  nodeSelector:</span></span><br><span class="line"><span class="string">    matchExpressions:</span></span><br><span class="line"><span class="string">      - key: node-role.kubernetes.io/control-plane</span></span><br><span class="line"><span class="string">        operator: DoesNotExist</span></span><br><span class="line"><span class="string">  interfaces:</span></span><br><span class="line"><span class="string">  - ^ens[0-9]+</span></span><br><span class="line"><span class="string">  externalIPs: true</span></span><br><span class="line"><span class="string">  loadBalancerIPs: true</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 확인</span></span><br><span class="line">kubectl get ciliuml2announcementpolicy</span><br><span class="line">kc describe l2announcement</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl apply -f - </span></span><br><span class="line"><span class="string">apiVersion: &quot;cilium.io/v2alpha1&quot;</span></span><br><span class="line"><span class="string">kind: CiliumLoadBalancerIPPool</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: &quot;cilium-pool&quot;</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  allowFirstLastIPs: &quot;No&quot;</span></span><br><span class="line"><span class="string">  blocks:</span></span><br><span class="line"><span class="string">  - cidr: &quot;10.10.200.0/29&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cilium ip pool 조회</span></span><br><span class="line">kubectl get CiliumLoadBalancerIPPool</span><br><span class="line"></span><br><span class="line">NAME          DISABLED   CONFLICTING   IPS AVAILABLE   AGE</span><br><span class="line">cilium-pool   <span class="literal">false</span>      False         6               4s</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>파드, 서비스 생성</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl apply -f -</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: webpod1</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: webpod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  nodeName: k8s-w1</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: container</span></span><br><span class="line"><span class="string">    image: traefik/whoami</span></span><br><span class="line"><span class="string">  terminationGracePeriodSeconds: 0</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: webpod2</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: webpod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  nodeName: k8s-w2</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: container</span></span><br><span class="line"><span class="string">    image: traefik/whoami</span></span><br><span class="line"><span class="string">  terminationGracePeriodSeconds: 0</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: svc1</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">    - name: svc1-webport</span></span><br><span class="line"><span class="string">      port: 80</span></span><br><span class="line"><span class="string">      targetPort: 80</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: webpod</span></span><br><span class="line"><span class="string">  type: LoadBalancer  # 서비스 타입이 LoadBalancer</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: svc2</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">    - name: svc2-webport</span></span><br><span class="line"><span class="string">      port: 80</span></span><br><span class="line"><span class="string">      targetPort: 80</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: webpod</span></span><br><span class="line"><span class="string">  type: LoadBalancer</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: svc3</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">    - name: svc3-webport</span></span><br><span class="line"><span class="string">      port: 80</span></span><br><span class="line"><span class="string">      targetPort: 80</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: webpod</span></span><br><span class="line"><span class="string">  type: LoadBalancer</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>



<p>확인</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl get svc,ep</span><br><span class="line">NAME                 TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">service/kubernetes   ClusterIP      10.10.0.1       &lt;none&gt;        443/TCP        5h20m</span><br><span class="line">service/svc1         LoadBalancer   10.10.226.228   10.10.200.1   80:32693/TCP   5m30s</span><br><span class="line">service/svc2         LoadBalancer   10.10.166.59    10.10.200.2   80:30107/TCP   5m30s</span><br><span class="line">service/svc3         LoadBalancer   10.10.106.144   10.10.200.3   80:31564/TCP   5m30s</span><br><span class="line"></span><br><span class="line">NAME                   ENDPOINTS                        AGE</span><br><span class="line">endpoints/kubernetes   192.168.10.10:6443               5h20m</span><br><span class="line">endpoints/svc1         172.16.1.52:80,172.16.2.196:80   5m30s</span><br><span class="line">endpoints/svc2         172.16.1.52:80,172.16.2.196:80   5m30s</span><br><span class="line">endpoints/svc3         172.16.1.52:80,172.16.2.196:80   5m30s</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">curl -s 10.10.200.1</span><br><span class="line">curl -s 10.10.200.2</span><br><span class="line">curl -s 10.10.200.3</span><br><span class="line"></span><br><span class="line">Hostname: webpod1</span><br><span class="line">IP: 127.0.0.1</span><br><span class="line">IP: ::1</span><br><span class="line">IP: 172.16.1.238</span><br><span class="line">IP: fe80::a059:8eff:fe41:9f6a</span><br><span class="line">RemoteAddr: 192.168.10.10:51286</span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: 10.10.200.3</span><br><span class="line">User-Agent: curl/7.81.0</span><br><span class="line">Accept: */</span><br><span class="line"></span><br></pre></td></tr></table></figure>



























</div><div class="article-licensing box"><div class="licensing-title"><p>communication</p><p><a href="https://seongtaekkim.github.io/blog/2024/10/27/docs/cilium/communication/">https://seongtaekkim.github.io/blog/2024/10/27/docs/cilium/communication/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Seongtaek Kim</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2024-10-27</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2024-10-27</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="notification is-danger">You need to set <code>install_url</code> to use ShareThis. Please set it in <code>_config.yml</code>.</div></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button donate" href="/blog/" target="_blank" rel="noopener" data-type="afdian"><span class="icon is-small"><i class="fas fa-charging-station"></i></span><span>Afdian.net</span></a><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>Alipay</span><span class="qrcode"><img src="/blog/" alt="Alipay"></span></a><a class="button donate" href="/blog/" target="_blank" rel="noopener" data-type="buymeacoffee"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>Buy me a coffee</span></a><a class="button donate" href="/blog/" target="_blank" rel="noopener" data-type="patreon"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a><div class="notification is-danger">You forgot to set the <code>business</code> or <code>currency_code</code> for Paypal. Please set it in <code>_config.yml</code>.</div><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>Wechat</span><span class="qrcode"><img src="/blog/" alt="Wechat"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/blog/2024/11/01/docs/vpccni/install/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">vpccni-install</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/blog/2024/10/27/docs/cilium/cilium/"><span class="level-item">cilium</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div class="notification is-danger">You forgot to set the <code>shortname</code> for Disqus. Please set it in <code>_config.yml</code>.</div></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/blog/img/avatar.png" alt="Seongtaek Kim"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Seongtaek Kim</p><p class="is-size-6 is-block">Blog</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/blog/archives"><p class="title">42</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/blog/categories"><p class="title">31</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/blog/tags"><p class="title">0</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/seongtaekkim"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Linkedin" href="https://linkedin.com/in/staek"><i class="fab fa-linkedin"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/blog/categories/calico-communication/"><span class="level-start"><span class="level-item">calico/communication</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/calico-concept/"><span class="level-start"><span class="level-item">calico/concept</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/calico-networkmode/"><span class="level-start"><span class="level-item">calico/networkmode</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/cilium-cilium/"><span class="level-start"><span class="level-item">cilium/cilium</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/cilium-communication/"><span class="level-start"><span class="level-item">cilium/communication</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/cilium-install/"><span class="level-start"><span class="level-item">cilium/install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-cgroup/"><span class="level-start"><span class="level-item">container/cgroup</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-namespace/"><span class="level-start"><span class="level-item">container/namespace</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-overlayFS/"><span class="level-start"><span class="level-item">container/overlayFS</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/container-overlaynetwork/"><span class="level-start"><span class="level-item">container/overlaynetwork</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/gateway-gatewayapi/"><span class="level-start"><span class="level-item">gateway/gatewayapi</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/gateway-gloo/"><span class="level-start"><span class="level-item">gateway/gloo</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/ingress-ingress/"><span class="level-start"><span class="level-item">ingress/ingress</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-bookinfo/"><span class="level-start"><span class="level-item">istio/bookinfo</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-envoy/"><span class="level-start"><span class="level-item">istio/envoy</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-istio-outline/"><span class="level-start"><span class="level-item">istio/istio-outline</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-istio-test/"><span class="level-start"><span class="level-item">istio/istio-test</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/istio-istio-traffic/"><span class="level-start"><span class="level-item">istio/istio-traffic</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/k8s-PAUSE-Container/"><span class="level-start"><span class="level-item">k8s/PAUSE-Container</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/k8s-flannel/"><span class="level-start"><span class="level-item">k8s/flannel</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/k8s-kind/"><span class="level-start"><span class="level-item">k8s/kind</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-ipvs/"><span class="level-start"><span class="level-item">loadbaleancer/ipvs</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-ipvs-install/"><span class="level-start"><span class="level-item">loadbaleancer/ipvs-install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-metalLB/"><span class="level-start"><span class="level-item">loadbaleancer/metalLB</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/loadbaleancer-metalLB-install/"><span class="level-start"><span class="level-item">loadbaleancer/metalLB-install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/serivce-clusterip/"><span class="level-start"><span class="level-item">serivce/clusterip</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/serivce-install/"><span class="level-start"><span class="level-item">serivce/install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/serivce-nodeport/"><span class="level-start"><span class="level-item">serivce/nodeport</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/vpccni-vpccni/"><span class="level-start"><span class="level-item">vpccni/vpccni</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/vpccni-vpccni-install/"><span class="level-start"><span class="level-item">vpccni/vpccni-install</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/blog/categories/vpccni-vpccni2/"><span class="level-start"><span class="level-item">vpccni/vpccni2</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-11-02T19:00:35.000Z">2024-11-03</time></p><p class="title"><a href="/blog/2024/11/03/docs/vpccni/vpccni-2/">vpccni-2</a></p><p class="categories"><a href="/blog/categories/vpccni-vpccni2/">vpccni/vpccni2</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-11-02T18:00:35.000Z">2024-11-03</time></p><p class="title"><a href="/blog/2024/11/03/docs/vpccni/vpccni/">vpccni</a></p><p class="categories"><a href="/blog/categories/vpccni-vpccni/">vpccni/vpccni</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-10-31T19:00:35.000Z">2024-11-01</time></p><p class="title"><a href="/blog/2024/11/01/docs/vpccni/install/">vpccni-install</a></p><p class="categories"><a href="/blog/categories/vpccni-vpccni-install/">vpccni/vpccni-install</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-10-26T17:00:35.000Z">2024-10-27</time></p><p class="title"><a href="/blog/2024/10/27/docs/cilium/communication/">communication</a></p><p class="categories"><a href="/blog/categories/cilium-communication/">cilium/communication</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-10-26T16:30:35.000Z">2024-10-27</time></p><p class="title"><a href="/blog/2024/10/27/docs/cilium/cilium/">cilium</a></p><p class="categories"><a href="/blog/categories/cilium-cilium/">cilium/cilium</a></p></div></article></div></div><!--!--></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/blog/">Blog</a><p class="is-size-7"><span>&copy; 2024 Seongtaek Kim</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/blog/js/column.js"></script><script src="/blog/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/blog/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/blog/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/blog/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/blog/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>